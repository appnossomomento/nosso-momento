<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Momento</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            /* Adicionado padding-bottom para que o conte√∫do n√£o fique por baixo do footer fixo */
            padding-bottom: 80px; /* Altura aproximada do footer */
        }
        .product-card {
            transition: all 0.3s ease-out;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 53, 71, 0.2);
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }
        .product-img {
            height: 160px;
            object-fit: cover;
            width: 100%;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 32px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .carrinho-item {
            animation: fadeIn 0.5s ease-out;
            border-radius: 12px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-red {
            background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px rgba(255, 53, 71, 0.3);
            padding: 14px 24px;
            border: none;
            outline: none;
            text-transform: uppercase;
            font-size: 14px;
        }
        .btn-red:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 53, 71, 0.4);
            background: linear-gradient(135deg, #FF4252 0%, #FF7B8A 100%);
        }
        .bg-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        /* Modern button styles */
        .btn-modern {
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        /* Input styles */
        input {
            border-radius: 12px !important;
            padding: 14px 16px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            background: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        input::placeholder {
            color: rgba(255,255,255,0.5) !important;
        }
        /* Card styles */
        .card {
            border-radius: 20px;
            background: rgba(30,30,30,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        /* Footer custom style */
        .app-footer {
            background: linear-gradient(90deg, #FF3547 0%, #FF6B7C 100%);
            color: white; /* Texto branco */
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); /* Sombra para contraste */
            padding: 16px;
            font-size: 14px;
            text-align: center;
            /* Adicionado para fixar no rodap√© */
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 100; /* Garante que fique acima de outros elementos */
        }

        /* Novo estilo para a barra de navega√ß√£o inferior (footer) */
        .bottom-nav-bar {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.08);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px; /* Altura da barra */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50; /* Abaixo da sidebar do carrinho */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            color: rgba(255,255,255,0.6);
            font-size: 11px;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 100%; /* Para centralizar o conte√∫do verticalmente */
            flex-grow: 1; /* Para que os itens se espalhem igualmente */
        }
        .bottom-nav-item.active {
            color: #FF6B7C; /* Cor de destaque */
        }
        .bottom-nav-item:hover {
            color: #FF6B7C; /* Cor de destaque no hover */
        }
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* Esconder a barra de rolagem horizontal se algo escapar */
        body {
            overflow-x: hidden;
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <div id="app">
        </div>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            /* Adicionado padding-bottom para que o conte√∫do n√£o fique por baixo do footer fixo */
            padding-bottom: 80px; /* Altura aproximada do footer */
        }
        .product-card {
            transition: all 0.3s ease-out;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 53, 71, 0.2);
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }
        .product-img {
            height: 160px;
            object-fit: cover;
            width: 100%;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 32px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .carrinho-item {
            animation: fadeIn 0.5s ease-out;
            border-radius: 12px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-red {
            background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px rgba(255, 53, 71, 0.3);
            padding: 14px 24px;
            border: none;
            outline: none;
            text-transform: uppercase;
            font-size: 14px;
        }
        .btn-red:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 53, 71, 0.4);
            background: linear-gradient(135deg, #FF4252 0%, #FF7B8A 100%);
        }
        .bg-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        /* Modern button styles */
        .btn-modern {
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        /* Input styles */
        input {
            border-radius: 12px !important;
            padding: 14px 16px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            background: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        input::placeholder {
            color: rgba(255,255,255,0.5) !important;
        }
        /* Card styles */
        .card {
            border-radius: 20px;
            background: rgba(30,30,30,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        /* Footer custom style */
        .app-footer {
            background: linear-gradient(90deg, #FF3547 0%, #FF6B7C 100%);
            color: white; /* Texto branco */
            text-shadow: 0 1px 2px rgba(0,0,0,0.4); /* Sombra para contraste */
            padding: 16px;
            font-size: 14px;
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        /* Novo estilo para a barra de navega√ß√£o inferior (footer) */
        .bottom-nav-bar {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.08);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px; /* Altura da barra */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 50; /* Abaixo da sidebar do carrinho */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 2px;
            color: rgba(255,255,255,0.6);
            font-size: 11px;
            font-weight: 500;
            transition: color 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 100%; /* Para centralizar o conte√∫do verticalmente */
            flex-grow: 1; /* Para que os itens se espalhem igualmente */
        }
        .bottom-nav-item.active {
            color: #FF6B7C; /* Cor de destaque */
        }
        .bottom-nav-item:hover {
            color: #FF6B7C; /* Cor de destaque no hover */
        }
        .bottom-nav-item i {
            font-size: 20px;
            margin-bottom: 2px;
        }

        /* Esconder a barra de rolagem horizontal se algo escapar */
        body {
            overflow-x: hidden;
        }

        /* Ajuste para telas pequenas - header */
        @media (max-width: 640px) { /* sm breakpoint no Tailwind */
            .header-content {
                display: flex;
                justify-content: space-between;
                width: 100%;
                align-items: center;
                padding-left: 1rem; /* px-4 */
                padding-right: 1rem; /* px-4 */
            }
            .header-content > div:nth-child(2) { /* A√ß√µes √† direita */
                display: flex;
                gap: 0.5rem; /* Menor gap para caber tudo */
            }
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <div id="app">
        </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAppTP2vJuLofr9ueWsK3djbwSeEm5qb2c",
      authDomain: "nosso-momento-app.firebaseapp.com",
      projectId: "nosso-momento-app",
      storageBucket: "nosso-momento-app.firebasestorage.app",
      messagingSenderId: "503855316994",
      appId: "1:503855316994:web:7d5ee171b44c4f8b86a71b",
    };

    // Inicializa√ß√£o do Firebase, Firestore e Auth
    firebase.initializeApp(firebaseConfig);
    console.log("‚úÖ Firebase: Initialized com sucesso!");
    const db = firebase.firestore();
    const auth = firebase.auth(); // Inicializa o Firebase Auth
  </script>

    <script>
        // Main application state
        const state = {
            usuario: null, // Incluir√° UID, nome, email, telefone, sexo, foguinhos, lastCheckInDate, pareadoCom
            pareado: false,
            etapa: 'landing', // Nova etapa inicial
            carrinho: [],
            codigoUsuario: null,       // C√≥digo gerado para o usu√°rio (telefone)
            codigoDigitando: false,    // Flag para controle da UI (pareamento)
            parceiroCodigo: null,      // C√≥digo do parceiro digitado (telefone)
            parceiroTelefone: null,    // Telefone do parceiro pareado (sem 55)
            parceiroNome: null,        // Nome do parceiro pareado
            showPartnerInfo: false,    // Mostra informa√ß√µes do parceiro
            // Nova propriedade para armazenar solicita√ß√µes de pareamento recebidas
            pendingPairingRequest: null, // {id, senderUid, senderName, senderPhone}
            showCartSidebar: false     // Nova flag para controlar a visibilidade do carrinho
        };

        // DOM elements
        const appContainer = document.getElementById('app');

        // --- Utils para datas ---
        function isSameDay(d1, d2) {
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // --- Fun√ß√µes de Renderiza√ß√£o ---

        function renderLandingPage() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">
                        <div class="text-center mb-10">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">NOSSO MOMENTO</h2>
                            <p class="text-gray-300 tracking-wider">Apimente a rela√ß√£o.<br>Deixe tudo mais gostoso!</p>
                        </div>
                        <div class="space-y-5">
                            <button onclick="changeStep('signIn')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                                <span class="text-lg">ENTRAR</span>
                                <i class="fas fa-sign-in-alt"></i>
                            </button>
                            <button onclick="changeStep('register')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none;">
                                <span class="text-lg">CADASTRO</span>
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignIn() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">
                        <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </button>
                        <div class="text-center mb-10">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">ENTRAR</h2>
                            <p class="text-gray-300 tracking-wider">Acesse sua conta para continuar</p>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <input id="signInEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                            <div>
                                <input id="signInPassword" type="password" placeholder="Senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                        </div>
                        <button onclick="handleSignIn()" class="btn-red w-full mt-8 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                            <span class="text-lg">LOGIN</span>
                            <i class="fas fa-sign-in-alt"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderRegister() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">
                        <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </button>
                        <div class="text-center mb-10">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">CADASTRO</h2>
                            <p class="text-gray-300 tracking-wider">Crie sua conta para come√ßar a apimentar!</p>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <input id="registerNome" placeholder="Seu nome" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                            <div>
                                <input id="registerEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                            <div>
                                <input id="registerTelefone" type="tel" placeholder="Telefone (apenas n√∫meros, ex: 11999991111)" pattern="[0-9]{11}" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                            <div>
                                <input id="registerSenha" type="password" placeholder="Crie uma senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                            </div>
                            <div>
                                <select id="registerSexo" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300">
                                    <option value="" disabled selected>Selecione seu sexo</option>
                                    <option value="Masculino">Masculino</option>
                                    <option value="Feminino">Feminino</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="handleRegister()" class="btn-red w-full mt-8 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                            <span class="text-lg">CADASTRAR</span>
                            <i class="fas fa-arrow-right-long"></i>
                        </button>
                        <p class="text-center mt-6 text-gray-400 text-sm">
                            Ao continuar, voc√™ concorda com nossos <a href="#" class="text-pink-400 hover:underline">Termos</a> e <a href="#" class="text-pink-400 hover:underline">Pol√≠tica de Privacidade</a>
                        </p>
                    </div>
                </div>
            `;
        }

        async function sendPairingRequest() {
            const codigoDigitado = document.getElementById('codigoParceiro').value;

            if (!codigoDigitado || codigoDigitado.length !== 11 || !/^\d+$/.test(codigoDigitado)) {
                alert('Por favor, digite um n√∫mero de telefone completo com 11 d√≠gitos (com DDD).');
                return;
            }

            if (codigoDigitado === state.usuario.telefone) {
                alert('Voc√™ n√£o pode parear consigo mesmo!');
                return;
            }

            try {
                console.log('--- Iniciando sendPairingRequest ---');
                console.log('Usu√°rio Logado (state.usuario):', state.usuario);
                console.log('Telefone do Parceiro Digitado:', codigoDigitado);

                // 1. Buscar o UID e nome do parceiro pelo telefone
                const parceiroQuery = await db.collection('usuarios')
                    .where('telefone', '==', codigoDigitado)
                    .limit(1)
                    .get();

                if (parceiroQuery.empty) {
                    alert('Parceiro n√£o encontrado. Verifique o c√≥digo digitado.');
                    return;
                }

                const parceiroDoc = parceiroQuery.docs[0];
                const parceiroUid = parceiroDoc.id; // Este √© o UID do parceiro!
                const parceiroNome = parceiroDoc.data().nome;

                console.log('Parceiro Encontrado - UID:', parceiroUid, 'Nome:', parceiroNome);

                // 2. Verificar se j√° existe uma solicita√ß√£o pendente entre os dois
                const requestId = [state.usuario.uid, parceiroUid].sort().join('_'); 
                const existingRequestDoc = await db.collection('pairingRequests').doc(requestId).get();

                console.log('ID da Solicita√ß√£o (RequestId):', requestId);
                console.log('Solicita√ß√£o Existente:', existingRequestDoc.exists ? existingRequestDoc.data() : 'Nenhuma');

                if (existingRequestDoc.exists && existingRequestDoc.data().status === 'pending') {
                    alert('Voc√™ j√° enviou uma solicita√ß√£o de pareamento para este parceiro e ela est√° pendente.');
                    return;
                }
                
                // 3. Verificar se o parceiro j√° est√° pareado ou se ele j√° tem uma solicita√ß√£o de pareamento pendente para outra pessoa
                if (parceiroDoc.data().pareadoCom && typeof parceiroDoc.data().pareadoCom === 'string' && !parceiroDoc.data().pareadoCom.startsWith('pending_')) {
                    alert(`O parceiro(a) ${parceiroNome} j√° est√° pareado(a) com outra pessoa.`);
                    return;
                }

                // 4. Criar a solicita√ß√£o de pareamento no Firestore
                const requestData = {
                    senderUid: state.usuario.uid,
                    senderName: state.usuario.nome,
                    senderPhone: state.usuario.telefone,
                    receiverUid: parceiroUid,
                    receiverName: parceiroNome, 
                    receiverPhone: codigoDigitado, 
                    status: 'pending',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };
                console.log('Dados da solicita√ß√£o a serem enviados:', requestData);

                await db.collection('pairingRequests').doc(requestId).set(requestData);
                console.log('Solicita√ß√£o de pareamento criada no Firestore com sucesso!');

                // Opcional: Marcar no perfil do sender que uma solicita√ß√£o est√° pendente
                await db.collection('usuarios').doc(state.usuario.uid).update({
                    pareadoCom: `pending_${codigoDigitado}` // Marcador tempor√°rio
                });
                state.usuario.pareadoCom = `pending_${codigoDigitado}`; // Atualiza o estado local
                console.log('Status do usu√°rio atualizado para pendente.');

                alert(`Solicita√ß√£o de pareamento enviada para ${parceiroNome}! Aguardando aceita√ß√£o.`);
                state.etapa = 'parear'; 
                state.codigoDigitando = false; 
                renderApp();

            } catch (error) {
                console.error('Erro ao enviar solicita√ß√£o de pareamento:', error);
                // Captura e exibe a mensagem de erro espec√≠fica do Firebase
                if (error.code) {
                    alert(`Erro Firebase: ${error.code} - ${error.message}`);
                } else {
                    alert('Erro ao enviar solicita√ß√£o de pareamento. Tente novamente.');
                }
            }
            console.log('--- Fim sendPairingRequest ---');
        }

        async function acceptPairingRequest(requestId, senderUid, senderPhone) {
            console.log('--- Iniciando acceptPairingRequest ---');
            console.log('requestId:', requestId, 'senderUid:', senderUid, 'senderPhone:', senderPhone);
            console.log('state.usuario.uid (receiverUid):', state.usuario.uid, 'state.usuario.telefone:', state.usuario.telefone);

            try {
                // Verificar se o usu√°rio j√° n√£o est√° pareado antes de aceitar
                if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && !state.usuario.pareadoCom.startsWith('pending_')) {
                    alert('Voc√™ j√° est√° pareado com outra pessoa. Desfa√ßa o pareamento atual para aceitar esta solicita√ß√£o.');
                    return;
                }

                // 1. Atualizar status da solicita√ß√£o para 'accepted'
                console.log('Passo 1: Tentando atualizar status da solicita√ß√£o de pareamento...');
                await db.collection('pairingRequests').doc(requestId).update({
                    status: 'accepted'
                });
                console.log('Passo 1 Conclu√≠do: Status da solicita√ß√£o de pareamento atualizado para accepted.');

                // 2. Atualizar o usu√°rio logado (receiver)
                console.log('Passo 2: Tentando atualizar pareadoCom do receiver (usu√°rio logado)...');
                await db.collection('usuarios').doc(state.usuario.uid).update({ 
                    pareadoCom: senderPhone
                });
                console.log('Passo 2 Conclu√≠do: pareadoCom do receiver atualizado.');

                // 3. Atualizar o remetente da solicita√ß√£o
                console.log('Passo 3: Tentando atualizar pareadoCom do sender...');
                await db.collection('usuarios').doc(senderUid).update({ 
                    pareadoCom: state.usuario.telefone
                });
                console.log('Passo 3 Conclu√≠do: pareadoCom do sender atualizado.');

                // 4. Criar/atualizar a collection "pareamentos"
                const telefones = [state.usuario.telefone, senderPhone].sort();
                // Limpa qualquer caractere n√£o num√©rico para garantir um ID de documento v√°lido
                const cleanTelefones = telefones.map(tel => tel.replace(/\D/g, '')); 
                const idPareamento = cleanTelefones.join('_'); 
                
                let uid1 = state.usuario.uid; // UID do receptor
                let uid2 = senderUid; // UID do remetente

                const pareamentoData = {
                    pessoa1: telefones[0], // Telefone original
                    pessoa2: telefones[1], // Telefone original
                    pessoa1Uid: cleanTelefones[0] === state.usuario.telefone.replace(/\D/g, '') ? uid1 : uid2,
                    pessoa2Uid: cleanTelefones[1] === state.usuario.telefone.replace(/\D/g, '') ? uid1 : uid2,
                    dataPareamento: firebase.firestore.FieldValue.serverTimestamp()
                };
                console.log('Passo 4: Tentando criar/atualizar documento na cole√ß√£o pareamentos...');
                console.log('ID do documento pareamentos:', idPareamento);
                console.log('Dados do documento pareamentos:', pareamentoData);

                await db.collection('pareamentos').doc(idPareamento).set(pareamentoData, { merge: true }); 
                console.log('Passo 4 Conclu√≠do: Documento na cole√ß√£o pareamentos criado/atualizado com sucesso!');


                alert('Pareamento aceito com sucesso! Voc√™s est√£o agora pareados.');

                // Atualiza o estado local para refletir o pareamento
                state.pareado = true;
                state.parceiroCodigo = senderPhone;
                state.usuario.pareadoCom = senderPhone; 
                
                // Busca o nome do parceiro aceito
                const parceiroAcceptedQuery = await db.collection('usuarios')
                    .where('telefone', '==', senderPhone)
                    .limit(1)
                    .get();
                if (!parceiroAcceptedQuery.empty) {
                    const parceiroData = parceiroAcceptedQuery.docs[0].data();
                    state.parceiroNome = parceiroData.nome;
                    state.parceiroTelefone = '55' + parceiroData.telefone.replace(/\D/g, '');
                }

                state.pendingPairingRequest = null; // Limpa a solicita√ß√£o pendente
                state.etapa = 'main'; // Vai para a tela principal
                renderApp();

            } catch (error) {
                console.error('Erro ao aceitar pareamento:', error);
                // Captura e exibe a mensagem de erro espec√≠fica do Firebase
                if (error.code) {
                    alert(`Erro Firebase: ${error.code} - ${error.message}`);
                } else {
                    alert('Erro ao aceitar pareamento. Tente novamente.');
                }
            }
            console.log('--- Fim acceptPairingRequest ---');
        }

        async function rejectPairingRequest(requestId) {
            try {
                // Atualiza o status da solicita√ß√£o para 'rejected'
                await db.collection('pairingRequests').doc(requestId).update({
                    status: 'rejected'
                });
                
                // Opcional: Limpar o 'pareadoCom' do sender se ele estava marcado como 'pending_'
                const requestDoc = await db.collection('pairingRequests').doc(requestId).get();
                if (requestDoc.exists) {
                    const senderUid = requestDoc.data().senderUid;
                    // Busca o documento do sender para remover o marcador 'pending_'
                    const senderDoc = await db.collection('usuarios').doc(senderUid).get();
                    if (senderDoc.exists && senderDoc.data().pareadoCom && senderDoc.data().pareadoCom.startsWith('pending_')) {
                        await db.collection('usuarios').doc(senderUid).update({
                            pareadoCom: firebase.firestore.FieldValue.delete() // Remove o campo
                        });
                    }
                }

                alert('Solicita√ß√£o de pareamento rejeitada.');
                state.pendingPairingRequest = null; // Limpa a solicita√ß√£o pendente
                renderApp(); // Re-renderiza para limpar a notifica√ß√£o
            } catch (error) {
                console.error('Erro ao rejeitar pareamento:', error);
                alert('Erro ao rejeitar pareamento. Tente novamente.');
            }
        }

        // Fun√ß√£o para cancelar uma solicita√ß√£o de pareamento pendente (do lado do sender)
        async function cancelPendingPairingRequest() {
            if (confirm('Tem certeza que deseja cancelar esta solicita√ß√£o de pareamento?')) {
                try {
                    const senderUid = state.usuario.uid;
                    const receiverPhone = state.usuario.pareadoCom.replace('pending_', ''); // O telefone do receiver est√° no marcador
                    
                    // Buscar o UID do receiver
                    const receiverQuery = await db.collection('usuarios')
                        .where('telefone', '==', receiverPhone)
                        .limit(1)
                        .get();
                    if (receiverQuery.empty) {
                        alert('Erro: N√£o foi poss√≠vel encontrar o destinat√°rio da solicita√ß√£o para cancelar.');
                        return;
                    }
                    const receiverUid = receiverQuery.docs[0].id;

                    // O ID da solicita√ß√£o √© [senderUid, receiverUid].sort().join('_')
                    const requestId = [senderUid, receiverUid].sort().join('_');
                    
                    // 1. Deletar a solicita√ß√£o de pareamento
                    await db.collection('pairingRequests').doc(requestId).delete();
                    console.log('Solicita√ß√£o de pareamento deletada no Firestore.');

                    // 2. Remover o marcador 'pending_' do perfil do usu√°rio logado (sender)
                    await db.collection('usuarios').doc(senderUid).update({
                        pareadoCom: firebase.firestore.FieldValue.delete()
                    });
                    console.log('Marcador pending_ removido do perfil do sender.');

                    alert('Solicita√ß√£o de pareamento cancelada com sucesso.');
                    state.usuario.pareadoCom = null; // Atualiza o estado local
                    state.etapa = 'parear'; // Volta para a tela de pareamento inicial
                    renderApp();

                } catch (error) {
                    console.error('Erro ao cancelar solicita√ß√£o de pareamento:', error);
                    alert('Erro ao cancelar solicita√ß√£o. Tente novamente.');
                }
            }
        }


        function renderPareamento() {
            console.log('renderPareamento chamada. state.codigoDigitando:', state.codigoDigitando);
            const codigoUsuario = state.usuario.telefone.replace(/\D/g, '');
            
            let content = '';

            // Se houver uma solicita√ß√£o pendente para o usu√°rio logado (ele recebeu)
            if (state.pendingPairingRequest) {
                content = `
                    <div class="text-center mb-6">
                        <p class="mb-4">Voc√™ recebeu uma solicita√ß√£o de pareamento de:</p>
                        <div class="text-3xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block">
                            ${state.pendingPairingRequest.senderName} (${state.pendingPairingRequest.senderPhone})
                        </div>
                        <p class="mt-4 text-sm text-gray-300">Deseja aceitar ou rejeitar?</p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-6">
                        <button onclick="acceptPairingRequest('${state.pendingPairingRequest.id}', '${state.pendingPairingRequest.senderUid}', '${state.pendingPairingRequest.senderPhone}')" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded text-white font-semibold transition flex-1">
                            Aceitar <i class="fas fa-check-circle ml-2"></i>
                        </button>
                        <button onclick="rejectPairingRequest('${state.pendingPairingRequest.id}')" class="btn-red px-6 py-3 rounded text-white font-semibold transition flex-1">
                            Rejeitar <i class="fas fa-times-circle ml-2"></i>
                        </button>
                    </div>
                `;
            }
            // Se o usu√°rio j√° enviou uma solicita√ß√£o e est√° pendente (ele enviou)
            else if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_')) {
                const pendingPhone = state.usuario.pareadoCom.replace('pending_', '');
                content = `
                    <div class="text-center mb-6">
                        <p class="mb-4">Sua solicita√ß√£o de pareamento para ${pendingPhone} est√° pendente.</p>
                        <p class="text-sm text-gray-300">Aguardando aceita√ß√£o do seu parceiro(a)...</p>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-6">
                        <button onclick="changeStep('main')" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded text-white font-semibold transition">
                            Voltar para Principal
                        </button>
                        <button onclick="cancelPendingPairingRequest()" class="btn-red px-6 py-3 rounded text-white font-semibold transition">
                            Cancelar Solicita√ß√£o
                        </button>
                    </div>
                `;
            }
            // Estado padr√£o de pareamento (onde se digita/compartilha o c√≥digo)
            else {
                content = `
                    ${!state.codigoDigitando ? `
                        <div class="text-center mb-6">
                            <p class="mb-4">Seu c√≥digo de pareamento √©:</p>
                            <div class="text-4xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block">
                                ${codigoUsuario}
                            </div>
                            <p class="mt-4 text-sm text-gray-300">Compartilhe este c√≥digo com seu parceiro(a)</p>
                        </div>

                        <div class="mb-6 text-center">
                            <p>OU</p>
                            <p class="mt-2">Digite o c√≥digo do seu parceiro(a)</p>
                        </div>

                        <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-6">
                            <button onclick="state.codigoDigitando = true; renderApp();" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded text-white font-semibold transition">
                                Digitar C√≥digo
                            </button>
                            <button onclick="handleContinuarSemParear()" class="btn-red px-6 py-3 rounded text-white font-semibold transition">
                                Fazer Isso Depois
                            </button>
                        </div>
                    ` : `
                        <div class="mb-6">
                            <label class="block mb-2">Digite o c√≥digo do seu parceiro(a)</label>
                            <input id="codigoParceiro" type="text" class="w-full p-3 rounded text-white" placeholder="11999991111" maxlength="11" />
                        </div>
                        <div class="flex gap-4">
                            <button onclick="state.codigoDigitando = false; renderApp();" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded text-white font-semibold transition">
                                Voltar
                            </button>
                            <button onclick="sendPairingRequest()" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded text-white font-semibold transition flex-1">
                                Enviar Solicita√ß√£o
                            </button>
                        </div>
                    `}
                `;
            }

            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
                    <div class="card p-8 max-w-md w-full relative overflow-hidden">
                        <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-pink-500 opacity-10"></div>
                        <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-red-500 opacity-10"></div>
                        <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500">
                            <i class="fas fa-heart mr-2"></i> Pareamento
                        </h2>
                        ${content}
                    </div>
                </div>
            `;

            if (!state.codigoUsuario) {
                state.codigoUsuario = codigoUsuario;
            }
        }


        function renderMain() {
            console.log('renderMain chamada.');
            const categorias = [
                { nome: 'Quentes', emoji: 'ü•µ', color: 'bg-pink-900' },
                { nome: 'Lovezin', emoji: 'üíó', color: 'bg-red-900' },
                { nome: 'Sair da Rotina', emoji: 'üéâ', color: 'bg-purple-900' }
            ];

            const momentos = [
                { nome: 'Mamada Surpresa', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://imagenes.elpais.com/resizer/v2/2ARTSVZFAMOWYEREJ5CC72W4WA.jpg?auth=72d5ccea313b45142dc48ab5509bfa8751331fa78cbbf5cd412413fbc51ba60d&width=414', intensidade: 4 },
                { nome: 'Chupada Surpresa', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://uniqcondoms.com/wp-content/uploads/2024/07/condones-femeninos-sexo-oral.png', intensidade: 4 },
                { nome: 'Sexo Rom√¢ntico', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://us.123rf.com/450wm/4pmproduction/4pmproduction1706/4pmproduction170600453/81004283-lindo-casal-apaixonado-est%C3%A1-se-beijando-na-cama-prel%C3%BAdio-ao-sexo.jpg', intensidade: 4 },
                { nome: 'Sexo Agressivo', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://conteudo.imguol.com.br/c/entretenimento/2d/2016/07/22/voce-conhece-as-preferencias-sexuais-do-seu-par-1469219198036_v2_900x506.jpg', intensidade: 5 },
                { nome: 'C*zinho', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://t4.ftcdn.net/jpg/06/27/26/69/360_F_627266974_C25IGTTKd4Fp2nXhuCDv4dMTlDsxqiWj.jpg', intensidade: 5 },
                { nome: 'Tapa na Bunda', categoria: 'Lovezin', emoji: 'üíó', img: 'https://vemconversar.com.br/wp-content/uploads/2022/10/E-no-olhar-que-tudo-comeca.jpeg', intensidade: 2 },
                { nome: 'Beij√£o', categoria: 'Lovezin', emoji: 'üíó', img: 'https://www.otempo.com.br/content/dam/otempo/editorias/interessa/2024/3/interessa-beijo-de-lingua-beneficios-do-beijo-1713342721.jpeg', intensidade: 1 },
                { nome: '30 Beijinhos', categoria: 'Lovezin', emoji: 'üíó', img: 'https://img.freepik.com/fotos-premium/retrato-em-close-up-de-dois-apaixonados-apaixonados-se-beijando-em-casa_171337-79073.jpg', intensidade: 1 },
                { nome: 'Abra√ßo', categoria: 'Lovezin', emoji: 'üíó', img: 'https://us.123rf.com/450wm/peopleimages12/peopleimages122210/peopleimages12221028649/193181819-seu-amor-transformou-meu-mundo-um-jovem-casal-desfrutando-de-algum-tempo-de-qualidade-juntos-na.jpg?ver=6', intensidade: 1 },
                { nome: 'Massagem', categoria: 'Lovezin', emoji: 'üíó', img: 'https://individuale.med.br/wp-content/uploads/2019/08/massagem-anti-stress.png', intensidade: 3 },
                { nome: 'Viajar', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://p2.trrsf.com/image/fget/cf/774/0/images.terra.com/2023/12/07/1581006561-1rdpraia-do-aventureiro-1.jpg', intensidade: 2 },
                { nome: 'Noitada', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=600&auto=format', intensidade: 2 },
                { nome: 'Pagode', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://s2-g1.glbimg.com/PiT2YdXpDe8AU4vPY3nVopJ3ksM=/0x0:1014x681/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_59edd422c0c84a879bd37670ae4f538a/internal_photos/bs/2021/j/p/h577gHSrq8AvQbtKQeBg/roda-de-samba-2.jpg', intensidade: 2 },
                { nome: 'Almo√ßar Fora', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://media.timeout.com/images/106062540/750/422/image.jpg', intensidade: 1 },
                { nome: 'Jantar Fora', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://www.rbsdirect.com.br/filestore/0/7/2/9/4/9/4_1b48f02f18ac345/4949270_5de2a64f5b53f27.jpg?format=webp&w=1600&h=900&a=c', intensidade: 1 }
            ];

            // Dobra o custo dos foguinhos para momentos com intensidade maior que 1
            const momentosAjustados = momentos.map(m => ({
                ...m,
                intensidade: m.intensidade > 1 ? m.intensidade * 2 : m.intensidade
            }));


            // Determina se o bot√£o de check-in deve estar habilitado
            const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
            const canCheckIn = state.pareado && (!lastCheckIn || !isSameDay(lastCheckIn, new Date()));

            appContainer.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-900 to-black text-white">
                    <header class="sticky top-0 z-10 bg-gray-900/80 backdrop-blur-md border-b border-gray-800">
                        <div class="container mx-auto px-4 py-4 flex justify-between items-center header-content">
                            <div class="flex items-center gap-1">
                                <div class="relative">
                                    <div class="flex items-center justify-center w-9 h-9 rounded-full bg-gradient-to-br from-pink-500 to-red-600 shadow-lg">
                                        <i class="fas fa-heart-beat text-white text-xs"></i>
                                    </div>
                                    <div class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-400 animate-pulse"></div>
                                </div>
                                <h1 class="text-2xl font-bold">
                                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 font-extrabold tracking-tight" style="text-shadow: 0 2px 4px rgba(255,53,71,0.3);">NOSSO</span>
                                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-500 font-extrabold tracking-tight" style="text-shadow: 0 2px 4px rgba(255,53,71,0.3);">MOMENTO</span>
                                </h1>
                                <div class="w-2 h-2 rounded-full bg-pink-500 opacity-70 animate-pulse ml-1"></div>
                            </div>
                            <div class="flex items-center gap-4">
                                ${state.usuario && state.usuario.nome ? `
                                    <span class="text-gray-300 text-sm font-medium hidden sm:inline">Ol√°, ${state.usuario.nome}!</span>
                                ` : ''}

                                <button onclick="handleLogout()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2">
                                    <i class="fas fa-sign-out-alt text-xs"></i> <span class="hidden sm:inline">Sair</span>
                                </button>
                            </div>
                        </div>
                    </header>

                    <main class="container mx-auto px-4 py-8">
                        <div class="mb-12 text-center">
                            <h2 class="text-3xl md:text-4xl font-bold mb-4">Viva um Momento Hoje</h2>
                            <p class="text-gray-400 max-w-2xl mx-auto">
                                Escolha os momentos mais √≠ntimos que voc√™ deseja viver com o seu parceiro(a)
                            </p>
                        </div>

                        <div class="flex flex-wrap justify-center gap-3 mb-12">
                            <button onclick="filtrarMomentos(null)"
                                class="px-4 py-2 rounded-full transition-all ${!state.filtro ?
                                    'bg-pink1-600 text-white shadow-lg ring-2 ring-pink-500/50' :
                                    'bg-gray-800 text-gray-300 hover:bg-gray-700'}"
                                style="background: ${!state.filtro ? 'linear-gradient(45deg, #FF3547 0%, #FF6B7B 100%)' : ''}">
                                Todos
                            </button>
                            ${categorias.map(cat => `
                                <button onclick="filtrarMomentos('${cat.nome}')"
                                    class="px-4 py-2 rounded-full transition-all ${state.filtro === cat.nome ?
                                        'text-white shadow-lg' :
                                        'text-gray-300 hover:bg-gray-800/50'} ${cat.color}">
                                    ${cat.emoji} ${cat.nome}
                                </button>
                            `).join('')}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                            ${(state.filtro ? momentosAjustados.filter(m => m.categoria === state.filtro) : momentosAjustados).map(momento => `
                                <div class="product-card group">
                                    <div class="relative overflow-hidden">
                                        <img src="${momento.img}" alt="${momento.nome}" class="product-img group-hover:scale-105 transition-transform duration-300">
                                        <span class="product-badge">${momento.emoji} ${momento.categoria}</span>
                                    </div>
                                    <div class="p-4">
                                        <h3 class="font-medium">${momento.nome}</h3>
                                        <div class="flex justify-between items-center mt-4">
                                            <div class="flex flex-col">
                                                <div class="flex items-center gap-1 mb-1">
                                                    <span class="text-gray-500 text-sm">Intensidade:</span>
                                                    <span class="text-pink-400">${'üî•'.repeat(momento.intensidade)}</span>
                                                </div>
                                                <span class="text-yellow-400 text-sm flex items-center gap-1 font-semibold">
                                                    <i class="fas fa-fire"></i> ${momento.intensidade} Foguinhos
                                                </span>
                                            </div>
                                            <button onclick="adicionarAoCarrinho(${JSON.stringify(momento).replace(/"/g, '&quot;')})" 
                                                class="text-sm bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white px-4 py-2 rounded-lg transition">
                                                Resgatar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </main>

                    ${state.showCartSidebar ? `
                        <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
                        <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>
                                <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <div class="space-y-3">
                                ${state.carrinho.length === 0 ? `
                                    <p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>
                                ` : state.carrinho.map((item, index) => `
                                    <div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center">
                                        <div>
                                            <h4 class="font-medium">${item.emoji} ${item.nome}</h4>
                                            <small class="text-gray-400 text-sm">${item.categoria}</small>
                                            <div class="text-yellow-400 text-sm flex items-center gap-1 mt-1">
                                                <i class="fas fa-fire"></i> ${item.intensidade} Foguinhos
                                            </div>
                                        </div>
                                        <button onclick="removerDoCarrinho(${index})" class="text-red-400 hover:text-red-300">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-8 pt-6 border-t border-gray-800">
                                <button onclick="finalizarPedido()" 
                                    class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all
                                    ${state.carrinho.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${state.carrinho.length === 0 ? 'disabled' : ''}>
                                    Finalizar Pedido
                                </button>
                                <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">
                                    Continuar Resgatando
                                </button>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // --- Fun√ß√µes de Manipula√ß√£o de Eventos e Firebase Auth/Firestore ---

        async function handleSignIn() {
            const email = document.getElementById('signInEmail').value;
            const password = document.getElementById('signInPassword').value;

            if (!email || !password) {
                alert('Por favor, preencha o email e a senha.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                console.log('Usu√°rio logado com sucesso:', user);

                await loadUserDataAndNavigate(user.uid, user.email);

            } catch (error) {
                console.error('Erro no login:', error.code, error.message);
                let errorMessage = 'Erro ao fazer login. Verifique seu email e senha.';
                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'Nenhum usu√°rio encontrado com este email.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Senha incorreta.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Email inv√°lido.';
                } else if (error.code === 'auth/invalid-credential') { 
                    errorMessage = 'Credenciais inv√°lidas. Verifique seu email e senha.';
                }
                alert(errorMessage);
            }
        }

        async function handleRegister() {
            const nome = document.getElementById('registerNome').value;
            const email = document.getElementById('registerEmail').value;
            const telefone = document.getElementById('registerTelefone').value;
            const senha = document.getElementById('registerSenha').value;
            const sexo = document.getElementById('registerSexo').value;

            // Valida√ß√£o de Frontend
            if (!nome || !email || !telefone || !senha || !sexo) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            if (telefone.length !== 11 || !/^\d+$/.test(telefone)) {
                alert('O telefone deve conter exatamente 11 d√≠gitos num√©ricos (com DDD).');
                return;
            }
            if (senha.length < 6) { 
                 alert('A senha deve ter no m√≠nimo 6 caracteres.');
                 return;
            }


            try {
                // 1. Criar usu√°rio no Firebase Authentication
                const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
                const user = userCredential.user;
                console.log('Usu√°rio criado no Auth:', user);

                // 2. Salvar dados adicionais no Firestore usando o UID do Firebase Auth como ID do documento
                await db.collection('usuarios').doc(user.uid).set({
                    nome: nome,
                    telefone: telefone,
                    email: email,
                    sexo: sexo,
                    foguinhos: 1, // Inicializa com 1 foguinho ao cadastrar!
                    lastCheckInDate: null, 
                    pareadoCom: null, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                console.log("Dados do usu√°rio salvos com sucesso no Firestore!");

                // Atualiza o estado local com os dados do novo usu√°rio
                state.usuario = {
                    uid: user.uid,
                    email: user.email,
                    nome,
                    telefone,
                    sexo,
                    foguinhos: 1, 
                    lastCheckInDate: null,
                    pareadoCom: null
                };
                state.etapa = 'parear'; 
                renderApp();
                alert('Cadastro realizado com sucesso! Voc√™ ser√° redirecionado para o pareamento.');

            } catch (error) {
                console.error('Erro no cadastro:', error.code, error.message);
                let errorMessage = 'Erro ao cadastrar. Tente novamente.';
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'Este email j√° est√° em uso. Tente fazer login ou use outro email.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'O formato do email √© inv√°lido.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'A senha √© muito fraca (m√≠nimo de 6 caracteres).';
                }
                alert(errorMessage);
            }
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                console.log('Usu√°rio deslogado com sucesso!');
                // Resetar todo o estado da aplica√ß√£o para o padr√£o inicial
                state.usuario = null;
                state.pareado = false;
                state.etapa = 'landing';
                state.carrinho = [];
                state.codigoUsuario = null;
                state.codigoDigitando = false;
                state.parceiroCodigo = null;
                state.parceiroTelefone = null;
                state.parceiroNome = null;
                state.showPartnerInfo = false;
                state.pendingPairingRequest = null;
                state.showCartSidebar = false; 
                renderApp(); // Volta para a tela inicial
            } catch (error) {
                console.error('Erro ao deslogar:', error);
                alert('Erro ao fazer logout. Tente novamente.');
            }
        }

        async function handleDailyCheckIn() {
            if (!state.pareado) {
                alert('Voc√™ precisa estar pareado para realizar o Check-in di√°rio.');
                return;
            }

            if (!state.parceiroCodigo || !state.parceiroNome) {
                 alert('N√£o foi poss√≠vel encontrar as informa√ß√µes do seu parceiro. Tente novamente mais tarde.');
                 return;
            }

            // Verifica se o check-in j√° foi feito hoje
            const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
            if (lastCheckIn && isSameDay(lastCheckIn, new Date())) {
                alert('Voc√™ j√° Presenteou hoje. Volte amanh√£ para Presentear seu parceiro(a) novamente!');
                return;
            }

            try {
                // 1. Atualiza a data do √∫ltimo check-in para o usu√°rio logado
                await db.collection('usuarios').doc(state.usuario.uid).update({
                    lastCheckInDate: firebase.firestore.FieldValue.serverTimestamp()
                });

                // 2. Busca o parceiro (o telefone do parceiro est√° em state.parceiroCodigo)
                const parceiroQuery = await db.collection('usuarios')
                    .where('telefone', '==', state.parceiroCodigo)
                    .limit(1)
                    .get();

                if (parceiroQuery.empty) {
                    alert('Erro: Parceiro n√£o encontrado no banco de dados para conceder foguinhos.');
                    return;
                }

                const parceiroDocRef = parceiroQuery.docs[0].ref;
                const parceiroData = parceiroQuery.docs[0].data();
                const parceiroFoguinhosAtuais = parceiroData.foguinhos || 0;

                // 3. Incrementa os foguinhos do parceiro
                await parceiroDocRef.update({
                    foguinhos: parceiroFoguinhosAtuais + 1
                });

                alert(`Presenteou! Seu parceiro(a) ${state.parceiroNome} ganhou 1 foguinho üî•.`);

                // Atualiza o estado local do usu√°rio que fez o check-in
                state.usuario.lastCheckInDate = firebase.firestore.FieldValue.serverTimestamp();
                
                // Recarrega os dados do usu√°rio para garantir que o estado local esteja 100% sincronizado com o Firestore
                await loadUserDataAndNavigate(state.usuario.uid, state.usuario.email);


            } catch (error) {
                console.error('Erro ao realizar Presentear (Check-in) di√°rio:', error);
                alert('Erro ao Presentear. Tente novamente.');
            }
        }


        function handleContinuarSemParear() {
            state.etapa = 'main';
            renderApp();
        }

        function filtrarMomentos(categoria) {
            state.filtro = categoria;
            renderApp(); // Re-renderiza a etapa atual, que √© 'main'
        }

        async function adicionarAoCarrinho(momento) {
            if (state.carrinho.length >= 2) {
                const animElement = document.createElement('div');
                animElement.innerHTML = `
                    <div class="fixed bottom-10 right-10 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce">
                        Limite de 2 itens no carrinho!
                    </div>
                `;
                document.body.appendChild(animElement);
                setTimeout(() => animElement.remove(), 2000);
                return;
            }

            if (!state.pareado) {
                alert('Voc√™ precisa estar pareado com seu parceiro(a) para resgatar momentos.');
                return;
            }

            const custo = momento.intensidade;
            if ((state.usuario.foguinhos || 0) < custo) {
                alert(`Voc√™ precisa de ${custo} foguinhos para resgatar este momento. Voc√™ tem apenas ${state.usuario.foguinhos || 0} üî•.`);
                return;
            }

            try {
                // Diminui os foguinhos do usu√°rio no Firestore
                await db.collection('usuarios').doc(state.usuario.uid).update({
                    foguinhos: firebase.firestore.FieldValue.increment(-custo)
                });
                
                // Atualiza o estado local dos foguinhos
                state.usuario.foguinhos = (state.usuario.foguinhos || 0) - custo;

                state.carrinho = [...state.carrinho, momento];

                // Anima√ß√£o de adi√ß√£o
                const animElement = document.createElement('div');
                animElement.innerHTML = `
                    <div class="fixed bottom-10 right-10 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce">
                        ${momento.emoji} ${momento.nome} adicionado! (-${custo} üî•)
                    </div>
                `;
                document.body.appendChild(animElement);
                setTimeout(() => animElement.remove(), 2000);

                renderApp(); // Re-renderiza para atualizar foguinhos e carrinho

            } catch (error) {
                console.error('Erro ao adicionar momento ao carrinho e consumir foguinhos:', error);
                alert('Erro ao adicionar momento. Tente novamente.');
            }
        }

        async function removerDoCarrinho(index) {
            const momentoRemovido = state.carrinho[index];
            const custo = momentoRemovido.intensidade;

            try {
                // Devolve os foguinhos ao usu√°rio no Firestore
                await db.collection('usuarios').doc(state.usuario.uid).update({
                    foguinhos: firebase.firestore.FieldValue.increment(custo)
                });

                // Atualiza o estado local dos foguinhos
                state.usuario.foguinhos = (state.usuario.foguinhos || 0) + custo;

                state.carrinho = state.carrinho.filter((_, i) => i !== index);

                // Anima√ß√£o de remo√ß√£o
                const animElement = document.createElement('div');
                animElement.innerHTML = `
                    <div class="fixed bottom-10 right-10 bg-red-600 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce">
                        Item removido do carrinho (+${custo} üî•)
                    </div>
                `;
                document.body.appendChild(animElement);
                setTimeout(() => animElement.remove(), 2000);

                renderApp(); // Re-renderiza para atualizar foguinhos e carrinho
            } catch (error) {
                console.error('Erro ao remover do carrinho e devolver foguinhos:', error);
                alert('Erro ao remover item. Tente novamente.');
            }
        }

        async function desparearParceiro() {
            if (confirm('Tem certeza que deseja desfazer o pareamento? Isso ir√° resetar os foguinhos de ambos os usu√°rios para 0.')) { 
                try {
                    const usuarioUid = state.usuario.uid;
                    const usuarioTelefone = state.usuario.telefone;
                    const parceiroTelefone = state.parceiroCodigo; 

                    // 1. Encontrar o UID do parceiro pelo telefone
                    let parceiroUid = null;
                    const parceiroQuery = await db.collection('usuarios').where('telefone', '==', parceiroTelefone).limit(1).get();
                    if (!parceiroQuery.empty) {
                        parceiroUid = parceiroQuery.docs[0].id;
                    }

                    const batch = db.batch();

                    // 2. Remover pareamento do usu√°rio atual no Firestore e resetar foguinhos
                    const userDocRef = db.collection('usuarios').doc(usuarioUid);
                    batch.update(userDocRef, {
                        pareadoCom: firebase.firestore.FieldValue.delete(),
                        foguinhos: 0,
                        lastCheckInDate: null
                    });

                    // 3. Remover pareamento do parceiro (se o UID for encontrado) e resetar foguinhos
                    if (parceiroUid) {
                        const parceiroDocRef = db.collection('usuarios').doc(parceiroUid);
                        batch.update(parceiroDocRef, {
                            pareadoCom: firebase.firestore.FieldValue.delete(),
                            foguinhos: 0,
                            lastCheckInDate: null
                        });
                    }

                    // 4. Remover documento da cole√ß√£o 'pareamentos'
                    const telefonesOrdenados = [usuarioTelefone, parceiroTelefone].sort();
                    // Garante que o ID do documento √© limpo de caracteres n√£o num√©ricos tamb√©m
                    const idPareamento = telefonesOrdenados.map(tel => tel.replace(/\D/g, '')).join('_');
                    const pareamentoDocRef = db.collection('pareamentos').doc(idPareamento);
                    batch.delete(pareamentoDocRef);

                    // 5. Limpar quaisquer solicita√ß√µes de pareamento pendentes entre os dois
                    const request1Id = [usuarioUid, parceiroUid].sort().join('_');
                    const requestDocRef = db.collection('pairingRequests').doc(request1Id);
                    batch.delete(requestDocRef); // Tenta deletar se existir
                    
                    await batch.commit(); // Executa todas as opera√ß√µes em um lote

                    // Resetar estado local
                    state.pareado = false;
                    state.parceiroCodigo = null;
                    state.parceiroTelefone = null;
                    state.parceiroNome = null;
                    state.showPartnerInfo = false;
                    state.usuario.pareadoCom = null; 
                    state.usuario.foguinhos = 0; 
                    state.usuario.lastCheckInDate = null; 
                    state.carrinho = []; 
                    state.showCartSidebar = false; 
                    alert('Pareamento desfeito com sucesso! Foguinhos resetados para ambos.');
                    renderApp(); // Re-renderiza a tela principal

                } catch (error) {
                    console.error('Erro ao desfazer pareamento:', error);
                    alert('Erro ao desfazer pareamento. Tente novamente.');
                }
            }
        }

        function finalizarPedido() {
            if (!state.pareado) {
                alert('Voc√™ precisa estar pareado com seu parceiro(a) para finalizar o pedido.');
                return;
            }
            if (state.carrinho.length === 0) {
                alert('Seu carrinho est√° vazio. Adicione momentos para finalizar o pedido.');
                return;
            }

            const momentos = state.carrinho.map(m => `${m.emoji} ${m.nome} (Intensidade: ${m.intensidade}üî•)`).join(' | ');
            const mensagem = encodeURIComponent(`üíë Pedido de Momentos Especiais üíë\n\nOl√°, ${state.parceiroNome || 'parceiro(a)'}!\n\nEu escolhi os seguintes momentos para n√≥s:\n\n${momentos}\n\nEnviei esta mensagem pelo app Nosso Momento! üòä`);

            const telefoneWhatsapp = state.parceiroTelefone; // J√° est√° formatado com 55DDD
            const whatsappLink = `https://wa.me/${telefoneWhatsapp}?text=${mensagem}`;

            // Animation
            const animElement = document.createElement('div');
            animElement.innerHTML = `
                <div class="fixed bottom-10 right-10 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg animate-bounce">
                    <i class="fas fa-paper-plane"></i> Abrindo WhatsApp com seu parceiro...
                </div>
            `;
            document.body.appendChild(animElement);
            setTimeout(() => {
                animElement.remove();
                window.open(whatsappLink, '_blank');
            }, 1500);

            state.carrinho = []; // Limpa o carrinho ap√≥s finalizar o pedido
            state.showCartSidebar = false; // Fecha a sidebar do carrinho
            renderApp();
        }

        // Fun√ß√£o para alternar a visibilidade do carrinho
        function toggleCartSidebar() {
            console.log('toggleCartSidebar chamada. state.showCartSidebar ANTES:', state.showCartSidebar);
            state.showCartSidebar = !state.showCartSidebar;
            console.log('state.showCartSidebar DEPOIS:', state.showCartSidebar);
            renderApp(); // Re-renderiza para exibir/esconder a sidebar
        }

        // --- Fun√ß√£o Central de Renderiza√ß√£o (Gerencia as etapas) ---
        function renderApp() {
            console.log('renderApp chamada. Etapa atual:', state.etapa, 'state.codigoDigitando:', state.codigoDigitando, 'state.showCartSidebar:', state.showCartSidebar);
            switch (state.etapa) {
                case 'landing':
                    renderLandingPage();
                    break;
                case 'signIn':
                    renderSignIn();
                    break;
                case 'register':
                    renderRegister();
                    break;
                case 'parear':
                    renderPareamento();
                    break;
                case 'main':
                    renderMain();
                    break;
                default:
                    renderLandingPage(); // Fallback
            }
        }

        // Fun√ß√£o para mudar a etapa da aplica√ß√£o
        function changeStep(newStep) {
            console.log('changeStep chamada. Nova etapa:', newStep, 'state.codigoDigitando ANTES:', state.codigoDigitando);
            state.etapa = newStep;
            state.showCartSidebar = false; 
            // Ajuste para garantir que, se for para 'parear' e 'codigoDigitando' j√° estiver true, ele n√£o seja resetado.
            // A l√≥gica √©: se a nova etapa N√ÉO √â 'parear' OU (se a nova etapa √â 'parear' E 'codigoDigitando' √â false)
            if (newStep !== 'parear' || (newStep === 'parear' && state.codigoDigitando === false)) {
                 console.log('Resetando state.codigoDigitando para false.');
                 state.codigoDigitando = false;
            }
            console.log('state.codigoDigitando DEPOIS do ajuste em changeStep:', state.codigoDigitando);
            renderApp();
        }

        // Carrega dados do usu√°rio e do parceiro se pareado
        async function loadUserDataAndNavigate(uid, email) {
            console.log('loadUserDataAndNavigate chamada para UID:', uid);
            try {
                // Certifique-se que o UID n√£o √© nulo/indefinido antes de fazer a chamada ao Firestore
                if (!uid) {
                    console.error('UID do usu√°rio √© nulo ou indefinido em loadUserDataAndNavigate. Abortando carregamento.');
                    state.etapa = 'landing';
                    renderApp();
                    return;
                }

                const userDoc = await db.collection('usuarios').doc(uid).get();
                if (userDoc.exists) {
                    state.usuario = { uid: uid, email: email, ...userDoc.data() };
                    
                    // Verifica status de pareamento: n√£o √© nulo E n√£o come√ßa com 'pending_'
                    state.pareado = !!state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && !state.usuario.pareadoCom.startsWith('pending_');
                    
                    // Se pareado, preenche as informa√ß√µes do parceiro
                    if (state.pareado && state.usuario.pareadoCom) {
                        state.parceiroCodigo = state.usuario.pareadoCom; // Telefone do parceiro
                        console.log('Usu√°rio pareado com telefone:', state.parceiroCodigo);
                        const parceiroQuery = await db.collection('usuarios')
                            .where('telefone', '==', state.parceiroCodigo)
                            .limit(1)
                            .get();
                        if (!parceiroQuery.empty) {
                            const parceiroData = parceiroQuery.docs[0].data();
                            state.parceiroNome = parceiroData.nome;
                            state.parceiroTelefone = '55' + parceiroData.telefone.replace(/\D/g, ''); // Garante formato para WhatsApp
                            console.log('Dados do parceiro carregados:', state.parceiroNome, state.parceiroTelefone);
                        } else {
                            // Se pareado mas o parceiro n√£o √© encontrado, algo est√° errado, desfaz o pareamento localmente
                            console.warn('Parceiro pareado n√£o encontrado no Firestore. Desfazendo pareamento localmente.');
                            state.pareado = false;
                            state.parceiroCodigo = null;
                            state.parceiroTelefone = null;
                            state.parceiroNome = null;
                            state.usuario.pareadoCom = null; 
                        }
                    } else {
                        // Limpa info do parceiro se n√£o estiver pareado
                        console.log('Usu√°rio n√£o est√° pareado ou pareamento pendente.');
                        state.parceiroCodigo = null;
                        state.parceiroTelefone = null;
                        state.parceiroNome = null;
                    }

                    // Verifica se h√° solicita√ß√µes de pareamento pendentes para o usu√°rio logado (ele √© o receiver)
                    const pendingRequestQuery = await db.collection('pairingRequests')
                        .where('receiverUid', '==', uid)
                        .where('status', '==', 'pending')
                        .limit(1)
                        .get();
                    console.log('Verificando solicita√ß√µes pendentes para receiverUid:', uid, 'Resultado:', pendingRequestQuery.empty ? 'Nenhuma' : 'Encontrada');


                    if (!pendingRequestQuery.empty) {
                        const requestDoc = pendingRequestQuery.docs[0];
                        state.pendingPairingRequest = {
                            id: requestDoc.id,
                            ...requestDoc.data()
                        };
                        state.etapa = 'parear'; // Redireciona para a tela de pareamento para exibir a solicita√ß√£o
                        console.log('Solicita√ß√£o de pareamento RECEBIDA encontrada. Redirecionando para parear.');
                    } else if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_')) {
                         // Se o usu√°rio tem um pareamento pendente (ele enviou a solicita√ß√£o)
                        state.etapa = 'parear';
                        state.pendingPairingRequest = null; // Garante que n√£o h√° solicita√ß√£o recebida ativa no estado
                        console.log('Solicita√ß√£o de pareamento ENVIADA pendente. Redirecionando para parear.');
                    }
                    else {
                        state.pendingPairingRequest = null; // Limpa qualquer solicita√ß√£o pendente anterior
                        state.etapa = 'main'; // Se n√£o h√° solicita√ß√µes pendentes e n√£o est√° pendente, vai para main
                        console.log('Nenhuma solicita√ß√£o pendente. Redirecionando para main.');
                    }

                } else {
                    // Usu√°rio logado via Auth, mas sem dados no Firestore (deveria ir para cadastro completo)
                    console.log('Usu√°rio logado via Auth, mas sem documento de perfil no Firestore.');
                    state.usuario = { uid: uid, email: email };
                    state.etapa = 'register';
                    alert('Por favor, complete seu cadastro para acessar todas as funcionalidades.');
                }
            } catch (error) {
                console.error('Erro ao carregar dados do usu√°rio em loadUserDataAndNavigate:', error);
                alert('Erro ao carregar seu perfil. Por favor, tente novamente.');
                state.etapa = 'landing'; // Volta para o in√≠cio em caso de erro
            } finally {
                renderApp(); // Renderiza a tela apropriada
            }
        }


        // Initialize app
        function init() {
            // Monitora o estado de autentica√ß√£o do Firebase ao carregar a p√°gina
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('init: Usu√°rio j√° logado no Auth:', user.email, user.uid);
                    await loadUserDataAndNavigate(user.uid, user.email);
                } else {
                    console.log('init: Nenhum usu√°rio logado no Auth. Redirecionando para landing page.');
                    // Limpa todo o estado do usu√°rio ao deslogar
                    state.usuario = null;
                    state.pareado = false;
                    state.etapa = 'landing';
                    state.carrinho = [];
                    state.codigoUsuario = null;
                    state.codigoDigitando = false;
                    state.parceiroCodigo = null;
                    state.parceiroTelefone = null;
                    state.parceiroNome = null;
                    state.showPartnerInfo = false;
                    state.pendingPairingRequest = null;
                    state.showCartSidebar = false;
                    renderApp();
                }
            });
        }


        // Start the app
        window.onload = function() {
            // Make functions global for onclick events
            window.isSameDay = isSameDay; 
            window.changeStep = changeStep; 
            window.handleSignIn = handleSignIn; 
            window.handleRegister = handleRegister; 
            window.handleLogout = handleLogout; 
            window.sendPairingRequest = sendPairingRequest; 
            window.acceptPairingRequest = acceptPairingRequest; 
            window.rejectPairingRequest = rejectPairingRequest; 
            window.handleDailyCheckIn = handleDailyCheckIn; 

            window.handleContinuarSemParear = handleContinuarSemParear;
            window.filtrarMomentos = filtrarMomentos;
            window.adicionarAoCarrinho = adicionarAoCarrinho;
            window.removerDoCarrinho = removerDoCarrinho;
            window.finalizarPedido = finalizarPedido;
            window.desparearParceiro = desparearParceiro;
            window.toggleCartSidebar = toggleCartSidebar; 
            window.cancelPendingPairingRequest = cancelPendingPairingRequest; // Nova fun√ß√£o

            init(); // Inicia o aplicativo
        };
    </script>
<nav class="bottom-nav-bar" id="bottom-nav-bar">
    <button class="bottom-nav-item" onclick="changeStep('main');">
        <i class="fas fa-home"></i>
        <span>Home</span>
    </button>
    <button class="bottom-nav-item" onclick="changeStep('parear');">
        <i class="fas fa-heart"></i>
        <span>Parear</span>
    </button>
    <button class="bottom-nav-item relative" onclick="toggleCartSidebar();">
        <i class="fas fa-shopping-cart"></i>
        <span>Carrinho</span>
        ${state.carrinho.length > 0 ? `
            <span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">
                ${state.carrinho.length}
            </span>
        ` : ''}
    </button>
    <button class="bottom-nav-item" onclick="state.showPartnerInfo = !state.showPartnerInfo; renderApp()">
        <i class="fas fa-fire"></i>
        <span>${state.usuario && state.usuario.foguinhos !== undefined ? state.usuario.foguinhos : '-'}</span>
    </button>
</nav>

</body>
</html>