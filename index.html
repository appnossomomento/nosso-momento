<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Momento</title>
    <link rel="icon" href="/assets/icons/iconprincipal.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            min-height: 100%;
            margin: 0;
        }
        body {
            font-family: 'Poppins', sans-serif;
            /* Adicionado padding-bottom para que o conteúdo não fique por baixo do footer fixo */
            overflow-x: hidden; /* Esconder a barra de rolagem horizontal se algo escapar */
        }
        #app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        :root {
            --footer-h: 48px;
        }
        .screen {
            min-height: calc(100vh - var(--footer-h) - env(safe-area-inset-bottom));
            min-height: calc(100svh - var(--footer-h) - env(safe-area-inset-bottom));
            min-height: calc(100dvh - var(--footer-h) - env(safe-area-inset-bottom));
        }
        .screen-pad {
            padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom));
        }
        .memorias-pad {
            padding-bottom: calc(var(--footer-h) + 24px + env(safe-area-inset-bottom));
        }
        .memorias-screen {
            min-height: 100dvh;
            padding-bottom: calc(var(--footer-h) + env(safe-area-inset-bottom));
        }
        .auth-screen {
            height: 100vh;
            min-height: 100vh;
            min-height: 100svh;
            min-height: 100dvh;
            min-height: -webkit-fill-available;
            display: grid;
            place-items: center;
            padding: 40px 16px;
        }
        .landing-screen {
            height: 100vh;
            min-height: 100vh;
            min-height: 100svh;
            min-height: 100dvh;
            min-height: -webkit-fill-available;
            display: grid;
            place-items: center;
            padding: 40px 16px;
        }
        .font-handwritten {
            font-family: 'Pacifico', cursive;
        }
        .product-card {
            transition: all 0.3s ease-out;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 53, 71, 0.2);
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }
        .product-img {
            height: 160px;
            object-fit: cover;
            width: 100%;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 32px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .carrinho-item {
            animation: fadeIn 0.5s ease-out;
            border-radius: 12px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-red {
            background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px rgba(255, 53, 71, 0.3);
            padding: 14px 24px;
            border: none;
            outline: none;
            text-transform: uppercase;
            font-size: 14px;
        }
        .btn-red:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 53, 71, 0.4);
            background: linear-gradient(135deg, #FF4252 0%, #FF7B8A 100%);
        }
        .bg-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        /* Modern button styles */
        .btn-modern {
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        /* Input styles */
        input {
            border-radius: 12px !important;
            padding: 14px 16px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            background: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        input::placeholder {
            color: rgba(255,255,255,0.5) !important;
        }
        .no-number-spin::-webkit-outer-spin-button,
        .no-number-spin::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .no-number-spin {
            -moz-appearance: textfield;
        }
        /* Card styles */
        .card {
            border-radius: 20px;
            background: rgba(30,30,30,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        /* Footer custom style */
        /* REMOVED: .app-footer style is no longer needed for the fixed footer structure */
        /*
        .app-footer {
            background: linear-gradient(90deg, #FF3547 0%, #FF6B7C 100%);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.4);
            padding: 16px;
            font-size: 14px;
            text-align: center;
            margin-top: 40px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        */

        /* Novo estilo para a barra de navegação inferior (footer) */
        .bottom-nav-bar {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.08);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 48px; /* Altura da barra */
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100; /* Garante que fique acima de outros elementos como a sidebar */
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            padding-bottom: env(safe-area-inset-bottom); /* Para iPhones com notch inferior */
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
            transition: color 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 100%;
            flex-grow: 1;
            text-align: center; /* Centraliza o conteúdo dentro do item */
        }
        .bottom-nav-item.active {
            color: #FF6B7C; /* Cor de destaque no hover */
        }
        .bottom-nav-item i {
            font-size: 20px;
        }

        /* Estilo para as bolinhas de notificação */
        .badge-notification {
            position: absolute;
            top: 5px; /* Ajusta a posição vertical */
            right: 5px;  /* Ajusta a posição horizontal */
            min-width: 20px; /* Largura mínima para 1-2 dígitos */
            height: 20px;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none; /* Garante que o clique passe para o botão pai */
            transform: translate(50%, -50%); /* Ajusta para centralizar na quina do ícone */
        }
        /* Cores das bolinhas */
        .badge-yellow { background-color: #f59e0b; /* yellow-500 */ }
        .badge-gray { background-color: #6b7280; /* gray-500 */ }

        .achievement-celebration-wrapper {
            position: fixed;
            top: 90px;
            left: 50%;
            transform: translate(-50%, -20px);
            opacity: 0;
            z-index: 200;
            pointer-events: none;
            transition: opacity 0.35s ease, transform 0.35s ease;
        }
        .achievement-celebration-wrapper.entered {
            opacity: 1;
            transform: translate(-50%, 0);
        }
        .achievement-celebration-wrapper.exiting {
            opacity: 0;
            transform: translate(-50%, -16px);
        }
        .achievement-celebration {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #ffffff;
            border-radius: 16px;
            padding: 12px 18px;
            border: 1px solid rgba(255, 45, 63, 0.15);
            box-shadow: 0 14px 30px rgba(0, 0, 0, 0.2);
        }
        .achievement-celebration__icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 18px;
            box-shadow: 0 6px 16px rgba(255, 45, 63, 0.28);
            animation: trophyPop 0.65s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .achievement-celebration__eyebrow {
            font-size: 0.68rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: rgba(55, 65, 81, 0.7);
            margin-bottom: 2px;
        }
        .achievement-celebration__title {
            font-weight: 700;
            font-size: 0.98rem;
            color: #111827;
        }
        .achievement-celebration__message {
            margin-top: 2px;
            font-size: 0.82rem;
            color: rgba(55, 65, 81, 0.85);
        }
        @keyframes trophyPop {
            0% { transform: scale(0.5) rotate(-12deg); opacity: 0; }
            55% { transform: scale(1.12) rotate(4deg); opacity: 1; }
            100% { transform: scale(1) rotate(0); opacity: 1; }
        }

        #foguinhosBadge,
        #carrinhoBadge {
            /* 1. Posiciona o badge com base no centro do botão */
            top: 50%;
            left: 50%;
            
            /* 2. Anula o 'right: 5px' da regra original */
            right: auto; 
            
            /* 3. Anula a transformação original e aplica a nova:
                - Move 14px para a direita (para ficar ao lado do ícone)
                - Move 70% da sua própria altura para cima (para ficar ligeiramente 
                  acima do centro, como no seu 'green square')
            */
            transform: translate(14px, -70%);
        }


        /* Esconder a barra de rolagem horizontal se algo escapar */
        body {
            overflow-x: hidden;
        }

        /* Ajuste para telas pequenas - header */
        @media (max-width: 640px) { /* sm breakpoint no Tailwind */
            .header-content {
                display: flex;
                justify-content: space-between;
                width: 100%;
                align-items: center;
                padding-left: 1rem; /* px-4 */
                padding-right: 1rem; /* px-4 */
            }
            .header-content > div:nth-child(2) { /* Ações à direita */
                display: flex;
                gap: 0.5rem; /* Menor gap para caber tudo */
            }
            .header-content h1 { /* Ajuste para o título do app na header */
                font-size: 1.5rem; /* Reduz o tamanho da fonte em telas pequenas */
            }
        }

.accordion-content.open {
    overflow: visible;
}
.accordion-button.open i {
    transform: rotate(180deg);
}

        /* Adicione este novo estilo para o botão central */
.bottom-nav-item-center {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 52px;   /* Tamanho do círculo */
    height: 52px;  /* Tamanho do círculo */
    background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%);
    color: white;
    border-radius: 50%; /* Deixa o botão redondo */
    border: 3px solid #1f2937; /* Cor de fundo da sua barra de navegação, para dar um efeito de recorte */
    transform: translateY(-14px); /* Move o botão para cima */
    box-shadow: 0 -5px 15px rgba(255, 53, 71, 0.4);
    transition: all 0.3s ease;
}

.bottom-nav-item-center:hover {
    transform: translateY(-16px) scale(1.05); /* Efeito suave ao passar o mouse */
    box-shadow: 0 -8px 20px rgba(255, 53, 71, 0.5);
}

.bottom-nav-item-center i {
    font-size: 22px;
    color: #ffffff;
}

        .icon-gradient {
            background: linear-gradient(135deg, #ff2d3f 0%, #ff5565 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent;
        }

        .notification-shell {
            background: rgba(16, 12, 20, 0.92);
            border-radius: 32px;
            padding: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
        }
        .notification-card {
            background: rgba(12, 12, 16, 0.78);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px;
        }
        .notification-avatar {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            overflow: hidden;
            background: rgba(255,255,255,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .notification-time {
            font-size: 11px;
            color: rgba(255,255,255,0.55);
        }
        .notification-pill {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.35);
            border-radius: 999px;
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .notif-shell {
            background: #120b16;
            border-radius: 28px;
            padding: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.35);
        }
        .notif-card-white {
            background: #f8f8fb;
            border-radius: 20px;
            padding: 18px;
            color: #1f2937;
        }
        .notif-tab {
            flex: 1;
            min-width: 0;
            padding: 7px 10px;
            border-radius: 999px;
            font-weight: 600;
            text-align: center;
            background: rgba(255,255,255,0.08);
            color: rgba(255,255,255,0.75);
            border: 1px solid rgba(255,255,255,0.12);
            transition: all 0.2s ease;
            backdrop-filter: blur(6px);
            font-size: 0.82rem;
            line-height: 1.1;
            white-space: nowrap;
        }
        .notif-tab:hover {
            background: rgba(255,255,255,0.16);
        }
        .notif-tab.active {
            background: linear-gradient(135deg, #ff2d3f 0%, #ff5565 100%);
            color: #fff;
            border-color: rgba(255,255,255,0.2);
            box-shadow: 0 8px 18px rgba(255, 45, 63, 0.25);
        }
        .notif-list-shell {
            background: #ffffff;
            border-radius: 18px;
            padding: 14px;
        }
        .notif-item {
            background: #efeff1;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: #374151;
        }
        .notif-item img {
            width: 46px;
            height: 46px;
            border-radius: 12px;
            object-fit: cover;
        }


/*
// =========================================
// NOVO SISTEMA DE NOTIFICAÇÕES (TOASTS)
// =========================================
*/
.toast {
    display: flex;
    align-items: center;
    padding: 10px 16px; /* Padding vertical diminuído */
    font-size: 14px; /* Fonte menor */
    border-radius: 9999px; /* Formato de pílula */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    animation: slideInUp 0.5s ease-out forwards; /* Nova animação de entrada */
}

.toast.exiting {
    animation: slideOutDown 0.4s ease-in forwards;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes slideOutDown {
    from {
        opacity: 1;
        transform: translateY(0);
    }
    to {
        opacity: 0;
        transform: translateY(20px);
    }
}

.achievements-overlay {
    animation: fadeIn 0.25s ease-out forwards;
}

.achievements-popup-card {
    animation: slideInUp 0.35s ease-out forwards;
}

.achievements-popup-card .achievements-scroll-area {
    scrollbar-width: thin;
    scrollbar-color: rgba(251, 191, 36, 0.65) rgba(30, 30, 30, 0.6);
}

.achievements-popup-card .achievements-scroll-area::-webkit-scrollbar {
    width: 6px;
}

.achievements-popup-card .achievements-scroll-area::-webkit-scrollbar-track {
    background: rgba(30, 30, 30, 0.6);
    border-radius: 9999px;
}

.achievements-popup-card .achievements-scroll-area::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, rgba(251, 191, 36, 0.85), rgba(249, 115, 22, 0.85));
    border-radius: 9999px;
}

.achievements-popup-card .achievements-scroll-area::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, rgba(251, 191, 36, 1), rgba(249, 115, 22, 1));
}

.achievement-card {
    padding: 16px;
}

.achievement-card.sm-card-padding {
    padding: 20px;
}

@media (max-width: 640px) {
    .achievements-popup-card {
        margin-top: 48px;
        margin-bottom: 32px;
    }
}

/* Instagram CTA com borda em gradiente e fundo discreto */
.instagram-cta-outline {
    display: inline-block;
    padding: 2px; /* espaço para a borda em gradiente */
    border-radius: 12px;
    background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
}
.instagram-cta-inner {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: #000; /* Fundo discreto */
    color: #fff;
    padding: 8px 12px;
    border-radius: 10px;
    text-decoration: none;
    font-weight: 600;
}
.instagram-cta-inner i { font-size: 16px; }
.instagram-cta-inner:hover { transform: translateY(-2px); }

.pending-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 22px;
    height: 22px;
    border-radius: 9999px;
    background: #ffffff;
    color: #ff2d3f;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 16px rgba(255, 45, 63, 0.35);
    animation: pendingPulse 1.4s ease-in-out infinite;
}

@keyframes pendingPulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.1);
        opacity: 0.7;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

        </style>
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-556FY0WV3Q"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());

            gtag('config', 'G-556FY0WV3Q');
        </script>
        <script>
                    gtag('config', 'G-556FY0WV3Q');
                </script>

                <script>
                !function(f,b,e,v,n,t,s)
                {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
                n.callMethod.apply(n,arguments):n.queue.push(arguments)};
                if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
                n.queue=[];t=b.createElement(e);t.async=!0;
                t.src=v;s=b.getElementsByTagName(e)[0];
                s.parentNode.insertBefore(t,s)}(window, document,'script',
                'https://connect.facebook.net/en_US/fbevents.js');
                fbq('init', '1883535982201745');
                fbq('track', 'PageView');
                </script>
                <noscript><img height="1" width="1" style="display:none"
                src="https://www.facebook.com/tr?id=1883535982201745&ev=PageView&noscript=1"
                /></noscript>
            <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
            <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
</head>
<body class="bg-black text-white font-sans">
    <header id="mainHeader" class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur-md border-b border-gray-800" style="display: none;">
    <div class="container mx-auto px-4 py-3 flex items-center header-content">
        <div class="flex-1">
            <button onclick="changeStep('dashboard')" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2">
                <i class="fas fa-home text-xs"></i> <span class="hidden sm:inline">Início</span>
            </button>
        </div>

        <div class="flex-1 flex justify-center">
            <img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento Logo" class="h-[36px] w-auto">
        </div>

        <div class="flex-1 flex justify-end">
            <button onclick="handleLogout()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2">
                <i class="fas fa-sign-out-alt text-xs"></i> <span class="hidden sm:inline">Sair</span>
            </button>
        </div>
    </div>
</header>

    <div id="app">
        </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAppTP2vJuLofr9ueWsK3djbwSeEm5qb2c",
      authDomain: "nosso-momento-app.firebaseapp.com",
      projectId: "nosso-momento-app",
      storageBucket: "nosso-momento-app.firebasestorage.app",
      messagingSenderId: "503855316994",
      appId: "1:503855316994:web:7d5ee171b44c4f8b86a71b",
    };

    // Inicialização do Firebase, Firestore e Auth
    firebase.initializeApp(firebaseConfig);
    console.log("✅ Firebase: Initialized com sucesso!");
        const db = firebase.firestore();
        const auth = firebase.auth(); // Inicializa o Firebase Auth
    const storage = firebase.storage();
    const CREATE_INPUT_URL = 'https://southamerica-east1-nosso-momento-app.cloudfunctions.net/createInput';
    const SET_NOTIFICATION_TOKEN_URL = 'https://southamerica-east1-nosso-momento-app.cloudfunctions.net/setNotificationToken';
    const GET_MEMORIAS_URL = 'https://southamerica-east1-nosso-momento-app.cloudfunctions.net/getMemorias';
    const CREATE_MEMORIA_URL = 'https://southamerica-east1-nosso-momento-app.cloudfunctions.net/createMemoriaFromPhoto';
    const DELETE_MEMORIA_URL = 'https://southamerica-east1-nosso-momento-app.cloudfunctions.net/deleteMemoria';
    const REGISTRATION_ENABLED = false;
    const NOTIFICATION_HIGHLIGHT = 'rgba(251, 191, 36, 0.2)';
  </script>

    <script>
    /**
     * Adiciona um input ao Firestore garantindo que o token do Auth esteja
     * válido e tentando um refresh antes de falhar com permission errors.
     * Retorna o DocumentReference resolvido pela chamada .add().
     */
    async function safeAddInput(inputObj) {
        const payload = {...inputObj};

        if (!payload.fromUid) {
            if (auth.currentUser) {
                payload.fromUid = auth.currentUser.uid;
            } else if (state.usuario && state.usuario.uid) {
                payload.fromUid = state.usuario.uid;
            }
        }

        // Sempre delegamos ao backend, então removemos sentinelas do Firestore.
        delete payload.timestamp;
        payload.processed = false;

        const currentUser = auth.currentUser;
        if (!currentUser) {
            const authError = new Error('auth_required');
            authError.code = 'auth_required';
            throw authError;
        }

        if (payload.fromUid !== currentUser.uid) {
            payload.fromUid = currentUser.uid;
        }

        const callBackend = async (forceRefreshToken = false) => {
            const idToken = await currentUser.getIdToken(forceRefreshToken);
            const response = await fetch(CREATE_INPUT_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`,
                },
                body: JSON.stringify({input: payload}),
            });

            let body = null;
            try {
                body = await response.json();
            } catch (jsonErr) {
                console.warn('safeAddInput: corpo não pôde ser parseado', jsonErr);
            }

            if (response.ok) {
                return body && body.id ? {id: body.id} : body;
            }

            const errorCode = body && body.error ? body.error : `http_${response.status}`;
            const backendError = new Error(errorCode);
            backendError.code = errorCode;
            backendError.status = response.status;
            backendError.details = body;
            throw backendError;
        };

        try {
            return await callBackend(false);
        } catch (err) {
            if (err.status === 401 || err.status === 403) {
                // Força refresh do token e tenta novamente uma vez.
                return await callBackend(true);
            }
            throw err;
        }
    }

    async function safeFetchBackend(url, payload) {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            const authError = new Error('auth_required');
            authError.code = 'auth_required';
            throw authError;
        }

        const callBackend = async (forceRefreshToken = false) => {
            const idToken = await currentUser.getIdToken(forceRefreshToken);
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`,
                },
                body: JSON.stringify(payload || {}),
            });

            let body = null;
            try {
                body = await response.json();
            } catch (jsonErr) {
                console.warn('safeFetchBackend: corpo não pôde ser parseado', jsonErr);
            }

            if (response.ok) {
                return body;
            }

            const errorCode = body && body.error ? body.error : `http_${response.status}`;
            const backendError = new Error(errorCode);
            backendError.code = errorCode;
            backendError.status = response.status;
            backendError.details = body;
            throw backendError;
        };

        try {
            return await callBackend(false);
        } catch (err) {
            if (err.status === 401 || err.status === 403) {
                return await callBackend(true);
            }
            throw err;
        }
    }

    // Main application state
    // Deve permanecer sincronizado com a definição em functions/index.js (ACHIEVEMENTS)
    const ACHIEVEMENTS = [
    {
        id: 'first_check_in',
        trigger: 'daily_check_in',
        title: 'Primeiro Passo',
        description: 'Realize seu primeiro check-in diário com o seu par.',
        hint: 'Envie um foguinho pela tela de check-in.',
        icon: 'fa-person-rays',
        accentColor: '#fbbf24',
        reward: 1,
    },
    {
        id: 'checkin_streak_7',
        trigger: 'daily_check_in',
        title: 'Foguinho Semanal',
        description: 'Complete 7 check-ins em dias consecutivos.',
        hint: 'Faça check-ins diários sem perder nenhum dia.',
        icon: 'fa-calendar-week',
        accentColor: '#34d399',
        reward: 3,
    },
    {
        id: 'checkin_master',
        trigger: 'daily_check_in',
        title: 'Mestre do Check-in',
        description: 'Realize 30 check-ins no total.',
        hint: 'Consistência é tudo: presenteie seu par frequentemente.',
        icon: 'fa-stopwatch',
        accentColor: '#60a5fa',
        reward: 10,
    },
    {
        id: 'sou_fiel',
        trigger: 'daily_check_in',
        title: 'Sou Fiel',
        description: 'Realize 60 check-ins no total.',
        hint: 'Mantenha o ritmo diário para mostrar compromisso.',
        icon: 'fa-hand-holding-heart',
        accentColor: '#38bdf8',
        reward: 20,
    },
    {
        id: 'first_moment_redeem',
        trigger: 'moment_redeem',
        title: 'Primeiro Momento',
        description: 'Resgate o seu primeiro momento.',
        hint: 'Escolha um momento e resgate com foguinhos.',
        icon: 'fa-heart',
        accentColor: '#f472b6',
        reward: 1,
    },
    {
        id: 'moment_collector',
        trigger: 'moment_redeem',
        title: 'Colecionador de Momentos',
        description: 'Resgate 5 momentos diferentes.',
        hint: 'Continue resgatando momentos para o seu mural.',
        icon: 'fa-gift',
        accentColor: '#c084fc',
        reward: 3,
    },
    {
        id: 'foguinhos_investor',
        trigger: 'moment_redeem',
        title: 'Investidor de Foguinhos',
        description: 'Gaste 50 foguinhos em momentos.',
        hint: 'Momentos incríveis custam foguinhos – continue investindo!',
        icon: 'fa-coins',
        accentColor: '#facc15',
        reward: 10,
    },
    {
        id: 'caliente',
        trigger: 'moment_redeem',
        title: 'Caliente',
        description: 'Gaste 100 foguinhos em momentos.',
        hint: 'Quanto mais foguinhos, mais experiências intensas.',
        icon: 'fa-fire-flame-curved',
        accentColor: '#fb923c',
        reward: 20,
    },
];

const ACHIEVEMENTS_BY_ID = ACHIEVEMENTS.reduce((acc, achievement) => {
    acc[achievement.id] = achievement;
    return acc;
}, {});

        const state = {
    usuario: null,
    pareado: false,
    parceiroData: null,
    idPareamentoAmigavel: null,
    notificacoesTarefasNaoLidas: 0,
    notificacoesPresentesNaoLidas: 0,
    notificacoesConquistasNaoLidas: 0,
    notificacoes: [],
    notificacoesTab: 'checkin',
    pendingChallenge: null,
    showChallengePopup: false,
    challengeSecondsLeft: 0,
    challengeTimerId: null,
    challengeDeadline: null,
    activeWeeklyChallengeId: null,
    challengePopupOpenedAt: 0,
    parceirosAtivos: [],
    etapa: 'landing',
    carrinho: [],
    momentosMestres: [],
    fcmToken: null,
    codigoUsuario: null,
    codigoDigitando: false,
    parceiroCodigo: null,
    pareadoUid: null,
    parceiroTelefone: null,
    parceiroNome: null,
    parceiroApelido: null,
    pendingPartnerName: null,
    showPartnerInfo: false,
    pendingPairingRequest: null,
    showCartSidebar: false,
    showFoguinhosPopup: false,
    showAchievementsPopup: false,
    showPairingModal: false,
    showVipPopup: false,
    abaTarefasAtiva: 'recebidos',
    desafiosTab: 'emAberto',
    desafiosSemanais: [],
    weeklyChallengeFromServer: false,
    hasTriggeredFirstPairingChallenge: false,
    desafiosCountdownId: null,
    showRealizadoPhotoPrompt: false,
    pendingRealizadoAction: null,
    pendingRealizadoPhotoData: null,
    pendingRealizadoPhotoFile: null,
    memoriasView: 'welcome',
    memoriasItems: [],
    memoriasLimit: 9,
    memoriasHasMore: false,
    memoriasLoading: false,
    memoriasViewerIndex: null,
    showMemoriasViewer: false,
    memoriasMonth: null,
    memoriasPairId: null,
    memoriasPairMenuOpen: false,
    memoriasShareModalOpen: false,
    memoriasShareLastPhoto: null,
    memoriasSharePreviewOpen: false,
    memoriasSharePreviewUrl: null,
    memoriasSharePreviewFile: null,
    memoriasSharePreviewMode: null,
    memoriasShareGenerating: false,
    showLegalModal: false,
    legalModalType: null,
    showInstagramModal: false,
    showEditNameModal: false,
    editNameValue: '',
    showSystemModal: false,
    systemModalType: 'alert',
    systemModalMessage: '',
    systemModalConfirmText: 'OK',
    systemModalCancelText: 'Cancelar',
    systemModalOnConfirm: null,
    tarefasCache: [],
    conquistas: {},
    achievementStats: {},
};

let unsubscribeNotifications = null;
let unsubscribeUserDoc = null;
let unsubscribePendingPairing = null;
let unsubscribeWeeklyChallenge = null;
let hasProcessedInitialConquistas = false;
let activeAchievementCelebration = null;
let activeAchievementCelebrationTimeout = null;
let hasProcessedInitialNotifications = false;
let lastNotificationIds = new Set();
const recentAchievementCelebrations = new Map();

function triggerAchievementCelebration(notif) {
    const achievementId = notif?.achievementId || null;
    const celebrationInfo = showAchievementCelebration(achievementId);
        if (celebrationInfo) {
            return;
        }
}

    // DOM elements (Declarar como `let` para que possam ser atribuídas após o DOM carregar)
    let appContainer;
    let userNameDisplay;
    let foguinhosBadge;
    let carrinhoBadge;
    let bottomNavBar; // Referência para a barra de navegação inferior
    let mainHeader; // Referência para o cabeçalho principal

    window.ACHIEVEMENTS = ACHIEVEMENTS;
    window.ACHIEVEMENTS_BY_ID = ACHIEVEMENTS_BY_ID;


    // --- Utils para datas ---
    function isSameDay(d1, d2) {
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
    }

        function formatarDataCurta(timestamp) {
            if (!timestamp) {
                return '';
            }

            try {
                let data;
                if (timestamp.toDate) {
                    data = timestamp.toDate();
                } else if (typeof timestamp === 'object' && 'seconds' in timestamp) {
                    data = new Date(timestamp.seconds * 1000);
                } else if (timestamp instanceof Date) {
                    data = timestamp;
                } else {
                    return '';
                }

                return data.toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (err) {
                console.warn('Não foi possível formatar a data da conquista:', err);
                return '';
            }
        }

            function formatarDataNumerica(timestamp) {
                if (!timestamp) {
                    return '';
                }

                try {
                    let data;
                    if (timestamp.toDate) {
                        data = timestamp.toDate();
                    } else if (typeof timestamp === 'object' && 'seconds' in timestamp) {
                        data = new Date(timestamp.seconds * 1000);
                    } else if (timestamp instanceof Date) {
                        data = timestamp;
                    } else {
                        return '';
                    }

                    return data.toLocaleDateString('pt-BR');
                } catch (err) {
                    console.warn('Não foi possível formatar a data numérica:', err);
                    return '';
                }
            }

    function showToast(message, type = 'sucesso') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        let iconClass = 'fa-check-circle';
        let toastClass = 'toast-sucesso';

        if (type === 'erro') {
            iconClass = 'fa-times-circle';
            toastClass = 'toast-erro';
        } else if (type === 'aviso') {
            iconClass = 'fa-exclamation-triangle';
            toastClass = 'toast-aviso';
        }

        const toastElement = document.createElement('div');
        toastElement.className = `toast ${toastClass}`;
        toastElement.innerHTML = `
            <i class="fas ${iconClass} toast-icon"></i>
            <span>${message}</span>
        `;

        container.appendChild(toastElement);

        setTimeout(() => {
            toastElement.classList.add('exiting');
            setTimeout(() => {
                toastElement.remove();
            }, 500);
        }, 2000);
    }

    function showAchievementCelebration(achievementId) {
        const normalizedId = achievementId || null;
        const definition = (normalizedId && ACHIEVEMENTS_BY_ID[normalizedId]) || null;
        const accent = definition?.accentColor || '#fbbf24';
        const iconClass = definition?.icon || 'fa-trophy';
        const title = definition?.title || 'Nova conquista desbloqueada!';
        const description = definition?.description || '';

        if (normalizedId && recentAchievementCelebrations.has(normalizedId)) {
            console.log('Banner de conquista ignorado porque já foi exibido recentemente:', normalizedId);
            return null;
        }

        if (!document.body) {
            console.warn('showAchievementCelebration chamado antes do document.body estar pronto.');
            return { title, description };
        }

        if (activeAchievementCelebrationTimeout) {
            clearTimeout(activeAchievementCelebrationTimeout);
            activeAchievementCelebrationTimeout = null;
        }
        if (activeAchievementCelebration && activeAchievementCelebration.parentNode) {
            activeAchievementCelebration.parentNode.removeChild(activeAchievementCelebration);
        }

        const wrapper = document.createElement('div');
        wrapper.className = 'achievement-celebration-wrapper';

        const inner = document.createElement('div');
        inner.className = 'achievement-celebration';
        inner.style.borderColor = accent;

        const iconContainer = document.createElement('div');
        iconContainer.className = 'achievement-celebration__icon';
        iconContainer.style.background = accent;
        const icon = document.createElement('i');
        icon.className = `fas ${iconClass}`;
        iconContainer.appendChild(icon);

        const textContainer = document.createElement('div');
        const eyebrow = document.createElement('p');
        eyebrow.className = 'achievement-celebration__eyebrow';
        eyebrow.textContent = 'Nova conquista!';
        const titleEl = document.createElement('p');
        titleEl.className = 'achievement-celebration__title';
        titleEl.textContent = title;
        textContainer.appendChild(eyebrow);
        textContainer.appendChild(titleEl);
        if (description) {
            const messageEl = document.createElement('p');
            messageEl.className = 'achievement-celebration__message';
            messageEl.textContent = description;
            textContainer.appendChild(messageEl);
        }

        inner.appendChild(iconContainer);
        inner.appendChild(textContainer);
        wrapper.appendChild(inner);
    document.body.appendChild(wrapper);
    console.log('Exibindo banner de conquista:', normalizedId || 'desconhecida', title);

        requestAnimationFrame(() => {
            wrapper.classList.add('entered');
        });

        activeAchievementCelebrationTimeout = setTimeout(() => {
            wrapper.classList.remove('entered');
            wrapper.classList.add('exiting');
            setTimeout(() => {
                if (wrapper.parentNode) {
                    wrapper.parentNode.removeChild(wrapper);
                }
            }, 320);
            activeAchievementCelebration = null;
            activeAchievementCelebrationTimeout = null;
        }, 4200);

        activeAchievementCelebration = wrapper;
        if (normalizedId) {
            const previousTimer = recentAchievementCelebrations.get(normalizedId);
            if (previousTimer) {
                clearTimeout(previousTimer);
            }
            const cleanupTimer = setTimeout(() => {
                recentAchievementCelebrations.delete(normalizedId);
            }, 6000);
            recentAchievementCelebrations.set(normalizedId, cleanupTimer);
        }
        return { title, description };
    }

// ==========================================================
    // NOVA FUNÇÃO DE RASTREAMENTO (ANALYTICS)
    // ==========================================================
    /**
     * Envia um evento customizado para o Google Analytics (GA4).
     * @param {string} eventName O nome do evento (ex: 'sign_up', 'purchase_moment').
     * @param {Object} [eventParams={}] Parâmetros adicionais (ex: { value: 10, currency: 'BRL' }).
     */
    function trackGAEvent(eventName, eventParams = {}) {
        // Verifica se a função gtag() está disponível
        if (typeof gtag === 'function') {
            console.log(`GA Event: ${eventName}`, eventParams);
            gtag('event', eventName, eventParams);
        } else {
            console.warn(`gtag() não definido. Evento "${eventName}" não rastreado.`);
        }
    }

    function escapeHtmlAttr(texto) {
        if (typeof texto !== 'string') {
            return '';
        }
        return texto
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function escapeJsString(texto) {
        if (typeof texto !== 'string') {
            return '';
        }
        return texto.replace(/\\/g, '\\\\').replace(/'/g, "\\'");
    }

    // ==========================================================
    // COLE ESTA NOVA FUNÇÃO AQUI (LOGO ABAIXO DA ANTERIOR)
    // ==========================================================
    /**
     * Envia um evento customizado para o Meta Pixel.
     * @param {string} eventName O nome do evento (ex: 'CompleteRegistration', 'Purchase').
     * @param {Object} [eventParams={}] Parâmetros adicionais (ex: { value: 10, currency: 'BRL' }).
     */
    function trackMetaEvent(eventName, eventParams = {}) {
        // Verifica se a função fbq() está disponível
        if (typeof fbq === 'function') {
            console.log(`Meta Event: ${eventName}`, eventParams);
            fbq('track', eventName, eventParams);
        } else {
            console.warn(`fbq() não definido. Evento "${eventName}" não rastreado.`);
        }
    }

    async function syncNotificationToken(payload) {
        const currentUser = auth.currentUser;
        if (!currentUser) {
            const authError = new Error('auth_required');
            authError.code = 'auth_required';
            throw authError;
        }

        const callBackend = async (forceRefreshToken = false) => {
            const idToken = await currentUser.getIdToken(forceRefreshToken);
            const response = await fetch(SET_NOTIFICATION_TOKEN_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${idToken}`,
                },
                body: JSON.stringify(payload),
            });

            let body = null;
            try {
                body = await response.json();
            } catch (jsonErr) {
                console.warn('syncNotificationToken: corpo não pôde ser parseado', jsonErr);
            }

            if (response.ok) {
                return body || {};
            }

            const errorCode = body && body.error ? body.error : `http_${response.status}`;
            const backendError = new Error(errorCode);
            backendError.code = errorCode;
            backendError.status = response.status;
            backendError.details = body;
            throw backendError;
        };

        try {
            return await callBackend(false);
        } catch (err) {
            if (err.status === 401 || err.status === 403) {
                return await callBackend(true);
            }
            throw err;
        }
    }
    // --- Funções de Renderização das Etapas ---
    // Apenas o conteúdo DENTRO da #app será renderizado por estas funções

    function renderLandingPage() {
        const registerButton = REGISTRATION_ENABLED ? `
                        <button onclick="changeStep('register')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none;">
                            <span class="text-lg">CADASTRO</span>
                            <i class="fas fa-user-plus"></i>
                        </button>
        ` : '';

        appContainer.innerHTML = `
            <div class="landing-screen flex flex-col justify-center items-center px-4" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                
                <div class="card p-6 sm:p-8 w-full text-white overflow-hidden" style="border-radius: 24px; width: 92vw; max-width: 520px;">
                    
                    <div class="text-center mb-6">
                        <img src="/assets/icons/logo-topdown-white-txt.png" alt="Nosso Momento" class="w-2/3 max-w-[200px] mx-auto mb-6">
                        <p class="text-gray-300 tracking-wider">Apimente a relação.<br>Deixe tudo mais gostoso!</p>
                    </div>
                    
                    <div class="space-y-4">
                        <button onclick="changeStep('signIn')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                            <span class="text-lg">ENTRAR</span>
                            <i class="fas fa-sign-in-alt"></i>
                        </button>
                        ${registerButton}
                    </div>
                </div>
            </div>
        `;
    }

    function renderDashboard() {
        const pendingCount = (state.notificacoesTarefasNaoLidas || 0) +
            (state.notificacoesPresentesNaoLidas || 0) +
            (state.notificacoesConquistasNaoLidas || 0);
        const hasPending = pendingCount > 0;
        const userName = state.usuario && state.usuario.nome ? state.usuario.nome : 'Amor';
        const fotoPerfil = (state.usuario && state.usuario.fotoUrl) || '/assets/icons/iconprincipal.png';
        const notificationStyle = hasPending ? `background: ${NOTIFICATION_HIGHLIGHT};` : '';
        const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
        const hasPendingChallenge = desafiosSemanais.some((desafio) => !(desafio.concluido || desafio.completed || desafio.status === 'finalizado')) || !!state.pendingChallenge;

        appContainer.innerHTML = `
            <div class="screen screen-pad bg-black text-white">
                <section class="px-0 pt-11 pb-14" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                    <div class="flex flex-col items-center text-center -mt-3">
                        <div class="w-20 h-20 rounded-full bg-white/20 flex items-center justify-center mb-3 -mt-1">
                            <img src="${fotoPerfil}" class="w-16 h-16 rounded-full object-cover" alt="Foto de perfil">
                        </div>
                        <div class="-mt-2">
                            <h2 class="text-xl font-semibold leading-tight">Olá, ${userName}</h2>
                            <p class="text-sm text-white/80 leading-snug">Apimente suas relações</p>
                        </div>
                    </div>
                </section>

                <section class="px-5 pb-8 -mt-10">
                    <div class="rounded-[32px] bg-[#0f0b14] p-6 shadow-lg">
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="changeStep('notificacoes')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20" style="${notificationStyle}">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-bell text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Notificações</h3>
                                <p class="text-xs text-white/70">${hasPending ? `${pendingCount} pendentes` : 'Tudo em dia'}</p>
                            </button>

                            <button onclick="changeStep('gerenciarCatalogo')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-store text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Meu Catálogo</h3>
                                <p class="text-xs text-white/70">Personalize-os</p>
                            </button>

                            <button onclick="changeStep('foguinhosPopup')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-fire text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Foguinhos</h3>
                                <p class="text-xs text-white/70">Saldo e histórico</p>
                            </button>

                            <button onclick="changeStep('memorias')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-book-open text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Memórias</h3>
                                <p class="text-xs text-white/70">Relembre</p>
                            </button>

                            <button onclick="changeStep('momentos')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-heart text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Momentos</h3>
                                <p class="text-xs text-white/70">Veja agora</p>
                            </button>

                            <button onclick="changeStep('achievementsPopup')" class="relative rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                ${hasPendingChallenge ? `<span class="pending-indicator"><i class="fas fa-clock text-[10px]"></i></span>` : ''}
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-trophy text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Desafios</h3>
                                <p class="text-xs text-white/70">Seu progresso</p>
                            </button>

                            <button onclick="changeStep('meuPerfil')" class="rounded-2xl bg-white/10 p-5 text-left transition hover:bg-white/20">
                                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center mb-3">
                                    <i class="fas fa-user text-xl icon-gradient"></i>
                                </div>
                                <h3 class="text-sm font-semibold">Meu Perfil</h3>
                                <p class="text-xs text-white/70">Ver e Editar</p>
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        `;
    }

    function renderSignIn() {
        appContainer.innerHTML = `
            <div class="auth-screen" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                <div class="card relative p-8 w-full text-white overflow-hidden" style="border-radius: 24px; width: 92vw; max-width: 560px;">
                    <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition" aria-label="Voltar">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <div class="text-center mb-6">
                        <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">ENTRAR</h2>
                        <p class="text-gray-300 tracking-wider">Acesse sua conta para continuar</p>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <input id="signInEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                        <div>
                            <input id="signInPassword" type="password" placeholder="Senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                    </div>
                    <button onclick="handleSignIn()" class="btn-red w-full mt-6 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                        <span class="text-lg">LOGIN</span>
                        <i class="fas fa-sign-in-alt"></i>
                    </button>
                </div>
            </div>
        `;
    }

    function renderRegister() {
        appContainer.innerHTML = `
            <div class="auth-screen" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                <div class="card relative p-10 w-full max-w-lg text-white overflow-hidden" style="border-radius: 24px;">
                    <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">
                        <i class="fas fa-arrow-left mr-2"></i> Voltar
                    </button>
                    <div class="text-center mb-10">
                        <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">CADASTRO</h2>
                        <p class="text-gray-300 tracking-wider">Crie sua conta para começar a apimentar!</p>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <input id="registerNome" placeholder="Seu nome" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                        <div>
                            <input id="registerEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                        <div>
                            <input id="registerTelefone" type="tel" placeholder="Telefone (apenas números, ex: 11999991111)" pattern="[0-9]{11}" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                        <div>
                            <input id="registerSenha" type="password" placeholder="Crie uma senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />
                        </div>
                        <div>
                            <select id="registerSexo" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300">
                                <option value="" disabled selected>Selecione seu sexo</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="handleRegister()" class="btn-red w-full mt-8 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                        <span class="text-lg">CADASTRAR</span>
                        <i class="fas fa-arrow-right-long"></i>
                    </button>
                    <p class="text-center mt-6 text-gray-400 text-sm">
                        Ao continuar, você concorda com nossos <button type="button" class="text-pink-400 hover:underline" onclick="openLegalModal('terms')">Termos</button> e <button type="button" class="text-pink-400 hover:underline" onclick="openLegalModal('privacy')">Política de Privacidade</button>
                    </p>
                </div>
            </div>
        `;
    }

function ensureFirstPairingChallenge() {
    if (!state.pareado || !state.usuario?.pareadoUid || state.hasTriggeredFirstPairingChallenge) {
        return;
    }
    if (state.weeklyChallengeFromServer) {
        state.hasTriggeredFirstPairingChallenge = true;
        return;
    }

    const uid = state.usuario?.uid || null;
    const firstPairKey = uid ? `firstPairingChallengeTriggered:${uid}` : null;
    const alreadyTriggered = !!(firstPairKey && localStorage.getItem(firstPairKey) === 'true');

    const localChallenge = loadLocalWeeklyChallenge();
    if (localChallenge) {
        state.desafiosSemanais = [localChallenge];
        const concluido = !!(localChallenge.concluido || localChallenge.completed || localChallenge.status === 'finalizado' || localChallenge.status === 'finalizado_sem_recompensa');
        state.pendingChallenge = concluido ? null : {
            id: localChallenge.id,
            titulo: localChallenge.titulo || 'Alma Gêmea',
            pergunta: localChallenge.pergunta || 'Pergunta indisponível.',
        };
        state.hasTriggeredFirstPairingChallenge = true;
        return;
    }

    if (alreadyTriggered) {
        state.hasTriggeredFirstPairingChallenge = true;
        return;
    }

    const docId = getWeeklyChallengeDocId();
    if (!docId) {
        return;
    }
    const desafioId = docId;

    const perguntaSelecionada = getStableChallengeQuestion(desafioId);

    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    const existingChallenge = desafiosSemanais.find((desafio) => desafio.id === desafioId || desafio.id?.startsWith('alma_gemea_'));
    const alreadyExists = !!existingChallenge;
    if (!alreadyExists) {
        const desafioBase = {
            id: desafioId,
            challengeId: 'alma_gemea',
            titulo: 'Alma Gêmea',
            descricao: 'Respondam a mesma pergunta para ganhar 1 foguinho.',
            pergunta: perguntaSelecionada,
            icon: 'fa-heart',
            reward: 1,
            prazoTexto: '6d 23h 59m',
            status: 'pendente',
            criadoEm: new Date(),
        };
        state.desafiosSemanais = [
            ...desafiosSemanais,
            desafioBase,
        ];
        saveLocalWeeklyChallenge(desafioBase);
        if (firstPairKey) {
            localStorage.setItem(firstPairKey, 'true');
        }
        seedWeeklyChallengeDocIfMissing(docId);
    }

    const perguntaFinal = existingChallenge?.pergunta || perguntaSelecionada;
    state.pendingChallenge = {
        id: desafioId,
        titulo: 'Alma Gêmea',
        pergunta: perguntaFinal,
    };

    state.hasTriggeredFirstPairingChallenge = true;
    setupWeeklyChallengeListener();
}

function getStableChallengeQuestion(seed) {
    const perguntasAlmaGemea = [
        'Qual é a música que representa vocês dois?',
        'Qual o local que nós demos o primeiro beijo?',
        'Qual foi o primeiro filme que vimos juntos?',
        'Qual é a nossa comida favorita para pedir juntos?',
    ];
    const seedStr = seed || 'alma_gemea';
    let hash = 0;
    for (let i = 0; i < seedStr.length; i++) {
        hash = (hash << 5) - hash + seedStr.charCodeAt(i);
        hash |= 0;
    }
    const index = Math.abs(hash) % perguntasAlmaGemea.length;
    return perguntasAlmaGemea[index];
}

const PRAZO_DESAFIO_SEMANAL_MS = ((6 * 24 + 23) * 60 + 59) * 60 * 1000;

function getDateFromValue(value) {
    if (!value) return null;
    if (value instanceof Date) return value;
    if (typeof value.toDate === 'function') return value.toDate();
    if (typeof value === 'number') return new Date(value);
    if (typeof value === 'string') {
        const asNumber = Number(value);
        if (Number.isFinite(asNumber)) return new Date(asNumber);
        const parsed = Date.parse(value);
        if (Number.isFinite(parsed)) return new Date(parsed);
    }
    return null;
}

function getPrazoRestanteTexto(desafio) {
    const createdValue = desafio?.criadoEm || desafio?.createdAt || desafio?.createdEm || null;
    const createdAt = getDateFromValue(createdValue) || new Date();
    const now = Date.now();
    const deadline = createdAt.getTime() + PRAZO_DESAFIO_SEMANAL_MS;
    const remaining = Math.max(0, deadline - now);

    const days = Math.ceil(remaining / (24 * 60 * 60 * 1000));

    return `${days}d`;
}

function getChallengeDeadlineMs(desafio) {
    const startValue = desafio?.startedAt || desafio?.prazoInicio || desafio?.startedEm || null;
    const startedAt = getDateFromValue(startValue);
    if (!startedAt) return null;
    return startedAt.getTime() + 60000;
}

function getLocalChallengeStartMs(challengeId) {
    const keys = [];
    if (challengeId) {
        keys.push(`weeklyChallengeStart:${challengeId}`);
    }
    const docId = getWeeklyChallengeDocId();
    if (docId) {
        keys.push(`weeklyChallengeStart:${docId}`);
    }
    keys.push('weeklyChallengeStart:alma_gemea_fallback');

    for (const key of keys) {
        const raw = localStorage.getItem(key);
        const ms = raw ? Number(raw) : NaN;
        if (Number.isFinite(ms)) {
            return ms;
        }
    }
    return null;
}

function setLocalChallengeStartMs(challengeId, ms) {
    if (!Number.isFinite(ms)) return;
    const keys = [];
    if (challengeId) {
        keys.push(`weeklyChallengeStart:${challengeId}`);
    }
    const docId = getWeeklyChallengeDocId();
    if (docId) {
        keys.push(`weeklyChallengeStart:${docId}`);
    }
    keys.push('weeklyChallengeStart:alma_gemea_fallback');

    keys.forEach((key) => {
        localStorage.setItem(key, String(ms));
    });
}

function updateDesafioPrazoLabels() {
    if (state.etapa !== 'achievementsPopup') return;
    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    desafiosSemanais.forEach((desafio) => {
        const concluido = !!(desafio.concluido || desafio.completed || desafio.status === 'finalizado');
        if (concluido) return;
        const prazoEl = document.getElementById(`desafioPrazo-${desafio.id}`);
        if (prazoEl) {
            prazoEl.textContent = `Prazo: ${getPrazoRestanteTexto(desafio)}`;
        }
    });
}

function startDesafiosCountdown() {
    if (state.desafiosCountdownId) {
        clearInterval(state.desafiosCountdownId);
        state.desafiosCountdownId = null;
    }
    if (state.etapa !== 'achievementsPopup') {
        return;
    }
    updateDesafioPrazoLabels();
    state.desafiosCountdownId = setInterval(() => {
        if (state.etapa !== 'achievementsPopup') {
            clearInterval(state.desafiosCountdownId);
            state.desafiosCountdownId = null;
            return;
        }
        updateDesafioPrazoLabels();
    }, 60000);
}

function getWeeklyChallengeDocId() {
    const uid = state.usuario?.uid || null;
    const partnerUid = state.usuario?.pareadoUid || null;
    const base = uid && partnerUid ? [uid, partnerUid].sort().join('_') : null;
    return base ? `alma_gemea_${base}` : null;
}

function getWeeklyChallengeStorageKey() {
    const docId = getWeeklyChallengeDocId();
    return docId ? `weeklyChallenge:${docId}` : null;
}

function clearLocalWeeklyChallenge(challengeId) {
    const key = getWeeklyChallengeStorageKey();
    if (key) {
        localStorage.removeItem(key);
    }
    const keys = [];
    if (challengeId) {
        keys.push(`weeklyChallengeStart:${challengeId}`);
    }
    const docId = getWeeklyChallengeDocId();
    if (docId) {
        keys.push(`weeklyChallengeStart:${docId}`);
    }
    keys.push('weeklyChallengeStart:alma_gemea_fallback');
    keys.forEach((k) => localStorage.removeItem(k));
}

function saveLocalWeeklyChallenge(data) {
    const key = getWeeklyChallengeStorageKey();
    if (!key || !data) return;
    try {
        const payload = sanitizeWeeklyChallengePayload(data);
        localStorage.setItem(key, JSON.stringify(payload));
    } catch (err) {
        console.warn('Falha ao salvar desafio semanal local:', err);
    }
}

function loadLocalWeeklyChallenge() {
    const key = getWeeklyChallengeStorageKey();
    if (!key) return null;
    try {
        const raw = localStorage.getItem(key);
        if (!raw) return null;
        return JSON.parse(raw);
    } catch (err) {
        console.warn('Falha ao ler desafio semanal local:', err);
        return null;
    }
}

function applyLocalWeeklyChallenge() {
    if (!state.pareado || !state.usuario?.pareadoUid) return;
    if (state.weeklyChallengeFromServer) return;
    const local = loadLocalWeeklyChallenge();
    if (!local) return;
    const docId = getWeeklyChallengeDocId();
    const shouldMigrate = docId && local.id && local.id !== docId && local.id.startsWith('alma_gemea');
    const migrated = shouldMigrate ? {
        ...local,
        id: docId,
        challengeId: local.challengeId || 'alma_gemea',
    } : local;
    if (migrated.startedAt) {
        const startedMs = getDateFromValue(migrated.startedAt)?.getTime() || Number(migrated.startedAt);
        if (Number.isFinite(startedMs)) {
            setLocalChallengeStartMs(migrated.id, startedMs);
        }
    }
    state.desafiosSemanais = [migrated];
    const concluido = !!(migrated.concluido || migrated.completed || migrated.status === 'finalizado' || migrated.status === 'finalizado_sem_recompensa');
    state.pendingChallenge = concluido ? null : {
        id: migrated.id,
        titulo: migrated.titulo || 'Alma Gêmea',
        pergunta: migrated.pergunta || 'Pergunta indisponível.',
    };
    state.hasTriggeredFirstPairingChallenge = true;
    if (shouldMigrate) {
        saveLocalWeeklyChallenge(migrated);
    }
}

function setupWeeklyChallengeListener() {
    const docId = getWeeklyChallengeDocId();
    if (!docId || !db) return;
    if (unsubscribeWeeklyChallenge) {
        unsubscribeWeeklyChallenge();
    }
    unsubscribeWeeklyChallenge = db
        .collection('weeklyChallenges')
        .doc(docId)
        .onSnapshot((doc) => {
            if (!doc.exists) {
                state.weeklyChallengeFromServer = false;
                state.desafiosSemanais = [];
                state.pendingChallenge = null;
                state.activeWeeklyChallengeId = null;
                state.challengeDeadline = null;
                state.challengeSecondsLeft = 0;
                state.showChallengePopup = false;
                if (state.challengeTimerId) {
                    clearInterval(state.challengeTimerId);
                    state.challengeTimerId = null;
                }
                clearLocalWeeklyChallenge(docId);
                if (state.etapa === 'achievementsPopup') {
                    renderAchievementsPopup();
                }
                return;
            }
            state.weeklyChallengeFromServer = true;
            const data = doc.data() || {};
            const currentUid = state.usuario?.uid || null;
            const partnerUid = state.usuario?.pareadoUid || null;
            const respostas = data.respostas || {};
            const nomes = data.respondeuNome || {};
            const merged = {
                ...data,
                id: doc.id,
                challengeId: data.challengeId || 'alma_gemea',
                respostaUsuario: currentUid ? respostas[currentUid] || data.respostaUsuario || null : data.respostaUsuario || null,
                respostaParceiro: partnerUid ? respostas[partnerUid] || data.respostaParceiro || null : data.respostaParceiro || null,
                parceiroNomeResposta: partnerUid ? nomes[partnerUid] || data.parceiroNomeResposta || null : data.parceiroNomeResposta || null,
            };
            state.desafiosSemanais = [merged];
            const concluido = !!(merged.concluido || merged.completed || merged.status === 'finalizado' || merged.status === 'finalizado_sem_recompensa');
            state.pendingChallenge = concluido ? null : {
                id: merged.id,
                titulo: merged.titulo || 'Alma Gêmea',
                pergunta: merged.pergunta || 'Pergunta indisponível.',
            };
            saveLocalWeeklyChallenge(merged);
            if (state.etapa === 'achievementsPopup' || state.showChallengePopup) {
                renderAchievementsPopup();
            }
        }, (err) => console.warn('Falha no listener do desafio semanal:', err));
}

function seedWeeklyChallengeDocIfMissing(docId) {
    if (!docId) return;
    const existing = Array.isArray(state.desafiosSemanais)
        ? state.desafiosSemanais.find((desafio) => desafio.id === docId || desafio.challengeId === 'alma_gemea')
        : null;
    if (!existing) return;
    const payload = sanitizeWeeklyChallengePayload({
        ...existing,
        id: docId,
        challengeId: existing.challengeId || 'alma_gemea',
    });
    safeAddInput({
        type: 'weekly_challenge_seed',
        challengeId: existing.challengeId || 'alma_gemea',
        challengeDocId: docId,
        payloadJson: JSON.stringify(payload),
        titulo: payload.titulo || null,
        pergunta: payload.pergunta || null,
        status: payload.status || null,
        reward: Number(payload.reward || 0),
        createdAtMs: Number(payload.criadoEm || payload.createdAt || payload.createdAtMs || payload.createdAtTimestamp || 0) || Date.now(),
        createdAt: Date.now(),
    }).catch((err) => console.warn('Falha ao solicitar seed do desafio semanal:', err));
}

function sanitizeWeeklyChallengePayload(desafio) {
    const sanitizeValue = (value) => {
        if (value instanceof Date) {
            return value.getTime();
        }
        if (value && typeof value.toDate === 'function') {
            return value.toDate().getTime();
        }
        if (value && typeof value === 'object' && Number.isFinite(value.seconds) && Number.isFinite(value.nanoseconds)) {
            return value.seconds * 1000 + Math.floor(value.nanoseconds / 1e6);
        }
        if (Array.isArray(value)) {
            return value.map(sanitizeValue);
        }
        if (value && typeof value === 'object') {
            const cleaned = {};
            Object.keys(value).forEach((key) => {
                const next = sanitizeValue(value[key]);
                if (next !== undefined) {
                    cleaned[key] = next;
                }
            });
            return cleaned;
        }
        if (typeof value === 'function') {
            return undefined;
        }
        return value;
    };

    return sanitizeValue(desafio);
}

function persistWeeklyChallenge(desafio) {
    const docId = getWeeklyChallengeDocId();
    if (!docId) {
        return;
    }
    const payload = sanitizeWeeklyChallengePayload({
        ...desafio,
        id: docId,
        challengeId: desafio.challengeId || 'alma_gemea',
    });
    return safeAddInput({
        type: 'weekly_challenge_upsert',
        challengeId: desafio.challengeId || 'alma_gemea',
        challengeDocId: docId,
        payloadJson: JSON.stringify(payload),
        titulo: payload.titulo || null,
        pergunta: payload.pergunta || null,
        status: payload.status || null,
        reward: Number(payload.reward || 0),
        createdAtMs: Number(payload.criadoEm || payload.createdAt || payload.createdAtMs || payload.createdAtTimestamp || 0) || Date.now(),
        startedAtMs: Number(payload.startedAt || payload.startedEm || payload.prazoInicio || 0) || null,
        completedAtMs: Number(payload.completedAt || payload.concluidoEm || 0) || null,
        respostaUsuario: payload.respostaUsuario || null,
        respostaParceiro: payload.respostaParceiro || null,
        updatedAt: Date.now(),
    }).catch((err) => console.warn('Falha ao solicitar upsert do desafio semanal:', err));
}

function markWeeklyChallengeStarted(desafioId) {
    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    const index = desafiosSemanais.findIndex((item) => item.id === desafioId);
    if (index === -1) return;
    const desafioAtual = desafiosSemanais[index];
    if (desafioAtual.startedAt || desafioAtual.prazoInicio) return;

    const startedAt = new Date();
    setLocalChallengeStartMs(desafioId, startedAt.getTime());
    desafiosSemanais[index] = {
        ...desafioAtual,
        startedAt,
    };
    state.desafiosSemanais = desafiosSemanais;
    saveLocalWeeklyChallenge(desafiosSemanais[index]);
    persistWeeklyChallenge(desafiosSemanais[index]);

    safeAddInput({
        type: 'weekly_challenge_start',
        challengeId: desafiosSemanais[index].challengeId || 'alma_gemea',
        challengeDocId: desafiosSemanais[index].id || desafioId,
        startedAt: Date.now(),
    }).catch((err) => console.warn('Falha ao registrar início do desafio semanal:', err));
}

function normalizeChallengeAnswer(answer) {
    return (answer || '')
        .toString()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
}

function applyWeeklyChallengeAnswer(desafioId, answer, responderUid, responderName) {
    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    const index = desafiosSemanais.findIndex((item) => item.id === desafioId);
    if (index === -1) {
        return { status: 'not_found' };
    }

    const desafioAtual = desafiosSemanais[index];
    const normalizedAnswer = normalizeChallengeAnswer(answer);
    const isCurrentUser = responderUid && responderUid === state.usuario?.uid;

    const updated = {
        ...desafioAtual,
        respondeuEm: new Date(),
        status: 'aguardando_parceiro',
    };

    if (isCurrentUser) {
        updated.respostaUsuario = normalizedAnswer;
        updated.respondidoPor = responderUid;
    } else {
        updated.respostaParceiro = normalizedAnswer;
        updated.respondidoPorParceiro = responderUid || updated.respondidoPorParceiro || null;
        updated.parceiroNomeResposta = responderName || updated.parceiroNomeResposta || null;
    }

    const respostaUsuario = updated.respostaUsuario || null;
    const respostaParceiro = updated.respostaParceiro || null;

    if (respostaUsuario && respostaParceiro) {
        if (respostaUsuario === respostaParceiro) {
            updated.status = 'finalizado';
            updated.concluido = true;
            updated.completedAt = new Date();
            if (!updated.rewarded) {
                const reward = Number(updated.reward || 1);
                if (state.usuario) {
                    state.usuario.foguinhos = (state.usuario.foguinhos || 0) + reward;
                }
                updated.rewarded = true;
            }
            state.pendingChallenge = null;
        } else {
            updated.status = 'finalizado_sem_recompensa';
            updated.concluido = true;
            updated.completedAt = new Date();
            updated.rewarded = false;
            state.pendingChallenge = null;
        }
    }

    desafiosSemanais[index] = updated;
    state.desafiosSemanais = desafiosSemanais;
    saveLocalWeeklyChallenge(updated);
    persistWeeklyChallenge(updated);
    safeAddInput({
        type: 'weekly_challenge_answer',
        challengeId: updated.challengeId || 'alma_gemea',
        challengeDocId: updated.id || desafioId,
        responderUid: responderUid || null,
        responderName: responderName || null,
        answer: normalizedAnswer,
        status: updated.status,
        answeredAt: Date.now(),
    }).catch((err) => console.warn('Falha ao enviar resposta do desafio:', err));

    return { status: updated.status, updated };
}

async function solicitarPermissaoDeNotificacao() {
if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
    console.warn("Este navegador não suporta notificações Push.");
    return;
}

try {
    const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
    console.log('Service Worker registrado com sucesso:', registration);

    const permission = await Notification.requestPermission();

    if (permission !== "granted") {
        console.log("Permissão de notificação negada.");
        showToast("Você não receberá notificações.", "aviso");
        return;
    }

    console.log("Permissão de notificação concedida.");

    const messaging = firebase.messaging();
    const fcmToken = await messaging.getToken({
        vapidKey: "BDTOlIk3SKC6BV_MD0Eu2DZfm7rPOnGbz6hvYL1K_3lYnR1YXvO6qbOMuHHzBqzHhtyKw8YJMetHIas4V8wrWpI",
        serviceWorkerRegistration: registration
    });

    if (!fcmToken) {
        console.log("Não foi possível obter o token do FCM. Tente recarregar a página.");
        showToast("Não foi possível ativar notificações agora.", "aviso");
        return;
    }

    console.log("Token do FCM obtido:", fcmToken);
    await syncNotificationToken({ token: fcmToken });

    state.fcmToken = fcmToken;
    if (!state.usuario) {
        state.usuario = {};
    }
    state.usuario.notificationsEnabled = true;

    showToast("Notificações ativadas!", "sucesso");
    renderApp();
} catch (error) {
    console.error("Erro detalhado ao solicitar permissão:", error);
    showToast("Erro ao ativar notificações.", "erro");
}
}

async function desativarNotificacoes() {
try {
    console.log("Iniciando processo de desativação...");
    // Encontra o registro do Service Worker
    const registration = await navigator.serviceWorker.getRegistration();
    if (!registration) {
        console.log("Nenhum Service Worker encontrado.");
        return;
    }

    // Pega a assinatura de Push
    const subscription = await registration.pushManager.getSubscription();
    if (subscription) {
        // Cancela a assinatura no navegador
        await subscription.unsubscribe();
        console.log("Assinatura de Push cancelada no navegador.");
    }

    const tokenParaRemover = state.fcmToken || state.usuario?.fcmToken || null;
    await syncNotificationToken({ revoke: true, token: tokenParaRemover || undefined });

    if (tokenParaRemover && firebase.messaging && firebase.messaging.isSupported && firebase.messaging.isSupported()) {
        try {
            await firebase.messaging().deleteToken(tokenParaRemover);
            console.log("Token removido do Firebase Messaging neste dispositivo.");
        } catch (deleteErr) {
            console.warn("Falha ao remover token local do FCM:", deleteErr);
        }
    }

    if (state.usuario) {
        state.usuario.notificationsEnabled = false;
    }
    state.fcmToken = null;

    console.log("Token FCM removido do backend.");
    showToast("Notificações desativadas com sucesso!", 'sucesso');

    // Força a re-renderização da página para atualizar o botão
    renderApp();

} catch (error) {
    console.error("Erro ao desativar notificações:", error);
    showToast("Erro ao desativar notificações.", 'erro');
}
}

function setupForegroundMessageHandler() {
// Certifique-se de que 'firebase.messaging' está disponível
if (firebase.messaging.isSupported()) {
    const messaging = firebase.messaging();
    messaging.onMessage((payload) => {
        console.log("Notificação Push recebida em primeiro plano: ", payload);

        // Em vez de uma notificação do sistema, mostramos um "toast"
        const title = payload.data.title;
        const body = payload.data.body;
        const notificationType = payload.data?.type || null;
        if (notificationType === 'achievement') {
            showAchievementCelebration(payload.data?.achievementId || null);
            trackGAEvent('unlock_achievement', {
                achievement_id: payload.data?.achievementId || 'unknown',
            });
            trackMetaEvent('UnlockAchievement', {
                achievement_id: payload.data?.achievementId || 'unknown',
            });
        } else {
            showToast(`🔔 ${title}: ${body}`, 'sucesso');
        }
        updateFixedUI();
    });
}
}

    async function sendPairingRequest() {
    const codigoDigitado = document.getElementById('codigoParceiro').value;
    const apelidoDigitado = document.getElementById('apelidoParceiro').value;
    const hasPending = !!(state.usuario && state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_'));
    if (hasPending) {
        showToast('Você já tem uma solicitação pendente.', 'aviso');
        return;
    }

if (!codigoDigitado || codigoDigitado.length !== 11 || !/^(\d+)$/.test(codigoDigitado)) {
    showToast('Por favor, digite um telefone com 11 dígitos.', 'aviso');
    return;
}
if (!apelidoDigitado || !apelidoDigitado.trim()) {
    showToast('Por favor, informe um apelido carinhoso.', 'aviso');
    return;
}
if (codigoDigitado === state.usuario.telefone) {
    showToast('Você não pode parear consigo mesmo!', 'erro');
    return;
}
try {
    const apelidoFormatado = apelidoDigitado.trim();
    const inputData = {
        type: 'pairing_request',
        fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
        fromName: state.usuario.nome,
        fromPhone: state.usuario.telefone,
        toPhone: codigoDigitado,
        partnerNickname: apelidoFormatado,
        resolvePartnerName: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        processed: false,
    };

    // Cria um input para o backend processar a solicitação de pareamento.
    await safeAddInput(inputData);

    trackGAEvent('initiate_pairing');
    trackMetaEvent('InitiatePairing');

    // Atualiza apenas o estado local/imediato do sender; o backend atualizará
    // os documentos reais quando processar o input.
    state.usuario.pareadoCom = `pending_${codigoDigitado}`;
    state.pendingPartnerName = apelidoFormatado;
    showToast('Solicitação enviada! Aguardando confirmação.', 'sucesso');
    state.etapa = 'pareamentos';
    state.codigoDigitando = false;
    state.showPairingModal = false;
    renderApp();
} catch (error) {
    console.error('Erro ao enviar solicitação de pareamento:', error);
    showToast('Erro ao enviar solicitação. Tente novamente.', 'erro');
}
}

    async function acceptPairingRequest(requestId, senderUid, senderPhone) {
try {
    if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && !state.usuario.pareadoCom.startsWith('pending_')) {
        showToast('Você já está pareado com outra pessoa.', 'aviso');
        return;
    }

    // Cria um input indicando que o receiver aceitou a solicitação. O backend
    // processará a aceitação (atualizará `usuarios` e criará `pareamentos`).
    await safeAddInput({
        type: 'pairing_response',
        fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
        requestId: requestId,
        response: 'accepted',
    });
    showToast('Solicitação aceita. Aguardando processamento...', 'sucesso');
    setTimeout(() => loadUserDataAndNavigate(state.usuario.uid, state.usuario.email), 800);
} catch (error) {
    console.error('Erro ao aceitar pareamento:', error);
    showToast('Erro ao aceitar pareamento. Tente novamente.', 'erro');
}
}

    async function rejectPairingRequest(requestId) {
try {
    // Cria um input indicando que o receiver rejeitou a solicitação. O backend
    // irá processar a rejeição e limpar o estado do sender.
    await safeAddInput({
        type: 'pairing_response',
        fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
        requestId: requestId,
        response: 'rejected',
    });
    showToast('Solicitação de pareamento rejeitada.', 'sucesso');
    state.pendingPairingRequest = null;
    renderApp();
} catch (error) {
    console.error('Erro ao rejeitar pareamento:', error);
    showToast('Erro ao rejeitar solicitação.', 'erro');
}
}

    // Função para cancelar uma solicitação de pareamento pendente (do lado do sender)
    async function cancelPendingPairingRequest() {
        openSystemConfirm('Tem certeza que deseja cancelar esta solicitação de pareamento?', async () => {
            try {
                const senderUid = state.usuario.uid;
                const receiverPhone = state.usuario.pareadoCom.replace('pending_', '');
                await safeAddInput({
                    type: 'pairing_cancel',
                    fromUid: (auth.currentUser && auth.currentUser.uid) || senderUid,
                    partnerPhone: receiverPhone,
                });

                showToast('Solicitação de pareamento cancelada. Aguardando processamento', 'sucesso');
                state.usuario.pareadoCom = null;
                state.usuario.pareadoUid = null;
                state.parceiroData = null;
                state.parceiroNome = null;
                state.parceiroTelefone = null;
                state.idPareamentoAmigavel = null;
                state.pareado = false;
                state.pendingPartnerName = null;
                state.etapa = 'pareamentos';
                renderApp();
            } catch (error) {
                console.error('Erro ao cancelar solicitação:', error);
                showToast('Erro ao cancelar solicitação.', 'erro');
            }
        });
    }


    function renderPareamento() {
if (state.pareado && state.parceiroData) {
    // Mostra o Perfil do Parceiro se estiver pareado
    const fotoParceiroUrl = state.parceiroData.fotoUrl || '/assets/icons/iconprincipal.png';
    const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
    const canCheckIn = !lastCheckIn || !isSameDay(lastCheckIn, new Date());
    const checkInButtonText = canCheckIn ? 'Presentear com 1 🔥' : 'Presenteado Hoje';
    const checkInButtonClasses = canCheckIn ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-700 text-gray-400 cursor-not-allowed';

    appContainer.innerHTML = `
        <div class="container mx-auto px-4 py-8 pb-8 pt-24">
            <div class="max-w-md mx-auto card text-center p-8">
                <h2 class="text-2xl font-bold mb-4 text-gray-300">Conectado com</h2>
                <img src="${fotoParceiroUrl}" class="w-32 h-32 rounded-full object-cover border-4 border-pink-500/50 mx-auto mb-4">
                <h3 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500">${state.parceiroData.nome}</h3>
                
                <p class="text-gray-500 text-sm mt-2">ID do Casal: ${state.idPareamentoAmigavel || 'Indisponível'}</p>

                <div class="mt-8 space-y-4">
                    <button onclick="handleDailyCheckIn()" ${!canCheckIn ? 'disabled' : ''} class="w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${checkInButtonClasses}">
                        <i class="fas fa-gift"></i> ${checkInButtonText}
                    </button>
                    <button onclick="desparearParceiro()" class="w-full py-3 bg-red-800/60 hover:bg-red-700 text-white rounded-lg font-semibold transition">
                        Desfazer Pareamento
                    </button>

                    <!-- Botão de seguir no Instagram (discreto, com borda em gradiente) -->
                    <button onclick="openInstagramModal()" class="instagram-cta-outline w-full mt-2">
                        <span class="instagram-cta-inner w-full justify-center">
                            <i class="fab fa-instagram"></i> Siga-nos no Instagram!
                        </span>
                    </button>
                </div>
            </div>
        </div>
        ${state.showCartSidebar ? renderCartSidebar() : ''}
    `;
    return;
}

// Se não estiver pareado, mostra a lógica antiga de pareamento
const codigoUsuario = state.usuario.telefone.replace(/\D/g, '');
let content = '';

if (state.pendingPairingRequest) {
    content = `
        <div class="screen screen-pad flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
            <div class="card p-8 max-w-md w-full text-center">
                <h2 class="text-3xl font-bold mb-4 text-pink-400">Solicitação Recebida</h2>
                <p class="mb-4">Você recebeu uma solicitação de pareamento de:</p>
                <div class="text-2xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block mb-6">${state.pendingPairingRequest.senderName}</div>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button onclick="acceptPairingRequest('${state.pendingPairingRequest.id}', '${state.pendingPairingRequest.senderUid}', '${state.pendingPairingRequest.senderPhone}')" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded text-white font-semibold transition flex-1">Aceitar</button>
                    <button onclick="rejectPairingRequest('${state.pendingPairingRequest.id}')" class="btn-red px-6 py-3 rounded text-white font-semibold transition flex-1">Rejeitar</button>
                </div>
            </div>
        </div>`;
} else if (state.usuario.pareadoCom && state.usuario.pareadoCom.startsWith('pending_')) {
    const pendingPhone = state.usuario.pareadoCom.replace('pending_', '');
    content = `
        <div class="screen screen-pad flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
            <div class="card p-8 max-w-md w-full text-center">
                <h2 class="text-3xl font-bold mb-4 text-yellow-400">Solicitação Enviada</h2>
                <p class="mb-4">Sua solicitação para ${pendingPhone} está pendente.</p>
                <p class="text-sm text-gray-300 mb-6">Aguardando aceitação...</p>
                <button onclick="cancelPendingPairingRequest()" class="btn-red px-6 py-3 rounded text-white font-semibold transition">Cancelar Solicitação</button>
            </div>
        </div>`;
} else {
    content = `
        <div class="screen screen-pad flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
            <div class="card p-8 max-w-md w-full text-center">
                <h2 class="text-3xl font-bold mb-4 text-pink-400">Parear com seu Amor</h2>
                ${!state.codigoDigitando ? `
                    <p class="mb-4">Seu código de pareamento é:</p>
                    <div class="text-4xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block">${codigoUsuario}</div>
                    <p class="mt-4 text-sm text-gray-300 mb-6">Compartilhe este código com seu/sua parceiro(a).</p>
                    <div class="flex flex-col sm:flex-row justify-center gap-4">
                        <button onclick="state.codigoDigitando = true; renderApp();" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded text-white font-semibold transition">Digitar Código</button>
                        <button onclick="handleContinuarSemParear()" class="btn-red">Fazer Isso Depois</button>
                    </div>
                ` : `
                    <div class="mb-6">
                        <label class="block mb-2">Digite o código do seu parceiro(a)</label>
                        <input id="codigoParceiro" type="text" class="w-full p-3 rounded text-white text-center" placeholder="11999991111" maxlength="11" />
                    </div>
                    <div class="flex gap-4">
                        <button onclick="state.codigoDigitando = false; renderApp();" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded font-semibold transition">Voltar</button>
                        <button onclick="sendPairingRequest()" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded font-semibold transition flex-1">Enviar Solicitação</button>
                    </div>
                `}
            </div>
        </div>`;
}
appContainer.innerHTML = content;
}

    // Nova função para renderizar o pop-up de Foguinhos
    async function renderFoguinhosPopupContent() {
    
    // 1. Limpa a "bolinha" de notificações de PRESENTES (fa-gift)
    // ==================================================================
    try {
        if (state.notificacoesPresentesNaoLidas > 0) {
            const batch = db.batch();
            let notificacoesDePresenteLidas = 0;

            state.notificacoes.forEach(notif => {
                // Marcamos como lidas APENAS as notificações de 'fa-gift'
                if (!notif.lida && notif.icone === 'fa-gift') {
                    const notifRef = db.collection('notificacoes').doc(notif.id);
                    batch.update(notifRef, { lida: true });
                    notificacoesDePresenteLidas++;
                }
            });

            if (notificacoesDePresenteLidas > 0) {
                await batch.commit();
                console.log(`Marcou ${notificacoesDePresenteLidas} notificações de presente como lidas.`);
                // Atualiza o state local (só subtrai as que limpamos)
                state.notificacoesPresentesNaoLidas = 0;
                updateFixedUI(); // Atualiza a bolinha
            }
        }
    } catch (err) {
        console.error("Erro ao marcar notificações de presente como lidas:", err);
    }
    // ==================================================================
    // FIM DO BLOCO DE LIMPEZA
    // ==================================================================


    // 2. Busca o histórico de presentes (filtrando as notificações)
    const historicoPresentes = state.notificacoes.filter(notif => notif.icone === 'fa-gift');

    // 3. Renderiza o HTML da página
    const partnerBalances = Array.isArray(state.parceirosAtivos)
        ? state.parceirosAtivos
        : [];
    const showPartnerBalances = partnerBalances.length > 1;
    const totalFromPartners = partnerBalances.reduce((acc, partner) => {
        const saldo = Number(partner.foguinhos ?? partner.saldoFoguinhos ?? 0);
        return acc + (Number.isFinite(saldo) ? saldo : 0);
    }, 0);
    const totalFoguinhos = totalFromPartners > 0
        ? totalFromPartners
        : (state.usuario ? state.usuario.foguinhos : 0);

    const partnerBalancesHtml = showPartnerBalances
        ? `
            <div>
                <div class="flex items-center justify-between mb-3">
                    <h4 class="text-sm font-semibold text-white/80">Saldo por parceiro</h4>
                    <span class="text-xs text-white/50">${partnerBalances.length} conexões</span>
                </div>
                <div class="notif-list-shell space-y-3">
                    ${partnerBalances.map((partner) => {
                        const partnerName = partner.nome || 'Parceiro';
                        const partnerPhoto = partner.fotoUrl || '';
                        const saldo = Number(partner.foguinhos ?? partner.saldoFoguinhos ?? 0);
                        return `
                            <div class="notif-item">
                                ${partnerPhoto
                                    ? `<img src="${partnerPhoto}" alt="${partnerName}">`
                                    : `<div class="notification-avatar"><i class="fas fa-user text-white/80"></i></div>`}
                                <div class="flex-1">
                                    <p class="text-sm font-semibold text-gray-800">${partnerName}</p>
                                    <p class="text-xs text-gray-500">Saldo atual</p>
                                </div>
                                <div class="flex items-center gap-2 text-amber-500 font-semibold">
                                    <i class="fas fa-fire"></i>
                                    <span>${Number.isFinite(saldo) ? saldo : 0}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `
        : '';

    appContainer.innerHTML = `
        <div class="screen screen-pad bg-black text-white">
            <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                <div class="flex flex-col items-center text-center -mt-6">
                    <i class="fas fa-fire text-3xl mb-3"></i>
                    <h2 class="text-3xl font-semibold">Foguinhos</h2>
                    <p class="text-white/80">Acompanhe seu saldo e ganhos</p>
                </div>
            </section>

            <section class="px-5 pb-8 -mt-10">
                <div class="notif-shell max-w-2xl mx-auto space-y-6">
                    <div class="notif-card-white flex items-center justify-between">
                        <div>
                            <h3 class="text-lg font-semibold text-red-500">Saldo total</h3>
                            <p class="text-sm text-gray-600">Use-os para resgatar momentos</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fas fa-fire text-2xl text-amber-500"></i>
                            <span class="text-2xl font-bold text-gray-800">${totalFoguinhos}</span>
                        </div>
                    </div>

                    ${partnerBalancesHtml}

                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="text-sm font-semibold text-white/80">Histórico de Presentes</h4>
                            <span class="text-xs text-white/50">${historicoPresentes.length} itens</span>
                        </div>
                        <div class="notif-list-shell space-y-3">
                            ${historicoPresentes.length === 0
                                ? `<p class="text-center text-gray-500 py-6">Nenhum presente recebido ainda.</p>`
                                : historicoPresentes.map(notif => `
                                    <div class="notif-item ${notif.lida ? 'opacity-70' : ''}">
                                        <div class="notification-avatar">
                                            <i class="fas ${notif.icone || 'fa-info-circle'} text-lg text-amber-500"></i>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-800">${notif.titulo || 'Presente recebido'}</p>
                                            <p class="text-sm text-gray-600">${notif.mensagem}</p>
                                            <p class="text-xs text-gray-500 mt-1">${notif.timestamp ? new Date(notif.timestamp.seconds * 1000).toLocaleString('pt-BR') : ''}</p>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            </section>
        </div>
        ${state.showChallengePopup ? renderChallengePopup() : ''}
    `;
}

function setupNotificationListener(userId) {
    // Se já existe um ouvinte, desliga ele primeiro
    if (unsubscribeNotifications) {
        unsubscribeNotifications();
    }

    hasProcessedInitialNotifications = false;
    lastNotificationIds = new Set();

    const notificationsQuery = db.collection('notificacoes')
        .where('userId', '==', userId)
        .orderBy('timestamp', 'desc')
        .limit(20);

    unsubscribeNotifications = notificationsQuery.onSnapshot(snapshot => {
        const notifs = [];
        snapshot.forEach(doc => {
            notifs.push({ id: doc.id, ...doc.data() });
        });

    state.notificacoes = notifs; // Guarda a lista completa no state
        
        // ==========================================================
        // AQUI ESTÁ A NOVA LÓGICA DE CONTAGEM
        // ==========================================================
        let tarefasNaoLidas = 0;
        let presentesNaoLidos = 0;
        let conquistasNaoLidas = 0;
        
        notifs.forEach(n => {
            if (!n.lida) {
                if (n.icone === 'fa-shopping-bag') { // Notificação de Tarefa
                    tarefasNaoLidas++;
                } else if (n.icone === 'fa-gift') { // Notificação de Presente
                    presentesNaoLidos++;
                } else if (n.tipo === 'achievement' || n.icone === 'fa-trophy') {
                    conquistasNaoLidas++;
                }
            }
        });

        // Atualiza os contadores separados no state
        state.notificacoesTarefasNaoLidas = tarefasNaoLidas;
        state.notificacoesPresentesNaoLidas = presentesNaoLidos;
    state.notificacoesConquistasNaoLidas = conquistasNaoLidas;
        // ==========================================================
        const docChanges = snapshot.docChanges ? snapshot.docChanges() : [];
        if (hasProcessedInitialNotifications && docChanges.length) {
            const newAchievementNotifs = [];
            docChanges.forEach((change) => {
                if (change.type === 'added') {
                    const notifData = { id: change.doc.id, ...change.doc.data() };
                    if (!notifData.lida && (notifData.tipo === 'achievement' || notifData.icone === 'fa-trophy')) {
                        newAchievementNotifs.push(notifData);
                    }
                }
            });
            if (newAchievementNotifs.length) {
                console.log('Novas notificações de conquista detectadas:', newAchievementNotifs.map((notif) => notif.id));
                newAchievementNotifs.forEach(triggerAchievementCelebration);
            }
        }

        const currentNotificationIds = new Set(notifs.map((notif) => notif.id));
        lastNotificationIds = currentNotificationIds;
        hasProcessedInitialNotifications = true;

    console.log(`Notificações carregadas: ${notifs.length}, Tarefas não lidas: ${tarefasNaoLidas}, Presentes não lidos: ${presentesNaoLidos}, Conquistas não lidas: ${conquistasNaoLidas}`);

        // Se o usuário estiver na tela de notificações, atualiza a lista
        if (state.etapa === 'notificacoes') {
            renderNossasTarefas(); // (Já tínhamos mudado isso)
        }

        // Atualiza a UI fixa (bolinha do sino e cor do fogo)
        updateFixedUI();
    });
}

async function renderAchievementsPopup() {
    await marcarNotificacoesDeConquistaComoLidas();

    if (!state.pareado || !state.usuario?.pareadoUid) {
        state.desafiosSemanais = [];
        state.pendingChallenge = null;
    }

    const conquistasUsuario = state.usuario?.conquistas || {};
    const totalConquistas = ACHIEVEMENTS.length;
    const conquistasDesbloqueadas = ACHIEVEMENTS.reduce((total, achievement) => {
        return conquistasUsuario[achievement.id] ? total + 1 : total;
    }, 0);
    const mostrarTodas = !!state.mostrarTodasConquistas;
    const desafiosTab = state.desafiosTab || 'conquistas';

    const desafiosSemanais = (state.pareado && state.usuario?.pareadoUid && Array.isArray(state.desafiosSemanais))
        ? state.desafiosSemanais
        : [];
    const desafiosSemanaisAbertos = desafiosSemanais.filter((desafio) => {
        const concluido = !!(desafio.concluido || desafio.completed || desafio.status === 'finalizado' || desafio.status === 'finalizado_sem_recompensa');
        return !concluido;
    });
    const desafiosSemanaisFinalizados = desafiosSemanais.filter((desafio) => {
        return !!(desafio.concluido || desafio.completed || desafio.status === 'finalizado' || desafio.status === 'finalizado_sem_recompensa');
    });

    let itensFiltrados = [];
    if (desafiosTab === 'emAberto') {
        const conquistasEmAberto = ACHIEVEMENTS.filter((achievement) => !conquistasUsuario[achievement.id]).map((achievement) => ({
            ...achievement,
            tipo: 'conquista',
        }));
        const semanaisEmAberto = desafiosSemanaisAbertos.map((desafio) => ({
            ...desafio,
            tipo: 'semanal',
        }));
        itensFiltrados = [...semanaisEmAberto, ...conquistasEmAberto];
    } else if (desafiosTab === 'finalizados') {
        itensFiltrados = desafiosSemanaisFinalizados.map((desafio) => ({
            ...desafio,
            tipo: 'semanal',
        }));
    } else {
        itensFiltrados = ACHIEVEMENTS.filter((achievement) => !!conquistasUsuario[achievement.id]).map((achievement) => ({
            ...achievement,
            tipo: 'conquista',
        }));
    }

    const itensVisiveis = mostrarTodas ? itensFiltrados : itensFiltrados.slice(0, 4);
    const mostrarBotaoVerMais = itensFiltrados.length > 4;

    const gridHtml = itensVisiveis.map((item) => {
        const isConquista = item.tipo === 'conquista';
        const isSemanalEmAberto = item.tipo === 'semanal' && desafiosTab === 'emAberto';
        const isSemanalFinalizadoTab = item.tipo === 'semanal' && desafiosTab === 'finalizados';
        const isSemanal = item.tipo === 'semanal';
        const usuarioRespondeu = isSemanal && !!item.respostaUsuario;
        const parceiroRespondeu = isSemanal && !!item.respostaParceiro;
        const isAguardandoParceiro = isSemanal && usuarioRespondeu && !parceiroRespondeu && (item.status === 'aguardando_parceiro');
        const isRespostasDiferentes = isSemanal && (item.status === 'respostas_diferentes');
        const isFinalizadoSemRecompensa = isSemanal && (item.status === 'finalizado_sem_recompensa');
        const cardClickable = isSemanal && !isSemanalFinalizadoTab && !isAguardandoParceiro && !isFinalizadoSemRecompensa && !!item.pergunta;
        const cardOnClick = cardClickable ? `onclick="openWeeklyChallengePopup('${item.id}', event)"` : '';
        const prazoTexto = isSemanalEmAberto ? getPrazoRestanteTexto(item) : (item.prazoTexto || '6d 23h 59m');
        const conquista = isConquista ? conquistasUsuario[item.id] : null;
        const desbloqueada = isConquista ? !!conquista : !!(item.concluido || item.completed || item.status === 'finalizado');
        const cardClasses = isSemanalEmAberto
            ? 'bg-white border-transparent shadow-lg text-gray-900'
            : (isSemanalFinalizadoTab
                ? 'bg-white/20 border-white/20 backdrop-blur-sm text-gray-200 opacity-90'
                : (desbloqueada
                    ? 'bg-gray-900 border-transparent shadow-lg shadow-black/30'
                    : 'bg-gray-800/40 border-gray-700 backdrop-blur-sm opacity-70'));
        const cor = item.accentColor || '#fbbf24';
        const titulo = item.title || item.titulo || 'Desafio';
        const descricao = item.description || item.descricao || '';
        const dica = item.hint || item.dica || '';
        const dataBase = (isConquista ? conquista?.unlockedAt : (item.completedAt || item.concluidoEm)) || null;
        const dataDesbloqueio = desbloqueada && dataBase ? formatarDataCurta(dataBase) : '';
        const dataDesbloqueioNumerica = desbloqueada && dataBase ? formatarDataNumerica(dataBase) : '';
        const iconClass = item.icon || 'fa-trophy';
        const hintAttr = dica ? `title="${escapeHtmlAttr(dica)}"` : '';
        const recompensa = typeof item.reward === 'number' ? item.reward : null;
        const recompensaTexto = recompensa !== null ? `Recompensa: ${recompensa} foguinho${recompensa === 1 ? '' : 's'}` : '';

        return `
            <div class="achievement-card sm-card-padding rounded-2xl border transition ${cardClasses} ${cardClickable ? 'cursor-pointer hover:-translate-y-0.5' : ''}" ${hintAttr} ${cardOnClick}>
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center ${desbloqueada || isSemanalEmAberto ? '' : 'border border-gray-600'}" style="${desbloqueada || isSemanalEmAberto ? `background: ${cor}; color: #111827;` : ''}">
                        <i class="fas ${iconClass} text-lg sm:text-xl"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-base sm:text-lg ${desbloqueada || isSemanalEmAberto ? '' : 'text-gray-300'}">${titulo}</h4>
                        <p class="text-xs sm:text-sm ${desbloqueada || isSemanalEmAberto ? 'text-gray-600' : 'text-gray-500'}">${descricao}</p>
                        ${recompensaTexto ? `<p class="text-xs sm:text-sm font-semibold text-amber-400 mt-2">${recompensaTexto}</p>` : ''}
                        ${isSemanalEmAberto && !isAguardandoParceiro ? `<p id="desafioPrazo-${item.id}" class="text-xs font-semibold text-pink-500 mt-2">Prazo: ${prazoTexto}</p>` : ''}
                        ${isAguardandoParceiro ? `<p class="text-xs font-semibold text-amber-500 mt-2">Aguardando ${state.parceiroApelido || state.parceiroNome || 'parceiro'} responder</p>` : ''}
                        ${isRespostasDiferentes ? `<p class="text-xs font-semibold text-rose-400 mt-2">Respostas diferentes. Sem sincronia.</p>` : ''}
                        ${desbloqueada ? (isSemanal
                            ? (isFinalizadoSemRecompensa
                                ? `<div class="mt-1">
                                    <p class="text-xs text-rose-400"><i class="fas fa-times-circle mr-1"></i>Conexão abalada!</p>
                                    ${dataDesbloqueioNumerica ? `<p class="text-[11px] text-gray-400 mt-1">${dataDesbloqueioNumerica}</p>` : ''}
                                </div>`
                                : `<div class="mt-1">
                                    <p class="text-xs text-emerald-400"><i class="fas fa-check-circle mr-1"></i>Vocês estão sintonizados!</p>
                                    ${dataDesbloqueioNumerica ? `<p class="text-[11px] text-gray-400 mt-1">${dataDesbloqueioNumerica}</p>` : ''}
                                </div>`)
                            : `<p class="text-xs text-emerald-400 mt-1"><i class="fas fa-check-circle mr-1"></i>${dataDesbloqueio ? dataDesbloqueio : 'Conquista desbloqueada!'}</p>`)
                            : `<p class="text-[11px] text-gray-500 mt-1">${dica || 'Complete a tarefa para desbloquear.'}</p>`}
                        ${isFinalizadoSemRecompensa ? `<div class="mt-2 inline-flex items-center gap-2 rounded-full bg-red-100 px-3 py-1 text-xs font-semibold text-red-600"><i class="fas fa-flag"></i> Sem sincronia</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    appContainer.innerHTML = `
        <div class="screen screen-pad bg-black text-white">
            <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                <div class="flex flex-col items-center text-center -mt-6">
                    <i class="fas fa-flag-checkered text-3xl mb-3"></i>
                    <h2 class="text-3xl font-semibold">Desafios</h2>
                    <p class="text-white/80">Acompanhe seus desafios e conquistas</p>
                </div>
            </section>

            <section class="px-5 pb-8 -mt-10">
                <div class="notif-shell max-w-4xl mx-auto space-y-6">
                    <div class="notif-card-white flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Conquistados</p>
                            <p class="text-2xl font-semibold text-gray-800">${conquistasDesbloqueadas}/${totalConquistas}</p>
                        </div>
                        <div class="w-12 h-12 rounded-2xl bg-red-100 flex items-center justify-center">
                            <i class="fas fa-trophy text-red-500 text-xl"></i>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="notif-tab ${desafiosTab === 'emAberto' ? 'active' : ''}" onclick="setDesafiosTab('emAberto')">Em Aberto</button>
                        <button class="notif-tab ${desafiosTab === 'finalizados' ? 'active' : ''}" onclick="setDesafiosTab('finalizados')">Finalizados</button>
                        <button class="notif-tab ${desafiosTab === 'conquistas' ? 'active' : ''}" onclick="setDesafiosTab('conquistas')">Conquistas</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">
                        ${gridHtml || '<p class="text-center text-gray-500 py-6 col-span-full">Nenhum item para exibir.</p>'}
                    </div>
                    ${mostrarBotaoVerMais ? `
                        <div class="text-center">
                            <button type="button" onclick="toggleMostrarConquistas()" class="btn-red px-10 py-3">
                                ${mostrarTodas ? 'Ver menos' : 'Ver mais'}
                            </button>
                        </div>
                    ` : ''}
                </div>
            </section>
        </div>
        ${state.showChallengePopup ? renderChallengePopup() : ''}
    `;
}

function buildPareamentosLista() {
    const lista = Array.isArray(state.parceirosAtivos) ? [...state.parceirosAtivos] : [];

    if (!lista.length && state.parceiroData) {
        lista.push({
            uid: state.parceiroData.uid || state.usuario?.pareadoUid || null,
            nome: state.parceiroApelido || state.parceiroData.nome || state.parceiroNome || 'Parceiro',
            fotoUrl: state.parceiroData.fotoUrl || '',
            pareamentoId: state.idPareamentoAmigavel || '',
            foguinhos: state.parceiroData.foguinhos ?? 0,
        });
    }

    return lista.map((partner) => ({
        uid: partner.uid || partner.parceiroUid || partner.userId || null,
        nome: partner.apelido || partner.nickname || partner.partnerNickname || partner.nome || 'Parceiro',
        fotoUrl: partner.fotoUrl || partner.photoUrl || '',
        pareamentoId: partner.pareamentoId || partner.pareamentoAmigavelId || partner.idPareamento || '',
        foguinhos: Number(partner.foguinhos ?? partner.saldoFoguinhos ?? 0),
        pareadoDesde: partner.pareadoDesde || partner.pareadoEm || null,
        sexo: partner.sexo || null,
        catalogoPersonalizado: partner.catalogoPersonalizado || null,
    }));
}

function getFoguinhosConexao(partnerUid) {
    const lista = Array.isArray(state.parceirosAtivos) ? state.parceirosAtivos : [];
    const match = lista.find((partner) => partner.uid === partnerUid || partner.parceiroUid === partnerUid);
    const saldo = match ? Number(match.foguinhos ?? match.saldoFoguinhos ?? 0) : NaN;
    if (Number.isFinite(saldo)) {
        return saldo;
    }
    return state.usuario ? (state.usuario.foguinhos || 0) : 0;
}

function renderPareamentosLista() {
    const pareamentos = buildPareamentosLista();
    const total = pareamentos.length;
    const maximo = 5;
    const hasPareamentos = total > 0;
    const isVip = !!(state.usuario && state.usuario.vip);
    const hasPending = !!(state.usuario && state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_'));
    const pendingPhone = hasPending ? state.usuario.pareadoCom.replace('pending_', '') : '';
    const pendingName = state.pendingPartnerName || 'Apelido carinhoso';
    const lastCheckIn = state.usuario?.lastCheckInDate?.toDate
        ? state.usuario.lastCheckInDate.toDate()
        : (state.usuario?.lastCheckInDate ? new Date(state.usuario.lastCheckInDate) : null);
    const canCheckIn = !lastCheckIn || !isSameDay(lastCheckIn, new Date());
    const pendingCardHtml = hasPending ? `
        <div class="rounded-2xl p-4 bg-amber-400/90 text-gray-900 shadow-[0_12px_30px_rgba(251,191,36,0.35)]">
            <div class="flex items-center gap-4">
                <div class="w-20 h-20 rounded-full bg-white/70 flex items-center justify-center">
                    <i class="fas fa-heart text-amber-600 text-2xl"></i>
                </div>
                <div class="flex-1">
                    <p class="text-lg font-semibold">${pendingName}</p>
                    <p class="text-xs text-gray-800/80">Pareamento Pendente</p>
                    <div class="mt-3 flex flex-col gap-2">
                        <button class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-500 cursor-not-allowed" disabled>
                            <i class="fas fa-fire-flame-curved mr-2"></i>Check-in diário
                        </button>
                        <button class="px-4 py-2 rounded-lg font-semibold bg-gray-200 text-gray-500 cursor-not-allowed" disabled>
                            <i class="fas fa-store mr-2"></i>Ir ao Catálogo
                        </button>
                        <button onclick="cancelPendingPairingRequest()" class="px-4 py-2 rounded-lg font-semibold bg-gray-900 text-white hover:bg-gray-800">
                            <i class="fas fa-times mr-2"></i>Cancelar solicitação
                        </button>
                    </div>
                </div>
            </div>
        </div>
    ` : '';

    appContainer.innerHTML = `
        <div class="screen screen-pad bg-black text-white">
            <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                <div class="flex flex-col items-center text-center -mt-6">
                    <i class="fas fa-heart text-3xl mb-3"></i>
                    <h2 class="text-3xl font-semibold">Pareamentos</h2>
                    <p class="text-white/80">Escolha sua conexão</p>
                </div>
            </section>

            <section class="px-5 pb-8 -mt-10">
                <div class="notif-shell max-w-2xl mx-auto space-y-6">
                    <div class="notif-card-white flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500">Pareamentos</p>
                            <p class="text-2xl font-semibold text-gray-800">${total}/${maximo}</p>
                        </div>
                        <span class="px-3 py-1 rounded-full text-xs font-bold border tracking-wide ${isVip ? 'bg-emerald-100 text-emerald-700 border-emerald-200' : 'bg-gray-200 text-gray-600 border-gray-300'}">${isVip ? 'POLIAMOR' : 'MONOGAMIA'}</span>
                    </div>

                    <div class="space-y-4">
                        ${pareamentos.length ? pareamentos.map((partner, index) => {
                            const nome = partner.nome || 'Parceiro';
                            const foto = partner.fotoUrl;
                            const pareadoDesde = partner.pareadoDesde
                                ? new Date(partner.pareadoDesde).toLocaleDateString('pt-BR')
                                : '—';
                            return `
                                <div class="relative rounded-2xl p-4 bg-[#ff4457] shadow-[0_12px_30px_rgba(255,68,87,0.35)]">
                                    <button type="button" class="absolute top-3 right-3 p-1 text-black hover:text-black/70 transition" onclick="requestUnpairFromList(${index})" title="Desparear">
                                        <i class="fas fa-link-slash text-sm"></i>
                                    </button>
                                    <div class="flex items-center gap-4">
                                        <button class="w-20 h-20 rounded-full bg-white overflow-hidden flex items-center justify-center" onclick="abrirCatalogoPareamento(${index})">
                                            ${foto ? `<img src="${foto}" class="w-full h-full object-cover" alt="${nome}">` : `<i class="fas fa-user text-red-400 text-2xl"></i>`}
                                        </button>
                                        <div class="flex-1">
                                            <p class="text-lg font-semibold text-white">${nome}</p>
                                            <p class="text-xs text-white/80">Pareado desde: ${pareadoDesde}</p>
                                            <div class="mt-3 flex flex-col gap-2">
                                                <button onclick="handleCheckInFromList(${index})" class="px-4 py-2 rounded-lg font-semibold ${canCheckIn ? 'bg-emerald-500 hover:bg-emerald-600 text-white' : 'bg-gray-600 text-gray-300 cursor-not-allowed'}" ${canCheckIn ? '' : 'disabled'}>
                                                    <i class="fas fa-fire-flame-curved mr-2"></i>Check-in diário
                                                </button>
                                                <button onclick="abrirCatalogoPareamento(${index})" class="px-4 py-2 rounded-lg font-semibold bg-amber-500 hover:bg-amber-600 text-white">
                                                    <i class="fas fa-store mr-2"></i>Ir ao Catálogo
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('') : ''}
                        ${pendingCardHtml}
                        ${!pareamentos.length && !hasPending ? `
                            <div class="notif-card-white text-center">
                                <p class="text-sm text-gray-500">Nenhum pareamento ativo no momento.</p>
                            </div>
                        ` : ''}
                    </div>

                    <div class="text-center">
                        <button type="button" class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-white text-gray-800 font-semibold shadow-lg" onclick="handlePairingCtaClick()">
                            <i class="fas ${(hasPareamentos || hasPending) ? 'fa-gem text-blue-500' : 'fa-heart text-red-500'}"></i>
                            Adicionar Conexão
                        </button>
                    </div>
                </div>
            </section>
        </div>
        ${state.showPairingModal ? renderPairingModal() : ''}
        ${state.showVipPopup ? renderVipPopup() : ''}
    `;
}

function renderPairingModal() {
    const codigoUsuario = state.usuario?.telefone ? state.usuario.telefone.replace(/\D/g, '') : '';
    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closePairingModal()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closePairingModal()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Pareamento</p>
                        <h3 class="text-2xl font-semibold mt-1">Conectar com seu amor</h3>
                        <p class="text-sm text-white/70 mt-2">Digite o telefone e o apelido carinhoso para personalizar a conexão.</p>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closePairingModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mt-5 space-y-4">
                    <div class="rounded-2xl bg-white/5 border border-white/10 p-4">
                        <p class="text-xs text-white/60">Seu código</p>
                        <p class="text-lg font-semibold mt-1">${codigoUsuario || '—'}</p>
                    </div>

                    <div>
                        <label class="text-xs text-white/70">Telefone do parceiro (11 dígitos)</label>
                        <input id="codigoParceiro" inputmode="numeric" maxlength="11" placeholder="Ex: 11999999999" class="mt-2 w-full rounded-xl bg-white/10 border border-white/10 px-4 py-3 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-rose-400" />
                    </div>

                    <div>
                        <label class="text-xs text-white/70">Apelido carinhoso</label>
                        <input id="apelidoParceiro" maxlength="32" placeholder="Ex: Meu Amor" class="mt-2 w-full rounded-xl bg-white/10 border border-white/10 px-4 py-3 text-sm text-white placeholder:text-white/40 focus:outline-none focus:ring-2 focus:ring-rose-400" />
                    </div>
                </div>

                <div class="mt-6 flex flex-col gap-3">
                    <button onclick="sendPairingRequest()" class="w-full rounded-xl bg-gradient-to-r from-rose-500 to-red-500 py-3 text-white font-semibold shadow-lg">Enviar solicitação</button>
                    <button onclick="closePairingModal()" class="w-full rounded-xl bg-white/10 py-3 text-white/80 font-semibold">Cancelar</button>
                </div>
            </div>
        </div>
    `;
}

function openPairingModal() {
    state.showPairingModal = true;
    renderPareamentosLista();
}

function closePairingModal() {
    state.showPairingModal = false;
    renderPareamentosLista();
}

function handlePairingCtaClick() {
    const hasPending = !!(state.usuario && state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_'));
    const hasPareamentos = buildPareamentosLista().length > 0;
    if (hasPareamentos || hasPending) {
        openVipPopup();
        return;
    }
    openPairingModal();
}

function renderVipPopup() {
    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closeVipPopup()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closeVipPopup()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Ambiente VIP</p>
                        <h3 class="text-2xl font-semibold mt-1">Acesso exclusivo</h3>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closeVipPopup()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="mt-4 rounded-2xl bg-white/5 border border-white/10 p-4 text-sm text-white/80">
                    Ambiente VIP: para se tornar um usuário VIP e usufruir dos benefícios, entre em contato com <span class="text-white font-semibold">faleconosco@nossomomento.app</span>.
                </div>

                <div class="mt-6">
                    <button onclick="closeVipPopup()" class="w-full rounded-xl bg-white/10 py-3 text-white/80 font-semibold">Entendi</button>
                </div>
            </div>
        </div>
    `;
}

function renderLegalModal() {
    const type = state.legalModalType || 'terms';
    const isTerms = type === 'terms';
    const title = isTerms ? 'Termos de Uso' : 'Política de Privacidade';
    const content = isTerms
        ? `Ao utilizar o Nosso Momento, você concorda em usar o app de forma responsável, respeitando seu par e as regras do serviço. Você é responsável pelas informações fornecidas e pelos conteúdos enviados.`
        : `Nós coletamos apenas os dados necessários para oferecer a melhor experiência no app, como informações de conta, pareamento e interações. Seus dados não são vendidos e ficam protegidos pelos serviços do Firebase.`;

    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closeLegalModal()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closeLegalModal()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Consentimento</p>
                        <h3 class="text-2xl font-semibold mt-1">${title}</h3>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closeLegalModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-4 rounded-2xl bg-white/5 border border-white/10 p-4 text-sm text-white/80 leading-relaxed">
                    ${content}
                </div>
                <div class="mt-6">
                    <button onclick="closeLegalModal()" class="w-full rounded-xl bg-white/10 py-3 text-white/80 font-semibold">Entendi</button>
                </div>
            </div>
        </div>
    `;
}

function renderInstagramModal() {
    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closeInstagramModal()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closeInstagramModal()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Instagram</p>
                        <h3 class="text-2xl font-semibold mt-1">Siga o Nosso Momento</h3>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closeInstagramModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-4 rounded-2xl bg-white/5 border border-white/10 p-4 text-sm text-white/80 leading-relaxed">
                    Você será direcionado para o Instagram em uma nova aba.
                </div>
                <div class="mt-6 flex gap-3">
                    <button onclick="closeInstagramModal()" class="flex-1 rounded-xl bg-white/10 py-3 text-white/80 font-semibold">Agora não</button>
                    <button onclick="confirmInstagramRedirect()" class="flex-1 rounded-xl bg-gradient-to-r from-pink-500 to-red-500 py-3 text-white font-semibold">Abrir Instagram</button>
                </div>
            </div>
        </div>
    `;
}

function renderEditNameModal() {
    const nomeAtual = state.usuario?.nome || '';
    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closeEditNameModal()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closeEditNameModal()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Perfil</p>
                        <h3 class="text-2xl font-semibold mt-1">Editar nome</h3>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closeEditNameModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <input id="editNameInput" type="text" value="${nomeAtual}" class="w-full" placeholder="Seu nome">
                </div>
                <div class="mt-6 flex gap-3">
                    <button onclick="closeEditNameModal()" class="flex-1 rounded-xl bg-white/10 py-3 text-white/80 font-semibold">Cancelar</button>
                    <button onclick="submitEditName()" class="flex-1 rounded-xl bg-gradient-to-r from-pink-500 to-red-500 py-3 text-white font-semibold">Salvar</button>
                </div>
            </div>
        </div>
    `;
}

function renderSystemModal() {
    const isConfirm = state.systemModalType === 'confirm';
    return `
        <div class="fixed inset-0 z-40 bg-black/70 backdrop-blur-sm" onclick="closeSystemModal()"></div>
        <div class="fixed inset-0 z-50 flex items-center justify-center px-4" onclick="closeSystemModal()">
            <div class="w-full max-w-md rounded-3xl bg-[#120b16] text-white shadow-2xl border border-white/10 p-6 sm:p-7" onclick="event.stopPropagation()">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-xs uppercase tracking-widest text-white/60">Atenção</p>
                        <h3 class="text-2xl font-semibold mt-1">${isConfirm ? 'Confirmação' : 'Aviso'}</h3>
                    </div>
                    <button class="text-white/70 hover:text-white" onclick="closeSystemModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-4 rounded-2xl bg-white/5 border border-white/10 p-4 text-sm text-white/80 leading-relaxed">
                    ${state.systemModalMessage || ''}
                </div>
                <div class="mt-6 flex gap-3">
                    ${isConfirm ? `<button onclick="closeSystemModal()" class="flex-1 rounded-xl bg-white/10 py-3 text-white/80 font-semibold">${state.systemModalCancelText || 'Cancelar'}</button>` : ''}
                    <button onclick="confirmSystemModal()" class="flex-1 rounded-xl bg-gradient-to-r from-pink-500 to-red-500 py-3 text-white font-semibold">${state.systemModalConfirmText || 'OK'}</button>
                </div>
            </div>
        </div>
    `;
}

function openVipPopup() {
    state.showVipPopup = true;
    renderPareamentosLista();
}

function closeVipPopup() {
    state.showVipPopup = false;
    renderPareamentosLista();
}

function openLegalModal(type) {
    state.legalModalType = type || 'terms';
    state.showLegalModal = true;
    renderApp();
}

function closeLegalModal() {
    state.showLegalModal = false;
    state.legalModalType = null;
    renderApp();
}

function openInstagramModal() {
    state.showInstagramModal = true;
    renderApp();
}

function closeInstagramModal() {
    state.showInstagramModal = false;
    renderApp();
}

function confirmInstagramRedirect() {
    closeInstagramModal();
    window.open('https://instagram.com/nossomomentoapp', '_blank');
}

function openSystemConfirm(message, onConfirm, options = {}) {
    state.systemModalType = 'confirm';
    state.systemModalMessage = message || '';
    state.systemModalConfirmText = options.confirmText || 'Confirmar';
    state.systemModalCancelText = options.cancelText || 'Cancelar';
    state.systemModalOnConfirm = typeof onConfirm === 'function' ? onConfirm : null;
    state.showSystemModal = true;
    renderApp();
}

function openSystemAlert(message, options = {}) {
    state.systemModalType = 'alert';
    state.systemModalMessage = message || '';
    state.systemModalConfirmText = options.confirmText || 'Entendi';
    state.systemModalCancelText = '';
    state.systemModalOnConfirm = null;
    state.showSystemModal = true;
    renderApp();
}

function closeSystemModal() {
    state.showSystemModal = false;
    state.systemModalMessage = '';
    state.systemModalOnConfirm = null;
    renderApp();
}

function confirmSystemModal() {
    const action = state.systemModalOnConfirm;
    closeSystemModal();
    if (typeof action === 'function') {
        action();
    }
}

function openEditNameModal() {
    if (!state.usuario) {
        return;
    }
    state.editNameValue = state.usuario.nome || '';
    state.showEditNameModal = true;
    renderApp();
}

function closeEditNameModal() {
    state.showEditNameModal = false;
    state.editNameValue = '';
    renderApp();
}

async function submitEditName() {
    if (!state.usuario) {
        return;
    }

    const input = document.getElementById('editNameInput');
    const rawValue = input ? input.value : state.editNameValue;
    const nomeAtual = state.usuario.nome || '';
    const nomeFormatado = (rawValue || '').trim();

    if (!nomeFormatado || nomeFormatado === nomeAtual) {
        closeEditNameModal();
        return;
    }

    try {
        await db.collection('usuarios').doc(state.usuario.uid).update({
            nome: nomeFormatado
        });
        state.usuario.nome = nomeFormatado;
        closeEditNameModal();
        renderMeuPerfil();
        updateFixedUI();
    } catch (error) {
        console.error('Erro ao atualizar nome:', error);
        showToast('Não foi possível atualizar o nome.', 'aviso');
    }
}

function requestUnpairFromList(index) {
    const pareamentos = buildPareamentosLista();
    const partner = pareamentos[index];
    if (!partner || !partner.uid) {
        showToast('Parceiro inválido para desfazer pareamento.', 'erro');
        return;
    }

    state.usuario.pareadoUid = partner.uid;
    state.parceiroNome = partner.nome || state.parceiroNome;
    state.idPareamentoAmigavel = partner.pareamentoId || state.idPareamentoAmigavel;
    state.parceiroData = {
        ...(state.parceiroData || {}),
        uid: partner.uid,
        nome: partner.nome,
        fotoUrl: partner.fotoUrl || '',
        sexo: partner.sexo || null,
        catalogoPersonalizado: partner.catalogoPersonalizado || {},
    };

    desparearParceiro();
}

async function handleCheckInFromList(index) {
    const pareamentos = buildPareamentosLista();
    const partner = pareamentos[index];
    if (!partner || !partner.uid) {
        showToast('Parceiro inválido para check-in.', 'erro');
        return;
    }

    const lastCheckIn = state.usuario?.lastCheckInDate?.toDate
        ? state.usuario.lastCheckInDate.toDate()
        : (state.usuario?.lastCheckInDate ? new Date(state.usuario.lastCheckInDate) : null);
    if (lastCheckIn && isSameDay(lastCheckIn, new Date())) {
        showToast('Check-in já realizado hoje.', 'aviso');
        renderPareamentosLista();
        return;
    }

    try {
        await safeAddInput({
            type: 'daily_check_in',
            fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
            partnerUid: partner.uid,
            pareamentoId: partner.pareamentoId || state.idPareamentoAmigavel || '',
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        });
        state.usuario.lastCheckInDate = new Date();
        showToast('Check-in enviado!', 'sucesso');
        renderPareamentosLista();
    } catch (error) {
        console.error('Erro ao enviar check-in:', error);
        showToast('Erro ao enviar check-in.', 'erro');
    }
}

function abrirCatalogoPareamento(index) {
    const pareamentos = buildPareamentosLista();
    const partner = pareamentos[index];
    if (!partner) {
        return;
    }

    if (partner.uid) {
        state.usuario.pareadoUid = partner.uid;
        state.parceiroNome = partner.nome || state.parceiroNome;
        state.idPareamentoAmigavel = partner.pareamentoId || state.idPareamentoAmigavel;
        state.parceiroData = {
            ...(state.parceiroData || {}),
            uid: partner.uid,
            nome: partner.nome,
            fotoUrl: partner.fotoUrl,
            sexo: partner.sexo || state.parceiroData?.sexo || null,
            catalogoPersonalizado: partner.catalogoPersonalizado || state.parceiroData?.catalogoPersonalizado || {},
        };
    }

    state.etapa = 'main';
    renderApp();
}

    // Nova função para renderizar o pop-up de Informações do Parceiro Pareado
    function renderPartnerInfoPopup() {
        const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
        const canCheckIn = state.pareado && (!lastCheckIn || !isSameDay(lastCheckIn, new Date()));

        appContainer.innerHTML = `
            <div class="screen screen-pad flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
                <div class="card p-8 max-w-md w-full relative overflow-hidden">
                    <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-pink-500 opacity-10"></div>
                    <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-red-500 opacity-10"></div>
                    <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-blue-500">
                        <i class="fas fa-user-heart mr-2"></i> Seu Parceiro
                    </h2>
                    <div class="text-center mb-6">
                        <p class="mb-2 text-xl">Nome: <span class="font-bold text-green-400">${state.parceiroNome || 'N/A'}</span></p>
                        <p class="mb-4 text-md text-gray-300">Telefone: ${state.parceiroCodigo || 'N/A'}</p>
                    </div>
                    <div class="space-y-4">
                        <button onclick="handleDailyCheckIn()" ${!canCheckIn ? 'disabled' : ''}
                            class="w-full text-sm px-6 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2
                            ${canCheckIn ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-700 text-gray-400 cursor-not-allowed'}">
                            <i class="fas fa-gift text-xs"></i> Presentear 🔥
                        </button>

                        <button onclick="desparearParceiro()" class="w-full text-sm bg-red-800 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition">
                            <i class="fas fa-unlink text-xs"></i> Desfazer Pareamento
                        </button>

                        <!-- Botão de seguir no Instagram (discreto, com borda em gradiente) -->
                        <button onclick="openInstagramModal()" class="instagram-cta-outline w-full">
                            <span class="instagram-cta-inner w-full justify-center">
                                <i class="fab fa-instagram text-xs"></i> Siga-nos no Instagram!
                            </span>
                        </button>

                        <button onclick="togglePartnerInfoPopup();" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded text-white font-semibold transition w-full">
                            Voltar
                        </button>
                    </div>
                </div>
            </div>
        `;
    }


    function renderMain() {
        if (!state.pareado || !state.parceiroData) {
            appContainer.innerHTML = `
                <div class="screen screen-pad bg-black text-white">
                    <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                        <div class="flex flex-col items-center text-center -mt-6">
                            <i class="fas fa-store text-3xl mb-3"></i>
                            <h2 class="text-3xl font-semibold">Catálogo</h2>
                            <p class="text-white/80">Escolha momentos para viver</p>
                        </div>
                    </section>
                    <section class="px-5 pb-8 -mt-10">
                        <div class="notif-shell max-w-2xl mx-auto">
                            <div class="notif-card-white text-center">
                                <h3 class="text-lg font-semibold text-red-500">Você ainda não está pareado(a)</h3>
                                <p class="text-sm text-gray-600 mt-2">Pareie com seu parceiro para acessar o catálogo de momentos.</p>
                                <button onclick="changeStep('parear')" class="mt-4 w-full py-2 rounded-lg bg-red-500 text-white font-semibold">
                                    Parear agora
                                </button>
                            </div>
                        </div>
                    </section>
                </div>
            `;
            return;
        }

        const partnerGender = state.parceiroData.sexo;
        const foguinhosConexao = getFoguinhosConexao(state.usuario?.pareadoUid || state.parceiroData?.uid || '');
        const momentosParaParceiro = state.momentosMestres.filter(m => m.targetGender === partnerGender || m.targetGender === 'Unisex');
        const catalogoParceiro = state.parceiroData.catalogoPersonalizado || {};
        const categorias = [...new Set(momentosParaParceiro.map(m => m.categoria))].map(nomeCat => {
            const momentoExemplo = state.momentosMestres.find(m => m.categoria === nomeCat);
            return {
                nome: nomeCat,
                emoji: momentoExemplo.emoji,
            };
        });

        const fotoParceiroUrl = state.parceiroData.fotoUrl || '/assets/icons/logo-instagram-white.png';

        appContainer.innerHTML = `
            <div class="screen screen-pad bg-black text-white">
                <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                    <div class="flex flex-col items-center text-center -mt-6">
                        <img src="${fotoParceiroUrl}" class="w-20 h-20 rounded-full object-cover border-2 border-white/40 mb-3">
                        <h2 class="text-3xl font-semibold">Catálogo de Momentos</h2>
                        <p class="text-white/80">${state.parceiroNome}</p>
                        <div class="mt-3 inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/20 text-white text-sm">
                            <i class="fas fa-fire text-yellow-200"></i>
                            <span>Seus foguinhos: ${Number.isFinite(foguinhosConexao) ? foguinhosConexao : 0}</span>
                        </div>
                    </div>
                </section>

                <section class="px-5 pb-8 -mt-10">
                    <div class="notif-shell max-w-5xl mx-auto space-y-6">
                        <div class="flex gap-2 overflow-x-auto pb-1 sm:flex-wrap sm:overflow-visible">
                            <button onclick="filtrarMomentos(null)" class="notif-tab ${!state.filtro ? 'active' : ''}">
                                Todos
                            </button>
                            ${categorias.map(cat => {
                                const displayName = cat.nome === 'Sair da Rotina' ? 'Rotina' : cat.nome;
                                return `
                                    <button onclick="filtrarMomentos('${cat.nome}')" class="notif-tab ${state.filtro === cat.nome ? 'active' : ''}">
                                        ${displayName}
                                    </button>
                                `;
                            }).join('')}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${(state.filtro ? momentosParaParceiro.filter(m => m.categoria === state.filtro) : momentosParaParceiro).map(momento => {
                                const configParceiro = catalogoParceiro[momento.nome];
                                const preco = configParceiro?.preco !== undefined ? configParceiro.preco : momento.intensidade * 2;
                                const bloqueado = configParceiro?.bloqueado || false;
                                const momentoParaCarrinho = { ...momento, custoFoguinhos: preco };
                                return `
                                    <div class="notification-card p-4 ${bloqueado ? 'opacity-50' : ''}">
                                        <div class="relative overflow-hidden rounded-xl">
                                            <img src="${momento.img}" alt="${momento.nome}" class="w-full h-40 object-cover">
                                            ${bloqueado ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><i class="fas fa-lock text-3xl text-white"></i></div>` : ''}
                                        </div>
                                        <div class="mt-4">
                                            <h3 class="font-semibold">${momento.nome}</h3>
                                            <div class="flex justify-between items-center mt-3">
                                                <span class="text-amber-300 text-sm flex items-center gap-1">
                                                    <i class="fas fa-fire"></i> ${preco} Foguinhos
                                                </span>
                                                <button onclick='adicionarAoCarrinho(${JSON.stringify(momentoParaCarrinho).replace(/"/g, "&quot;")})'
                                                    class="text-sm px-3 py-2 rounded-lg transition ${bloqueado ? 'bg-gray-700 cursor-not-allowed' : 'bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white'}"
                                                    ${bloqueado ? 'disabled' : ''}>
                                                    ${bloqueado ? '🔒' : 'Resgatar'}
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </section>
            </div>

            ${state.showCartSidebar ? renderCartSidebar() : ''}
        `;

        startDesafiosCountdown();
}

function renderCartSidebar() {
    const totalFoguinhos = state.carrinho.reduce((total, item) => {
        const valor = Number(item?.custoFoguinhos ?? 0);
        return total + (Number.isFinite(valor) ? valor : 0);
    }, 0);
    const saldoAtual = Number(state.usuario?.foguinhos ?? 0) || 0;
    const saldoFinal = saldoAtual - totalFoguinhos;

    const itemsHtml = state.carrinho.length === 0
        ? '<p class="text-white/70 text-center py-6">Seu carrinho está vazio.</p>'
        : state.carrinho.map((item, index) => {
            const imageHtml = item.img
                ? `<img src="${item.img}" alt="${item.nome}" class="w-full h-full object-cover">`
                : `<span class="text-2xl">${item.emoji || '🔥'}</span>`;

            return `
                <div class="bg-white rounded-2xl p-4 flex gap-3 items-center shadow-md">
                    <div class="w-16 h-16 rounded-xl bg-gray-100 flex items-center justify-center overflow-hidden">
                        ${imageHtml}
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-900">${item.emoji ? `${item.emoji} ` : ''}${item.nome}</h4>
                                <p class="text-xs text-gray-500">${item.categoria || 'Geral'}</p>
                            </div>
                            <button onclick="removerDoCarrinho(${index})" class="text-gray-400 hover:text-red-500">
                                <i class="fas fa-xmark"></i>
                            </button>
                        </div>
                        <div class="mt-2 flex items-center justify-between text-xs text-gray-500">
                            <span>Qtde: 1</span>
                            <span class="text-amber-500 font-semibold flex items-center gap-1">
                                <i class="fas fa-fire"></i> ${item.custoFoguinhos}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    return `
        <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
        <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-[#120b16] z-30 border-l border-white/10 p-6 overflow-y-auto" onclick="event.stopPropagation()">
            <div class="flex items-center justify-between mb-6">
                <button onclick="toggleCartSidebar()" class="text-white/70 hover:text-white">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <h3 class="text-lg font-semibold text-center flex-1">Meu carrinho</h3>
                <button class="text-white/70 hover:text-white" aria-label="Opções do carrinho">
                    <i class="fas fa-ellipsis-vertical"></i>
                </button>
            </div>

            <div class="space-y-3">
                ${itemsHtml}
            </div>

            <div class="mt-6 rounded-2xl bg-white/90 text-gray-900 p-4 shadow-sm">
                <h4 class="text-sm font-semibold mb-3">Resumo</h4>
                <div class="space-y-2 text-sm text-gray-600">
                    <div class="flex justify-between">
                        <span>Itens</span>
                        <span>${state.carrinho.length}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Meu Saldo</span>
                        <span class="font-semibold text-emerald-600">${saldoAtual}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Custo Total (Foguinhos)</span>
                        <span class="font-semibold text-red-500">-${totalFoguinhos}</span>
                    </div>
                    <div class="pt-2 mt-2 border-t border-gray-200 flex justify-between text-gray-900">
                        <span class="font-semibold">Saldo Final</span>
                        <span class="font-semibold">${saldoFinal}</span>
                    </div>
                </div>
            </div>

            <div class="mt-6">
                <button onclick="finalizarPedido()" 
                    class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-xl font-semibold transition-all ${state.carrinho.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                    ${state.carrinho.length === 0 ? 'disabled' : ''}>
                    Finalizar Pedido
                </button>
                <button onclick="toggleCartSidebar()" class="w-full mt-3 py-2 text-white/70 hover:text-white transition">
                    Continuar Resgatando
                </button>
            </div>
        </div>
    `;
}

function calcularPrecoBase(momento) {
    if (momento == null) {
        return 10;
    }

    const intensidade = Number(momento.intensidade);
    if (Number.isFinite(intensidade) && intensidade >= 0) {
        return intensidade * 2;
    }

    const custoFoguinhos = Number(momento.custoFoguinhos);
    if (Number.isFinite(custoFoguinhos) && custoFoguinhos >= 0) {
        return custoFoguinhos;
    }

    return 10;
}

function normalizarPreco(valor, fallback) {
    if (valor === '' || valor === null || valor === undefined) {
        return fallback;
    }

    const numero = Number(valor);
    return Number.isFinite(numero) && numero >= 0 ? numero : fallback;
}

async function marcarNotificacoesDeConquistaComoLidas() {
    if (!state.usuario?.uid || state.notificacoesConquistasNaoLidas <= 0) {
        return;
    }

    try {
        const batch = db.batch();
        let totalMarcadas = 0;

        state.notificacoes.forEach((notif) => {
            if (!notif.lida && (notif.tipo === 'achievement' || notif.icone === 'fa-trophy')) {
                const notifRef = db.collection('notificacoes').doc(notif.id);
                batch.update(notifRef, { lida: true });
                totalMarcadas++;
            }
        });

        if (totalMarcadas > 0) {
            await batch.commit();
            state.notificacoesConquistasNaoLidas = 0;
            updateFixedUI();
        }
    } catch (err) {
        console.error('Erro ao marcar conquistas como lidas:', err);
    }
}

function renderGerenciarCatalogo() {
const userGender = state.usuario?.sexo || 'Masculino';
const momentosDisponiveis = state.momentosMestres.filter(m => m.targetGender === userGender || m.targetGender === 'Unisex');
const catalogoSalvo = state.usuario?.catalogoPersonalizado || {};
const categorias = [...new Set(momentosDisponiveis.map(m => m.categoria))];
const fotoUrl = state.usuario?.fotoUrl || 'assets/icons/iconprincipal.png';
const conquistasNaoLidas = state.notificacoesConquistasNaoLidas || 0;
const muralBadgeHtml = conquistasNaoLidas > 0
    ? `<span class="px-3 py-1 rounded-full bg-red-600/80 text-white text-xs font-semibold shadow-lg shadow-red-900/40">${conquistasNaoLidas} novo${conquistasNaoLidas > 1 ? 's' : ''}</span>`
    : '';
const muralCardAccent = conquistasNaoLidas > 0
    ? 'ring-1 ring-yellow-400/60 shadow-lg'
    : 'hover:bg-gray-100';

let notificationButtonHtml = '';
if (window.Notification) {
    if (state.usuario && state.usuario.notificationsEnabled && Notification.permission === 'granted') {
        notificationButtonHtml = `
            <button onclick="handleNotificationToggle()" class="mt-4 bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-bell-slash"></i> Desativar Notificações
            </button>
        `;
    } else if (Notification.permission === 'denied') {
        notificationButtonHtml = `
            <button onclick="handleNotificationToggle()" class="mt-4 bg-gray-600 text-gray-400 font-bold py-2 px-4 rounded-lg cursor-not-allowed" title="Você precisa permitir as notificações nas configurações do seu navegador.">
                <i class="fas fa-ban"></i> Notificações Bloqueadas
            </button>
        `;
    } else {
        notificationButtonHtml = `
            <button onclick="handleNotificationToggle()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                <i class="fas fa-bell"></i> Ativar Notificações
            </button>
        `;
    }
}

appContainer.innerHTML = `
    <div class="screen screen-pad bg-black text-white">
        <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
            <div class="flex flex-col items-center text-center -mt-6">
                <i class="fas fa-store text-3xl mb-3"></i>
                <h2 class="text-3xl font-semibold">Meu Catálogo</h2>
                <p class="text-white/80">Gerencie preços e disponibilidade</p>
            </div>
        </section>

        <section class="px-5 pb-8 -mt-10">
            <div class="notif-shell max-w-5xl mx-auto space-y-6">
                <div class="space-y-4">
                    ${categorias.map(categoria => `
                        <div class="notification-card overflow-hidden">
                            <button onclick="toggleAccordion(this)" class="w-full p-4 text-left font-semibold text-base flex justify-between items-center text-white">
                                <span>${categoria}</span>
                                <i class="fas fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                                <div class="space-y-2 p-4 border-t border-white/10">
                                    ${momentosDisponiveis.filter(m => m.categoria === categoria).map(momento => {
                                        const configSalva = catalogoSalvo[momento.nome];
                                        const precoPadrao = calcularPrecoBase(momento);
                                        const preco = normalizarPreco(configSalva?.preco, precoPadrao);
                                        if (configSalva && configSalva.preco !== preco) {
                                            configSalva.preco = preco;
                                        }
                                        const bloqueado = configSalva?.bloqueado || false;
                                        return `
                                        <div class="p-2 flex items-start gap-3 sm:items-center sm:justify-between border-b border-white/10 last:border-b-0">
                                            <div class="flex items-start gap-3 flex-1 min-w-0">
                                                <img src="${momento.img}" class="w-14 h-14 rounded-lg object-cover shrink-0">
                                                <div class="min-w-0 flex-1">
                                                    <h3 class="text-sm font-semibold text-white truncate">${momento.nome}</h3>
                                                    <div class="mt-2 flex items-center gap-2 sm:hidden">
                                                        <label class="relative inline-flex items-center cursor-pointer">
                                                            <input type="checkbox" ${bloqueado ? 'checked' : ''} class="sr-only peer" id="bloqueado-${momento.nome.replace(/\s+/g, '-')}">
                                                            <div class="relative w-11 h-6 bg-pink-600 peer-checked:bg-gray-600 rounded-full transition-colors flex items-center justify-between px-1.5">
                                                                <i class="fas fa-lock text-white text-[9px]"></i>
                                                                <i class="fas fa-lock-open text-white text-[9px]"></i>
                                                            </div>
                                                            <div class="absolute top-0.5 left-[2px] w-5 h-5 bg-white rounded-full border border-gray-300 transition-transform transform peer-checked:translate-x-full"></div>
                                                        </label>
                                                        <div class="flex items-center gap-1 bg-transparent rounded-lg px-2 py-0.5">
                                                            <i class="fas fa-fire text-yellow-400 text-xs"></i>
                                                            <input type="number" min="0" step="1" value="${preco}" id="preco-${momento.nome.replace(/\s+/g, '-')}" class="no-number-spin bg-transparent w-14 h-6 text-center text-sm font-semibold text-white">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="hidden sm:flex items-center gap-2 sm:ml-auto">
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" ${bloqueado ? 'checked' : ''} class="sr-only peer" id="bloqueado-${momento.nome.replace(/\s+/g, '-')}">
                                                    <div class="relative w-11 h-6 bg-pink-600 peer-checked:bg-gray-600 rounded-full transition-colors flex items-center justify-between px-1.5">
                                                        <i class="fas fa-lock text-white text-[9px]"></i>
                                                        <i class="fas fa-lock-open text-white text-[9px]"></i>
                                                    </div>
                                                    <div class="absolute top-0.5 left-[2px] w-5 h-5 bg-white rounded-full border border-gray-300 transition-transform transform peer-checked:translate-x-full"></div>
                                                </label>
                                                <div class="flex items-center gap-1 bg-transparent rounded-lg px-2 py-0.5">
                                                    <i class="fas fa-fire text-yellow-400 text-xs"></i>
                                                    <input type="number" min="0" step="1" value="${preco}" id="preco-${momento.nome.replace(/\s+/g, '-')}" class="no-number-spin bg-transparent w-14 h-6 text-center text-sm font-semibold text-white">
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="text-center">
                    <button onclick="handleSaveCatalogo()" class="btn-red px-10 py-4">
                        Salvar Alterações
                    </button>
                </div>
            </div>
        </section>
    </div>

    ${state.showCartSidebar ? renderCartSidebar() : ''}
`;
}

function renderMeuPerfil() {
    const userName = state.usuario?.nome || 'Amor';
    const email = state.usuario?.email || '—';
    const telefone = state.usuario?.telefone || '—';
    const sexo = state.usuario?.sexo || '—';
    const idade = state.usuario?.idade ?? 'XX';
    const fotoUrl = state.usuario?.fotoUrl || '/assets/icons/iconprincipal.png';

    let notificationButtonHtml = '';
    if (window.Notification) {
        if (state.usuario && state.usuario.notificationsEnabled && Notification.permission === 'granted') {
            notificationButtonHtml = `
                <button onclick="handleNotificationToggle()" class="mt-4 bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg transition">
                    <i class="fas fa-bell-slash"></i> Desativar Notificações
                </button>
            `;
        } else if (Notification.permission === 'denied') {
            notificationButtonHtml = `
                <button onclick="handleNotificationToggle()" class="mt-4 bg-gray-600 text-gray-400 font-bold py-2 px-4 rounded-lg cursor-not-allowed" title="Você precisa permitir as notificações nas configurações do seu navegador.">
                    <i class="fas fa-ban"></i> Notificações Bloqueadas
                </button>
            `;
        } else {
            notificationButtonHtml = `
                <button onclick="handleNotificationToggle()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                    <i class="fas fa-bell"></i> Ativar Notificações
                </button>
            `;
        }
    }

    appContainer.innerHTML = `
        <div class="screen screen-pad bg-black text-white">
            <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                <div class="flex flex-col items-center text-center -mt-6">
                    <i class="fas fa-user text-3xl mb-3"></i>
                    <h2 class="text-3xl font-semibold">Meu Perfil</h2>
                    <p class="text-white/80">Seus dados e preferências</p>
                </div>
            </section>

            <section class="px-5 pb-8 -mt-10">
                <div class="notif-shell max-w-3xl mx-auto space-y-6">
                    <div class="rounded-2xl p-4 bg-[#ff4457] shadow-[0_12px_30px_rgba(255,68,87,0.35)]">
                        <div class="flex flex-col sm:flex-row sm:items-start gap-5">
                            <div class="flex flex-col items-start gap-3">
                                <div class="w-24 h-32 rounded-2xl bg-white overflow-hidden flex items-center justify-center">
                                    <img id="profilePicPreview" src="${fotoUrl}" class="w-full h-full object-cover" alt="Foto de perfil">
                                </div>
                                <label class="inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-900 text-white cursor-pointer">
                                    <i class="fas fa-camera"></i>
                                    Trocar foto
                                    <input type="file" accept="image/*" class="hidden" onchange="handleFileSelect(event)">
                                </label>
                            </div>
                            <div class="flex flex-col gap-4 flex-1">
                                <div class="flex items-center gap-2">
                                    <span class="text-xs uppercase tracking-wide text-white/80">Nome:</span>
                                    <span class="text-base font-semibold text-white">${userName}</span>
                                    <button type="button" onclick="handleEditarNome()" class="text-white/90 hover:text-white" aria-label="Editar nome">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-xs uppercase tracking-wide text-white/80">Idade:</span>
                                    <span class="text-base font-semibold text-white">${idade}</span>
                                </div>
                            </div>
                        </div>
                        <div id="uploadProgress" class="hidden mt-4 w-full bg-gray-200 rounded-full h-2">
                            <div id="uploadProgressBar" class="h-2 rounded-full bg-red-500 w-0"></div>
                        </div>
                    </div>

                    <div class="notification-card p-5">
                        <div class="space-y-3">
                            <div class="flex items-center justify-between border-b border-white/10 pb-3">
                                <span class="text-sm text-white/70">Telefone</span>
                                <span class="text-sm font-semibold">${telefone}</span>
                            </div>
                            <div class="flex items-center justify-between border-b border-white/10 pb-3">
                                <span class="text-sm text-white/70">Sexo</span>
                                <span class="text-sm font-semibold">${sexo}</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <span class="text-sm text-white/70">Email</span>
                                <span class="text-sm font-semibold">${email}</span>
                            </div>
                        </div>
                    </div>

                    <div class="notif-card-white p-5">
                        <h3 class="text-lg font-semibold text-gray-800">Notificações</h3>
                        <p class="text-sm text-gray-500">Ao ativar, você receberá mensagens de push com as movimentações dentro do app.</p>
                        ${notificationButtonHtml}
                    </div>

                </div>
            </section>
        </div>
    `;
}

function toggleMostrarConquistas() {
    state.mostrarTodasConquistas = !state.mostrarTodasConquistas;
    renderAchievementsPopup();
}

function setDesafiosTab(tab) {
    if (state.desafiosTab !== tab) {
        state.desafiosTab = tab;
        renderAchievementsPopup();
    }
}

async function handleSaveCatalogo() {
console.log('Iniciando salvamento do catálogo...');
const novoCatalogo = {}; // 1. Começamos com um objeto vazio.

// 2. Para cada momento da nossa lista mestra...
state.momentosMestres.forEach(momento => {
    // Montamos os IDs dos campos na tela, como fizemos ao criá-los.
    const idPreco = `preco-${momento.nome.replace(/\s+/g, '-')}`;
    const idBloqueado = `bloqueado-${momento.nome.replace(/\s+/g, '-')}`;

    const inputPreco = document.getElementById(idPreco);
    const inputBloqueado = document.getElementById(idBloqueado);

    // Verificamos se encontramos os campos na tela, por segurança.
    if (inputPreco && inputBloqueado) {
        // 3. Coletamos os valores.
        const precoPadrao = calcularPrecoBase(momento);
        const preco = normalizarPreco(inputPreco.value, precoPadrao);
        const bloqueado = inputBloqueado.checked; // 'checked' será true ou false.

        // 4. Montamos o objeto para este momento específico.
        novoCatalogo[momento.nome] = {
            preco: preco,
            bloqueado: bloqueado
        };
    }
});

try {
    // 5. Usamos o comando 'update' para salvar o novo mapa no Firestore.
    await db.collection('usuarios').doc(state.usuario.uid).update({
        catalogoPersonalizado: novoCatalogo
    });

    // 6. Atualizamos o estado local para manter tudo sincronizado.
    state.usuario.catalogoPersonalizado = novoCatalogo;

    trackGAEvent('customize_catalog');
    trackMetaEvent('CustomizeProduct');

    // 7. Damos um feedback de sucesso.
    showToast('Seu catálogo foi salvo com sucesso!', 'sucesso');
    console.log('Catálogo salvo no Firestore:', novoCatalogo);

} catch (error) {
    console.error("Erro ao salvar o catálogo: ", error);
    openSystemAlert('Houve um erro ao salvar seu catálogo. Tente novamente.');
}
}

async function carregarMomentosMestres() {
    console.log("Buscando momentos mestres no Firestore...");

    state.momentosMestres = [];

    try {
        const querySnapshot = await db.collection('momentosMestres')
            .orderBy('nome') // Opcional: ordenar por nome
            .get();

        const momentosPorChave = new Map();

        querySnapshot.forEach(doc => {
            const data = { id: doc.id, ...doc.data() };
            if (!data || !data.nome) {
                console.warn('Documento de momento sem nome ignorado:', doc.id);
                return;
            }
            const dedupeKey = `${data.nome}::${data.targetGender || 'any'}`;
            if (!momentosPorChave.has(dedupeKey)) {
                momentosPorChave.set(dedupeKey, data);
            } else {
                const existente = momentosPorChave.get(dedupeKey);
                console.warn('Momento duplicado detectado no Firestore:', dedupeKey, 'doc existente:', existente.id, 'doc ignorado:', doc.id);
            }
        });

        state.momentosMestres = Array.from(momentosPorChave.values());

        // 2. Confirmação no console para nosso teste
        console.log(`✅ Sucesso: ${state.momentosMestres.length} momentos mestres carregados.`);
        console.log(state.momentosMestres); // <-- Mostra o que foi carregado

    } catch (error) {
        console.error("Erro ao carregar momentos mestres:", error);
        // Se falhar, como fallback, podemos carregar a lista antiga (mas por enquanto, só avisamos)
        showToast("Erro ao carregar catálogo de momentos.", "erro");
    }
}

function toggleAccordion(buttonElement) {
const content = buttonElement.nextElementSibling;
const isOpening = !content.classList.contains('open');

buttonElement.classList.toggle('open');
content.classList.toggle('open');

const finalizeTransition = (event) => {
    if (event.target !== content || event.propertyName !== 'max-height') return;
    if (content.classList.contains('open')) {
        content.style.maxHeight = 'none';
        content.style.overflow = 'visible';
    } else {
        content.style.maxHeight = '0';
        content.style.overflow = 'hidden';
    }
    content.removeEventListener('transitionend', finalizeTransition);
};

content.addEventListener('transitionend', finalizeTransition);

if (isOpening) {
    content.style.overflow = 'hidden';
    content.style.maxHeight = content.scrollHeight + 'px';
    if (content.scrollHeight === 0) {
        requestAnimationFrame(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
        });
    }
} else {
    if (content.style.maxHeight === 'none' || content.style.maxHeight === '') {
        content.style.maxHeight = content.scrollHeight + 'px';
        void content.offsetHeight;
    }
    content.style.overflow = 'hidden';
    requestAnimationFrame(() => {
        content.style.maxHeight = '0';
    });
}
}

async function handleNotificationToggle() {
const notificationsActive = state.usuario && state.usuario.notificationsEnabled && Notification.permission === 'granted';

if (Notification.permission === 'denied') {
    openSystemAlert("As notificações estão bloqueadas. Você precisa permitir manualmente nas configurações do seu navegador (clicando no ícone de cadeado 🔒 ao lado da URL).");
} else if (notificationsActive) {
    // Se está ativo, a ação é desativar
    await desativarNotificacoes();
} else {
    // Se não está ativo, a ação é ativar
    await solicitarPermissaoDeNotificacao();
}
}

function handleFileSelect(event) {
const file = event.target.files[0];
if (!file) {
    return; // O usuário não escolheu nenhum arquivo
}

// Validação simples: checa se é uma imagem e se tem menos de 5MB
if (!file.type.startsWith('image/')){
    openSystemAlert('Por favor, selecione um arquivo de imagem (jpg, png, etc.).');
    return;
}
if (file.size > 5 * 1024 * 1024) { // 5 Megabytes
    openSystemAlert('A imagem é muito grande. Por favor, escolha uma com menos de 5MB.');
    return;
}

// Mostra a pré-visualização da imagem na tela
const reader = new FileReader();
reader.onload = function(e) {
    const profilePicPreview = document.getElementById('profilePicPreview');
    if (profilePicPreview) {
        profilePicPreview.src = e.target.result;
    }
};
reader.readAsDataURL(file);

// Inicia o processo de upload
uploadProfilePic(file);
}

async function handleEditarNome() {
    if (!state.usuario) {
        return;
    }

    openEditNameModal();
}

// Função 2: Faz o upload do arquivo para o Firebase Storage
async function uploadProfilePic(file) {
if (!state.usuario) {
    openSystemAlert('Você precisa estar logado para enviar uma foto.');
    return;
}

// Mostra a barra de progresso
const progressContainer = document.getElementById('uploadProgress');
const progressBar = document.getElementById('uploadProgressBar');
if(progressContainer) progressContainer.classList.remove('hidden');

// 1. Define o caminho onde a imagem será salva no Storage
// Ex: profile_pics/UID_DO_USUARIO.jpg
const filePath = `profile_pics/${state.usuario.uid}/${file.name}`;
const fileRef = storage.ref(filePath);

// 2. Inicia o upload
const uploadTask = fileRef.put(file);

// 3. Acompanha o progresso do upload
uploadTask.on('state_changed', 
    (snapshot) => {
        // Atualiza a barra de progresso
        const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
        if(progressBar) progressBar.style.width = progress + '%';
        console.log('Upload is ' + progress + '% done');
    }, 
    (error) => {
        // Em caso de erro
        console.error("Erro no upload: ", error);
        openSystemAlert('Houve um erro ao enviar sua foto.');
        if(progressContainer) progressContainer.classList.add('hidden');
    }, 
    () => {
        // 4. Quando o upload terminar, pega a URL pública da imagem
        uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
            console.log('Arquivo disponível em', downloadURL);

            // 5. Salva a URL da foto no perfil do usuário no Firestore
            await db.collection('usuarios').doc(state.usuario.uid).update({
                fotoUrl: downloadURL
            });

            // 6. Atualiza o estado local e a UI
            state.usuario.fotoUrl = downloadURL;
            updateFixedUI(); // Chama a função para atualizar a header

            showToast('Foto de perfil atualizada com sucesso!', 'sucesso');
            if(progressContainer) progressContainer.classList.add('hidden'); // Esconde a barra
        });
    }
);
}

    // --- Funções de Manipulação de Eventos e Firebase Auth/Firestore ---

    async function handleSignIn() {
        const email = document.getElementById('signInEmail').value;
        const password = document.getElementById('signInPassword').value;

        if (!email || !password) {
            openSystemAlert('Por favor, preencha o email e a senha.');
            return;
        }

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            const user = userCredential.user;
            console.log('Usuário logado com sucesso:', user);

            await loadUserDataAndNavigate(user.uid, user.email);

            trackGAEvent('login', { method: 'Email' });
            trackMetaEvent('Login');

        } catch (error) {
            console.error('Erro no login:', error.code, error.message);
            let errorMessage = 'Erro ao fazer login. Verifique seu email e senha.';
            if (error.code === 'auth/user-not-found') {
                errorMessage = 'Nenhum usuário encontrado com este email.';
            } else if (error.code === 'auth/wrong-password') {
                errorMessage = 'Senha incorreta.';
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = 'Email inválido.';
            } else if (error.code === 'auth/invalid-credential') { 
                errorMessage = 'Credenciais inválidas. Verifique seu email e senha.';
            }
            openSystemAlert(errorMessage);
        }
    }

    async function handleRegister() {
const nome = document.getElementById('registerNome').value;
const email = document.getElementById('registerEmail').value;
const telefone = document.getElementById('registerTelefone').value;
const senha = document.getElementById('registerSenha').value;
const sexo = document.getElementById('registerSexo').value;

// Validação de Frontend
if (!nome || !email || !telefone || !senha || !sexo) {
    openSystemAlert('Por favor, preencha todos os campos.');
    return;
}
if (telefone.length !== 11 || !/^\d+$/.test(telefone)) {
    openSystemAlert('O telefone deve conter exatamente 11 dígitos numéricos (com DDD).');
    return;
}
if (senha.length < 6) {
     openSystemAlert('A senha deve ter no mínimo 6 caracteres.');
     return;
}

try {
    // 1. Criar usuário no Firebase Authentication
    const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
    const user = userCredential.user;
    console.log('Usuário criado no Auth:', user);

    // 2. Salvar dados adicionais no Firestore usando o UID do Firebase Auth como ID do documento
    await db.collection('usuarios').doc(user.uid).set({
        nome: nome,
        telefone: telefone,
        email: email,
        sexo: sexo,
        foguinhos: 10,
        lastCheckInDate: null,
        pareadoCom: null,
        catalogoPersonalizado: {}, // <-- NOSSA NOVA LINHA! Inicializa o catálogo.
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    console.log("Dados do usuário salvos com sucesso no Firestore!");

    trackGAEvent('sign_up');
    trackMetaEvent('CompleteRegistration');

    // Atualiza o estado local com os dados do novo usuário
    state.usuario = {
        uid: user.uid,
        email: user.email,
        nome,
        telefone,
        sexo,
        foguinhos: 10,
        lastCheckInDate: null,
        pareadoCom: null,
        catalogoPersonalizado: {}, // <-- E AQUI TAMBÉM, para consistência.
        conquistas: {},
        achievementStats: {}
    };
    state.conquistas = {};
    state.achievementStats = {};
    state.etapa = 'parear';
    renderApp();
    showToast('Cadastro realizado com sucesso! Você será redirecionado para o pareamento.', 'sucesso');

} catch (error) {
    console.error('Erro no cadastro:', error.code, error.message);
    let errorMessage = 'Erro ao cadastrar. Tente novamente.';
    if (error.code === 'auth/email-already-in-use') {
        errorMessage = 'Este email já está em uso. Tente fazer login ou use outro email.';
    } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'O formato do email é inválido.';
    } else if (error.code === 'auth/weak-password') {
        errorMessage = 'A senha é muito fraca (mínimo de 6 caracteres).';
    }
    openSystemAlert(errorMessage);
}
}

    async function handleLogout() {
try {
    // >>> DESLIGA O OUVINTE DE NOTIFICAÇÕES AQUI <<<
    if (unsubscribeNotifications) {
        unsubscribeNotifications();
        unsubscribeNotifications = null;
    }

    await auth.signOut();
    console.log('Usuário deslogado com sucesso!');
    
    // Resetar todo o estado da aplicação para o padrão inicial
    state.usuario = null;
    state.pareado = false;
    state.parceiroData = null;
    state.idPareamentoAmigavel = null;
    state.notificacoes = [];
    state.etapa = 'landing';
    state.carrinho = [];
    state.codigoUsuario = null;
    state.codigoDigitando = false;
    state.parceiroCodigo = null;
    state.parceiroTelefone = null;
    state.parceiroNome = null;
    state.showPartnerInfo = false;
    state.pendingPairingRequest = null;
    state.showCartSidebar = false;
    state.showFoguinhosPopup = false;
    state.conquistas = {};
    state.achievementStats = {};
    state.notificacoesTarefasNaoLidas = 0;
    state.notificacoesPresentesNaoLidas = 0;
    state.notificacoesConquistasNaoLidas = 0;
    state.showPairingModal = false;
        state.showVipPopup = false;
    state.pendingPartnerName = null;

    renderApp(); // Volta para a tela inicial
} catch (error) {
    console.error('Erro ao deslogar:', error);
    showToast('Erro ao fazer logout.', 'erro');
}
}

    async function handleDailyCheckIn() {
if (!state.pareado || !state.usuario || !state.usuario.pareadoUid) {
    showToast('Você precisa estar pareado para presentear.', 'aviso');
    return;
}

try {
    await safeAddInput({
        type: 'daily_check_in',
        fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
        partnerUid: state.usuario.pareadoUid,
        timestamp: firebase.firestore.FieldValue.serverTimestamp(),
    });

    trackGAEvent('gift_foguinho');
    trackMetaEvent('GiftFoguinho');

    showToast(`Presente enviado!`, 'sucesso');
} catch (error) {
    console.error('Erro ao realizar Presentear (Check-in) diário:', error);
    showToast('Erro ao presentear. Tente novamente.', 'erro');
}
}


    function handleContinuarSemParear() {
        state.etapa = 'main';
        renderApp();
    }

    function filtrarMomentos(categoria) {
        state.filtro = categoria;
        renderApp(); // Re-renderiza a etapa atual, que é 'main'
    }

    async function adicionarAoCarrinho(momento) {
// Validação 1: Limite de itens no carrinho
if (state.carrinho.length >= 2) {
    showToast('Limite de 2 itens no carrinho!', 'aviso');
    return;
}

// Validação 2: Checa se o usuário está pareado
if (!state.pareado) {
    showToast('Você precisa estar pareado para resgatar momentos.', 'aviso');
    return;
}

const custo = momento.custoFoguinhos;
const foguinhosEmUso = state.carrinho.reduce((total, item) => total + item.custoFoguinhos, 0);
const saldoDisponivel = (state.usuario.foguinhos || 0) - foguinhosEmUso;
// Validação 3: Checa se o usuário tem "foguinhos" suficientes
if (saldoDisponivel < custo) {
    showToast(`Você precisa de ${custo} foguinhos para este momento.`, 'aviso');
    return;
}

state.carrinho = [...state.carrinho, momento];
trackGAEvent('add_to_cart', {
            currency: 'FOG', // Moeda customizada "Foguinhos"
            value: momento.custoFoguinhos,
            items: [{
                item_id: momento.nome.replace(/\s+/g, '_'), // ID do item (nome sem espaços)
                item_name: momento.nome,
                item_category: momento.categoria,
                price: momento.custoFoguinhos,
                quantity: 1
            }]
        });

trackMetaEvent('AddToCart', {
            currency: 'BRL', // A Meta prefere moedas reais, mas podemos ajustar se necessário.
            value: 0, // Como é moeda virtual, o valor monetário é 0
            content_name: momento.nome,
            content_ids: [momento.nome.replace(/\s+/g, '_')],
            content_type: 'product'
        });

showToast(`${momento.nome} adicionado ao carrinho!`, 'sucesso');
renderApp();
}

    async function removerDoCarrinho(index) {
const momentoRemovido = state.carrinho[index];
state.carrinho = state.carrinho.filter((_, i) => i !== index);
showToast(`Item removido do carrinho${momentoRemovido ? ` (${momentoRemovido.emoji || ''} ${momentoRemovido?.nome || ''})` : ''}.`, 'sucesso');
renderApp();
}

    async function desparearParceiro() {
        openSystemConfirm('Tem certeza que deseja desfazer o pareamento? Isso irá resetar os foguinhos de ambos os usuários para 0.', async () => {
            try {
                // Ao invés de tentar atualizar `usuarios` diretamente (que viola
                // regras de segurança para campos sensíveis), criaremos um
                // input que o backend processará com privilégios de Admin.
                // Use o uid do usuário autenticado no Auth (mais seguro)
                const currentUser = auth.currentUser;
                if (!currentUser) {
                    throw new Error('Usuário não autenticado. Faça login antes de desfazer o pareamento.');
                }
                const usuarioUid = currentUser.uid;
                const parceiroTelefone = state.parceiroCodigo || null;
                const parceiroUid = state.usuario.pareadoUid || (state.parceiroData && state.parceiroData.uid) || null;

                // Cria um input 'pairing_unpair' para o backend processar a
                // operação com privilégios administrativos.
                await safeAddInput({
                    type: 'pairing_unpair',
                    fromUid: usuarioUid,
                    partnerUid: parceiroUid || null,
                    partnerPhone: parceiroTelefone || null,
                });

                // Atualização otimista da UI (será corrigida pelo ouvinte do
                // documento do usuário assim que o backend aplicar as mudanças).
                state.pareado = false;
                state.parceiroCodigo = null;
                state.parceiroTelefone = null;
                state.parceiroNome = null;
                state.showPartnerInfo = false;
                state.usuario.pareadoCom = null;
                state.usuario.pareadoUid = null;
                state.carrinho = [];
                state.showCartSidebar = false;
                state.pareado = false;
                state.idPareamentoAmigavel = null;
                showToast('Solicitação de desfazer pareamento enviada. Aguardando processamento...', 'sucesso');
                renderApp();

            } catch (error) {
                console.error('Erro ao desfazer pareamento (criando input):', error);
                if (error && error.message && error.message.toLowerCase().includes('autenticado')) {
                    openSystemAlert(error.message);
                } else if (error && error.code === 'permission-denied') {
                    openSystemAlert('Permissão negada: sua sessão expirou ou você não está autenticado. Faça login novamente.');
                } else {
                    openSystemAlert('Erro ao desfazer pareamento. Tente novamente.');
                }
            }
        });
    }

    async function finalizarPedido() {
    // 1. Validações iniciais
    if (!state.pareado) {
        showToast('Você precisa estar pareado para finalizar o pedido.', 'aviso');
        return;
    }
    if (state.carrinho.length === 0) {
        showToast('Seu carrinho está vazio.', 'aviso');
        return;
    }

    if (!state.usuario || !state.usuario.pareadoUid) {
        showToast('Erro: parceiro pareado não encontrado.', 'erro');
        return;
    }

    try {
        const payload = {
            type: 'moment_redeem',
            fromUid: (auth.currentUser && auth.currentUser.uid) || state.usuario.uid,
            partnerUid: state.usuario.pareadoUid,
            pareamentoId: state.idPareamentoAmigavel || '',
            items: state.carrinho.map(item => ({
                nome: item.nome,
                emoji: item.emoji || '',
                categoria: item.categoria || 'Geral',
                custoFoguinhos: item.custoFoguinhos,
                img: item.img || '',
            })),
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
        };

        await safeAddInput(payload);

        const totalCost = state.carrinho.reduce((sum, item) => sum + item.custoFoguinhos, 0);
    trackGAEvent('purchase', {
        currency: 'FOG', // Moeda customizada "Foguinhos"
        value: totalCost,
        items: state.carrinho.map(item => ({
            item_id: item.nome.replace(/\s+/g, '_'),
            item_name: item.nome,
            item_category: item.categoria,
            price: item.custoFoguinhos,
            quantity: 1
        }))
    });

    trackMetaEvent('Purchase', {
        currency: 'BRL', // A Meta prefere moedas reais
        value: 0, // O valor monetário é 0, pois é moeda virtual
        content_ids: state.carrinho.map(item => item.nome.replace(/\s+/g, '_')),
        content_name: state.carrinho.map(item => item.nome).join(', '),
        content_type: 'product',
        num_items: state.carrinho.length
    });

        const totalItens = state.carrinho.length;
        const plural = totalItens > 1 ? 's' : '';
        showToast(`Pedido enviado! ${totalItens} momento${plural} aguardando confirmação.`, 'sucesso');

        // 7. Limpa o carrinho e atualiza a interface
        state.carrinho = [];
        state.showCartSidebar = false;
        renderApp();

    } catch (error) {
        console.error("Erro ao finalizar pedido e criar tarefas:", error);
        showToast("Ocorreu um erro ao finalizar o pedido.", "erro");
    }
}

    // Função para alternar a visibilidade do carrinho
    function toggleCartSidebar() {
        console.log('toggleCartSidebar chamada. state.showCartSidebar ANTES:', state.showCartSidebar);
        state.showCartSidebar = !state.showCartSidebar;
        console.log('state.showCartSidebar DEPOIS:', state.showCartSidebar);
        renderApp(); // Re-renderiza para exibir/esconder a sidebar
    }

    // --- Função Central de Renderização (Gerencia as etapas) ---
    function renderApp() {
        console.log('renderApp chamada. Etapa atual:', state.etapa, 'state.codigoDigitando:', state.codigoDigitando, 'state.showCartSidebar:', state.showCartSidebar, 'state.showFoguinhosPopup:', state.showFoguinhosPopup);
        if (document && document.body) {
            document.body.style.backgroundColor = state.etapa === 'memorias'
                ? '#f7f5f9'
                : '#000000';
        }
        // Atualiza os elementos da header e footer que são fixos no DOM
        updateFixedUI();

        if (state.etapa !== 'achievementsPopup' && state.desafiosCountdownId) {
            clearInterval(state.desafiosCountdownId);
            state.desafiosCountdownId = null;
        }
        
        // Renderiza o conteúdo principal dentro da #app
        switch (state.etapa) {
            case 'landing':
                renderLandingPage();
                break;
            case 'signIn':
                renderSignIn();
                break;
            case 'dashboard':
                renderDashboard();
                break;
            case 'register':
                if (REGISTRATION_ENABLED) {
                    renderRegister();
                } else {
                    state.etapa = 'signIn';
                    renderSignIn();
                }
                break;
            case 'parear':
                renderPareamento();
                break;
            case 'pareamentos':
                renderPareamentosLista();
                break;
            case 'main':
                renderMain();
                break;
            case 'momentos':
                renderMomentos();
                break;
            case 'memorias':
                loadMemoriasPosts().then(() => renderMemorias());
                break;
            case 'gerenciarCatalogo':
                renderGerenciarCatalogo();
                break;
            case 'notificacoes':
                renderNossasTarefas();
                break;
            case 'foguinhosPopup':
                renderFoguinhosPopupContent();
                break;
            case 'achievementsPopup':
                renderAchievementsPopup();
                break;
            case 'meuPerfil':
                renderMeuPerfil();
                break;
            default:
                renderLandingPage(); // Fallback
        }

        if (appContainer) {
            appContainer.innerHTML += `
                ${state.showLegalModal ? renderLegalModal() : ''}
                ${state.showInstagramModal ? renderInstagramModal() : ''}
                ${state.showEditNameModal ? renderEditNameModal() : ''}
                ${state.showSystemModal ? renderSystemModal() : ''}
            `;
        }
    }

    async function renderNossasTarefas() {
    
        // (Bloco de limpeza de notificações - marca todas como lidas ao abrir)
    try {
            const hasUnread = state.notificacoes && state.notificacoes.some((notif) => !notif.lida);
            if (hasUnread) {
            const batch = db.batch();
                let notificacoesLidas = 0;

            state.notificacoes.forEach(notif => {
                    if (!notif.lida) {
                    const notifRef = db.collection('notificacoes').doc(notif.id);
                    batch.update(notifRef, { lida: true });
                        notificacoesLidas++;
                }
            });

                if (notificacoesLidas > 0) {
                await batch.commit();
                    console.log(`Marcou ${notificacoesLidas} notificações como lidas.`);
                state.notificacoesTarefasNaoLidas = 0;
                    state.notificacoesPresentesNaoLidas = 0;
                    state.notificacoesConquistasNaoLidas = 0;
                updateFixedUI(); 
            }
        }
    } catch (err) {
            console.error("Erro ao marcar notificações como lidas:", err);
    }
    // (Fim do bloco de limpeza)

        const pendingCount = (state.notificacoesTarefasNaoLidas || 0) +
            (state.notificacoesPresentesNaoLidas || 0) +
            (state.notificacoesConquistasNaoLidas || 0);
        const hasPending = pendingCount > 0;
        const notifications = state.notificacoes || [];
        const tab = state.notificacoesTab || 'checkin';
        const filteredNotifications = notifications.filter((notif) => {
            if (tab === 'momentos') {
                return notif.icone === 'fa-shopping-bag';
            }
            if (tab === 'pareamento') {
                return notif.tipo === 'pairing' || notif.icone === 'fa-heart';
            }
            return notif.icone === 'fa-gift' || notif.tipo === 'checkin';
        });

        const notificationsHtml = filteredNotifications.length
            ? filteredNotifications.map((notif) => {
                const avatarUrl = notif.partnerPhotoUrl || notif.partnerFotoUrl || '';
                const iconClass = notif.icone || 'fa-bell';
                const timestamp = notif.timestamp && notif.timestamp.seconds
                    ? new Date(notif.timestamp.seconds * 1000).toLocaleString('pt-BR')
                    : '';
                let tabIcon = 'fa-fire';
                let tabIconColor = 'text-red-500';
                if (tab === 'momentos') {
                    tabIcon = 'fa-gift';
                    tabIconColor = 'text-amber-500';
                } else if (tab === 'pareamento') {
                    tabIcon = 'fa-heart';
                    tabIconColor = 'text-red-500';
                }
                return `
                    <div class="notif-item ${notif.lida ? 'opacity-70' : ''}">
                        ${avatarUrl
                            ? `<img src="${avatarUrl}" alt="Parceiro">`
                            : `<div class="notification-avatar"><i class="fas ${iconClass} text-lg text-white/80"></i></div>`}
                        <div class="flex-1">
                            <p class="text-sm font-semibold">${notif.titulo || 'Atualização'}</p>
                            <p class="text-sm text-gray-600">${notif.mensagem || 'Você recebeu uma atualização.'}</p>
                            ${timestamp ? `<p class="text-xs text-gray-500 mt-1">${timestamp}</p>` : ''}
                        </div>
                        <i class="fas ${tabIcon} ${tabIconColor}"></i>
                    </div>
                `;
            }).join('')
            : `<p class="text-center text-gray-500 py-8">Nenhuma notificação disponível.</p>`;

        const challengePending = !!state.pendingChallenge;
        appContainer.innerHTML = `
            <div class="screen screen-pad bg-black text-white">
                <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                    <div class="flex flex-col items-center text-center -mt-6">
                        <i class="fas fa-bell text-3xl mb-3"></i>
                        <h2 class="text-3xl font-semibold">Notificações</h2>
                        <p class="text-white/80">Veja as novidades do seu perfil</p>
                    </div>
                </section>

                <section class="px-5 pb-8 -mt-10">
                    <div class="notif-shell max-w-2xl mx-auto space-y-6">
                        <div class="flex gap-2">
                            <button class="notif-tab ${tab === 'checkin' ? 'active' : ''}" onclick="setNotificacoesTab('checkin')">Check-in</button>
                            <button class="notif-tab ${tab === 'momentos' ? 'active' : ''}" onclick="setNotificacoesTab('momentos')">Momentos</button>
                            <button class="notif-tab ${tab === 'pareamento' ? 'active' : ''}" onclick="setNotificacoesTab('pareamento')">Pareamento</button>
                        </div>

                        <div class="notif-list-shell space-y-3">
                            ${notificationsHtml}
                        </div>
                    </div>
                </section>
            </div>

            ${state.showChallengePopup ? renderChallengePopup() : ''}
        `;
}

async function renderMomentos() {
    const abaAtiva = state.abaTarefasAtiva || 'recebidos';
    appContainer.innerHTML = `
        <div class="screen screen-pad bg-black text-white">
            <section class="px-6 pt-20 pb-12" style="background: linear-gradient(180deg, #ff2d3f 0%, #ff5565 100%);">
                <div class="flex flex-col items-center text-center -mt-6">
                    <i class="fas fa-heart text-3xl mb-3"></i>
                    <h2 class="text-3xl font-semibold">Momentos</h2>
                    <p class="text-white/80">Recebidos e enviados</p>
                </div>
            </section>

            <section class="px-5 pb-8 -mt-10">
                <div class="notif-shell max-w-2xl mx-auto space-y-6">
                    <div class="flex gap-2">
                        <button class="notif-tab ${abaAtiva === 'recebidos' ? 'active' : ''}" onclick="trocarAbaTarefas('recebidos')">Recebidos</button>
                        <button class="notif-tab ${abaAtiva === 'enviados' ? 'active' : ''}" onclick="trocarAbaTarefas('enviados')">Enviados</button>
                    </div>

                    <div id="tarefas-list-container" class="notif-list-shell space-y-3">
                        <div class="text-center py-8">
                            <i class="fas fa-spinner fa-spin text-3xl text-red-500"></i>
                            <p class="mt-2 text-gray-500">Buscando momentos...</p>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    `;

    let tarefas = [];
    let queryField = '';

    if (abaAtiva === 'recebidos') {
        queryField = 'executadoPorUid';
    } else {
        queryField = 'resgatadoPorUid';
    }

    try {
        const querySnapshot = await db.collection('tarefasMomentos')
            .where(queryField, '==', state.usuario.uid)
            .where('idPareamento', '==', state.idPareamentoAmigavel)
            .orderBy('dataResgate', 'desc')
            .limit(30)
            .get();

        querySnapshot.forEach(doc => {
            tarefas.push({ id: doc.id, ...doc.data() });
        });
    } catch (error) {
        console.error("Erro ao buscar tarefas:", error);
        showToast("Erro ao carregar momentos.", "erro");
    }

    state.tarefasCache = tarefas;

    const container = document.getElementById('tarefas-list-container');
    if (!container) {
        return;
    }

    if (tarefas.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-8">Nenhum momento encontrado aqui.</p>`;
    } else {
        container.innerHTML = tarefas.map(tarefa => {
            const isPendente = tarefa.status === 'Pendente';
            const statusCor = isPendente ? 'text-yellow-500' : 'text-green-600';
            const statusIcon = isPendente ? 'fa-clock' : 'fa-check-circle';
            const dataFormatada = tarefa.dataResgate ? new Date(tarefa.dataResgate.seconds * 1000).toLocaleDateString('pt-BR') : 'Data indisponível';
            const momentoInfo = state.momentosMestres.find(m => m.nome === tarefa.momentoNome);
            const imagemHtml = momentoInfo
                ? `<img src="${momentoInfo.img}" class="w-12 h-12 rounded-lg object-cover">`
                : `<span class="text-2xl">${tarefa.momentoEmoji || '🔥'}</span>`;

            return `
                <div class="notif-item ${!isPendente ? 'opacity-70' : ''}">
                    ${imagemHtml}
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-gray-800">${tarefa.momentoNome}</p>
                        <p class="text-xs text-gray-500">
                            ${abaAtiva === 'recebidos' ? `Resgatado por: ${tarefa.resgatadoPorNome}` : `Aguardando: ${tarefa.executadoPorNome}`}
                        </p>
                        <p class="text-xs text-gray-400 mt-1">${dataFormatada}</p>
                    </div>
                    <div class="text-right">
                        <div class="flex items-center justify-end gap-1 ${statusCor} text-xs font-semibold mb-2">
                            <i class="fas ${statusIcon}"></i>
                            <span>${tarefa.status}</span>
                        </div>
                        ${(abaAtiva === 'enviados' && isPendente) ? `
                            <button onclick="requestRealizadoWithPhoto('${tarefa.id}', '${escapeJsString(tarefa.momentoNome || '')}', ${tarefa.custoFoguinhos || 0})"
                                class="bg-green-600 hover:bg-green-700 text-white text-xs font-medium py-1 px-2 rounded-lg inline-flex items-center gap-1">
                                <i class="fas fa-check"></i>
                                <span>Realizado</span>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    appContainer.innerHTML += `
        ${state.showRealizadoPhotoPrompt ? renderRealizadoPhotoPrompt() : ''}
    `;
}

function ensureMemoriasMonth() {
    if (state.memoriasMonth) return;
    const now = new Date();
    state.memoriasMonth = { year: now.getFullYear(), month: now.getMonth() };
}

function getMemoriasMonthLabel() {
    ensureMemoriasMonth();
    const { year, month } = state.memoriasMonth;
    const date = new Date(year, month, 1);
    return date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
}

function getMemoriasMonthRange() {
    ensureMemoriasMonth();
    const { year, month } = state.memoriasMonth;
    const start = new Date(year, month, 1, 0, 0, 0, 0);
    const end = new Date(year, month + 1, 0, 23, 59, 59, 999);
    return { startMs: start.getTime(), endMs: end.getTime() };
}

function buildMemoriasPairOptions() {
    const options = buildPareamentosLista();
    if (options.length) return options;
    if (state.parceiroData) {
        return [state.parceiroData];
    }
    return [];
}

function resolveMemoriasPairId(pair) {
    if (!pair || typeof pair !== 'object') return null;
    return pair.pareamentoId ||
        pair.pareamentoAmigavelId ||
        pair.idPareamento ||
        pair.idPareamentoAmigavel ||
        null;
}

function getMemoriasPairName(pair) {
    if (!pair || typeof pair !== 'object') return 'Pareamento';
    return pair.nome ||
        pair.apelido ||
        pair.nickname ||
        pair.partnerNickname ||
        pair.partnerName ||
        pair.name ||
        'Pareamento';
}

function getMemoriasPairPhoto(pair) {
    if (!pair || typeof pair !== 'object') return '/assets/icons/iconprincipal.png';
    return pair.fotoUrl ||
        pair.photoUrl ||
        pair.partnerPhotoUrl ||
        pair.avatarUrl ||
        '/assets/icons/iconprincipal.png';
}

function resolveMemoriaCategoria(item) {
    const momentoNome = item?.momentoNome || '';
    if (!momentoNome) return '';
    const momento = state.momentosMestres.find((m) => m.nome === momentoNome);
    return momento?.categoria || '';
}

function getMemoriasCategoriaCounts(items) {
    const counts = {
        lovezin: 0,
        sairRotina: 0,
        quentes: 0,
    };

    items.forEach((item) => {
        const categoria = resolveMemoriaCategoria(item);
        if (categoria === 'Lovezin') {
            counts.lovezin += 1;
        } else if (categoria === 'Sair da Rotina') {
            counts.sairRotina += 1;
        } else if (categoria === 'Quentes') {
            counts.quentes += 1;
        }
    });

    return counts;
}

function pickRandomMemoriaPhotoByCategoria(items, categoria) {
    const filtered = items.filter((item) => resolveMemoriaCategoria(item) === categoria);
    const photoUrls = filtered.map((item) => item.fotoUrl).filter(Boolean);
    if (!photoUrls.length) return null;

    let candidate = photoUrls[Math.floor(Math.random() * photoUrls.length)];
    if (photoUrls.length > 1 && candidate === state.memoriasShareLastPhoto) {
        candidate = photoUrls.find((url) => url !== state.memoriasShareLastPhoto) || candidate;
    }
    state.memoriasShareLastPhoto = candidate;
    return candidate;
}

function isLocalShareContext() {
    return window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost';
}

function getMemoriasSharePhotoUrl(items, categoria, fallbackUrl) {
    const candidate = pickRandomMemoriaPhotoByCategoria(items, categoria);
    let url = candidate || fallbackUrl || '/assets/icons/iconprincipal.png';

    try {
        const resolved = new URL(url, window.location.href);
        if (isLocalShareContext() && resolved.origin !== window.location.origin) {
            url = '/assets/icons/iconprincipal.png';
        }
    } catch {
        url = '/assets/icons/iconprincipal.png';
    }

    return url;
}

function ensureMemoriasPairSelection() {
    const options = buildMemoriasPairOptions();
    if (!options.length) {
        state.memoriasPairId = null;
        return;
    }

    if (state.memoriasPairId) return;

    const currentId = state.idPareamentoAmigavel || null;
    if (currentId) {
        state.memoriasPairId = currentId;
        return;
    }

    const fallbackId = resolveMemoriasPairId(options[0]);
    state.memoriasPairId = fallbackId || null;
}

function changeMemoriasMonth(delta) {
    ensureMemoriasMonth();
    const { year, month } = state.memoriasMonth;
    const date = new Date(year, month + delta, 1);
    state.memoriasMonth = { year: date.getFullYear(), month: date.getMonth() };
    loadMemoriasPosts().then(() => renderMemorias());
}

function toggleMemoriasPairMenu() {
    state.memoriasPairMenuOpen = !state.memoriasPairMenuOpen;
    renderMemorias();
}

function selectMemoriasPair(pairId) {
    state.memoriasPairId = pairId || null;
    state.memoriasPairMenuOpen = false;
    loadMemoriasPosts().then(() => renderMemorias());
}

async function loadMemoriasPosts() {
    const hasPairs = buildMemoriasPairOptions().length > 0;
    if (!hasPairs) {
        state.memoriasItems = [];
        state.memoriasHasMore = false;
        return;
    }

    ensureMemoriasMonth();
    ensureMemoriasPairSelection();

    state.memoriasLoading = true;
    try {
        const limit = state.memoriasLimit || 200;
        const { startMs, endMs } = getMemoriasMonthRange();
        const response = await safeFetchBackend(GET_MEMORIAS_URL, {
            limit,
            startMs,
            endMs,
            pareamentoId: state.memoriasPairId,
        });
        const items = Array.isArray(response?.items) ? response.items : [];
        state.memoriasHasMore = !!response?.hasMore;
        state.memoriasItems = items;
    } catch (err) {
        console.warn('Erro ao carregar memórias:', err);
        state.memoriasItems = [];
        state.memoriasHasMore = false;
    } finally {
        state.memoriasLoading = false;
    }
}

function openMemoriasFeed() {
    state.memoriasView = 'feed';
    state.memoriasLimit = 200;
    state.showMemoriasViewer = false;
    state.memoriasViewerIndex = null;
    loadMemoriasPosts().then(() => renderMemorias());
}

function loadMoreMemorias() {
    state.memoriasLimit += 9;
    loadMemoriasPosts().then(() => renderMemorias());
}

function openMemoriaViewer(index) {
    state.memoriasViewerIndex = index;
    state.showMemoriasViewer = true;
    renderMemorias();
}

function closeMemoriaViewer() {
    state.showMemoriasViewer = false;
    state.memoriasViewerIndex = null;
    renderMemorias();
}

function changeMemoriaViewer(delta) {
    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    if (!items.length) return;
    const current = Number(state.memoriasViewerIndex) || 0;
    let next = current + delta;
    if (next < 0) next = items.length - 1;
    if (next >= items.length) next = 0;
    state.memoriasViewerIndex = next;
    renderMemorias();
}

function renderMemoriaViewer() {
    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    const index = Number(state.memoriasViewerIndex) || 0;
    const item = items[index];
    if (!item) return '';
    return `
        <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center px-4" onclick="closeMemoriaViewer()">
            <div class="w-full max-w-md bg-white rounded-3xl p-5 shadow-2xl" onclick="event.stopPropagation()">
                <div class="relative">
                    <div class="w-full aspect-[3/4] overflow-hidden rounded-2xl">
                        <img src="${item.fotoUrl}" alt="Memória" class="w-full h-full object-cover">
                    </div>
                    <button onclick="changeMemoriaViewer(-1)" class="absolute left-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-black/30 text-white text-sm">&#10094;</button>
                    <button onclick="changeMemoriaViewer(1)" class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-full bg-black/30 text-white text-sm">&#10095;</button>
                </div>
                <p class="text-sm text-gray-600 mt-4">${item.descricao || ''}</p>
                <div class="mt-4 flex items-center justify-center gap-3">
                    <button onclick="closeMemoriaViewer()" class="w-11 h-11 rounded-full bg-gray-200 text-gray-600 flex items-center justify-center" aria-label="Fechar">
                        <i class="fas fa-times"></i>
                    </button>
                    <button onclick="requestDeleteMemoriaFromViewer('${item.id}')" class="w-11 h-11 rounded-full bg-red-500 text-white flex items-center justify-center" aria-label="Excluir foto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
}

function requestDeleteMemoriaFromViewer(memoriaId) {
    if (!memoriaId) return;
    openSystemConfirm('Tem certeza que deseja excluir esta foto?', async () => {
        try {
            await deleteMemoriaById(memoriaId);
        } catch (error) {
            console.error('Erro ao excluir memória:', error);
            openSystemAlert('Erro ao excluir a foto. Tente novamente.');
        }
    }, { confirmText: 'Excluir', cancelText: 'Cancelar' });
}

async function deleteMemoriaById(memoriaId) {
    await safeFetchBackend(DELETE_MEMORIA_URL, { memoriaId });

    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    const updated = items.filter((item) => item.id !== memoriaId);
    state.memoriasItems = updated;

    if (!updated.length) {
        state.showMemoriasViewer = false;
        state.memoriasViewerIndex = null;
    } else {
        const currentIndex = Number(state.memoriasViewerIndex) || 0;
        state.memoriasViewerIndex = Math.min(currentIndex, updated.length - 1);
    }

    renderMemorias();
    showToast('Foto excluída com sucesso!', 'sucesso');
}

function openMemoriasSharePicker() {
    state.memoriasShareModalOpen = true;
    renderMemorias();
}

function closeMemoriasSharePicker() {
    state.memoriasShareModalOpen = false;
    renderMemorias();
}

function renderMemoriasShareModal() {
    return `
        <div class="fixed inset-0 bg-black/70 z-50 flex items-center justify-center px-4" onclick="closeMemoriasSharePicker()">
            <div class="w-full max-w-sm bg-[#111827] border border-gray-700 rounded-3xl p-5 shadow-2xl" onclick="event.stopPropagation()">
                <h3 class="text-lg font-semibold text-white">Escolha o modelo</h3>
                <p class="text-sm text-gray-400 mt-1">Selecione o estilo do extrato.</p>
                <div class="mt-5 grid gap-3">
                    <button onclick="handleMemoriasShareChoice('simple')" class="w-full py-3 rounded-xl bg-gray-800 text-white font-semibold">Discreto</button>
                    <button onclick="handleMemoriasShareChoice('detailed')" class="w-full py-3 rounded-xl bg-gradient-to-r from-pink-500 to-red-500 text-white font-semibold">Detalhado</button>
                </div>
                <button onclick="closeMemoriasSharePicker()" class="mt-4 w-full py-2 rounded-xl bg-white/10 text-white/70">Cancelar</button>
            </div>
        </div>
    `;
}

function handleMemoriasShareChoice(mode) {
    state.memoriasShareModalOpen = false;
    state.memoriasSharePreviewOpen = true;
    state.memoriasSharePreviewMode = mode;
    state.memoriasSharePreviewUrl = null;
    state.memoriasSharePreviewFile = null;
    state.memoriasShareGenerating = true;
    renderMemorias();
    generateMemoriasSharePreview(mode);
}

function closeMemoriasSharePreview() {
    state.memoriasSharePreviewOpen = false;
    state.memoriasSharePreviewMode = null;
    state.memoriasSharePreviewUrl = null;
    state.memoriasSharePreviewFile = null;
    state.memoriasShareGenerating = false;
    renderMemorias();
}

function backToMemoriasSharePicker() {
    closeMemoriasSharePreview();
    openMemoriasSharePicker();
}

function renderMemoriasSharePreview() {
    const previewUrl = state.memoriasSharePreviewUrl;
    const isGenerating = state.memoriasShareGenerating;
    return `
        <div class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center px-4" onclick="closeMemoriasSharePreview()">
            <div class="w-full max-w-xs sm:max-w-sm bg-[#111827] border border-gray-700 rounded-3xl p-4 shadow-2xl" style="max-height:90vh;" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-white">Pré-visualização</h3>
                    <button onclick="closeMemoriasSharePreview()" class="w-9 h-9 rounded-full bg-white/10 text-white/70 flex items-center justify-center" aria-label="Fechar">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="mt-3 rounded-2xl overflow-hidden bg-black/30 flex items-center justify-center" style="max-height:55vh;">
                    ${isGenerating ? '<div class="py-12 text-sm text-gray-300">Gerando imagem...</div>' : `<img src="${previewUrl}" alt="Pré-visualização" style="width:100%;height:auto;max-height:55vh;object-fit:contain;">`}
                </div>
                <div class="mt-3 grid grid-cols-3 gap-3">
                    <button onclick="backToMemoriasSharePicker()" class="py-2 rounded-xl bg-white/10 text-white/80">Voltar</button>
                    <button onclick="shareMemoriasPreview()" class="py-2 rounded-xl bg-gradient-to-r from-pink-500 to-red-500 text-white font-semibold">Compartilhar</button>
                    <button onclick="saveMemoriasPreview()" class="py-2 rounded-xl bg-white text-red-600 font-semibold">Salvar</button>
                </div>
            </div>
        </div>
    `;
}

async function generateMemoriasSharePreview(mode) {
    try {
        const container = mode === 'simple'
            ? buildMemoriasShareContainerSimple()
            : buildMemoriasShareContainerDetailed();
        const result = await createMemoriasShareImage(container);
        state.memoriasSharePreviewUrl = result.dataUrl;
        state.memoriasSharePreviewFile = result.file;
    } catch (error) {
        console.error('Erro ao gerar preview:', error);
        openSystemAlert('Nao foi possivel gerar a pre-visualizacao.');
        state.memoriasSharePreviewOpen = false;
    } finally {
        state.memoriasShareGenerating = false;
        renderMemorias();
    }
}

async function shareMemoriasPreview() {
    const file = state.memoriasSharePreviewFile;
    if (!file) {
        openSystemAlert('Imagem ainda nao pronta.');
        return;
    }

    if (navigator.canShare && navigator.canShare({ files: [file] }) && navigator.share) {
        try {
            await navigator.share({ files: [file], title: 'Nosso Momento', text: 'Resumo de foguinhos do mes.' });
            showToast('Extrato pronto para compartilhar!', 'sucesso');
        } catch (error) {
            console.error('Erro ao compartilhar:', error);
        }
    } else {
        openSystemAlert('Compartilhamento nao suportado neste dispositivo.');
    }
}

function saveMemoriasPreview() {
    const dataUrl = state.memoriasSharePreviewUrl;
    if (!dataUrl) {
        openSystemAlert('Imagem ainda nao pronta.');
        return;
    }
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = `memorias-${Date.now()}.png`;
    document.body.appendChild(link);
    link.click();
    link.remove();
}

function buildMemoriasShareContainerSimple() {
    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    const totalFoguinhos = items.reduce((sum, item) => sum + (Number(item.custoFoguinhos) || 0), 0);
    const monthLabel = getMemoriasMonthLabel();
    const pairOptions = buildMemoriasPairOptions();
    const selectedPair = pairOptions.find((pair) => resolveMemoriasPairId(pair) === state.memoriasPairId) || null;
    const fallbackPhoto = getMemoriasPairPhoto(selectedPair);
    const photoUrl = getMemoriasSharePhotoUrl(items, 'Sair da Rotina', fallbackPhoto);

    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.style.top = '0';
    container.style.width = '720px';
    container.style.height = '1280px';
    container.style.padding = '56px 48px 48px';
    container.style.borderRadius = '40px';
    container.style.background = 'linear-gradient(135deg, #ff2d3f 0%, #ff5565 100%)';
    container.style.color = '#ffffff';
    container.style.fontFamily = 'Poppins, sans-serif';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.justifyContent = 'space-between';
    container.innerHTML = `
        <div style="text-align:center;">
            <img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento" style="height:60px;width:auto;display:inline-block;">
            <div style="font-size:16px;letter-spacing:3px;text-transform:uppercase;opacity:0.9;margin-top:6px;">Resumo de ${monthLabel.toUpperCase()}</div>
        </div>
        <div style="width:100%;display:flex;justify-content:center;">
            <div style="width:360px;height:360px;border-radius:40px;border:6px solid rgba(255,255,255,0.6);background:rgba(255,255,255,0.1);overflow:hidden;">
                <img src="${photoUrl}" alt="Momento" style="width:100%;height:100%;object-fit:cover;" crossorigin="anonymous">
            </div>
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;text-align:center;width:100%;max-width:640px;align-self:center;justify-items:stretch;">
        <div style="background:rgba(0,0,0,0.12);border-radius:18px;padding:40px 10px;align-items:center;display:flex;flex-direction:column;width:100%;">
                <div style="font-size:90px;">🔥</div><br></br>
                <div style="font-size:55px;font-weight:800;margin-top:8px;">${totalFoguinhos}</div><br>
                <div style="font-size:27px;letter-spacing:1px;opacity:0.9;">INVESTIDOS NO<br>NOSSO AMOR</div>
            </div>
            <div style="background:rgba(0,0,0,0.12);border-radius:18px;padding:40px 10px;align-items:center;display:flex;flex-direction:column;width:100%;">
                <div style="font-size:90px;">❤️</div><br></br>
                <div style="font-size:55px;font-weight:800;margin-top:8px;">${totalFoguinhos}</div><br>
                <div style="font-size:27px;letter-spacing:1px;opacity:0.9;">MOMENTOS<br>RESGATADOS</div>
            </div>
            </div>
        <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0b;padding:14px 18px;border-radius:18px;">
            <img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento" style="height:26px;">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;">
                <i class="fab fa-instagram"></i>
                <span>/nossomomentoapp</span>
            </div>
        </div>
    `;

    return container;
}

function buildMemoriasShareContainerDetailed() {
    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    const totalFoguinhos = items.reduce((sum, item) => sum + (Number(item.custoFoguinhos) || 0), 0);
    const monthLabel = getMemoriasMonthLabel();
    const counts = getMemoriasCategoriaCounts(items);
    const pairOptions = buildMemoriasPairOptions();
    const selectedPair = pairOptions.find((pair) => resolveMemoriasPairId(pair) === state.memoriasPairId) || null;
    const fallbackPhoto = getMemoriasPairPhoto(selectedPair);
    const photoUrl = getMemoriasSharePhotoUrl(items, 'Sair da Rotina', fallbackPhoto);

    const container = document.createElement('div');
    container.style.position = 'fixed';
    container.style.left = '-9999px';
    container.style.top = '0';
    container.style.width = '720px';
    container.style.height = '1280px';
    container.style.padding = '56px 48px 48px';
    container.style.borderRadius = '40px';
    container.style.background = 'linear-gradient(135deg, #ff2d3f 0%, #ff5565 100%)';
    container.style.color = '#ffffff';
    container.style.fontFamily = 'Poppins, sans-serif';
    container.style.display = 'flex';
    container.style.flexDirection = 'column';
    container.style.justifyContent = 'space-between';
    container.innerHTML = `
        <div style="text-align:center;">
            <img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento" style="height:60px;width:auto;display:inline-block;">
            <div style="font-size:20px;letter-spacing:3px;text-transform:uppercase;opacity:0.9;margin-top:6px;">Resumo de ${monthLabel.toUpperCase()}</div>
        </div>
        <div style="width:100%;display:flex;justify-content:center;">
            <div style="width:360px;height:360px;border-radius:40px;border:6px solid rgba(255,255,255,0.6);background:rgba(255,255,255,0.1);overflow:hidden;">
                <img src="${photoUrl}" alt="Momento" style="width:100%;height:100%;object-fit:cover;" crossorigin="anonymous">
            </div>
        </div>
        <div style="text-align:center;font-size:22px;font-weight:700;width:100%;max-width:560px;align-self:center;">${items.length} Momentos Resgatados em ${monthLabel}</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;text-align:center;">
            <div style="background:rgba(0,0,0,0.12);border-radius:18px;padding:40px 10px;">
                <div style="font-size:60px;">🍷</div><br></br>
                <div style="font-size:30px;font-weight:800;margin-top:8px;">${counts.sairRotina}x</div>
                <div style="font-size:20px;letter-spacing:1px;opacity:0.9;">SAIR DA ROTINA</div>
            </div>
            <div style="background:rgba(0,0,0,0.12);border-radius:18px;padding:40px 10px;">
                <div style="font-size:60px;">❤️</div><br></br>
                <div style="font-size:30px;font-weight:800;margin-top:8px;">${counts.lovezin}x</div>
                <div style="font-size:20px;letter-spacing:1px;opacity:0.9;">LOVEZIN</div>
            </div>
            <div style="background:rgba(0,0,0,0.12);border-radius:18px;padding:40px 10px;">
                <div style="font-size:60px;">🌶️</div><br></br>
                <div style="font-size:30px;font-weight:800;margin-top:8px;">${counts.quentes}x</div>
                <div style="font-size:20px;letter-spacing:1px;opacity:0.9;">QUENTES</div>
            </div>
        </div>
        <div style="display:flex;align-items:center;justify-content:center;gap:18px;width:100%;max-width:560px;align-self:center;">
            <div style="font-size:80px;transform:translateY(-30px);">🔥</div>
            <div style="font-size:90px;font-weight:900;line-height:1;transform:translateY(-30px);">${totalFoguinhos}</div>
            <div style="font-size:26px;font-weight:700;line-height:1.1;text-align:left;">Foguinhos Investidos<br>No Nosso Amor</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;background:#0b0b0b;padding:14px 18px;border-radius:18px;">
            <img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento" style="height:26px;">
            <div style="display:flex;align-items:center;gap:6px;font-size:12px;">
                <i class="fab fa-instagram"></i>
                <span>/nossomomentoapp</span>
            </div>
        </div>
    `;

    return container;
}

async function createMemoriasShareImage(container) {
    if (typeof html2canvas !== 'function') {
        throw new Error('html2canvas_missing');
    }

    document.body.appendChild(container);
    try {
        const images = Array.from(container.querySelectorAll('img'));
        images.forEach((img) => {
            if (!img.getAttribute('crossorigin')) {
                img.setAttribute('crossorigin', 'anonymous');
            }
        });
        await Promise.all(images.map((img) => {
            if (img.complete && img.naturalWidth) {
                return Promise.resolve();
            }
            return new Promise((resolve) => {
                const done = () => {
                    img.removeEventListener('load', done);
                    img.removeEventListener('error', done);
                    resolve();
                };
                img.addEventListener('load', done);
                img.addEventListener('error', done);
            });
        }));
        const canvas = await html2canvas(container, {backgroundColor: null, scale: 2, useCORS: true});
        const dataUrl = canvas.toDataURL('image/png');
        const blob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/png'));
        if (!blob) {
            throw new Error('share_blob_failed');
        }

        const file = new File([blob], `memorias-${Date.now()}.png`, { type: 'image/png' });
        return { dataUrl, file };
    } finally {
        container.remove();
    }
}


function renderMemoriasWelcome() {
    const fotoUsuario = state.usuario?.fotoUrl || '/assets/icons/iconprincipal.png';
    const fotoParceiro = state.parceiroData?.fotoUrl || '/assets/icons/iconprincipal.png';
    const podeRelembrar = !!(state.pareado && state.idPareamentoAmigavel);
    return `
        <div class="memorias-screen bg-[#f7f5f9] text-gray-900">
            <section class="px-6 pt-20 pb-10">
                <div class="flex flex-col items-center text-center">
                    <h2 class="text-lg tracking-wide text-gray-500">Bem vindos as suas</h2>
                    <h3 class="text-3xl font-semibold text-gray-900 mt-2">Memórias</h3>
                </div>
            </section>
            <section class="px-4 pb-8">
                <div class="max-w-md mx-auto bg-white rounded-3xl p-6 shadow-xl">
                    <div class="flex items-center justify-center gap-4">
                        <div class="w-20 h-20 rounded-full bg-pink-100 flex items-center justify-center overflow-hidden">
                            <img src="${fotoUsuario}" class="w-full h-full object-cover" alt="Você">
                        </div>
                        <div class="w-12 h-12 rounded-full bg-pink-500 flex items-center justify-center text-white text-xl">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="w-20 h-20 rounded-full bg-pink-100 flex items-center justify-center overflow-hidden">
                            <img src="${fotoParceiro}" class="w-full h-full object-cover" alt="Par">
                        </div>
                    </div>
                    ${podeRelembrar ? '' : '<p class="text-xs text-gray-500 mt-2 text-center">Pareie seu parceiro para começar a guardar memórias.</p>'}
                    <button onclick="${podeRelembrar ? 'openMemoriasFeed()' : ''}" class="w-full mt-5 py-3 rounded-full text-white font-semibold ${podeRelembrar ? 'bg-gradient-to-r from-pink-500 to-red-500' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}">Relembrar</button>
                    <button onclick="changeStep('dashboard')" class="w-full mt-3 py-3 rounded-full bg-gray-200 text-gray-600 font-semibold">Fechar</button>
                </div>
            </section>
        </div>
    `;
}

function renderMemoriasFeed() {
    const items = Array.isArray(state.memoriasItems) ? state.memoriasItems : [];
    const isLoading = !!state.memoriasLoading;
    const pairOptions = buildMemoriasPairOptions();
    ensureMemoriasMonth();
    ensureMemoriasPairSelection();
    const monthLabel = getMemoriasMonthLabel();
    const selectedPairId = state.memoriasPairId;
    const selectedPair = pairOptions.find((pair) => resolveMemoriasPairId(pair) === selectedPairId) || null;
    const pairName = getMemoriasPairName(selectedPair);
    const pairPhoto = getMemoriasPairPhoto(selectedPair);
    const totalFoguinhos = items.reduce((sum, item) => sum + (Number(item.custoFoguinhos) || 0), 0);

    if (!pairOptions.length) {
        appContainer.innerHTML = `
            <div class="memorias-screen bg-[#111827] text-white min-h-screen">
                <section class="px-6 pt-24 pb-10 text-center">
                    <h2 class="text-2xl font-bold">Sua Jornada</h2>
                    <p class="mt-3 text-sm text-gray-300">Pareie seu parceiro para visualizar suas memórias.</p>
                    <button onclick="changeStep('pareamentos')" class="mt-6 w-full max-w-xs mx-auto py-3 rounded-full bg-gradient-to-r from-red-500 to-orange-500 text-white font-semibold">Parear agora</button>
                </section>
            </div>
        `;
        return;
    }

    appContainer.innerHTML = `
        <div class="memorias-screen bg-[#111827] text-white min-h-screen">
            <section class="px-6 pt-20 pb-6 text-center">
                <div class="flex flex-col items-center text-center">
                    <i class="fas fa-book-open text-3xl mb-2 text-white/80"></i>
                    <h2 class="text-3xl font-semibold text-white">Memórias</h2>
                    <p class="text-sm text-white/70">Sua jornada registrada</p>
                </div>
                <div class="mt-4 flex items-center justify-center gap-2 w-full max-w-sm mx-auto">
                    <div class="relative flex-1 min-w-0">
                        <button onclick="toggleMemoriasPairMenu()" class="flex items-center gap-2 bg-gray-800 rounded-full px-3 py-2 w-full shadow-lg border border-gray-700">
                            <img src="${pairPhoto}" alt="${pairName}" class="w-7 h-7 rounded-full object-cover">
                            <span class="text-sm font-semibold text-gray-100 flex-1 text-left truncate">${pairName}</span>
                            <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
                        </button>
                        ${state.memoriasPairMenuOpen ? `
                            <div class="absolute left-0 right-0 mt-2 bg-gray-900 border border-gray-700 rounded-2xl shadow-xl overflow-hidden z-20">
                                ${pairOptions.map((pair) => {
                                    const optionId = resolveMemoriasPairId(pair);
                                    const optionName = getMemoriasPairName(pair);
                                    const optionPhoto = getMemoriasPairPhoto(pair);
                                    const isActive = optionId === selectedPairId;
                                    return `
                                        <button onclick="selectMemoriasPair('${optionId || ''}')" class="w-full flex items-center gap-3 px-4 py-3 text-left ${isActive ? 'bg-gray-800' : 'hover:bg-gray-800/60'}">
                                            <img src="${optionPhoto}" alt="${optionName}" class="w-7 h-7 rounded-full object-cover">
                                            <span class="text-sm text-gray-100 truncate">${optionName}</span>
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        ` : ''}
                    </div>
                    <div class="flex items-center justify-between bg-gray-800 rounded-full px-3 py-2 flex-1 min-w-0 shadow-lg border border-gray-700">
                        <button onclick="changeMemoriasMonth(-1)" class="text-gray-400 hover:text-white" aria-label="Mes anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span class="text-xs font-semibold text-gray-100 truncate">${monthLabel}</span>
                        <button onclick="changeMemoriasMonth(1)" class="text-gray-400 hover:text-white" aria-label="Proximo mes">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </section>

            <section class="px-5 pb-6">
                <div class="w-full max-w-sm mx-auto rounded-3xl p-6 relative overflow-hidden shadow-2xl bg-gradient-to-br from-pink-500 via-red-500 to-red-600">
                    <p class="text-xs text-white/80 uppercase tracking-widest">Resumo de ${monthLabel}</p>
                    <div class="mt-2 text-3xl font-extrabold text-white drop-shadow-md flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-fire text-amber-500"></i>
                        <span class="flex items-baseline gap-2">
                            <span>${totalFoguinhos}</span>
                            <span class="text-2xl font-semibold">Foguinhos investidos</span>
                        </span>
                    </div>
                    <p class="mt-2 text-sm text-white/90">Veja suas estatisticas e compartilhe o amor.</p>
                    <button onclick="openMemoriasSharePicker()" class="mt-4 w-full bg-white text-red-600 font-bold py-3 px-6 rounded-xl shadow-lg hover:bg-gray-50">Ver e Compartilhar</button>
                </div>
            </section>

            <section class="px-4 pb-20">
                <h3 class="text-lg font-bold text-white mb-4 pl-1">Galeria de Fotos</h3>
                <div class="grid grid-cols-2 gap-3">
                    ${items.map((item, index) => `
                        <button onclick="openMemoriaViewer(${index})" class="aspect-[3/4] overflow-hidden bg-gray-900 border border-gray-800">
                            <img src="${item.fotoUrl}" alt="Memoria" class="w-full h-full object-cover">
                        </button>
                    `).join('')}
                </div>
                ${!isLoading && items.length === 0 ? '<p class="text-center text-gray-400 mt-6">Nenhuma memoria neste mes.</p>' : ''}
                ${isLoading ? '<p class="text-center text-gray-400 mt-6">Carregando...</p>' : ''}
            </section>
        </div>
        ${state.showMemoriasViewer ? renderMemoriaViewer() : ''}
        ${state.memoriasShareModalOpen ? renderMemoriasShareModal() : ''}
        ${state.memoriasSharePreviewOpen ? renderMemoriasSharePreview() : ''}
    `;
}

function renderMemorias() {
    renderMemoriasFeed();
}

function trocarAbaTarefas(aba) {
    if (state.abaTarefasAtiva !== aba) {
        state.abaTarefasAtiva = aba;
        renderMomentos(); // Re-renderiza a tela com a nova aba
    }
}

function renderChallengePopup() {
    const secondsLeft = state.challengeSecondsLeft || 60;
    const disabled = secondsLeft <= 0;
    const pergunta = state.pendingChallenge?.pergunta || 'Pergunta indisponível.';
    return `
        <div class="fixed inset-0 bg-black/60 z-40 flex items-center justify-center px-4" onclick="closeChallengePopup()">
            <div class="w-full max-w-md rounded-3xl bg-white p-6 shadow-2xl" onclick="event.stopPropagation()">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-semibold bg-gradient-to-r from-pink-500 to-red-500 text-transparent bg-clip-text">Desafio da Semana</h3>
                    <button onclick="closeChallengePopup()" class="w-9 h-9 rounded-full bg-gray-100 text-gray-500 hover:text-gray-700 flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p class="text-base font-semibold text-gray-900 mb-2">${pergunta}</p>
                <p class="text-sm bg-gradient-to-r from-pink-500 to-red-500 text-transparent bg-clip-text mb-4">Responda igual ao seu par para ganhar o foguinho.</p>
                <div class="flex items-center justify-between mb-4">
                    <span class="text-xs text-pink-500">Tempo restante</span>
                    <span id="challengeCountdown" class="text-lg font-bold text-pink-500">${secondsLeft}s</span>
                </div>
                <input id="challengeAnswer" type="text" placeholder="Digite sua resposta" ${disabled ? 'disabled' : ''} class="w-full mb-4 uppercase border border-pink-200 rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-pink-300" oninput="this.value = this.value.toUpperCase()">
                <button onclick="submitWeeklyChallengeAnswer()" class="w-full py-2 rounded-xl ${disabled ? 'bg-gray-200 text-gray-400' : 'bg-gradient-to-r from-pink-500 to-red-500 text-white'}" ${disabled ? 'disabled' : ''}>
                    Enviar resposta
                </button>
                ${disabled ? '<p class="text-xs text-gray-400 mt-3">Tempo esgotado.</p>' : ''}
            </div>
        </div>
    `;
}

function renderRealizadoPhotoPrompt() {
    const hasPreview = !!state.pendingRealizadoPhotoData;
    const previewHtml = hasPreview
        ? `
            <div class="w-full aspect-[3/4] bg-white/10 overflow-hidden flex items-center justify-center mb-4">
                <img src="${state.pendingRealizadoPhotoData}" alt="Preview da foto" class="w-full h-full object-cover">
            </div>
        `
        : '';

    const actionsHtml = hasPreview
        ? `
            <div class="flex gap-3">
                <button onclick="confirmRealizadoWithPhoto()" class="flex-1 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-red-500 text-white font-semibold">Usar foto</button>
                <button onclick="openRealizadoPhotoPicker()" class="flex-1 py-2 rounded-lg bg-white/10 text-white/80">Trocar</button>
            </div>
            <button onclick="handleRealizadoPhotoChoice(false)" class="w-full mt-3 py-2 rounded-lg text-white/70 hover:text-white">Sem foto</button>
        `
        : `
            <div class="flex gap-3">
                <button onclick="handleRealizadoPhotoChoice(true)" class="flex-1 py-2 rounded-lg bg-gradient-to-r from-pink-500 to-red-500 text-white font-semibold">Sim</button>
                <button onclick="handleRealizadoPhotoChoice(false)" class="flex-1 py-2 rounded-lg bg-white/10 text-white/80">Não</button>
            </div>
        `;

    return `
        <div class="fixed inset-0 bg-black/80 z-40 flex items-center justify-center px-4" onclick="closeRealizadoPhotoPrompt()">
            <div class="card p-6 w-full max-w-sm" onclick="event.stopPropagation()">
                <h3 class="text-lg font-semibold text-white mb-2">Adicionar foto?</h3>
                <p class="text-sm text-gray-300 mb-4">Deseja incluir uma foto deste momento realizado?</p>
                ${previewHtml}
                ${actionsHtml}
                <input id="realizadoPhotoInput" type="file" accept="image/*" class="hidden" onchange="handleRealizadoPhotoSelect(event)">
            </div>
        </div>
    `;
}

function requestRealizadoWithPhoto(tarefaId, momentoNome, custoFoguinhos) {
    const tarefasCache = Array.isArray(state.tarefasCache) ? state.tarefasCache : [];
    const tarefa = tarefasCache.find((item) => item.id === tarefaId) || {};
    state.pendingRealizadoAction = {
        tarefaId,
        momentoNome,
        custoFoguinhos,
        pareamentoId: tarefa.idPareamento || state.idPareamentoAmigavel || null,
        executadoPorNome: tarefa.executadoPorNome || state.parceiroApelido || state.parceiroNome || 'Parceiro',
        resgatadoPorNome: tarefa.resgatadoPorNome || state.usuario?.nome || 'Você',
        executadoPorUid: tarefa.executadoPorUid || state.usuario?.pareadoUid || null,
        resgatadoPorUid: tarefa.resgatadoPorUid || state.usuario?.uid || null,
    };
    state.pendingRealizadoPhotoData = null;
    state.pendingRealizadoPhotoFile = null;
    state.showRealizadoPhotoPrompt = true;
    renderMomentos();
}

function closeRealizadoPhotoPrompt() {
    state.showRealizadoPhotoPrompt = false;
    state.pendingRealizadoAction = null;
    state.pendingRealizadoPhotoData = null;
    state.pendingRealizadoPhotoFile = null;
    renderMomentos();
}

function handleRealizadoPhotoChoice(shouldAdd) {
    const pending = state.pendingRealizadoAction;
    if (!pending) {
        closeRealizadoPhotoPrompt();
        return;
    }

    if (shouldAdd) {
        openRealizadoPhotoPicker();
        return;
    }

    state.showRealizadoPhotoPrompt = false;
    state.pendingRealizadoAction = null;
    state.pendingRealizadoPhotoData = null;
    state.pendingRealizadoPhotoFile = null;
    renderMomentos();
    handleDarCheck(pending.tarefaId, pending.momentoNome, pending.custoFoguinhos);
}

function openRealizadoPhotoPicker() {
    const input = document.getElementById('realizadoPhotoInput');
    if (input) {
        input.click();
    }
}

async function confirmRealizadoWithPhoto() {
    const pending = state.pendingRealizadoAction;
    if (!pending) {
        closeRealizadoPhotoPrompt();
        return;
    }

    state.showRealizadoPhotoPrompt = false;
    state.pendingRealizadoAction = null;
    const photoFile = state.pendingRealizadoPhotoFile;
    state.pendingRealizadoPhotoData = null;
    state.pendingRealizadoPhotoFile = null;
    renderMomentos();

    if (photoFile) {
        await createMemoriaPostFromPhoto(pending, photoFile);
    }
    handleDarCheck(pending.tarefaId, pending.momentoNome, pending.custoFoguinhos);
}

function handleRealizadoPhotoSelect(event) {
    const file = event.target.files && event.target.files[0];
    const pending = state.pendingRealizadoAction;

    if (!pending) {
        return;
    }

    if (file && file.type.startsWith('image/')) {
        state.pendingRealizadoPhotoFile = file;
        const reader = new FileReader();
        reader.onload = function(e) {
            state.pendingRealizadoPhotoData = e.target.result;
            state.showRealizadoPhotoPrompt = true;
            renderMomentos();
        };
        reader.readAsDataURL(file);
    } else {
        state.pendingRealizadoPhotoData = null;
        state.pendingRealizadoPhotoFile = null;
        state.showRealizadoPhotoPrompt = true;
        renderMomentos();
    }

    event.target.value = '';
}

function buildMemoriaDescricao(pending) {
    const executado = pending.executadoPorNome || 'Alguém';
    const resgatado = pending.resgatadoPorNome || 'seu par';
    const momentoNome = pending.momentoNome || 'um momento especial';
    return `${executado} realizou ${momentoNome} para ${resgatado} e esse foi o registro desse momento especial`;
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = (err) => reject(err);
        reader.readAsDataURL(file);
    });
}

async function uploadMemoriaPhoto(file, pending) {
    const dataUrl = await fileToBase64(file);
    const base64 = typeof dataUrl === 'string' && dataUrl.includes(',')
        ? dataUrl.split(',')[1]
        : null;

    if (!base64) {
        throw new Error('Falha ao ler a imagem.');
    }

    const safeName = (file.name || 'memoria').replace(/[^a-zA-Z0-9._-]/g, '_');
    return await safeFetchBackend(CREATE_MEMORIA_URL, {
        tarefaId: pending.tarefaId,
        fileName: safeName,
        contentType: file.type || 'image/jpeg',
        base64,
    });
}

async function createMemoriaPostFromPhoto(pending, file) {
    try {
        const pairUidsCheck = [pending.executadoPorUid, pending.resgatadoPorUid]
            .filter(Boolean);
        if (!pairUidsCheck.length) {
            return;
        }
        await uploadMemoriaPhoto(file, pending);
    } catch (err) {
        console.warn('Falha ao criar memória:', err);
        showToast('Não foi possível salvar a memória.', 'aviso');
    }
}

function setNotificacoesTab(tab) {
    if (state.notificacoesTab !== tab) {
        state.notificacoesTab = tab;
        renderNossasTarefas();
    }
}

function openChallengePopup() {
    state.showChallengePopup = true;
    state.challengePopupOpenedAt = Date.now();
    if (!state.challengeSecondsLeft || state.challengeSecondsLeft <= 0) {
        state.challengeSecondsLeft = 60;
    }
    if (state.challengeTimerId) {
        clearInterval(state.challengeTimerId);
    }
    renderNossasTarefas();
    state.challengeTimerId = setInterval(() => {
        if (state.challengeSecondsLeft <= 0) {
            clearInterval(state.challengeTimerId);
            state.challengeTimerId = null;
            const countdownEl = document.getElementById('challengeCountdown');
            if (countdownEl) {
                countdownEl.textContent = '0s';
            }
            return;
        }
        state.challengeSecondsLeft -= 1;
        const countdownEl = document.getElementById('challengeCountdown');
        if (countdownEl) {
            countdownEl.textContent = `${state.challengeSecondsLeft}s`;
        }
    }, 1000);
}

function openWeeklyChallengePopup(desafioId, evt) {
    if (evt && typeof evt.stopPropagation === 'function') {
        evt.preventDefault();
        evt.stopPropagation();
    }
    if (!state.pareado || !state.usuario?.pareadoUid) {
        showToast('Você precisa estar pareado para responder este desafio.', 'aviso');
        return;
    }
    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    const index = desafiosSemanais.findIndex((item) => item.id === desafioId);
    const desafio = index >= 0 ? desafiosSemanais[index] : null;
    if (!desafio) {
        return;
    }
    state.pendingChallenge = {
        id: desafio.id,
        titulo: desafio.titulo || 'Desafio da Semana',
        pergunta: desafio.pergunta || 'Pergunta indisponível.',
    };
    state.showChallengePopup = true;
    state.challengePopupOpenedAt = Date.now();
    const now = Date.now();
    const localStartMs = getLocalChallengeStartMs(desafio.id);
    let startedMs = getDateFromValue(desafio.startedAt || desafio.prazoInicio || desafio.startedEm)?.getTime();
    if (!Number.isFinite(startedMs)) {
        startedMs = Number.isFinite(localStartMs) ? localStartMs : null;
    }
    const isFinalizado = !!(desafio.concluido || desafio.completed || desafio.status === 'finalizado' || desafio.status === 'finalizado_sem_recompensa');
    const hasAnswer = !!(desafio.respostaUsuario || desafio.respostaParceiro);
    const isStale = startedMs && (now - startedMs >= 60000) && !isFinalizado && !hasAnswer;
    if (!startedMs || isStale) {
        startedMs = now;
        setLocalChallengeStartMs(desafio.id, startedMs);
        desafiosSemanais[index] = {
            ...desafio,
            startedAt: new Date(startedMs),
        };
        state.desafiosSemanais = desafiosSemanais;
        saveLocalWeeklyChallenge(desafiosSemanais[index]);
    } else {
        setLocalChallengeStartMs(desafio.id, startedMs);
    }
    state.activeWeeklyChallengeId = desafio.id;
    state.challengeDeadline = startedMs + 60000;
    const remainingMs = Math.max(0, (state.challengeDeadline || Date.now()) - Date.now());
    state.challengeSecondsLeft = Math.ceil(remainingMs / 1000);
    if (state.challengeTimerId) {
        clearInterval(state.challengeTimerId);
    }
    renderAchievementsPopup();
    state.challengeTimerId = setInterval(() => {
        if (!state.activeWeeklyChallengeId || !state.challengeDeadline) {
            clearInterval(state.challengeTimerId);
            state.challengeTimerId = null;
            return;
        }
        const remainingMs = Math.max(0, state.challengeDeadline - Date.now());
        state.challengeSecondsLeft = Math.ceil(remainingMs / 1000);
        const countdownEl = document.getElementById('challengeCountdown');
        if (countdownEl) {
            countdownEl.textContent = `${state.challengeSecondsLeft}s`;
        }
        if (remainingMs <= 0) {
            handleWeeklyChallengeTimeout(state.activeWeeklyChallengeId);
            clearInterval(state.challengeTimerId);
            state.challengeTimerId = null;
        }
    }, 1000);
}

function submitWeeklyChallengeAnswer() {
    const input = document.getElementById('challengeAnswer');
    const answer = (input && input.value ? input.value.trim().toUpperCase() : '');
    if (!answer) {
        showToast('Digite sua resposta antes de enviar.', 'aviso');
        return;
    }

    const challengeId = state.pendingChallenge?.id || 'alma_gemea';
    const result = applyWeeklyChallengeAnswer(
        challengeId,
        answer,
        state.usuario?.uid || null,
        state.usuario?.nome || null
    );

    state.showChallengePopup = false;
    state.activeWeeklyChallengeId = null;
    state.challengeDeadline = null;
    if (state.challengeTimerId) {
        clearInterval(state.challengeTimerId);
        state.challengeTimerId = null;
    }

    if (result.status === 'finalizado') {
        showToast('Respostas iguais! Desafio concluído.', 'sucesso');
    } else if (result.status === 'finalizado_sem_recompensa') {
        showToast('Respostas diferentes. Sem sincronia.', 'aviso');
    } else {
        showToast('Resposta enviada! Aguardando seu par.', 'sucesso');
    }
    renderAchievementsPopup();
}

function handlePartnerChallengeAnswer(desafioId, answer, partnerName) {
    const result = applyWeeklyChallengeAnswer(desafioId, answer, state.usuario?.pareadoUid || null, partnerName);
    if (result.status === 'finalizado') {
        showToast('Respostas iguais! Desafio concluído.', 'sucesso');
    } else if (result.status === 'finalizado_sem_recompensa') {
        showToast('Respostas diferentes. Sem sincronia.', 'aviso');
    }
    renderAchievementsPopup();
}

function closeChallengePopup() {
    if (state.challengePopupOpenedAt && Date.now() - state.challengePopupOpenedAt < 200) {
        return;
    }
    state.showChallengePopup = false;
    if (state.challengeTimerId && !state.activeWeeklyChallengeId) {
        clearInterval(state.challengeTimerId);
        state.challengeTimerId = null;
    }
    renderAchievementsPopup();
}

function handleWeeklyChallengeTimeout(desafioId) {
    const desafiosSemanais = Array.isArray(state.desafiosSemanais) ? state.desafiosSemanais : [];
    const index = desafiosSemanais.findIndex((item) => item.id === desafioId);
    if (index === -1) {
        return;
    }
    const desafioAtual = desafiosSemanais[index];
    desafiosSemanais[index] = {
        ...desafioAtual,
        status: 'finalizado_sem_recompensa',
        concluido: true,
        completedAt: new Date(),
        rewarded: false,
    };
    state.desafiosSemanais = desafiosSemanais;
    persistWeeklyChallenge(desafiosSemanais[index]);
    safeAddInput({
        type: 'weekly_challenge_timeout',
        challengeId: desafiosSemanais[index].challengeId || 'alma_gemea',
        challengeDocId: desafiosSemanais[index].id || desafioId,
        timedOutAt: Date.now(),
    }).catch((err) => console.warn('Falha ao enviar timeout do desafio:', err));
    state.showChallengePopup = false;
    state.activeWeeklyChallengeId = null;
    state.challengeDeadline = null;
    state.pendingChallenge = null;
    showToast('Tempo esgotado. Desafio finalizado sem recompensa.', 'aviso');
    renderAchievementsPopup();
}

async function handleDarCheck(tarefaId, momentoNome, custoFoguinhos) {
    if (!tarefaId) {
        console.error("ID da tarefa não fornecido.");
        return;
    }
    openSystemConfirm("Tem certeza que deseja marcar este momento como 'Realizado'?", async () => {
        try {
            const tarefaRef = db.collection('tarefasMomentos').doc(tarefaId);
            
            await tarefaRef.update({
                status: 'Realizado',
                dataConclusao: firebase.firestore.FieldValue.serverTimestamp()
            });

            trackGAEvent('complete_moment', {
                currency: 'FOG',
                value: custoFoguinhos,
                items: [{
                    item_id: (momentoNome || 'unknown').replace(/\s+/g, '_'),
                    item_name: momentoNome || 'unknown',
                    price: custoFoguinhos,
                    quantity: 1
                }]
            });

            trackMetaEvent('CompleteMoment', {
                currency: 'BRL',
                value: 0,
                content_name: momentoNome || 'unknown',
                content_ids: [(momentoNome || 'unknown').replace(/\s+/g, '_')]
            });
            // ==========================================================

            showToast("Momento confirmado com sucesso!", "sucesso");
            
            // Re-renderiza a tela para mostrar a mudança de status
            renderMomentos();

        } catch (error) {
            console.error("Erro ao confirmar tarefa:", error);
            showToast("Erro ao confirmar o momento.", "erro");
        }
    });
}

    // Função para mudar a etapa da aplicação
    function changeStep(newStep) {
// Bloqueia navegação para cadastro quando desativado
if (!REGISTRATION_ENABLED && newStep === 'register') {
    showToast('Cadastros estão fechados nesta fase.', 'aviso');
    newStep = 'signIn';
}
// Lógica de Navegação Simplificada
// Se o usuário clicar no ícone da tela em que ele já está...
if (state.etapa === newStep) {
    // ...e essa tela NÃO for a principal, então ele volta para a principal (efeito de fechar).
    if (newStep !== 'dashboard') {
        state.etapa = 'dashboard';
    } else {
        // Se ele já está na 'dashboard' e clica na 'dashboard', não faz nada.
        return;
    }
} else {
    // Se ele clicar em um ícone de uma tela DIFERENTE, ele navega para ela. Simples assim.
    state.etapa = newStep;
}

if (state.etapa === 'memorias') {
    state.memoriasView = 'welcome';
    state.showMemoriasViewer = false;
    state.memoriasViewerIndex = null;
}

// Reseta o estado de outros elementos da UI ao navegar
state.showCartSidebar = false;
state.showFoguinhosPopup = false;
state.showPartnerInfoPopup = false;
state.showAchievementsPopup = false;
state.showPairingModal = false;
state.showVipPopup = false;

// Renderiza a aplicação com o novo estado definido
renderApp();
}

    // Nova função para atualizar elementos da UI fixa (header e footer)
    function updateFixedUI() {
    // ATUALIZA O NOME DO USUÁRIO (igual)
    if (userNameDisplay) {
        userNameDisplay.textContent = state.usuario && state.usuario.nome ? `Olá, ${state.usuario.nome}!` : '';
    }

    // ATUALIZA FOTO DE PERFIL NA HEADER (igual)
    const headerPic = document.getElementById('headerProfilePic');
    if (headerPic && state.usuario) {
        const fotoPadrao = '/assets/icons/iconprincipal.png';
        headerPic.src = state.usuario.fotoUrl || fotoPadrao;
        headerPic.classList.remove('hidden');
    } else if (headerPic) {
        headerPic.classList.add('hidden');
    }

    // ==================================================================
    // LÓGICA ATUALIZADA (PONTO VERMELHO)
    // ==================================================================
    // CONTROLA PONTO VERMELHO DE NOTIFICAÇÃO (SÓ PARA TAREFAS)
    const notificationDot = document.getElementById('notificationDot');
    if (notificationDot) {
        // AGORA VERIFICA O CONTADOR DE TAREFAS
        if ((state.notificacoesTarefasNaoLidas || 0) + (state.notificacoesPresentesNaoLidas || 0) + (state.notificacoesConquistasNaoLidas || 0) > 0) {
            notificationDot.classList.remove('hidden');
        } else {
            notificationDot.classList.add('hidden');
        }
    }

    const notificationsButton = document.getElementById('notificationsButton');
    if (notificationsButton) {
        const pendingCount = (state.notificacoesTarefasNaoLidas || 0) +
            (state.notificacoesPresentesNaoLidas || 0) +
            (state.notificacoesConquistasNaoLidas || 0);
        if (pendingCount > 0) {
            notificationsButton.style.background = NOTIFICATION_HIGHLIGHT;
            notificationsButton.style.borderRadius = '999px';
            notificationsButton.style.padding = '6px';
        } else {
            notificationsButton.style.background = '';
            notificationsButton.style.borderRadius = '';
            notificationsButton.style.padding = '';
        }
    }

    // ATUALIZA OS BADGES DA BARRA DE NAVEGAÇÃO (igual)
    if (foguinhosBadge) {
        foguinhosBadge.textContent = state.usuario ? state.usuario.foguinhos : 0;
    }
    if (carrinhoBadge) {
        carrinhoBadge.textContent = state.carrinho.length;
    }

    // LÓGICA DE VISIBILIDADE DAS BARRAS (igual)
    if (bottomNavBar && mainHeader) {
        const telasComBarraVisivel = ['dashboard', 'main', 'momentos', 'memorias', 'parear', 'pareamentos', 'foguinhosPopup', 'partnerInfoPopup', 'gerenciarCatalogo', 'notificacoes', 'achievementsPopup', 'meuPerfil'];
        if (telasComBarraVisivel.includes(state.etapa)) {
            bottomNavBar.style.display = 'flex';
            mainHeader.style.display = 'flex';
        } else {
            bottomNavBar.style.display = 'none';
            mainHeader.style.display = 'none';
        }
    }

    const catalogActions = document.getElementById('catalogActions');
    if (catalogActions) {
        if (state.etapa === 'main') {
            catalogActions.classList.remove('hidden');
        } else {
            catalogActions.classList.add('hidden');
        }
    }

    // LÓGICA PARA CORES E ESTADO "ATIVO" DOS ÍCONES (atualizada)
    const bottomNavItems = document.querySelectorAll('.bottom-nav-bar .bottom-nav-item, .bottom-nav-bar .bottom-nav-item-center');
    
    // ==================================================================
    // NOVA LÓGICA DE COR (ÍCONE DE FOGO AMARELO)
    // ==================================================================
    // Primeiro, tratamos o ícone de fogo separadamente
    const foguinhosBtn = document.getElementById('foguinhosNavButton');
    if (foguinhosBtn) {
        // Limpa os estados de cor primeiro
        foguinhosBtn.classList.remove('active', 'text-yellow-400'); 
        
        if (state.etapa === 'foguinhosPopup') {
            // 1. Se a tela está ATIVA, fica ROSA (cor 'active')
            foguinhosBtn.classList.add('active');
        } else if (state.notificacoesPresentesNaoLidas > 0) {
            // 2. Se não está ativa, MAS TEM notificação, fica AMARELO
            foguinhosBtn.classList.add('text-yellow-400');
        }
        // 3. Se não for nenhum dos casos, ele fica com a cor padrão (cinza)
    }

    // Agora, tratamos o resto dos ícones (exceto o de fogo)
    bottomNavItems.forEach(item => {
        // Não mexemos no de fogo, pois já fizemos isso
        if (item.id === 'foguinhosNavButton') return; 

        item.classList.remove('active');
        
        // (Lógica do ícone de coração - continua igual)
        const heartIcon = item.querySelector('.fas.fa-heart');
        if (heartIcon) {
            heartIcon.classList.remove('text-red-500', 'text-yellow-400', 'text-gray-400');
            if (state.pareado) {
                heartIcon.classList.add('text-red-500');
            } else if (state.usuario && state.usuario.pareadoCom && state.usuario.pareadoCom.startsWith('pending_')) {
                heartIcon.classList.add('text-yellow-400');
            } else {
                heartIcon.classList.add('text-gray-400');
            }
        }

        // (Lógica de ativação dos outros botões - continua igual)
        if (item.querySelector('.fas.fa-store') && state.etapa === 'gerenciarCatalogo') {
            item.classList.add('active');
        } else if (item.querySelector('.fas.fa-heart') && (state.etapa === 'parear' || state.etapa === 'pareamentos' || state.etapa === 'partnerInfoPopup')) {
            item.classList.add('active');
        } else if (item.querySelector('.fas.fa-shopping-cart') && state.showCartSidebar) {
            item.classList.add('active');
        } else if (item.querySelector('.fas.fa-bell') && state.etapa === 'notificacoes') {
            item.classList.add('active');
        }
    });
}

    // Função para alternar a visibilidade do pop-up de Foguinhos
    function toggleFoguinhosPopup() {
        console.log('toggleFoguinhosPopup chamada. state.showFoguinhosPopup ANTES:', state.showFoguinhosPopup);
        if (state.etapa === 'foguinhosPopup') {
            state.etapa = 'main'; // Volta para a tela principal
        } else {
            state.etapa = 'foguinhosPopup'; // Vai para a tela do pop-up
        }
        state.showFoguinhosPopup = !state.showFoguinhosPopup; // Atualiza a flag para logs/referência
        renderApp();
        console.log('state.showFoguinhosPopup DEPOIS:', state.showFoguinhosPopup);
    }

    // Função para alternar a visibilidade do pop-up de Informações do Parceiro Pareado
    function togglePartnerInfoPopup() {
        console.log('togglePartnerInfoPopup chamada. state.showPartnerInfoPopup ANTES:', state.showPartnerInfoPopup);
        if (state.etapa === 'partnerInfoPopup') {
            state.etapa = 'main'; // Volta para a tela principal
        } else {
            state.etapa = 'partnerInfoPopup'; // Vai para a tela do pop-up de informações do parceiro
        }
        state.showPartnerInfoPopup = !state.showPartnerInfoPopup; // Atualiza a flag
        renderApp();
        console.log('state.showPartnerInfoPopup DEPOIS:', state.showPartnerInfoPopup);
    }

    function toggleAchievementsPopup() {
        console.log('toggleAchievementsPopup chamada. state.showAchievementsPopup ANTES:', state.showAchievementsPopup);
        if (state.etapa === 'achievementsPopup') {
            state.etapa = 'gerenciarCatalogo';
        } else {
            state.etapa = 'achievementsPopup';
        }
        state.showAchievementsPopup = !state.showAchievementsPopup;
        renderApp();
        console.log('state.showAchievementsPopup DEPOIS:', state.showAchievementsPopup);
    }

    // Carrega dados do usuário e do parceiro se pareado
    
async function loadUserDataAndNavigate(uid, email) {
console.log('loadUserDataAndNavigate chamada para UID:', uid);
await carregarMomentosMestres();
try {
    hasProcessedInitialConquistas = false;
    if (!uid) {
        console.error('UID do usuário é nulo ou indefinido em loadUserDataAndNavigate. Abortando carregamento.');
        state.etapa = 'landing';
        renderApp();
        return;
    }

    const userDoc = await db.collection('usuarios').doc(uid).get();
    if (userDoc.exists) {
    state.usuario = { uid: uid, email: email, ...userDoc.data() };
    state.parceirosAtivos = Array.isArray(state.usuario.pareamentosAtivos)
        ? state.usuario.pareamentosAtivos
        : [];
    state.usuario.notificationsEnabled = !!state.usuario.notificationsEnabled;
    state.usuario.conquistas = state.usuario.conquistas || {};
    state.usuario.achievementStats = state.usuario.achievementStats || {};
    state.conquistas = state.usuario.conquistas;
    state.achievementStats = state.usuario.achievementStats;
    state.pendingPartnerName = state.usuario.pendingPartnerName || state.pendingPartnerName || null;
        state.usuario.pareadoUid = state.usuario.pareadoUid || null;

        const wasPareado = state.pareado;
        const hasPairUid = !!(state.usuario.pareadoUid && typeof state.usuario.pareadoUid === 'string');
        const hasPairPhone = !!(state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && !state.usuario.pareadoCom.startsWith('pending_'));
        state.pareado = hasPairUid || hasPairPhone;
        if (!wasPareado && state.pareado && state.usuario?.pareadoUid) {
            ensureFirstPairingChallenge();
        }
        if (state.pareado && state.usuario?.pareadoUid) {
            setupWeeklyChallengeListener();
            applyLocalWeeklyChallenge();
        } else {
            state.desafiosSemanais = [];
            state.pendingChallenge = null;
        }

        if (state.pareado && state.pendingPartnerName && !state.parceiroApelido) {
            state.parceiroApelido = state.pendingPartnerName;
        }

        state.parceiroCodigo = state.usuario.pareadoCom || null;
        state.parceiroData = null;
        state.parceiroNome = null;
        state.parceiroTelefone = null;
        state.idPareamentoAmigavel = null;

        // >>> LIGA O OUVINTE DE NOTIFICAÇÕES AQUI <<<
        setupNotificationListener(uid);

        // LIGA O OUVINTE DE NOTIFICAÇÕES PUSH EM PRIMEIRO PLANO
        setupForegroundMessageHandler();

        if (state.pareado && state.usuario.pareadoUid) {
            const parceiroSnap = await db.collection('usuarios').doc(state.usuario.pareadoUid).get();
            if (parceiroSnap.exists) {
                const parceiroData = { uid: parceiroSnap.id, ...parceiroSnap.data() };
                state.parceiroData = parceiroData;
                state.parceiroNome = state.parceiroApelido || parceiroData.nome;
                state.parceiroCodigo = parceiroData.telefone || state.parceiroCodigo;
                if (parceiroData.telefone) {
                    state.parceiroTelefone = '55' + parceiroData.telefone.replace(/\D/g, '');
                }

                const telefoneUsuario = state.usuario.telefone ? state.usuario.telefone.replace(/\D/g, '') : null;
                const telefoneParceiro = parceiroData.telefone ? parceiroData.telefone.replace(/\D/g, '') : null;
                if (telefoneUsuario && telefoneParceiro) {
                    const telefonesOrdenados = [telefoneUsuario, telefoneParceiro].sort();
                    const idPareamentoDoc = telefonesOrdenados.join('_');
                    const pareamentoDoc = await db.collection('pareamentos').doc(idPareamentoDoc).get();
                    if (pareamentoDoc.exists && pareamentoDoc.data().idAmigavel) {
                        state.idPareamentoAmigavel = pareamentoDoc.data().idAmigavel;
                        console.log('ID Amigável carregado:', state.idPareamentoAmigavel);
                        setupWeeklyChallengeListener();
                    }
                }
            } else {
                console.warn('Parceiro pareado não encontrado no Firestore.');
                state.pareado = false;
                state.usuario.pareadoUid = null;
            }
        }

        if (!state.pareado) {
            state.parceiroData = null;
            state.idPareamentoAmigavel = null;
            state.desafiosSemanais = [];
            state.pendingChallenge = null;
            state.weeklyChallengeFromServer = false;
            state.activeWeeklyChallengeId = null;
            state.challengeDeadline = null;
            state.challengeSecondsLeft = 0;
            state.showChallengePopup = false;
            if (state.challengeTimerId) {
                clearInterval(state.challengeTimerId);
                state.challengeTimerId = null;
            }
        }
        
        state.etapa = 'dashboard';

        // Ouvinte em tempo real: documento do usuário (para refletir mudanças
        // feitas pelo backend, como remoção de pending quando rejeitado)
        if (unsubscribeUserDoc) {
            unsubscribeUserDoc();
            unsubscribeUserDoc = null;
        }
        unsubscribeUserDoc = db.collection('usuarios').doc(uid).onSnapshot((doc) => {
            if (!doc.exists) return;

            const docData = doc.data() || {};
            const previousConquistas = { ...(state.conquistas || {}) };
            const nextConquistas = docData.conquistas ? { ...docData.conquistas } : {};
            const newlyUnlockedIds = hasProcessedInitialConquistas
                ? Object.keys(nextConquistas).filter((achievementId) => nextConquistas[achievementId] && !previousConquistas[achievementId])
                : [];

            state.usuario = {
                uid: uid,
                email: email,
                ...docData,
                conquistas: nextConquistas,
                achievementStats: docData.achievementStats ? { ...docData.achievementStats } : {},
            };
            state.usuario.notificationsEnabled = !!state.usuario.notificationsEnabled;
            state.usuario.pareadoUid = state.usuario.pareadoUid || null;
            state.conquistas = nextConquistas;
            state.achievementStats = state.usuario.achievementStats;
            state.pendingPartnerName = docData.pendingPartnerName || state.pendingPartnerName;
            const wasPareado = state.pareado;
            const hasUidPair = !!(state.usuario.pareadoUid && typeof state.usuario.pareadoUid === 'string');
            const hasPhonePair = !!(state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && !state.usuario.pareadoCom.startsWith('pending_'));
            state.pareado = hasUidPair || hasPhonePair;
            if (!wasPareado && state.pareado && state.usuario?.pareadoUid) {
                ensureFirstPairingChallenge();
            }
            if (state.pareado && state.usuario?.pareadoUid) {
                setupWeeklyChallengeListener();
                applyLocalWeeklyChallenge();
            } else {
                state.desafiosSemanais = [];
                state.pendingChallenge = null;
            }
            state.parceiroCodigo = state.usuario.pareadoCom || null;
            if (state.pareado && state.pendingPartnerName && !state.parceiroApelido) {
                state.parceiroApelido = state.pendingPartnerName;
            }
            if (!state.pareado && (!state.usuario.pareadoCom || !state.usuario.pareadoCom.startsWith('pending_'))) {
                state.pendingPairingRequest = null;
                state.parceiroData = null;
                state.parceiroNome = null;
                state.parceiroTelefone = null;
                state.idPareamentoAmigavel = null;
                state.pendingPartnerName = null;
                state.parceiroApelido = null;
                state.desafiosSemanais = [];
                state.pendingChallenge = null;
                state.weeklyChallengeFromServer = false;
                state.activeWeeklyChallengeId = null;
                state.challengeDeadline = null;
                state.challengeSecondsLeft = 0;
                state.showChallengePopup = false;
                if (state.challengeTimerId) {
                    clearInterval(state.challengeTimerId);
                    state.challengeTimerId = null;
                }
            }

            if (state.pareado && state.usuario.pareadoUid && (!state.parceiroData || state.parceiroData.uid !== state.usuario.pareadoUid)) {
                db.collection('usuarios').doc(state.usuario.pareadoUid).get().then(async (partnerSnap) => {
                    if (partnerSnap.exists) {
                        const parceiroData = { uid: partnerSnap.id, ...partnerSnap.data() };
                        state.parceiroData = parceiroData;
                        state.parceiroNome = state.parceiroApelido || parceiroData.nome;
                        state.parceiroCodigo = parceiroData.telefone || state.usuario.pareadoCom || null;
                        state.parceiroTelefone = parceiroData.telefone ? '55' + parceiroData.telefone.replace(/\D/g, '') : null;

                        const telefoneUsuario = state.usuario.telefone ? state.usuario.telefone.replace(/\D/g, '') : null;
                        const telefoneParceiro = parceiroData.telefone ? parceiroData.telefone.replace(/\D/g, '') : null;
                        if (telefoneUsuario && telefoneParceiro) {
                            const telefonesOrdenados = [telefoneUsuario, telefoneParceiro].sort();
                            const idPareamentoDoc = telefonesOrdenados.join('_');
                            const pareamentoDoc = await db.collection('pareamentos').doc(idPareamentoDoc).get();
                            if (pareamentoDoc.exists && pareamentoDoc.data().idAmigavel) {
                                state.idPareamentoAmigavel = pareamentoDoc.data().idAmigavel;
                            }
                        }
                    }
                    renderApp();
                }).catch((err) => console.error('Erro ao carregar parceiro pareado:', err));
            }
            if (hasProcessedInitialConquistas && newlyUnlockedIds.length) {
                console.log('Conquistas novas detectadas via snapshot:', newlyUnlockedIds);
                newlyUnlockedIds.forEach((achievementId) => {
                    const celebrationInfo = showAchievementCelebration(achievementId);
                    if (celebrationInfo) {
                        const celebrationText = celebrationInfo.description
                            ? `${celebrationInfo.title}: ${celebrationInfo.description}`
                            : celebrationInfo.title;
                        showToast(`🏆 ${celebrationText}`, 'sucesso');
                    }
                });
            }
            hasProcessedInitialConquistas = true;
            renderApp();
        });

        // Ouvinte para solicitações pendentes onde este usuário é receiver
        if (unsubscribePendingPairing) {
            unsubscribePendingPairing();
            unsubscribePendingPairing = null;
        }
        unsubscribePendingPairing = db.collection('pairingRequests')
            .where('receiverUid', '==', uid)
            .where('status', '==', 'pending')
            .limit(1)
            .onSnapshot((snap) => {
                if (!snap.empty) {
                    const requestDoc = snap.docs[0];
                    state.pendingPairingRequest = { id: requestDoc.id, ...requestDoc.data() };
                    state.etapa = 'parear';
                } else if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_')) {
                    state.etapa = 'parear';
                    state.pendingPairingRequest = null;
                } else {
                    state.etapa = 'dashboard';
                }
                renderApp();
            });
    } else {
        console.log('Usuário logado via Auth, mas sem documento de perfil no Firestore.');
    state.usuario = { uid: uid, email: email, conquistas: {}, achievementStats: {} };
        if (REGISTRATION_ENABLED) {
            state.etapa = 'register';
            openSystemAlert('Por favor, complete seu cadastro para acessar todas as funcionalidades.');
        } else {
            state.etapa = 'signIn';
            openSystemAlert('Perfil incompleto. Entre em contato com o suporte do MVP.');
        }
    }
} catch (error) {
    console.error('Erro ao carregar dados do usuário:', error);
    state.etapa = 'landing';
} finally {
    renderApp();
}
}


    // Initialize app
    function init() {
        // Monitora o estado de autenticação do Firebase ao carregar a página
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('init: Usuário já logado no Auth:', user.email, user.uid);
                await loadUserDataAndNavigate(user.uid, user.email);
            } else {
                console.log('init: Nenhum usuário logado no Auth. Redirecionando para landing page.');
                // Limpa todo o estado do usuário ao deslogar
                state.usuario = null;
                state.pareado = false;
                state.etapa = 'landing';
                state.carrinho = [];
                state.codigoUsuario = null;
                state.codigoDigitando = false;
                state.parceiroCodigo = null;
                state.parceiroTelefone = null;
                state.parceiroNome = null;
                state.showPartnerInfo = false;
                state.pendingPairingRequest = null;
                state.showCartSidebar = false;
                state.showFoguinhosPopup = false;
                state.showPartnerInfoPopup = false; // Resetar pop-up de parceiro
                state.showPairingModal = false;
                    state.showVipPopup = false;
                state.pendingPartnerName = null;
                renderApp();
            }
        });
    }

    // Função que inicializa o aplicativo
    function initializeApp() {
        console.log("🚀 Aplicação inicializando...");

        // 1. Atribui os elementos do DOM a variáveis globais
        appContainer = document.getElementById('app');
        userNameDisplay = document.getElementById('userNameDisplay');
        foguinhosBadge = document.getElementById('foguinhosBadge');
        carrinhoBadge = document.getElementById('carrinhoBadge');
        bottomNavBar = document.getElementById('bottom-nav-bar');
        mainHeader = document.getElementById('mainHeader');

        // 2. Torna as funções de evento acessíveis globalmente para o HTML
        window.changeStep = changeStep;
        window.handleSignIn = handleSignIn;
        window.handleRegister = handleRegister;
        window.handleLogout = handleLogout;
        window.sendPairingRequest = sendPairingRequest;
        window.acceptPairingRequest = acceptPairingRequest;
        window.rejectPairingRequest = rejectPairingRequest;
        window.handleDailyCheckIn = handleDailyCheckIn;
        window.handleCheckInFromList = handleCheckInFromList;
        window.handleContinuarSemParear = handleContinuarSemParear;
        window.filtrarMomentos = filtrarMomentos;
        window.adicionarAoCarrinho = adicionarAoCarrinho;
        window.removerDoCarrinho = removerDoCarrinho;
        window.finalizarPedido = finalizarPedido;
        window.desparearParceiro = desparearParceiro;
        window.toggleCartSidebar = toggleCartSidebar;
        window.cancelPendingPairingRequest = cancelPendingPairingRequest;
        window.toggleFoguinhosPopup = toggleFoguinhosPopup;
        window.togglePartnerInfoPopup = togglePartnerInfoPopup;
        window.abrirCatalogoPareamento = abrirCatalogoPareamento;
    window.toggleAchievementsPopup = toggleAchievementsPopup;
        window.openChallengePopup = openChallengePopup;
        window.closeChallengePopup = closeChallengePopup;
        window.openWeeklyChallengePopup = openWeeklyChallengePopup;
        window.submitWeeklyChallengeAnswer = submitWeeklyChallengeAnswer;
        window.handlePartnerChallengeAnswer = handlePartnerChallengeAnswer;
        window.handleWeeklyChallengeTimeout = handleWeeklyChallengeTimeout;
        window.openPairingModal = openPairingModal;
        window.closePairingModal = closePairingModal;
        window.handlePairingCtaClick = handlePairingCtaClick;
        window.openVipPopup = openVipPopup;
        window.closeVipPopup = closeVipPopup;
        window.openLegalModal = openLegalModal;
        window.closeLegalModal = closeLegalModal;
        window.openInstagramModal = openInstagramModal;
        window.closeInstagramModal = closeInstagramModal;
        window.confirmInstagramRedirect = confirmInstagramRedirect;
        window.openEditNameModal = openEditNameModal;
        window.closeEditNameModal = closeEditNameModal;
        window.submitEditName = submitEditName;
        window.openSystemConfirm = openSystemConfirm;
        window.openSystemAlert = openSystemAlert;
        window.closeSystemModal = closeSystemModal;
        window.confirmSystemModal = confirmSystemModal;
        window.requestUnpairFromList = requestUnpairFromList;
        window.setDesafiosTab = setDesafiosTab;
        window.setNotificacoesTab = setNotificacoesTab;
        window.solicitarPermissaoDeNotificacao = solicitarPermissaoDeNotificacao;
        window.desativarNotificacoes = desativarNotificacoes;
        window.handleNotificationToggle = handleNotificationToggle;
        window.handleSaveCatalogo = handleSaveCatalogo;
        window.toggleAccordion = toggleAccordion;
        window.handleFileSelect = handleFileSelect;
        window.trocarAbaTarefas = trocarAbaTarefas;
        window.handleDarCheck = handleDarCheck;
        window.requestRealizadoWithPhoto = requestRealizadoWithPhoto;
        window.closeRealizadoPhotoPrompt = closeRealizadoPhotoPrompt;
        window.handleRealizadoPhotoChoice = handleRealizadoPhotoChoice;
        window.handleRealizadoPhotoSelect = handleRealizadoPhotoSelect;
        window.openRealizadoPhotoPicker = openRealizadoPhotoPicker;
        window.confirmRealizadoWithPhoto = confirmRealizadoWithPhoto;
        window.openMemoriasFeed = openMemoriasFeed;
        window.loadMoreMemorias = loadMoreMemorias;
        window.openMemoriaViewer = openMemoriaViewer;
        window.closeMemoriaViewer = closeMemoriaViewer;
        window.changeMemoriaViewer = changeMemoriaViewer;
        window.requestDeleteMemoriaFromViewer = requestDeleteMemoriaFromViewer;
        window.changeMemoriasMonth = changeMemoriasMonth;
        window.toggleMemoriasPairMenu = toggleMemoriasPairMenu;
        window.selectMemoriasPair = selectMemoriasPair;
        window.openMemoriasSharePicker = openMemoriasSharePicker;
        window.closeMemoriasSharePicker = closeMemoriasSharePicker;
        window.handleMemoriasShareChoice = handleMemoriasShareChoice;
        window.closeMemoriasSharePreview = closeMemoriasSharePreview;
        window.backToMemoriasSharePicker = backToMemoriasSharePicker;
        window.shareMemoriasPreview = shareMemoriasPreview;
        window.saveMemoriasPreview = saveMemoriasPreview;

        console.log("✅ Funções de evento prontas.");

        // 3. Inicia a lógica principal da aplicação
        init();
    }

    // Ouve pelo evento que indica que o HTML está pronto
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>

<nav class="bottom-nav-bar" id="bottom-nav-bar" style="display: none;">
    <button class="bottom-nav-item-center" onclick="changeStep('pareamentos');">
        <i class="fas fa-heart"></i>
    </button>
    <div id="catalogActions" class="absolute right-6 top-1/2 -translate-y-1/2 flex items-center gap-3 hidden">
        <button id="cartNavButton" class="bottom-nav-item" onclick="toggleCartSidebar()">
            <i class="fas fa-shopping-cart"></i>
            <span class="text-[10px] leading-none mt-0.5">Carrinho</span>
            <span id="carrinhoBadge" class="badge-notification badge-yellow">0</span>
        </button>
    </div>
</nav>
<div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[9999] space-y-2 w-auto max-w-sm"></div>

</body>
</html>