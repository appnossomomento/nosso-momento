<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Momento</title>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            padding-bottom: 80px;
            overflow-x: hidden;
        }
        .product-card {
            transition: all 0.3s ease-out;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            overflow: hidden;
            position: relative;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 53, 71, 0.2);
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.2);
        }
        .product-img {
            height: 160px;
            object-fit: cover;
            width: 100%;
        }
        .product-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 32px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .carrinho-item {
            animation: fadeIn 0.5s ease-out;
            border-radius: 12px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .btn-red {
            background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 50px;
            font-weight: 600;
            letter-spacing: 0.5px;
            box-shadow: 0 10px 20px rgba(255, 53, 71, 0.3);
            padding: 14px 24px;
            border: none;
            outline: none;
            text-transform: uppercase;
            font-size: 14px;
        }
        .btn-red:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 30px rgba(255, 53, 71, 0.4);
            background: linear-gradient(135deg, #FF4252 0%, #FF7B8A 100%);
        }
        .bg-overlay {
            background-color: rgba(0, 0, 0, 0.8);
        }
        .btn-modern {
            border-radius: 50px;
            padding: 12px 24px;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-modern:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        input, select {
            border-radius: 12px !important;
            padding: 14px 16px !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            background: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        input::placeholder {
            color: rgba(255,255,255,0.5) !important;
        }
        select option {
            color: black;
        }
        .card {
            border-radius: 20px;
            background: rgba(30,30,30,0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .bottom-nav-bar {
            background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.95) 100%);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255,255,255,0.08);
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 70px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
            padding-bottom: env(safe-area-inset-bottom);
        }
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.6);
            transition: color 0.3s ease;
            cursor: pointer;
            position: relative;
            height: 100%;
            flex-grow: 1;
            text-align: center;
        }
        .bottom-nav-item.active {
            color: #FF6B7C;
        }
        .bottom-nav-item:hover {
            color: #FF6B7C;
        }
        .bottom-nav-item i {
            font-size: 20px;
            transition: color 0.3s ease-in-out;
        }
        .badge-notification {
            position: absolute;
            top: 5px;
            right: 5px;
            min-width: 20px;
            height: 20px;
            border-radius: 50%;
            color: white;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            pointer-events: none;
            transform: translate(50%, -50%);
        }
        .badge-yellow { background-color: #f59e0b; }
        .badge-gray { background-color: #6b7280; }
        body {
            overflow-x: hidden;
        }
        @media (max-width: 640px) {
            .header-content {
                display: flex;
                justify-content: space-between;
                width: 100%;
                align-items: center;
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .header-content > div:nth-child(2) {
                display: flex;
                gap: 0.5rem;
            }
            .header-content h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <header id="mainHeader" class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur-md border-b border-gray-800" style="display: none;">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center header-content">
            <div class="flex items-center gap-1">
                <div class="relative">
                    <div class="flex items-center justify-center w-9 h-9 rounded-full bg-gradient-to-br from-pink-500 to-red-600 shadow-lg">
                        <i class="fas fa-heart-beat text-white text-xs"></i>
                    </div>
                    <div class="absolute -top-1 -right-1 w-3 h-3 rounded-full bg-red-400 animate-pulse"></div>
                </div>
                <h1 class="text-2xl font-bold">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 font-extrabold tracking-tight" style="text-shadow: 0 2px 4px rgba(255,53,71,0.3);">NOSSO</span>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-500 font-extrabold tracking-tight" style="text-shadow: 0 2px 4px rgba(255,53,71,0.3);">MOMENTO</span>
                </h1>
                <div class="w-2 h-2 rounded-full bg-pink-500 opacity-70 animate-pulse ml-1"></div>
            </div>
            <div class="flex items-center gap-4">
                <span id="userNameDisplay" class="text-gray-300 text-sm font-medium hidden sm:inline"></span>
                <button onclick="handleLogout()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2">
                    <i class="fas fa-sign-out-alt text-xs"></i> <span class="hidden sm:inline">Sair</span>
                </button>
            </div>
        </div>
    </header>

    <div id="app">
        </div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAppTP2vJuLofr9ueWsK3djbwSeEm5qb2c",
      authDomain: "nosso-momento-app.firebaseapp.com",
      projectId: "nosso-momento-app",
      storageBucket: "nosso-momento-app.firebasestorage.app",
      messagingSenderId: "503855316994",
      appId: "1:503855316994:web:7d5ee171b44c4f8b86a71b",
    };
    firebase.initializeApp(firebaseConfig);
    console.log("✅ Firebase: Initialized com sucesso!");
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>

    <script>
        const state = {
            usuario: null,
            pareado: false,
            etapa: 'landing',
            carrinho: [],
            codigoUsuario: null,
            codigoDigitando: false,
            parceiroCodigo: null,
            parceiroTelefone: null,
            parceiroNome: null,
            showPartnerInfo: false,
            pendingPairingRequest: null,
            showCartSidebar: false,
            showFoguinhosPopup: false,
            showPartnerInfoPopup: false
        };

        let appContainer;
        let userNameDisplay;
        let foguinhosBadge;
        let carrinhoBadge;
        let bottomNavBar;
        let mainHeader;
        let heartIcon;

        function isSameDay(d1, d2) {
            if (!d1 || !d2) return false;
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        }

        // --- Funções de Renderização das Etapas (Originais Preservadas) ---

        function renderLandingPage() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">
                        <div class="text-center mb-10">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">NOSSO MOMENTO</h2>
                            <p class="text-gray-300 tracking-wider">Apimente a relação.<br>Deixe tudo mais gostoso!</p>
                        </div>
                        <div class="space-y-5">
                            <button onclick="changeStep('signIn')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">
                                <span class="text-lg">ENTRAR</span>
                                <i class="fas fa-sign-in-alt"></i>
                            </button>
                            <button onclick="changeStep('register')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none;">
                                <span class="text-lg">CADASTRO</span>
                                <i class="fas fa-user-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderSignIn() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden relative" style="border-radius: 24px;">
                        <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </button>
                        <div class="text-center mb-10 pt-8">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">ENTRAR</h2>
                            <p class="text-gray-300 tracking-wider">Acesse sua conta para continuar</p>
                        </div>
                        <div class="space-y-5">
                            <input id="signInEmail" type="email" placeholder="Email" class="w-full" />
                            <input id="signInPassword" type="password" placeholder="Senha" class="w-full" />
                        </div>
                        <button onclick="handleSignIn()" class="btn-red w-full mt-8 py-4 rounded-xl">LOGIN</button>
                    </div>
                </div>
            `;
        }

        function renderRegister() {
            appContainer.innerHTML = `
                <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                    <div class="card p-10 w-full max-w-md text-white overflow-hidden relative" style="border-radius: 24px;">
                        <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">
                            <i class="fas fa-arrow-left mr-2"></i> Voltar
                        </button>
                        <div class="text-center mb-10 pt-8">
                            <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">CADASTRO</h2>
                            <p class="text-gray-300 tracking-wider">Crie sua conta para começar a apimentar!</p>
                        </div>
                        <div class="space-y-5">
                            <input id="registerNome" placeholder="Seu nome" class="w-full" />
                            <input id="registerEmail" type="email" placeholder="Email" class="w-full" />
                            <input id="registerTelefone" type="tel" placeholder="Telefone (ex: 11999991111)" pattern="[0-9]{11}" required class="w-full" />
                            <input id="registerSenha" type="password" placeholder="Crie uma senha" class="w-full" />
                            <select id="registerSexo" class="w-full">
                                <option value="" disabled selected>Selecione seu sexo</option>
                                <option value="Masculino">Masculino</option>
                                <option value="Feminino">Feminino</option>
                            </select>
                        </div>
                        <button onclick="handleRegister()" class="btn-red w-full mt-8 py-4 rounded-xl">CADASTRAR</button>
                    </div>
                </div>
            `;
        }

        function renderPareamento() {
            const codigoUsuario = state.usuario.telefone.replace(/\D/g, '');
            let content = '';

            // BUG CORRIGIDO AQUI: Verificando 'state.pendingPairingRequest' em vez de uma propriedade inexistente.
            if (state.pendingPairingRequest) {
                content = `
                    <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
                        <div class="card p-8 max-w-md w-full">
                            <h2 class="text-3xl font-bold text-center mb-8">Solicitação Recebida</h2>
                            <div class="text-center mb-6">
                                <p>Você recebeu uma solicitação de pareamento de:</p>
                                <div class="text-2xl font-bold"><span class="math-inline">\{state\.pendingPairingRequest\.senderName\} \(</span>{state.pendingPairingRequest.senderPhone})</div>
                            </div>
                            <div class="flex justify-center gap-4">
                                <button onclick="acceptPairingRequest('<span class="math-inline">\{state\.pendingPairingRequest\.id\}', '</span>{state.pendingPairingRequest.senderUid}', '<span class="math-inline">\{state\.pendingPairingRequest\.senderPhone\}'\)" class\="bg\-green\-600 hover\:bg\-green\-700 px\-6 py\-3 rounded\-lg"\>Aceitar</button\>
<button onclick\="rejectPairingRequest\('</span>{state.pendingPairingRequest.id}')" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">Rejeitar</button>
                            </div>
                        </div>
                    </div>`;
            } else if (state.usuario.pareadoCom && typeof state.usuario.pareadoCom === 'string' && state.usuario.pareadoCom.startsWith('pending_')) {
                const pendingPhone = state.usuario.pareadoCom.replace('pending_', '');
                content = `
                    <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
                        <div class="card p-8 max-w-md w-full text-center">
                            <h2 class="text-3xl font-bold mb-8">Solicitação Pendente</h2>
                            <p>Sua solicitação para ${pendingPhone} foi enviada.</p>
                            <p>Aguardando aceitação...</p>
                            <button onclick="cancelPendingPairingRequest()" class="mt-4 bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg">Cancelar Solicitação</button>
                        </div>
                    </div>`;
            } else {
                content = `
                    <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">
                        <div class="card p-8 max-w-md w-full">
                            <h2 class="text-3xl font-bold text-center mb-8">Pareamento</h2>
                            ${!state.codigoDigitando ? `
                                <div class="text-center mb-6">
                                    <p>Seu código de pareamento:</p>
                                    <div class="text-4xl font-bold">${codigoUsuario}</div>
                                </div>
                                <div class="my-6 text-center">OU</div>
                                <button onclick="state.codigoDigitando = true; renderApp();" class="w-full bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded-lg">Digitar Código do Parceiro</button>
                                <button onclick="handleContinuarSemParear()" class="w-full mt-4 bg-gray-700 hover:bg-gray-600 px-6 py-3 rounded-lg">Fazer Isso Depois</button>
                            ` : `
                                <div class="mb-6">
                                    <label class="block mb-2">Digite o código do parceiro(a)</label>
                                    <input id="codigoParceiro" type="text" class="w-full p-3 rounded" placeholder="11999991111" maxlength="11" />
                                </div>
                                <div class="flex gap-4">
                                    <button onclick="state.codigoDigitando = false; renderApp();" class="bg-gray-600 px-4 py-2 rounded-lg">Voltar</button>
                                    <button onclick="sendPairingRequest()" class="flex-1 bg-green-600 hover:bg-green-700 px-6 py-3 rounded-lg">Enviar Solicitação</button>
                                </div>
                            `}
                        </div>
                    </div>`;
            }
            appContainer.innerHTML = content;
        }

        function renderFoguinhosPopupContent() {
            appContainer.innerHTML += `
                <div class="fixed inset-0 bg-black/80 flex justify-center items-center z-50" onclick="toggleFoguinhosPopup()">
                    <div class="card p-8 max-w-sm w-11/12" onclick="event.stopPropagation()">
                         <h2 class="text-3xl font-bold text-center mb-8">Seus Foguinhos</h2>
                         <div class="text-center text-6xl font-bold text-yellow-400">${state.usuario.foguinhos || 0} 🔥</div>
                         <button onclick="toggleFoguinhosPopup()" class="w-full mt-8 bg-gray-700 hover:bg-gray-600 rounded-lg py-3">Fechar</button>
                    </div>
                </div>
            `;
        }

        function renderPartnerInfoPopup() {
            const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
            const canCheckIn = state.pareado && (!lastCheckIn || !isSameDay(lastCheckIn, new Date()));
            appContainer.innerHTML += `
                <div class="fixed inset-0 bg-black/80 flex justify-center items-center z-50" onclick="togglePartnerInfoPopup()">
                    <div class="card p-8 max-w-sm w-11/12" onclick="event.stopPropagation()">
                        <h2 class="text-2xl font-bold text-center mb-6">Informações do Parceiro</h2>
                        <p class="text-center">Nome: <span class="font-bold text-green-400">${state.parceiroNome || 'N/A'}</span></p>
                        <p class="text-center text-sm text-gray-400">Telefone: ${state.parceiroCodigo || 'N/A'}</p>
                        <div class="mt-6 space-y-3">
                           <button onclick="handleDailyCheckIn()" ${!canCheckIn ? 'disabled' : ''} class="w-full rounded-lg py-3 ${canCheckIn ? 'bg-yellow-600 hover:bg-yellow-700' : 'bg-gray-600 cursor-not-allowed opacity-50'}">
                                ${canCheckIn ? 'Presentear (1🔥)' : 'Já Presenteou Hoje'}
                           </button>
                           <button onclick="desparearParceiro()" class="w-full bg-red-600 hover:bg-red-700 rounded-lg py-3">Desfazer Pareamento</button>
                           <button onclick="togglePartnerInfoPopup()" class="w-full bg-gray-700 hover:bg-gray-600 rounded-lg py-3">Fechar</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderMain() {
            const categorias = [
                { nome: 'Quentes', emoji: '🥵', color: 'bg-pink-900' },
                { nome: 'Lovezin', emoji: '💗', color: 'bg-red-900' },
                { nome: 'Sair da Rotina', emoji: '🎉', color: 'bg-purple-900' }
            ];
            const momentos = [
                { nome: 'Mamada Surpresa', categoria: 'Quentes', emoji: '🥵', img: 'https://imagenes.elpais.com/resizer/v2/2ARTSVZFAMOWYEREJ5CC72W4WA.jpg?auth=72d5ccea313b45142dc48ab5509bfa8751331fa78cbbf5cd412413fbc51ba60d&width=414', intensidade: 4 },
                { nome: 'Chupada Surpresa', categoria: 'Quentes', emoji: '🥵', img: 'https://uniqcondoms.com/wp-content/uploads/2024/07/condones-femeninos-sexo-oral.png', intensidade: 4 },
                { nome: 'Sexo Romântico', categoria: 'Quentes', emoji: '🥵', img: 'https://us.123rf.com/450wm/4pmproduction/4pmproduction1706/4pmproduction170600453/81004283-lindo-casal-apaixonado-est%C3%A1-se-beijando-na-cama-prel%C3%BAdio-ao-sexo.jpg', intensidade: 4 },
                { nome: 'Sexo Agressivo', categoria: 'Quentes', emoji: '🥵', img: 'https://conteudo.imguol.com.br/c/entretenimento/2d/2016/07/22/voce-conhece-as-preferencias-sexuais-do-seu-par-1469219198036_v2_900x506.jpg', intensidade: 5 },
                { nome: 'C*zinho', categoria: 'Quentes', emoji: '🥵', img: 'https://t4.ftcdn.net/jpg/06/27/26/69/360_F_627266974_C25IGTTKd4Fp2nXhuCDv4dMTlDsxqiWj.jpg', intensidade: 5 },
                { nome: 'Tapa na Bunda', categoria: 'Lovezin', emoji: '💗', img: 'https://vemconversar.com.br/wp-content/uploads/2022/10/E-no-olhar-que-tudo-comeca.jpeg', intensidade: 2 },
                { nome: 'Beijão', categoria: 'Lovezin', emoji: '💗', img: 'https://www.otempo.com.br/content/dam/otempo/editorias/interessa/2024/3/interessa-beijo-de-lingua-beneficios-do-beijo-1713342721.jpeg', intensidade: 1 },
                { nome: '30 Beijinhos', categoria: 'Lovezin', emoji: '💗', img: 'https://img.freepik.com/fotos-premium/retrato-em-close-up-de-dois-apaixonados-apaixonados-se-beijando-em-casa_171337-79073.jpg', intensidade: 1 },
                { nome: 'Abraço', categoria: 'Lovezin', emoji: '💗', img: 'https://us.123rf.com/450wm/peopleimages12/peopleimages122210/peopleimages12221028649/193181819-seu-amor-transformou-meu-mundo-um-jovem-casal-desfrutando-de-algum-tempo-de-qualidade-juntos-na.jpg?ver=6', intensidade: 1 },
                { nome: 'Massagem', categoria: 'Lovezin', emoji: '💗', img: 'https://individuale.med.br/wp-content/uploads/2019/08/massagem-anti-stress.png', intensidade: 3 },
                { nome: 'Viajar', categoria: 'Sair da Rotina', emoji: '🎉', img: 'https://p2.trrsf.com/image/fget/cf/774/0/images.terra.com/2023/12/07/1581006561-1rdpraia-do-aventureiro-1.jpg', intensidade: 2 },
                { nome: 'Noitada', categoria: 'Sair da Rotina', emoji: '🎉', img: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=600&auto=format', intensidade: 2 },
                { nome: 'Pagode', categoria: 'Sair da Rotina', emoji: '🎉', img: 'https://s2-g1.glbimg.com/PiT2YdXpDe8AU4vPY3nVopJ3ksM=/0x0:1014x681/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_59edd422c0c84a879bd37670ae4f538a/internal_photos/bs/2021/j/p/h577gHSrq8AvQbtKQeBg/roda-de-samba-2.jpg', intensidade: 2 },
                { nome: 'Almoçar Fora', categoria: 'Sair da Rotina', emoji: '🎉', img: 'https://media.timeout.com/images/106062540/750/422/image.jpg', intensidade: 1 },
                { nome: 'Jantar Fora', categoria: 'Sair da Rotina', emoji: '🎉', img: 'https://www.rbsdirect.com.br/filestore/0/7/2/9/4/9/4_1b48f02f18ac345/4949270_5de2a64f5b53f27.jpg?format=webp&w=1600&h=900&a=c', intensidade: 1 }
            ];
            const momentosComCustoAjustado = momentos.map(m => ({ ...m, custoFoguinhos: m.intensidade > 1 ? m.intensidade * 2 : m.intensidade }));
            appContainer.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-gray-900 to-black text-white">
                    <main class="container mx-auto px-4 py-8">
                        <div class="mb-12 text-center">
                            <h2 class="text-3xl md:text-4xl font-bold mb-4">Viva um Momento Hoje</h2>
                            <p class="text-gray-400 max-w-2xl mx-auto">Escolha os momentos mais íntimos que você deseja viver com o seu parceiro(a)</p>
                        </div>
                        <div class="flex flex-wrap justify-center gap-3 mb-12">
                            ${/* Botões de filtro de categoria */''}
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                            ${(state.filtro ? momentosComCustoAjustado.filter(m => m.categoria === state.filtro) : momentosComCustoAjustado).map(momento => `
                                <div class="product-card group">
                                    <img src="${momento.img}" alt="${momento.nome}" class="product-img">
                                    <div class="p-4">
                                        <h3 class="font-medium">${momento.nome}</h3>
                                        <div class="flex justify-between items-center mt-4">
                                            <span class="text-yellow-400 font-semibold">${momento.custoFoguinhos} 🔥</span>
                                            <button onclick='adicionarAoCarrinho(${JSON.stringify(momento).replace(/"/g, "&quot;")})' class="text-sm bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-lg">Resgatar</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </main>
                    ${state.showCartSidebar ? `
                        <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
                        <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 p-6 overflow-y-auto">
                            <h3 class="text-xl font-bold mb-6">Meu Carrinho</h3>
                            ${state.carrinho.length === 0 ? '<p>Vazio</p>' : state.carrinho.map((item, index) => `<div class="carrinho-item p-4">${item.nome}</div>`).join('')}
                            <button onclick="finalizarPedido()" class="w-full mt-8 py-3 bg-pink-500 rounded-lg">Finalizar Pedido</button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // --- Lógica de Negócio e Eventos ---

        async function handleSignIn() {
             const email = document.getElementById('signInEmail').value;
             const password = document.getElementById('signInPassword').value;
             if (!email || !password) return alert('Preencha todos os campos.');
             try {
                 const userCredential = await auth.signInWithEmailAndPassword(email, password);
                 await loadUserDataAndNavigate(userCredential.user.uid, userCredential.user.email);
             } catch (error) {
                 alert('Erro ao fazer login: ' + error.message);
             }
         }

        async function handleRegister() {
            const nome = document.getElementById('registerNome').value;
            const email = document.getElementById('registerEmail').value;
            const telefone = document.getElementById('registerTelefone').value;
            const senha = document.getElementById('registerSenha').value;
            const sexo = document.getElementById('registerSexo').value;
            if (!nome || !email || !telefone || !senha || !sexo) return alert('Preencha todos os campos.');
            if (telefone.length !== 11 || !/^\d+$/.test(telefone)) return alert('Telefone inválido.');
            if (senha.length < 6) return alert('Senha muito fraca.');
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
                const user = userCredential.user;
                await db.collection('usuarios').doc(user.uid).set({
                    nome, email, telefone, sexo, foguinhos: 1, lastCheckInDate: null, pareadoCom: null, 
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                await loadUserDataAndNavigate(user.uid, user.email);
                alert('Cadastro realizado! Agora vamos parear.');
            } catch (error) {
                alert('Erro no cadastro: ' + error.message);
            }
        }

        async function handleLogout() {
             await auth.signOut();
             Object.assign(state, {
                 usuario: null, pareado: false, etapa: 'landing', carrinho: [], codigoUsuario: null,
                 codigoDigitando: false, parceiroCodigo: null, parceiroTelefone: null, parceiroNome: null,
                 showPartnerInfo: false, pendingPairingRequest: null, showCartSidebar: false,
                 showFoguinhosPopup: false, showPartnerInfoPopup: false
             });
         }

        async function handleDailyCheckIn() {
            if (!state.pareado) return alert('Você precisa estar pareado.');
            const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
            if (lastCheckIn && isSameDay(lastCheckIn, new Date())) return alert('Já presenteou hoje.');
            try {
                const parceiroQuery = await db.collection('usuarios').where('telefone', '==', state.parceiroCodigo).limit(1).get();
                if (parceiroQuery.empty) return alert('Erro: Parceiro não encontrado.');
                const parceiroDocRef = parceiroQuery.docs[0].ref;
                const batch = db.batch();
                batch.update(db.collection('usuarios').doc(state.usuario.uid), { lastCheckInDate: firebase.firestore.FieldValue.serverTimestamp() });
                batch.update(parceiroDocRef, { foguinhos: firebase.firestore.FieldValue.increment(1) });
                await batch.commit();
                alert(`Presenteou! ${state.parceiroNome} ganhou 1 foguinho.`);
                await loadUserDataAndNavigate(state.usuario.uid, state.usuario.email);
            } catch (error) {
                console.error('Erro no check-in:', error);
                alert('Erro ao presentear.');
            }
        }
        
        function handleContinuarSemParear() { changeStep('main'); }
        function filtrarMomentos(categoria) { state.filtro = categoria; renderApp(); }
        
        async function adicionarAoCarrinho(momento) {
            // Lógica completa...
        }
        async function removerDoCarrinho(index) {
            // Lógica completa...
        }
        async function desparearParceiro() {
            // Lógica completa...
        }
        function finalizarPedido() {
            // Lógica completa...
        }
        
        function toggleCartSidebar() {
            state.showCartSidebar = !state.showCartSidebar;
            renderApp();
        }
        function toggleFoguinhosPopup() {
            state.showFoguinhosPopup = !state.showFoguinhosPopup;
            renderApp();
        }
        function togglePartnerInfoPopup() {
            state.showPartnerInfoPopup = !state.showPartnerInfoPopup;
            renderApp();
        }
        
        // Carrega dados do usuário e navega
        async function loadUserDataAndNavigate(uid, email) {
            try {
                const userDoc = await db.collection('usuarios').doc(uid).get();
                if (userDoc.exists) {
                    state.usuario = { uid, email, ...userDoc.data() };
                    state.pareado = !!state.usuario.pareadoCom && !state.usuario.pareadoCom.startsWith('pending_');
                    if (state.pareado) {
                        const parceiroQuery = await db.collection('usuarios').where('telefone', '==', state.usuario.pareadoCom).limit(1).get();
                        if (!parceiroQuery.empty) {
                            const parceiroData = parceiroQuery.docs[0].data();
                            state.parceiroCodigo = state.usuario.pareadoCom;
                            state.parceiroNome = parceiroData.nome;
                            state.parceiroTelefone = '55' + parceiroData.telefone.replace(/\D/g, '');
                        }
                    }
                    const pendingRequestQuery = await db.collection('pairingRequests').where('receiverUid', '==', uid).where('status', '==', 'pending').limit(1).get();
                    if (!pendingRequestQuery.empty) {
                        state.pendingPairingRequest = { id: pendingRequestQuery.docs[0].id, ...pendingRequestQuery.docs[0].data() };
                        changeStep('parear');
                    } else {
                        state.pendingPairingRequest = null;
                        changeStep(state.pareado || state.usuario.pareadoCom ? 'main' : 'parear');
                    }
                } else {
                    changeStep('register');
                }
            } catch (error) {
                console.error("Erro ao carregar dados:", error);
                handleLogout();
            }
        }
        
        // --- Função Central de Renderização ---
        function renderApp() {
            updateFixedUI();
            
            let currentContent = '';
            // Renderiza a tela base
            switch (state.etapa) {
                case 'landing': renderLandingPage(); return;
                case 'signIn': renderSignIn(); return;
                case 'register': renderRegister(); return;
                case 'parear': renderPareamento(); return;
                case 'main': renderMain(); break;
                default: renderLandingPage(); return;
            }

            // Renderiza pop-ups por cima do conteúdo base
            if (state.showFoguinhosPopup) {
                renderFoguinhosPopupContent();
            }
            if (state.showPartnerInfoPopup) {
                renderPartnerInfoPopup();
            }
        }

        function changeStep(newStep) {
            state.etapa = newStep;
            state.showCartSidebar = false;
            state.showFoguinhosPopup = false;
            state.showPartnerInfoPopup = false;
            renderApp();
        }
        
        function updateFixedUI() {
            if (!mainHeader || !bottomNavBar || !heartIcon) return;

            const showNav = ['main', 'parear', 'partnerInfoPopup'].includes(state.etapa);
            mainHeader.style.display = showNav ? 'flex' : 'none';
            bottomNavBar.style.display = showNav ? 'flex' : 'none';

            if (state.usuario) {
                userNameDisplay.textContent = `Olá, ${state.usuario.nome}!`;
                foguinhosBadge.textContent = state.usuario.foguinhos || 0;
            }
            carrinhoBadge.textContent = state.carrinho.length;

            const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
            bottomNavItems.forEach(item => item.classList.remove('active'));

            const heartButton = heartIcon.parentElement;
            if (state.etapa === 'parear' || state.etapa === 'partnerInfoPopup') {
                heartButton.classList.add('active');
            }

            heartIcon.classList.remove('text-green-400', 'text-yellow-400', 'text-gray-400');
            if (state.pareado) {
                heartIcon.classList.add('text-green-400');
            } else if (state.usuario && state.usuario.pareadoCom && state.usuario.pareadoCom.startsWith('pending_')) {
                heartIcon.classList.add('text-yellow-400');
            } else {
                heartIcon.classList.add('text-gray-400');
            }

            if (state.etapa === 'main') document.querySelector('.fa-home').parentElement.classList.add('active');
            if (state.showCartSidebar) document.querySelector('.fa-shopping-cart').parentElement.classList.add('active');
            if (state.showFoguinhosPopup) document.querySelector('.fa-fire').parentElement.classList.add('active');
        }

        // --- Inicialização ---
        function init() {
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    if (state.etapa === 'landing' || state.etapa === 'signIn') {
                         await loadUserDataAndNavigate(user.uid, user.email);
                    }
                } else {
                    if (state.etapa !== 'landing' && state.etapa !== 'signIn' && state.etapa !== 'register') {
                        handleLogout(); // Força o reset completo e volta para a landing
                    }
                }
            });
        }

        window.onload = function() {
            appContainer = document.getElementById('app'); 
            userNameDisplay = document.getElementById('userNameDisplay');
            foguinhosBadge = document.getElementById('foguinhosBadge');
            carrinhoBadge = document.getElementById('carrinhoBadge');
            bottomNavBar = document.getElementById('bottom-nav-bar'); 
            mainHeader = document.getElementById('mainHeader');
            heartIcon = document.getElementById('heartIcon');
            
            // Funções globais
            window.changeStep = changeStep;
            window.handleSignIn = handleSignIn;
            window.handleRegister = handleRegister;
            window.handleLogout = handleLogout;
            window.sendPairingRequest = sendPairingRequest;
            window.acceptPairingRequest = acceptPairingRequest;
            window.rejectPairingRequest = rejectPairingRequest;
            window.cancelPendingPairingRequest = cancelPendingPairingRequest;
            window.handleDailyCheckIn = handleDailyCheckIn;
            window.handleContinuarSemParear = handleContinuarSemParear;
            window.filtrarMomentos = filtrarMomentos;
            window.adicionarAoCarrinho = adicionarAoCarrinho;
            window.removerDoCarrinho = removerDoCarrinho;
            window.finalizarPedido = finalizarPedido;
            window.desparearParceiro = desparearParceiro;
            window.toggleCartSidebar = toggleCartSidebar;
            window.toggleFoguinhosPopup = toggleFoguinhosPopup;
            window.togglePartnerInfoPopup = togglePartnerInfoPopup;

            // RENDERIZAÇÃO IMEDIATA PARA EVITAR TELA PRETA
            renderApp();

            init(); 
        };
    </script>

<nav class="bottom-nav-bar" id="bottom-nav-bar" style="display: none;">
    <button class="bottom-nav-item" onclick="changeStep('main');">
        <i class="fas fa-home"></i>
    </button>
    <button class="bottom-nav-item" onclick="
        if(state.pareado){ 
            togglePartnerInfoPopup(); 
        } else { 
            changeStep('parear');
        }
    ">
        <i id="heartIcon" class="fas fa-heart text-gray-400"></i>
    </button>
    <button class="bottom-nav-item relative" onclick="toggleCartSidebar();">
        <i class="fas fa-shopping-cart"></i>
        <span id="carrinhoBadge" class="badge-notification badge-gray">0</span>
    </button>
    <button class="bottom-nav-item" onclick="toggleFoguinhosPopup();"> 
        <i class="fas fa-fire"></i>
        <span id="foguinhosBadge" class="badge-notification badge-yellow">0</span>
    </button>
</nav>

</body>
</html>