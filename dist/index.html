<!doctype html><html lang="pt-BR"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Nosso Momento</title><link rel="icon" href="/assets/icons/iconprincipal.png" type="image/png"><link rel="stylesheet" href="./assets/tailwind.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"><style>body{font-family:Poppins,sans-serif;overflow-x:hidden}.product-card{transition:all .3s ease-out;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:16px;overflow:hidden;position:relative}.product-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(255,53,71,.2);background:rgba(255,255,255,.05);border-color:rgba(255,255,255,.2)}.product-img{height:160px;object-fit:cover;width:100%}.product-badge{position:absolute;top:10px;right:10px;background:rgba(0,0,0,.7);color:#fff;padding:4px 10px;border-radius:32px;font-size:12px;display:flex;align-items:center;gap:4px}.carrinho-item{animation:fadeIn .5s ease-out;border-radius:12px}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.btn-red{background:linear-gradient(135deg,#ff3547 0,#ff6b7c 100%);transition:all .4s cubic-bezier(.4, 0, .2, 1);border-radius:50px;font-weight:600;letter-spacing:.5px;box-shadow:0 10px 20px rgba(255,53,71,.3);padding:14px 24px;border:none;outline:0;text-transform:uppercase;font-size:14px}.btn-red:hover{transform:translateY(-3px) scale(1.02);box-shadow:0 15px 30px rgba(255,53,71,.4);background:linear-gradient(135deg,#ff4252 0,#ff7b8a 100%)}.bg-overlay{background-color:rgba(0,0,0,.8)}.btn-modern{border-radius:50px;padding:12px 24px;font-weight:600;transition:all .3s cubic-bezier(.25, .8, .25, 1);box-shadow:0 4px 8px rgba(0,0,0,.1)}.btn-modern:hover{transform:translateY(-2px);box-shadow:0 6px 12px rgba(0,0,0,.15)}input{border-radius:12px!important;padding:14px 16px!important;border:1px solid rgba(255,255,255,.1)!important;background:rgba(255,255,255,.05)!important;color:#fff!important}input::placeholder{color:rgba(255,255,255,.5)!important}.card{border-radius:20px;background:rgba(30,30,30,.7);backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,.05)}.bottom-nav-bar{background:linear-gradient(135deg,rgba(30,30,30,.95) 0,rgba(0,0,0,.95) 100%);backdrop-filter:blur(10px);border-top:1px solid rgba(255,255,255,.08);position:fixed;bottom:0;left:0;width:100%;height:70px;display:flex;justify-content:space-around;align-items:center;z-index:100;box-shadow:0 -5px 20px rgba(0,0,0,.4);padding-bottom:env(safe-area-inset-bottom)}.bottom-nav-item{display:flex;flex-direction:column;align-items:center;justify-content:center;color:rgba(255,255,255,.6);transition:color .3s ease;cursor:pointer;position:relative;height:100%;flex-grow:1;text-align:center}.bottom-nav-item.active{color:#ff6b7c}.bottom-nav-item:hover{color:#ff6b7c}.bottom-nav-item i{font-size:20px}.badge-notification{position:absolute;top:5px;right:5px;min-width:20px;height:20px;border-radius:50%;color:#fff;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:700;box-shadow:0 1px 3px rgba(0,0,0,.3);pointer-events:none;transform:translate(50%,-50%)}.badge-yellow{background-color:#f59e0b}.badge-gray{background-color:#6b7280}.achievement-celebration-wrapper{position:fixed;top:90px;left:50%;transform:translate(-50%,-20px);opacity:0;z-index:200;pointer-events:none;transition:opacity .35s ease,transform .35s ease}.achievement-celebration-wrapper.entered{opacity:1;transform:translate(-50%,0)}.achievement-celebration-wrapper.exiting{opacity:0;transform:translate(-50%,-16px)}.achievement-celebration{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,rgba(30,41,59,.94),rgba(17,24,39,.94));border-radius:9999px;padding:16px 26px;border:1px solid rgba(251,191,36,.55);box-shadow:0 18px 40px rgba(0,0,0,.35)}.achievement-celebration__icon{width:52px;height:52px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#111827;font-size:22px;box-shadow:0 0 0 4px rgba(0,0,0,.25);animation:trophyPop .65s cubic-bezier(.34,1.56,.64,1)}.achievement-celebration__eyebrow{font-size:.72rem;letter-spacing:.14em;text-transform:uppercase;color:rgba(255,255,255,.65);margin-bottom:2px}.achievement-celebration__title{font-weight:700;font-size:1.05rem;color:#f9fafb}.achievement-celebration__message{margin-top:4px;font-size:.85rem;color:rgba(226,232,240,.95)}@keyframes trophyPop{0%{transform:scale(.5) rotate(-12deg);opacity:0}55%{transform:scale(1.12) rotate(4deg);opacity:1}100%{transform:scale(1) rotate(0);opacity:1}}#carrinhoBadge,#foguinhosBadge{top:50%;left:50%;right:auto;transform:translate(14px,-70%)}body{overflow-x:hidden}@media (max-width:640px){.header-content{display:flex;justify-content:space-between;width:100%;align-items:center;padding-left:1rem;padding-right:1rem}.header-content>div:nth-child(2){display:flex;gap:.5rem}.header-content h1{font-size:1.5rem}}.accordion-content.open{overflow:visible}.accordion-button.open i{transform:rotate(180deg)}.bottom-nav-item-center{display:flex;align-items:center;justify-content:center;width:60px;height:60px;background:linear-gradient(135deg,#ff3547 0,#ff6b7c 100%);color:#fff;border-radius:50%;border:3px solid #1f2937;transform:translateY(-20px);box-shadow:0 -5px 15px rgba(255,53,71,.4);transition:all .3s ease}.bottom-nav-item-center:hover{transform:translateY(-23px) scale(1.05);box-shadow:0 -8px 20px rgba(255,53,71,.5)}.bottom-nav-item-center i{font-size:24px}.toast{display:flex;align-items:center;padding:10px 16px;font-size:14px;border-radius:9999px;box-shadow:0 4px 12px rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.1);backdrop-filter:blur(10px);animation:slideInUp .5s ease-out forwards}.toast.exiting{animation:slideOutDown .4s ease-in forwards}@keyframes slideInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes slideOutDown{from{opacity:1;transform:translateY(0)}to{opacity:0;transform:translateY(20px)}}.achievements-overlay{animation:fadeIn .25s ease-out forwards}.achievements-popup-card{animation:slideInUp .35s ease-out forwards}@media (max-width:640px){.achievements-popup-card{margin-top:48px;margin-bottom:32px}}.instagram-cta-outline{display:inline-block;padding:2px;border-radius:12px;background:linear-gradient(45deg,#f09433 0,#e6683c 25%,#dc2743 50%,#cc2366 75%,#bc1888 100%)}.instagram-cta-inner{display:inline-flex;align-items:center;gap:8px;background:#000;color:#fff;padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:600}.instagram-cta-inner i{font-size:16px}.instagram-cta-inner:hover{transform:translateY(-2px)}</style><script async src="https://www.googletagmanager.com/gtag/js?id=G-556FY0WV3Q"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-556FY0WV3Q")</script><script>gtag("config","G-556FY0WV3Q")</script><script>!function(e,t,n,c,o,a,f){e.fbq||(o=e.fbq=function(){o.callMethod?o.callMethod.apply(o,arguments):o.queue.push(arguments)},e._fbq||(e._fbq=o),o.push=o,o.loaded=!0,o.version="2.0",o.queue=[],(a=t.createElement(n)).async=!0,a.src="https://connect.facebook.net/en_US/fbevents.js",(f=t.getElementsByTagName(n)[0]).parentNode.insertBefore(a,f))}(window,document,"script"),fbq("init","1883535982201745"),fbq("track","PageView")</script><noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=1883535982201745&ev=PageView&noscript=1"></noscript><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script><script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script></head><body class="bg-black text-white font-sans"><header id="mainHeader" class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur-md border-b border-gray-800" style="display:none"><div class="container mx-auto px-4 py-4 flex justify-between items-center header-content"><div class="flex items-center"><img src="/assets/icons/logo-white-txt-v2.png" alt="Nosso Momento Logo" class="h-[55px] w-auto"></div><div class="flex items-center gap-4"><button onclick='changeStep("notificacoes")' class="relative text-gray-400 hover:text-white transition"><i class="fas fa-bell text-xl"></i> <span id="notificationDot" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full hidden"></span></button> <img id="headerProfilePic" src="" class="w-8 h-8 rounded-full object-cover hidden sm:block"> <span id="userNameDisplay" class="text-gray-300 text-sm font-medium hidden sm:inline"></span> <button onclick="handleLogout()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2"><i class="fas fa-sign-out-alt text-xs"></i> <span class="hidden sm:inline">Sair</span></button></div></div></header><div id="app"></div><script>const firebaseConfig={apiKey:"AIzaSyAppTP2vJuLofr9ueWsK3djbwSeEm5qb2c",authDomain:"nosso-momento-app.firebaseapp.com",projectId:"nosso-momento-app",storageBucket:"nosso-momento-app.firebasestorage.app",messagingSenderId:"503855316994",appId:"1:503855316994:web:7d5ee171b44c4f8b86a71b"};firebase.initializeApp(firebaseConfig),console.log("‚úÖ Firebase: Initialized com sucesso!");const db=firebase.firestore(),auth=firebase.auth(),storage=firebase.storage(),CREATE_INPUT_URL="https://southamerica-east1-nosso-momento-app.cloudfunctions.net/createInput",SET_NOTIFICATION_TOKEN_URL="https://southamerica-east1-nosso-momento-app.cloudfunctions.net/setNotificationToken"</script><script>async function safeAddInput(e){const t={...e};t.fromUid||(auth.currentUser?t.fromUid=auth.currentUser.uid:state.usuario&&state.usuario.uid&&(t.fromUid=state.usuario.uid)),delete t.timestamp,t.processed=!1;const a=auth.currentUser;if(!a){const e=new Error("auth_required");throw e.code="auth_required",e}t.fromUid!==a.uid&&(t.fromUid=a.uid);const o=async(e=!1)=>{const o=await a.getIdToken(e),n=await fetch(CREATE_INPUT_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({input:t})});let s=null;try{s=await n.json()}catch(e){console.warn("safeAddInput: corpo n√£o p√¥de ser parseado",e)}if(n.ok)return s&&s.id?{id:s.id}:s;const i=s&&s.error?s.error:`http_${n.status}`,r=new Error(i);throw r.code=i,r.status=n.status,r.details=s,r};try{return await o(!1)}catch(e){if(401===e.status||403===e.status)return await o(!0);throw e}}const ACHIEVEMENTS=[{id:"first_check_in",trigger:"daily_check_in",title:"Primeiro Passo",description:"Realize seu primeiro check-in di√°rio com o seu par.",hint:"Envie um foguinho pela tela de check-in.",icon:"fa-person-rays",accentColor:"#fbbf24",reward:1},{id:"checkin_streak_7",trigger:"daily_check_in",title:"Foguinho Semanal",description:"Complete 7 check-ins em dias consecutivos.",hint:"Fa√ßa check-ins di√°rios sem perder nenhum dia.",icon:"fa-calendar-week",accentColor:"#34d399",reward:3},{id:"checkin_master",trigger:"daily_check_in",title:"Mestre do Check-in",description:"Realize 30 check-ins no total.",hint:"Consist√™ncia √© tudo: presenteie seu par frequentemente.",icon:"fa-stopwatch",accentColor:"#60a5fa",reward:10},{id:"first_moment_redeem",trigger:"moment_redeem",title:"Primeiro Momento",description:"Resgate o seu primeiro momento.",hint:"Escolha um momento e resgate com foguinhos.",icon:"fa-heart",accentColor:"#f472b6",reward:1},{id:"moment_collector",trigger:"moment_redeem",title:"Colecionador de Momentos",description:"Resgate 5 momentos diferentes.",hint:"Continue resgatando momentos para o seu mural.",icon:"fa-gift",accentColor:"#c084fc",reward:3},{id:"foguinhos_investor",trigger:"moment_redeem",title:"Investidor de Foguinhos",description:"Gaste 50 foguinhos em momentos.",hint:"Momentos incr√≠veis custam foguinhos ‚Äì continue investindo!",icon:"fa-coins",accentColor:"#facc15",reward:10}],ACHIEVEMENTS_BY_ID=ACHIEVEMENTS.reduce((e,t)=>(e[t.id]=t,e),{}),state={usuario:null,pareado:!1,parceiroData:null,idPareamentoAmigavel:null,notificacoesTarefasNaoLidas:0,notificacoesPresentesNaoLidas:0,notificacoesConquistasNaoLidas:0,notificacoes:[],etapa:"landing",carrinho:[],momentosMestres:[],fcmToken:null,codigoUsuario:null,codigoDigitando:!1,parceiroCodigo:null,pareadoUid:null,parceiroTelefone:null,parceiroNome:null,showPartnerInfo:!1,pendingPairingRequest:null,showCartSidebar:!1,showFoguinhosPopup:!1,showAchievementsPopup:!1,abaTarefasAtiva:"recebidos",conquistas:{},achievementStats:{}};let unsubscribeNotifications=null,unsubscribeUserDoc=null,unsubscribePendingPairing=null,hasProcessedInitialConquistas=!1,activeAchievementCelebration=null,activeAchievementCelebrationTimeout=null,hasProcessedInitialNotifications=!1,lastNotificationIds=new Set;const recentAchievementCelebrations=new Map;function triggerAchievementCelebration(e){const t=showAchievementCelebration(e?.achievementId||null);if(t){showToast(`üèÜ ${t.description?`${t.title}: ${t.description}`:t.title}`,"sucesso")}else e?.mensagem&&showToast(`üèÜ ${e.mensagem}`,"sucesso")}let appContainer,userNameDisplay,foguinhosBadge,carrinhoBadge,bottomNavBar,mainHeader;function isSameDay(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}function formatarDataCurta(e){if(!e)return"";try{let t;if(e.toDate)t=e.toDate();else if("object"==typeof e&&"seconds"in e)t=new Date(1e3*e.seconds);else{if(!(e instanceof Date))return"";t=e}return t.toLocaleDateString("pt-BR",{day:"2-digit",month:"short",year:"numeric"})}catch(e){return console.warn("N√£o foi poss√≠vel formatar a data da conquista:",e),""}}function showToast(e,t="sucesso"){const a=document.getElementById("toast-container");if(!a)return;let o="fa-check-circle",n="toast-sucesso";"erro"===t?(o="fa-times-circle",n="toast-erro"):"aviso"===t&&(o="fa-exclamation-triangle",n="toast-aviso");const s=document.createElement("div");s.className=`toast ${n}`,s.innerHTML=`\n            <i class="fas ${o} toast-icon"></i>\n            <span>${e}</span>\n        `,a.appendChild(s),setTimeout(()=>{s.classList.add("exiting"),setTimeout(()=>{s.remove()},500)},2e3)}function showAchievementCelebration(e){const t=e||null,a=t&&ACHIEVEMENTS_BY_ID[t]||null,o=a?.accentColor||"#fbbf24",n=a?.icon||"fa-trophy",s=a?.title||"Nova conquista desbloqueada!",i=a?.description||"";if(t&&recentAchievementCelebrations.has(t))return console.log("Banner de conquista ignorado porque j√° foi exibido recentemente:",t),null;if(!document.body)return console.warn("showAchievementCelebration chamado antes do document.body estar pronto."),{title:s,description:i};activeAchievementCelebrationTimeout&&(clearTimeout(activeAchievementCelebrationTimeout),activeAchievementCelebrationTimeout=null),activeAchievementCelebration&&activeAchievementCelebration.parentNode&&activeAchievementCelebration.parentNode.removeChild(activeAchievementCelebration);const r=document.createElement("div");r.className="achievement-celebration-wrapper";const c=document.createElement("div");c.className="achievement-celebration",c.style.borderColor=o;const l=document.createElement("div");l.className="achievement-celebration__icon",l.style.background=o;const d=document.createElement("i");d.className=`fas ${n}`,l.appendChild(d);const u=document.createElement("div"),p=document.createElement("p");p.className="achievement-celebration__eyebrow",p.textContent="Nova conquista!";const m=document.createElement("p");if(m.className="achievement-celebration__title",m.textContent=s,u.appendChild(p),u.appendChild(m),i){const e=document.createElement("p");e.className="achievement-celebration__message",e.textContent=i,u.appendChild(e)}if(c.appendChild(l),c.appendChild(u),r.appendChild(c),document.body.appendChild(r),console.log("Exibindo banner de conquista:",t||"desconhecida",s),requestAnimationFrame(()=>{r.classList.add("entered")}),activeAchievementCelebrationTimeout=setTimeout(()=>{r.classList.remove("entered"),r.classList.add("exiting"),setTimeout(()=>{r.parentNode&&r.parentNode.removeChild(r)},320),activeAchievementCelebration=null,activeAchievementCelebrationTimeout=null},4200),activeAchievementCelebration=r,t){const e=recentAchievementCelebrations.get(t);e&&clearTimeout(e);const a=setTimeout(()=>{recentAchievementCelebrations.delete(t)},6e3);recentAchievementCelebrations.set(t,a)}return{title:s,description:i}}function trackGAEvent(e,t={}){"function"==typeof gtag?(console.log(`GA Event: ${e}`,t),gtag("event",e,t)):console.warn(`gtag() n√£o definido. Evento "${e}" n√£o rastreado.`)}function escapeHtmlAttr(e){return"string"!=typeof e?"":e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function trackMetaEvent(e,t={}){"function"==typeof fbq?(console.log(`Meta Event: ${e}`,t),fbq("track",e,t)):console.warn(`fbq() n√£o definido. Evento "${e}" n√£o rastreado.`)}async function syncNotificationToken(e){const t=auth.currentUser;if(!t){const e=new Error("auth_required");throw e.code="auth_required",e}const a=async(a=!1)=>{const o=await t.getIdToken(a),n=await fetch(SET_NOTIFICATION_TOKEN_URL,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify(e)});let s=null;try{s=await n.json()}catch(e){console.warn("syncNotificationToken: corpo n√£o p√¥de ser parseado",e)}if(n.ok)return s||{};const i=s&&s.error?s.error:`http_${n.status}`,r=new Error(i);throw r.code=i,r.status=n.status,r.details=s,r};try{return await a(!1)}catch(e){if(401===e.status||403===e.status)return await a(!0);throw e}}function renderLandingPage(){appContainer.innerHTML='\n            <div class="min-h-screen flex flex-col justify-center items-center px-4" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url(\'https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80\'); background-size: cover; background-position: center;">\n                \n                <div class="card p-6 sm:p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">\n                    \n                    <div class="text-center mb-10">\n                        <img src="/assets/icons/logo-topdown-white-txt.png" alt="Nosso Momento" class="w-2/3 max-w-[200px] mx-auto mb-6">\n                        <p class="text-gray-300 tracking-wider">Apimente a rela√ß√£o.<br>Deixe tudo mais gostoso!</p>\n                    </div>\n                    \n                    <div class="space-y-5">\n                        <button onclick="changeStep(\'signIn\')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">\n                            <span class="text-lg">ENTRAR</span>\n                            <i class="fas fa-sign-in-alt"></i>\n                        </button>\n                        <button onclick="changeStep(\'register\')" class="btn-red w-full py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none;">\n                            <span class="text-lg">CADASTRO</span>\n                            <i class="fas fa-user-plus"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        '}function renderSignIn(){appContainer.innerHTML='\n            <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url(\'https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80\'); background-size: cover; background-position: center;">\n                <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">\n                    <button onclick="changeStep(\'landing\')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">\n                        <i class="fas fa-arrow-left mr-2"></i> Voltar\n                    </button>\n                    <div class="text-center mb-10">\n                        <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">ENTRAR</h2>\n                        <p class="text-gray-300 tracking-wider">Acesse sua conta para continuar</p>\n                    </div>\n                    <div class="space-y-5">\n                        <div>\n                            <input id="signInEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                        <div>\n                            <input id="signInPassword" type="password" placeholder="Senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                    </div>\n                    <button onclick="handleSignIn()" class="btn-red w-full mt-8 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">\n                        <span class="text-lg">LOGIN</span>\n                        <i class="fas fa-sign-in-alt"></i>\n                    </button>\n                </div>\n            </div>\n        '}function renderRegister(){appContainer.innerHTML='\n            <div class="min-h-screen flex flex-col justify-center items-center" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url(\'https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80\'); background-size: cover; background-position: center;">\n                <div class="card p-10 w-full max-w-md text-white overflow-hidden" style="border-radius: 24px;">\n                    <button onclick="changeStep(\'landing\')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition">\n                        <i class="fas fa-arrow-left mr-2"></i> Voltar\n                    </button>\n                    <div class="text-center mb-10">\n                        <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4" style="font-weight: 700;">CADASTRO</h2>\n                        <p class="text-gray-300 tracking-wider">Crie sua conta para come√ßar a apimentar!</p>\n                    </div>\n                    <div class="space-y-5">\n                        <div>\n                            <input id="registerNome" placeholder="Seu nome" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                        <div>\n                            <input id="registerEmail" type="email" placeholder="Email" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                        <div>\n                            <input id="registerTelefone" type="tel" placeholder="Telefone (apenas n√∫meros, ex: 11999991111)" pattern="[0-9]{11}" required class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                        <div>\n                            <input id="registerSenha" type="password" placeholder="Crie uma senha" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300" />\n                        </div>\n                        <div>\n                            <select id="registerSexo" class="w-full bg-gray-800 bg-opacity-50 border border-gray-700 focus:border-pink-500 focus:ring-2 focus:ring-pink-500/50 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-400 transition-all duration-300">\n                                <option value="" disabled selected>Selecione seu sexo</option>\n                                <option value="Masculino">Masculino</option>\n                                <option value="Feminino">Feminino</option>\n                            </select>\n                        </div>\n                    </div>\n                    <button onclick="handleRegister()" class="btn-red w-full mt-8 py-4 rounded-xl hover:shadow-xl transition-all duration-400 flex items-center justify-center gap-3">\n                        <span class="text-lg">CADASTRAR</span>\n                        <i class="fas fa-arrow-right-long"></i>\n                    </button>\n                    <p class="text-center mt-6 text-gray-400 text-sm">\n                        Ao continuar, voc√™ concorda com nossos <a href="#" class="text-pink-400 hover:underline">Termos</a> e <a href="#" class="text-pink-400 hover:underline">Pol√≠tica de Privacidade</a>\n                    </p>\n                </div>\n            </div>\n        '}async function solicitarPermissaoDeNotificacao(){if("Notification"in window&&"serviceWorker"in navigator&&"PushManager"in window)try{const e=await navigator.serviceWorker.register("./firebase-messaging-sw.js");console.log("Service Worker registrado com sucesso:",e);if("granted"!==await Notification.requestPermission())return console.log("Permiss√£o de notifica√ß√£o negada."),void showToast("Voc√™ n√£o receber√° notifica√ß√µes.","aviso");console.log("Permiss√£o de notifica√ß√£o concedida.");const t=firebase.messaging(),a=await t.getToken({vapidKey:"BDTOlIk3SKC6BV_MD0Eu2DZfm7rPOnGbz6hvYL1K_3lYnR1YXvO6qbOMuHHzBqzHhtyKw8YJMetHIas4V8wrWpI",serviceWorkerRegistration:e});if(!a)return console.log("N√£o foi poss√≠vel obter o token do FCM. Tente recarregar a p√°gina."),void showToast("N√£o foi poss√≠vel ativar notifica√ß√µes agora.","aviso");console.log("Token do FCM obtido:",a),await syncNotificationToken({token:a}),state.fcmToken=a,state.usuario||(state.usuario={}),state.usuario.notificationsEnabled=!0,showToast("Notifica√ß√µes ativadas!","sucesso"),renderApp()}catch(e){console.error("Erro detalhado ao solicitar permiss√£o:",e),showToast("Erro ao ativar notifica√ß√µes.","erro")}else console.warn("Este navegador n√£o suporta notifica√ß√µes Push.")}async function desativarNotificacoes(){try{console.log("Iniciando processo de desativa√ß√£o...");const e=await navigator.serviceWorker.getRegistration();if(!e)return void console.log("Nenhum Service Worker encontrado.");const t=await e.pushManager.getSubscription();t&&(await t.unsubscribe(),console.log("Assinatura de Push cancelada no navegador."));const a=state.fcmToken||state.usuario?.fcmToken||null;if(await syncNotificationToken({revoke:!0,token:a||void 0}),a&&firebase.messaging&&firebase.messaging.isSupported&&firebase.messaging.isSupported())try{await firebase.messaging().deleteToken(a),console.log("Token removido do Firebase Messaging neste dispositivo.")}catch(e){console.warn("Falha ao remover token local do FCM:",e)}state.usuario&&(state.usuario.notificationsEnabled=!1),state.fcmToken=null,console.log("Token FCM removido do backend."),showToast("Notifica√ß√µes desativadas com sucesso!","sucesso"),renderApp()}catch(e){console.error("Erro ao desativar notifica√ß√µes:",e),showToast("Erro ao desativar notifica√ß√µes.","erro")}}function setupForegroundMessageHandler(){if(firebase.messaging.isSupported()){firebase.messaging().onMessage(e=>{console.log("Notifica√ß√£o Push recebida em primeiro plano: ",e);const t=e.data.title,a=e.data.body;if("achievement"===(e.data?.type||null)){const o=showAchievementCelebration(e.data?.achievementId||null);showToast(o?`üèÜ ${o.title}${o.description?`: ${o.description}`:""}`:`üèÜ ${t}: ${a}`,"sucesso"),trackGAEvent("unlock_achievement",{achievement_id:e.data?.achievementId||"unknown"}),trackMetaEvent("UnlockAchievement",{achievement_id:e.data?.achievementId||"unknown"})}else showToast(`üîî ${t}: ${a}`,"sucesso");updateFixedUI()})}}async function sendPairingRequest(){const e=document.getElementById("codigoParceiro").value;if(e&&11===e.length&&/^\d+$/.test(e))if(e!==state.usuario.telefone)try{const t={type:"pairing_request",fromUid:auth.currentUser&&auth.currentUser.uid||state.usuario.uid,fromName:state.usuario.nome,fromPhone:state.usuario.telefone,toPhone:e,timestamp:firebase.firestore.FieldValue.serverTimestamp(),processed:!1};await safeAddInput(t),trackGAEvent("initiate_pairing"),trackMetaEvent("InitiatePairing"),state.usuario.pareadoCom=`pending_${e}`,showToast("Solicita√ß√£o enviada! Aguardando confirma√ß√£o.","sucesso"),state.etapa="parear",state.codigoDigitando=!1,renderApp()}catch(e){console.error("Erro ao enviar solicita√ß√£o de pareamento:",e),showToast("Erro ao enviar solicita√ß√£o. Tente novamente.","erro")}else showToast("Voc√™ n√£o pode parear consigo mesmo!","erro");else showToast("Por favor, digite um telefone com 11 d√≠gitos.","aviso")}async function acceptPairingRequest(e,t,a){try{if(state.usuario.pareadoCom&&"string"==typeof state.usuario.pareadoCom&&!state.usuario.pareadoCom.startsWith("pending_"))return void showToast("Voc√™ j√° est√° pareado com outra pessoa.","aviso");await safeAddInput({type:"pairing_response",fromUid:auth.currentUser&&auth.currentUser.uid||state.usuario.uid,requestId:e,response:"accepted"}),showToast("Solicita√ß√£o aceita. Aguardando processamento...","sucesso"),setTimeout(()=>loadUserDataAndNavigate(state.usuario.uid,state.usuario.email),800)}catch(e){console.error("Erro ao aceitar pareamento:",e),showToast("Erro ao aceitar pareamento. Tente novamente.","erro")}}async function rejectPairingRequest(e){try{await safeAddInput({type:"pairing_response",fromUid:auth.currentUser&&auth.currentUser.uid||state.usuario.uid,requestId:e,response:"rejected"}),showToast("Solicita√ß√£o de pareamento rejeitada.","sucesso"),state.pendingPairingRequest=null,renderApp()}catch(e){console.error("Erro ao rejeitar pareamento:",e),showToast("Erro ao rejeitar solicita√ß√£o.","erro")}}async function cancelPendingPairingRequest(){if(confirm("Tem certeza que deseja cancelar esta solicita√ß√£o de pareamento?"))try{const e=state.usuario.uid,t=state.usuario.pareadoCom.replace("pending_","");await safeAddInput({type:"pairing_cancel",fromUid:auth.currentUser&&auth.currentUser.uid||e,partnerPhone:t}),showToast("Solicita√ß√£o de pareamento cancelada. Aguardando processamento","sucesso"),state.usuario.pareadoCom=null,state.usuario.pareadoUid=null,state.parceiroData=null,state.parceiroNome=null,state.parceiroTelefone=null,state.idPareamentoAmigavel=null,state.pareado=!1,state.etapa="parear",renderApp()}catch(e){console.error("Erro ao cancelar solicita√ß√£o:",e),showToast("Erro ao cancelar solicita√ß√£o.","erro")}}function renderPareamento(){if(state.pareado&&state.parceiroData){const e=state.parceiroData.fotoUrl||"/assets/icons/iconprincipal.png",t=state.usuario.lastCheckInDate?state.usuario.lastCheckInDate.toDate():null,a=!t||!isSameDay(t,new Date),o=a?"Presentear com 1 üî•":"Presenteado Hoje",n=a?"bg-yellow-600 hover:bg-yellow-700 text-white":"bg-gray-700 text-gray-400 cursor-not-allowed";return void(appContainer.innerHTML=`\n        <div class="container mx-auto px-4 py-8 pb-24 pt-24">\n            <div class="max-w-md mx-auto card text-center p-8">\n                <h2 class="text-2xl font-bold mb-4 text-gray-300">Conectado com</h2>\n                <img src="${e}" class="w-32 h-32 rounded-full object-cover border-4 border-pink-500/50 mx-auto mb-4">\n                <h3 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500">${state.parceiroData.nome}</h3>\n                \n                <p class="text-gray-500 text-sm mt-2">ID do Casal: ${state.idPareamentoAmigavel||"Indispon√≠vel"}</p>\n\n                <div class="mt-8 space-y-4">\n                    <button onclick="handleDailyCheckIn()" ${a?"":"disabled"} class="w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${n}">\n                        <i class="fas fa-gift"></i> ${o}\n                    </button>\n                    <button onclick="desparearParceiro()" class="w-full py-3 bg-red-800/60 hover:bg-red-700 text-white rounded-lg font-semibold transition">\n                        Desfazer Pareamento\n                    </button>\n\n                    \x3c!-- Bot√£o de seguir no Instagram (discreto, com borda em gradiente) --\x3e\n                    <button onclick="window.open('https://instagram.com/nossomomentoapp','_blank')" class="instagram-cta-outline w-full mt-2">\n                        <span class="instagram-cta-inner w-full justify-center">\n                            <i class="fab fa-instagram"></i> Siga-nos no Instagram!\n                        </span>\n                    </button>\n                </div>\n            </div>\n        </div>\n        ${state.showCartSidebar?`\n<div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>\n<div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">\n    <div class="flex justify-between items-center mb-6">\n        <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>\n        <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white">\n            <i class="fas fa-times"></i>\n        </button>\n    </div>\n\n    <div class="space-y-3">\n        ${0===state.carrinho.length?'\n            <p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>\n        ':state.carrinho.map((e,t)=>`\n            <div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center">\n                <div>\n                    <h4 class="font-medium">${e.emoji} ${e.nome}</h4>\n                    <small class="text-gray-400 text-sm">${e.categoria}</small>\n                    <div class="text-yellow-400 text-sm flex items-center gap-1 mt-1">\n                        <i class="fas fa-fire"></i> ${e.custoFoguinhos} Foguinhos\n                    </div>\n                </div>\n                <button onclick="removerDoCarrinho(${t})" class="text-red-400 hover:text-red-300">\n                    <i class="fas fa-trash"></i>\n                </button>\n            </div>\n        `).join("")}\n    </div>\n\n    <div class="mt-8 pt-6 border-t border-gray-800">\n        <button onclick="finalizarPedido()" \n            class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all\n            ${0===state.carrinho.length?"opacity-50 cursor-not-allowed":""}"\n            ${0===state.carrinho.length?"disabled":""}>\n            Finalizar Pedido\n        </button>\n        <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">\n            Continuar Resgatando\n        </button>\n    </div>\n</div>\n`:""}\n    `)}const e=state.usuario.telefone.replace(/\D/g,"");let t="";if(state.pendingPairingRequest)t=`\n        <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">\n            <div class="card p-8 max-w-md w-full text-center">\n                <h2 class="text-3xl font-bold mb-4 text-pink-400">Solicita√ß√£o Recebida</h2>\n                <p class="mb-4">Voc√™ recebeu uma solicita√ß√£o de pareamento de:</p>\n                <div class="text-2xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block mb-6">${state.pendingPairingRequest.senderName}</div>\n                <div class="flex flex-col sm:flex-row justify-center gap-4">\n                    <button onclick="acceptPairingRequest('${state.pendingPairingRequest.id}', '${state.pendingPairingRequest.senderUid}', '${state.pendingPairingRequest.senderPhone}')" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded text-white font-semibold transition flex-1">Aceitar</button>\n                    <button onclick="rejectPairingRequest('${state.pendingPairingRequest.id}')" class="btn-red px-6 py-3 rounded text-white font-semibold transition flex-1">Rejeitar</button>\n                </div>\n            </div>\n        </div>`;else if(state.usuario.pareadoCom&&state.usuario.pareadoCom.startsWith("pending_")){t=`\n        <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">\n            <div class="card p-8 max-w-md w-full text-center">\n                <h2 class="text-3xl font-bold mb-4 text-yellow-400">Solicita√ß√£o Enviada</h2>\n                <p class="mb-4">Sua solicita√ß√£o para ${state.usuario.pareadoCom.replace("pending_","")} est√° pendente.</p>\n                <p class="text-sm text-gray-300 mb-6">Aguardando aceita√ß√£o...</p>\n                <button onclick="cancelPendingPairingRequest()" class="btn-red px-6 py-3 rounded text-white font-semibold transition">Cancelar Solicita√ß√£o</button>\n            </div>\n        </div>`}else t=`\n        <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">\n            <div class="card p-8 max-w-md w-full text-center">\n                <h2 class="text-3xl font-bold mb-4 text-pink-400">Parear com seu Amor</h2>\n                ${state.codigoDigitando?'\n                    <div class="mb-6">\n                        <label class="block mb-2">Digite o c√≥digo do seu parceiro(a)</label>\n                        <input id="codigoParceiro" type="text" class="w-full p-3 rounded text-white text-center" placeholder="11999991111" maxlength="11" />\n                    </div>\n                    <div class="flex gap-4">\n                        <button onclick="state.codigoDigitando = false; renderApp();" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded font-semibold transition">Voltar</button>\n                        <button onclick="sendPairingRequest()" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded font-semibold transition flex-1">Enviar Solicita√ß√£o</button>\n                    </div>\n                ':`\n                    <p class="mb-4">Seu c√≥digo de pareamento √©:</p>\n                    <div class="text-4xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block">${e}</div>\n                    <p class="mt-4 text-sm text-gray-300 mb-6">Compartilhe este c√≥digo com seu/sua parceiro(a).</p>\n                    <div class="flex flex-col sm:flex-row justify-center gap-4">\n                        <button onclick="state.codigoDigitando = true; renderApp();" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded text-white font-semibold transition">Digitar C√≥digo</button>\n                        <button onclick="handleContinuarSemParear()" class="btn-red">Fazer Isso Depois</button>\n                    </div>\n                `}\n            </div>\n        </div>`;appContainer.innerHTML=t}async function renderFoguinhosPopupContent(){try{if(state.notificacoesPresentesNaoLidas>0){const e=db.batch();let t=0;state.notificacoes.forEach(a=>{if(!a.lida&&"fa-gift"===a.icone){const o=db.collection("notificacoes").doc(a.id);e.update(o,{lida:!0}),t++}}),t>0&&(await e.commit(),console.log(`Marcou ${t} notifica√ß√µes de presente como lidas.`),state.notificacoesPresentesNaoLidas=0,updateFixedUI())}}catch(e){console.error("Erro ao marcar notifica√ß√µes de presente como lidas:",e)}const e=state.notificacoes.filter(e=>"fa-gift"===e.icone);appContainer.innerHTML=`\n    <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8 pt-24 pb-24">\n        <div class="card p-6 md:p-8 max-w-md w-full relative overflow-hidden">\n            <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-pink-500 opacity-10"></div>\n            <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-red-500 opacity-10"></div>\n            \n            <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500">\n                <i class="fas fa-fire mr-2"></i> Meus Foguinhos\n            </h2>\n            <div class="text-center mb-6">\n                <p class="mb-4 text-xl">Voc√™ tem:</p>\n                <div class="relative inline-block">\n                    <i class="fas fa-fire text-6xl text-yellow-400 animate-pulse"></i>\n                    <span class="badge-notification badge-yellow text-2xl" style="top: 0px; right: -20px; min-width: 40px; height: 40px;">\n                        ${state.usuario?state.usuario.foguinhos:0}\n                    </span>\n                </div>\n                <p class="mt-4 text-sm text-gray-300">Use-os para resgatar momentos!</p>\n            </div>\n\n            <div class="border-t border-gray-700 mt-6 pt-6">\n                <h3 class="font-bold text-lg text-center text-gray-300 mb-4">Hist√≥rico de Presentes</h3>\n                \n                <div class="space-y-3 max-h-48 overflow-y-auto pr-2">\n                    ${0===e.length?'<p class="text-center text-gray-500 py-4">Nenhum presente recebido ainda.</p>':e.map(e=>`\n                            <div class="bg-gray-800/50 p-3 rounded-lg flex items-center gap-3 ${e.lida?"":"border-l-2 border-yellow-400"}">\n                                <i class="fas ${e.icone||"fa-info-circle"} text-xl text-yellow-400"></i>\n                                <div>\n                                    <p class="text-sm text-gray-200">${e.mensagem}</p>\n                                    <p class="text-xs text-gray-500 mt-1">${e.timestamp?new Date(1e3*e.timestamp.seconds).toLocaleString("pt-BR"):""}</p>\n                                </div>\n                            </div>\n                        `).join("")}\n                </div>\n            </div>\n\n            <div class="flex justify-center mt-8">\n                <button onclick="changeStep('main');" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded text-white font-semibold transition">\n                    Voltar\n                </button>\n            </div>\n        </div>\n    </div>\n    `}function setupNotificationListener(e){unsubscribeNotifications&&unsubscribeNotifications(),hasProcessedInitialNotifications=!1,lastNotificationIds=new Set;const t=db.collection("notificacoes").where("userId","==",e).orderBy("timestamp","desc").limit(20);unsubscribeNotifications=t.onSnapshot(e=>{const t=[];e.forEach(e=>{t.push({id:e.id,...e.data()})}),state.notificacoes=t;let a=0,o=0,n=0;t.forEach(e=>{e.lida||("fa-shopping-bag"===e.icone?a++:"fa-gift"===e.icone?o++:"achievement"!==e.tipo&&"fa-trophy"!==e.icone||n++)}),state.notificacoesTarefasNaoLidas=a,state.notificacoesPresentesNaoLidas=o,state.notificacoesConquistasNaoLidas=n;const s=e.docChanges?e.docChanges():[];if(hasProcessedInitialNotifications&&s.length){const e=[];s.forEach(t=>{if("added"===t.type){const a={id:t.doc.id,...t.doc.data()};a.lida||"achievement"!==a.tipo&&"fa-trophy"!==a.icone||e.push(a)}}),e.length&&(console.log("Novas notifica√ß√µes de conquista detectadas:",e.map(e=>e.id)),e.forEach(triggerAchievementCelebration))}const i=new Set(t.map(e=>e.id));lastNotificationIds=i,hasProcessedInitialNotifications=!0,console.log(`Notifica√ß√µes carregadas: ${t.length}, Tarefas n√£o lidas: ${a}, Presentes n√£o lidos: ${o}, Conquistas n√£o lidas: ${n}`),"notificacoes"===state.etapa&&renderNossasTarefas(),updateFixedUI()})}async function renderAchievementsPopup(){await marcarNotificacoesDeConquistaComoLidas();const e=state.usuario?.conquistas||{},t=ACHIEVEMENTS.map(t=>{const a=e[t.id],o=!!a,n=t.accentColor||"#fbbf24",s=t.title,i=t.description,r=t.hint||"",c=o?formatarDataCurta(a.unlockedAt):"",l=t.icon||"fa-trophy",d=r?`title="${escapeHtmlAttr(r)}"`:"",u="number"==typeof t.reward?t.reward:null,p=null!==u?`Recompensa: ${u} foguinho${1===u?"":"s"}`:"";return`\n            <div class="rounded-2xl p-5 sm:p-6 border transition ${o?"bg-gray-900 border-transparent shadow-lg shadow-black/30":"bg-gray-800/40 border-gray-700 backdrop-blur-sm opacity-70"}" ${d}>\n                <div class="flex items-center gap-4">\n                    <div class="w-12 h-12 sm:w-14 sm:h-14 rounded-full flex items-center justify-center ${o?"":"border border-gray-600"}" style="${o?`background: ${n}; color: #111827;`:""}">\n                        <i class="fas ${l} text-lg sm:text-xl"></i>\n                    </div>\n                    <div class="flex-1">\n                        <h4 class="font-semibold text-base sm:text-lg ${o?"":"text-gray-300"}">${s}</h4>\n                        <p class="text-xs sm:text-sm ${o?"text-gray-300":"text-gray-500"}">${i}</p>\n                        ${p?`<p class="text-xs sm:text-sm font-semibold text-amber-400 mt-2">${p}</p>`:""}\n                        ${o?`<p class="text-xs text-emerald-400 mt-1"><i class="fas fa-check-circle mr-1"></i>${c?`Conquistado em ${c}`:"Conquista desbloqueada!"}</p>`:`<p class="text-[11px] text-gray-500 mt-1">${r||"Complete a tarefa para desbloquear."}</p>`}\n                    </div>\n                </div>\n            </div>\n        `}).join("");appContainer.innerHTML=`\n        <div class="achievements-overlay min-h-screen w-full bg-black bg-opacity-90 text-white px-4 sm:px-8 py-12 sm:py-16 flex justify-center items-start sm:items-center overflow-y-auto">\n            <div class="card achievements-popup-card w-full max-w-3xl relative overflow-hidden shadow-2xl flex flex-col sm:max-h-[85vh] p-6 sm:p-10">\n                <div class="absolute -top-24 -right-24 w-48 h-48 rounded-full bg-yellow-500 opacity-10 pointer-events-none"></div>\n                <div class="absolute -bottom-24 -left-24 w-48 h-48 rounded-full bg-pink-500 opacity-10 pointer-events-none"></div>\n                <div class="flex items-center justify-between mb-6 sm:mb-8">\n                    <div class="flex items-center gap-4">\n                        <div class="w-14 h-14 rounded-full bg-yellow-500/20 text-yellow-300 flex items-center justify-center">\n                            <i class="fas fa-trophy text-2xl"></i>\n                        </div>\n                        <div>\n                            <h2 class="text-3xl font-bold">Mural de Conquistas</h2>\n                            <p class="text-sm text-gray-400">Celebre seus trof√©us e descubra o que falta desbloquear.</p>\n                        </div>\n                    </div>\n                    <button type="button" onclick="toggleAchievementsPopup()" class="text-gray-400 hover:text-white text-lg focus:outline-none focus:ring-2 focus:ring-gray-300" aria-label="Fechar mural">\n                        <i class="fas fa-times"></i>\n                    </button>\n                </div>\n                <div class="mt-6 sm:mt-8 sm:flex-1 sm:overflow-y-auto sm:pr-3">\n                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-5">\n                        ${t}\n                    </div>\n                </div>\n                <div class="mt-6 sm:mt-8 flex justify-center">\n                    <button type="button" onclick="toggleAchievementsPopup()" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded text-white font-semibold transition focus:outline-none focus:ring-2 focus:ring-gray-300">\n                        Voltar\n                    </button>\n                </div>\n            </div>\n        </div>\n    `}function renderPartnerInfoPopup(){const e=state.usuario.lastCheckInDate?state.usuario.lastCheckInDate.toDate():null,t=state.pareado&&(!e||!isSameDay(e,new Date));appContainer.innerHTML=`\n            <div class="min-h-screen flex flex-col justify-center items-center bg-black bg-opacity-90 text-white p-8">\n                <div class="card p-8 max-w-md w-full relative overflow-hidden">\n                    <div class="absolute -top-20 -right-20 w-40 h-40 rounded-full bg-pink-500 opacity-10"></div>\n                    <div class="absolute -bottom-20 -left-20 w-40 h-40 rounded-full bg-red-500 opacity-10"></div>\n                    <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-green-500 to-blue-500">\n                        <i class="fas fa-user-heart mr-2"></i> Seu Parceiro\n                    </h2>\n                    <div class="text-center mb-6">\n                        <p class="mb-2 text-xl">Nome: <span class="font-bold text-green-400">${state.parceiroNome||"N/A"}</span></p>\n                        <p class="mb-4 text-md text-gray-300">Telefone: ${state.parceiroCodigo||"N/A"}</p>\n                    </div>\n                    <div class="space-y-4">\n                        <button onclick="handleDailyCheckIn()" ${t?"":"disabled"}\n                            class="w-full text-sm px-6 py-3 rounded-lg font-medium transition flex items-center justify-center gap-2\n                            ${t?"bg-yellow-600 hover:bg-yellow-700 text-white":"bg-gray-700 text-gray-400 cursor-not-allowed"}">\n                            <i class="fas fa-gift text-xs"></i> Presentear üî•\n                        </button>\n\n                        <button onclick="desparearParceiro()" class="w-full text-sm bg-red-800 hover:bg-red-700 text-white px-6 py-3 rounded-lg transition">\n                            <i class="fas fa-unlink text-xs"></i> Desfazer Pareamento\n                        </button>\n\n                        \x3c!-- Bot√£o de seguir no Instagram (discreto, com borda em gradiente) --\x3e\n                        <button onclick="window.open('https://instagram.com/nossomomentoapp','_blank')" class="instagram-cta-outline w-full">\n                            <span class="instagram-cta-inner w-full justify-center">\n                                <i class="fab fa-instagram text-xs"></i> Siga-nos no Instagram!\n                            </span>\n                        </button>\n\n                        <button onclick="togglePartnerInfoPopup();" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded text-white font-semibold transition w-full">\n                            Voltar\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `}function renderMain(){if(!state.pareado||!state.parceiroData)return void(appContainer.innerHTML='\n            <div class="min-h-screen container mx-auto px-4 py-8 text-center flex flex-col justify-center items-center">\n            <h2 class="text-2xl font-bold mb-4">Voc√™ ainda n√£o est√° pareado(a).</h2>\n            <p class="text-gray-400 mb-6">Pareie com seu/sua parceiro(a) para ver o cat√°logo de momentos dele(a).</p>\n            <button onclick="changeStep(\'parear\')" class="btn-red">Parear agora</button>\n\n            \x3c!-- CTA social abaixo do bot√£o de parear (discreto com borda em gradiente) --\x3e\n            <button onclick="window.open(\'https://instagram.com/nossomomentoapp\',\'_blank\')" class="instagram-cta-outline mt-4 inline-block">\n                <span class="instagram-cta-inner inline-flex items-center gap-2">\n                    <i class="fab fa-instagram"></i> Siga-nos no Instagram!\n                </span>\n            </button>\n        </div>\n    ');const e=state.parceiroData.sexo,t=state.momentosMestres.filter(t=>t.targetGender===e||"Unisex"===t.targetGender),a=state.parceiroData.catalogoPersonalizado||{},o=[...new Set(t.map(e=>e.categoria))].map(e=>{const t=state.momentosMestres.find(t=>t.categoria===e);let a="bg-gray-800";if(t)switch(t.categoria){case"Quentes":a="bg-pink-600";break;case"Lovezin":a="bg-red-600";break;case"Sair da Rotina":a="bg-amber-600"}return{nome:e,emoji:t.emoji,color:a}}),n=state.parceiroData.fotoUrl||"/assets/icons/logo-instagram-white.png";appContainer.innerHTML=`\n    <main class="container mx-auto px-4 py-8 pb-24 pt-24 bg-gradient-to-br from-gray-900 to-black text-white">\n        <div class="mb-12 text-center">\n            <img src="${n}" class="w-24 h-24 rounded-full object-cover border-4 border-pink-500/50 mx-auto mb-6">\n            <h2 class="text-3xl md:text-4xl font-bold mb-4">Cat√°logo de ${state.parceiroNome}</h2>\n            <p class="text-gray-400 max-w-2xl mx-auto">Escolha os momentos que voc√™ deseja viver!</p>\n        </div>\n        \n        <div class="flex flex-wrap justify-center gap-3 mb-12">\n            <button onclick="filtrarMomentos(null)"\n                class="px-4 py-2 rounded-full transition-all ${state.filtro?"bg-gray-800 text-gray-300 hover:bg-gray-700":"bg-pink-600 text-white shadow-lg"}"\n                style="background: ${state.filtro?"":"linear-gradient(45deg, #FF3547 0%, #FF6B7B 100%)"}">\n                Todos\n            </button>\n            ${o.map(e=>`\n                <button onclick="filtrarMomentos('${e.nome}')"\n                    class="px-4 py-2 rounded-full transition-all ${state.filtro===e.nome?"text-white shadow-lg":"text-gray-300 hover:bg-gray-800/50"} ${e.color}">\n                    ${e.emoji} ${e.nome}\n                </button>\n            `).join("")}\n        </div>\n        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">\n            ${(state.filtro?t.filter(e=>e.categoria===state.filtro):t).map(e=>{const t=a[e.nome],o=void 0!==t?.preco?t.preco:2*e.intensidade,n=t?.bloqueado||!1,s={...e,custoFoguinhos:o};return`\n                <div class="product-card group ${n?"opacity-50":""}">\n                    <div class="relative overflow-hidden">\n                        <img src="${e.img}" alt="${e.nome}" class="product-img group-hover:scale-105 transition-transform duration-300">\n                        <span class="product-badge">${e.emoji} ${e.categoria}</span>\n                        ${n?'<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><i class="fas fa-lock text-4xl text-white"></i></div>':""}\n                    </div>\n                    <div class="p-4">\n                        <h3 class="font-medium">${e.nome}</h3>\n                        <div class="flex justify-between items-center mt-4">\n                            <span class="text-yellow-400 text-sm flex items-center gap-1 font-semibold">\n                                <i class="fas fa-fire"></i> ${o} Foguinhos\n                            </span>\n                            <button onclick='adicionarAoCarrinho(${JSON.stringify(s).replace(/"/g,"&quot;")})'\n                                class="text-sm px-4 py-2 rounded-lg transition ${n?"bg-gray-700 cursor-not-allowed":"bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white"}"\n                                ${n?"disabled":""}>\n                                ${n?"üîí":"Resgatar"}\n                            </button>\n                        </div>\n                    </div>\n                </div>\n                `}).join("")}\n        </div>\n    </main>\n\n    ${state.showCartSidebar?`\n        <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>\n        <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">\n            <div class="flex justify-between items-center mb-6">\n                <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>\n                <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n            <div class="space-y-3">\n                ${0===state.carrinho.length?'<p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>':state.carrinho.map((e,t)=>`\n                    <div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center">\n                        <div>\n                            <h4 class="font-medium">${e.emoji} ${e.nome}</h4>\n                            <small class="text-gray-400 text-sm">${e.categoria}</small>\n                            <div class="text-yellow-400 text-sm flex items-center gap-1 mt-1">\n                                <i class="fas fa-fire"></i> ${e.custoFoguinhos} Foguinhos\n                            </div>\n                        </div>\n                        <button onclick="removerDoCarrinho(${t})" class="text-red-400 hover:text-red-300">\n                            <i class="fas fa-trash"></i>\n                        </button>\n                    </div>\n                `).join("")}\n            </div>\n            <div class="mt-8 pt-6 border-t border-gray-800">\n                <button onclick="finalizarPedido()" \n                    class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all ${0===state.carrinho.length?"opacity-50 cursor-not-allowed":""}"\n                    ${0===state.carrinho.length?"disabled":""}>\n                    Finalizar Pedido\n                </button>\n                <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">\n                    Continuar Resgatando\n                </button>\n            </div>\n        </div>\n    `:""}\n`}function calcularPrecoBase(e){if(null==e)return 10;const t=Number(e.intensidade);if(Number.isFinite(t)&&t>=0)return 2*t;const a=Number(e.custoFoguinhos);return Number.isFinite(a)&&a>=0?a:10}function normalizarPreco(e,t){if(""===e||null==e)return t;const a=Number(e);return Number.isFinite(a)&&a>=0?a:t}async function marcarNotificacoesDeConquistaComoLidas(){if(state.usuario?.uid&&!(state.notificacoesConquistasNaoLidas<=0))try{const e=db.batch();let t=0;state.notificacoes.forEach(a=>{if(!a.lida&&("achievement"===a.tipo||"fa-trophy"===a.icone)){const o=db.collection("notificacoes").doc(a.id);e.update(o,{lida:!0}),t++}}),t>0&&(await e.commit(),state.notificacoesConquistasNaoLidas=0,updateFixedUI())}catch(e){console.error("Erro ao marcar conquistas como lidas:",e)}}function renderGerenciarCatalogo(){const e=state.usuario?.sexo||"Masculino",t=state.momentosMestres.filter(t=>t.targetGender===e||"Unisex"===t.targetGender),a=state.usuario?.catalogoPersonalizado||{},o=[...new Set(t.map(e=>e.categoria))],n=state.usuario?.fotoUrl||"assets/icons/iconprincipal.png",s=state.notificacoesConquistasNaoLidas||0,i=s>0?`<span class="px-3 py-1 rounded-full bg-red-600/80 text-white text-xs font-semibold shadow-lg shadow-red-900/40">${s} novo${s>1?"s":""}</span>`:"",r=s>0?"ring-1 ring-yellow-400/60 shadow-lg":"hover:bg-gray-800/40";let c="";window.Notification&&(c=state.usuario&&state.usuario.notificationsEnabled&&"granted"===Notification.permission?'\n            <button onclick="handleNotificationToggle()" class="mt-4 bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg transition">\n                <i class="fas fa-bell-slash"></i> Desativar Notifica√ß√µes\n            </button>\n        ':"denied"===Notification.permission?'\n            <button onclick="handleNotificationToggle()" class="mt-4 bg-gray-600 text-gray-400 font-bold py-2 px-4 rounded-lg cursor-not-allowed" title="Voc√™ precisa permitir as notifica√ß√µes nas configura√ß√µes do seu navegador.">\n                <i class="fas fa-ban"></i> Notifica√ß√µes Bloqueadas\n            </button>\n        ':'\n            <button onclick="handleNotificationToggle()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">\n                <i class="fas fa-bell"></i> Ativar Notifica√ß√µes\n            </button>\n        '),appContainer.innerHTML=`\n    <div class="container mx-auto px-4 py-8 pb-24 pt-24">\n        <div class="text-center mb-10">\n            <h2 class="text-3xl md:text-4xl font-bold mb-2">Meu Perfil e Cat√°logo</h2>\n            <p class="text-gray-400 max-w-2xl mx-auto">Gerencie sua foto, pre√ßos e a disponibilidade dos momentos.</p>\n        </div>\n\n        <div class="max-w-2xl mx-auto mb-12 p-6 card flex flex-col items-center">\n            <h3 class="font-bold text-xl mb-4">Sua Foto de Perfil</h3>\n            <img id="profilePicPreview" src="${n}" class="w-32 h-32 rounded-full object-cover border-4 border-gray-600 mb-4">\n            <input type="file" id="fileInput" onchange="handleFileSelect(event)" accept="image/*" class="hidden">\n            <button onclick="document.getElementById('fileInput').click()" class="text-pink-400 hover:text-pink-300 font-semibold">\n                Trocar Foto\n            </button>\n\n            ${c}\n\n            <div id="uploadProgress" class="w-full bg-gray-700 rounded-full h-2.5 mt-4 hidden">\n                <div id="uploadProgressBar" class="bg-pink-600 h-2.5 rounded-full" style="width: 0%"></div>\n            </div>\n        </div>\n\n        <div class="space-y-4 max-w-2xl mx-auto">\n            <div class="card mb-12 p-6 cursor-pointer transition group ${r} focus:outline-none focus:ring-2 focus:ring-yellow-300/80" role="button" tabindex="0" aria-label="Abrir mural de conquistas" onclick="toggleAchievementsPopup()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();toggleAchievementsPopup();}">\n                <div class="flex items-center justify-between gap-4">\n                    <div class="flex items-center gap-3">\n                        <div class="w-10 h-10 flex items-center justify-center rounded-full bg-yellow-500/20 text-yellow-300">\n                            <i class="fas fa-trophy"></i>\n                        </div>\n                        <div>\n                            <h3 class="text-xl font-bold">Mural de Conquistas</h3>\n                            <p class="text-sm text-gray-400">Veja os trof√©us que voc√™ j√° desbloqueou e quais ainda pode conquistar.</p>\n                        </div>\n                    </div>\n                    <div class="flex items-center gap-3 text-sm text-gray-400 group-hover:text-yellow-200 transition">\n                        ${i}\n                        <i class="fas fa-chevron-right text-base"></i>\n                    </div>\n                </div>\n            </div>\n            ${o.map(e=>`\n                <div class="card overflow-hidden">\n                    <button onclick="toggleAccordion(this)" class="w-full p-4 text-left font-bold text-lg flex justify-between items-center">\n                        <span>${e}</span>\n                        <i class="fas fa-chevron-down transition-transform duration-300"></i>\n                    </button>\n                    <div class="accordion-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out">\n                        <div class="space-y-2 p-4 border-t border-gray-700">\n                            ${t.filter(t=>t.categoria===e).map(e=>{const t=a[e.nome],o=calcularPrecoBase(e),n=normalizarPreco(t?.preco,o);t&&t.preco!==n&&(t.preco=n);const s=t?.bloqueado||!1;return`\n                                <div class="p-2 flex items-center justify-between gap-4">\n                                    <div class="flex items-center gap-4">\n                                        <img src="${e.img}" class="w-12 h-12 rounded-lg object-cover">\n                                        <div><h3 class="font-semibold">${e.nome}</h3></div>\n                                    </div>\n                                    <div class="flex items-center gap-4">\n                                        <div class="flex items-center gap-1 bg-gray-800 rounded-lg p-2">\n                                            <i class="fas fa-fire text-yellow-400"></i>\n                                            <input type="number" min="0" step="1" value="${n}" id="preco-${e.nome.replace(/\s+/g,"-")}" class="bg-transparent w-16 text-center font-bold">\n                                        </div>\n                                        <label class="relative inline-flex items-center cursor-pointer">\n                                            <input type="checkbox" ${s?"checked":""} class="sr-only peer" id="bloqueado-${e.nome.replace(/\s+/g,"-")}">\n                                            <div class="relative w-14 h-7 bg-pink-600 peer-checked:bg-gray-600 rounded-full transition-colors flex items-center justify-between px-2">\n                                                <i class="fas fa-lock text-white text-xs"></i>\n                                                <i class="fas fa-lock-open text-white text-xs"></i>\n                                            </div>\n                                            <div class="absolute top-0.5 left-[2px] w-6 h-6 bg-white rounded-full border border-gray-300 transition-transform transform peer-checked:translate-x-full"></div>\n                                        </label>\n                                    </div>\n                                </div>\n                                `}).join("")}\n                        </div>\n                    </div>\n                </div>\n            `).join("")}\n        </div>\n\n        <div class="mt-10 text-center">\n            <button onclick="handleSaveCatalogo()" class="btn-red px-10 py-4">\n                Salvar Altera√ß√µes\n            </button>\n        </div>\n    </div>\n\n    ${state.showCartSidebar?`\n        <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>\n        <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">\n            <div class="flex justify-between items-center mb-6">\n                <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>\n                <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>\n            </div>\n            <div class="space-y-3">\n                ${0===state.carrinho.length?'<p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>':state.carrinho.map((e,t)=>`\n                    <div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center">\n                        <div>\n                            <h4 class="font-medium">${e.emoji} ${e.nome}</h4>\n                            <small class="text-gray-400 text-sm">${e.categoria}</small>\n                            <div class="text-yellow-400 text-sm flex items-center gap-1 mt-1"><i class="fas fa-fire"></i> ${e.custoFoguinhos} Foguinhos</div>\n                        </div>\n                        <button onclick="removerDoCarrinho(${t})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>\n                    </div>\n                `).join("")}\n            </div>\n            <div class="mt-8 pt-6 border-t border-gray-800">\n                <button onclick="finalizarPedido()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all ${0===state.carrinho.length?"opacity-50 cursor-not-allowed":""}" ${0===state.carrinho.length?"disabled":""}>\n                    Finalizar Pedido\n                </button>\n                <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">\n                    Continuar Resgatando\n                </button>\n            </div>\n        </div>\n    `:""}\n`}async function handleSaveCatalogo(){console.log("Iniciando salvamento do cat√°logo...");const e={};state.momentosMestres.forEach(t=>{const a=`preco-${t.nome.replace(/\s+/g,"-")}`,o=`bloqueado-${t.nome.replace(/\s+/g,"-")}`,n=document.getElementById(a),s=document.getElementById(o);if(n&&s){const a=calcularPrecoBase(t),o=normalizarPreco(n.value,a),i=s.checked;e[t.nome]={preco:o,bloqueado:i}}});try{await db.collection("usuarios").doc(state.usuario.uid).update({catalogoPersonalizado:e}),state.usuario.catalogoPersonalizado=e,trackGAEvent("customize_catalog"),trackMetaEvent("CustomizeProduct"),alert("Seu cat√°logo foi salvo com sucesso!"),console.log("Cat√°logo salvo no Firestore:",e)}catch(e){console.error("Erro ao salvar o cat√°logo: ",e),alert("Houve um erro ao salvar seu cat√°logo. Tente novamente.")}}async function carregarMomentosMestres(){console.log("Buscando momentos mestres no Firestore..."),state.momentosMestres=[];try{const e=await db.collection("momentosMestres").orderBy("nome").get(),t=new Map;e.forEach(e=>{const a={id:e.id,...e.data()};if(!a||!a.nome)return void console.warn("Documento de momento sem nome ignorado:",e.id);const o=`${a.nome}::${a.targetGender||"any"}`;if(t.has(o)){const a=t.get(o);console.warn("Momento duplicado detectado no Firestore:",o,"doc existente:",a.id,"doc ignorado:",e.id)}else t.set(o,a)}),state.momentosMestres=Array.from(t.values()),console.log(`‚úÖ Sucesso: ${state.momentosMestres.length} momentos mestres carregados.`),console.log(state.momentosMestres)}catch(e){console.error("Erro ao carregar momentos mestres:",e),showToast("Erro ao carregar cat√°logo de momentos.","erro")}}function toggleAccordion(e){const t=e.nextElementSibling,a=!t.classList.contains("open");e.classList.toggle("open"),t.classList.toggle("open");const o=e=>{e.target===t&&"max-height"===e.propertyName&&(t.classList.contains("open")?(t.style.maxHeight="none",t.style.overflow="visible"):(t.style.maxHeight="0",t.style.overflow="hidden"),t.removeEventListener("transitionend",o))};t.addEventListener("transitionend",o),a?(t.style.overflow="hidden",t.style.maxHeight=t.scrollHeight+"px",0===t.scrollHeight&&requestAnimationFrame(()=>{t.style.maxHeight=t.scrollHeight+"px"})):("none"!==t.style.maxHeight&&""!==t.style.maxHeight||(t.style.maxHeight=t.scrollHeight+"px",t.offsetHeight),t.style.overflow="hidden",requestAnimationFrame(()=>{t.style.maxHeight="0"}))}async function handleNotificationToggle(){const e=state.usuario&&state.usuario.notificationsEnabled&&"granted"===Notification.permission;"denied"===Notification.permission?alert("As notifica√ß√µes est√£o bloqueadas. Voc√™ precisa permitir manualmente nas configura√ß√µes do seu navegador (clicando no √≠cone de cadeado üîí ao lado da URL)."):e?await desativarNotificacoes():await solicitarPermissaoDeNotificacao()}function handleFileSelect(e){const t=e.target.files[0];if(!t)return;if(!t.type.startsWith("image/"))return void alert("Por favor, selecione um arquivo de imagem (jpg, png, etc.).");if(t.size>5242880)return void alert("A imagem √© muito grande. Por favor, escolha uma com menos de 5MB.");const a=new FileReader;a.onload=function(e){const t=document.getElementById("profilePicPreview");t&&(t.src=e.target.result)},a.readAsDataURL(t),uploadProfilePic(t)}async function uploadProfilePic(e){if(!state.usuario)return void alert("Voc√™ precisa estar logado para enviar uma foto.");const t=document.getElementById("uploadProgress"),a=document.getElementById("uploadProgressBar");t&&t.classList.remove("hidden");const o=`profile_pics/${state.usuario.uid}/${e.name}`,n=storage.ref(o).put(e);n.on("state_changed",e=>{const t=e.bytesTransferred/e.totalBytes*100;a&&(a.style.width=t+"%"),console.log("Upload is "+t+"% done")},e=>{console.error("Erro no upload: ",e),alert("Houve um erro ao enviar sua foto."),t&&t.classList.add("hidden")},()=>{n.snapshot.ref.getDownloadURL().then(async e=>{console.log("Arquivo dispon√≠vel em",e),await db.collection("usuarios").doc(state.usuario.uid).update({fotoUrl:e}),state.usuario.fotoUrl=e,updateFixedUI(),alert("Foto de perfil atualizada com sucesso!"),t&&t.classList.add("hidden")})})}async function handleSignIn(){const e=document.getElementById("signInEmail").value,t=document.getElementById("signInPassword").value;if(e&&t)try{const a=(await auth.signInWithEmailAndPassword(e,t)).user;console.log("Usu√°rio logado com sucesso:",a),await loadUserDataAndNavigate(a.uid,a.email),trackGAEvent("login",{method:"Email"}),trackMetaEvent("Login")}catch(e){console.error("Erro no login:",e.code,e.message);let t="Erro ao fazer login. Verifique seu email e senha.";"auth/user-not-found"===e.code?t="Nenhum usu√°rio encontrado com este email.":"auth/wrong-password"===e.code?t="Senha incorreta.":"auth/invalid-email"===e.code?t="Email inv√°lido.":"auth/invalid-credential"===e.code&&(t="Credenciais inv√°lidas. Verifique seu email e senha."),alert(t)}else alert("Por favor, preencha o email e a senha.")}async function handleRegister(){const e=document.getElementById("registerNome").value,t=document.getElementById("registerEmail").value,a=document.getElementById("registerTelefone").value,o=document.getElementById("registerSenha").value,n=document.getElementById("registerSexo").value;if(e&&t&&a&&o&&n)if(11===a.length&&/^\d+$/.test(a))if(o.length<6)alert("A senha deve ter no m√≠nimo 6 caracteres.");else try{const s=(await auth.createUserWithEmailAndPassword(t,o)).user;console.log("Usu√°rio criado no Auth:",s),await db.collection("usuarios").doc(s.uid).set({nome:e,telefone:a,email:t,sexo:n,foguinhos:10,lastCheckInDate:null,pareadoCom:null,catalogoPersonalizado:{},createdAt:firebase.firestore.FieldValue.serverTimestamp()}),console.log("Dados do usu√°rio salvos com sucesso no Firestore!"),trackGAEvent("sign_up"),trackMetaEvent("CompleteRegistration"),state.usuario={uid:s.uid,email:s.email,nome:e,telefone:a,sexo:n,foguinhos:10,lastCheckInDate:null,pareadoCom:null,catalogoPersonalizado:{},conquistas:{},achievementStats:{}},state.conquistas={},state.achievementStats={},state.etapa="parear",renderApp(),alert("Cadastro realizado com sucesso! Voc√™ ser√° redirecionado para o pareamento.")}catch(e){console.error("Erro no cadastro:",e.code,e.message);let t="Erro ao cadastrar. Tente novamente.";"auth/email-already-in-use"===e.code?t="Este email j√° est√° em uso. Tente fazer login ou use outro email.":"auth/invalid-email"===e.code?t="O formato do email √© inv√°lido.":"auth/weak-password"===e.code&&(t="A senha √© muito fraca (m√≠nimo de 6 caracteres)."),alert(t)}else alert("O telefone deve conter exatamente 11 d√≠gitos num√©ricos (com DDD).");else alert("Por favor, preencha todos os campos.")}async function handleLogout(){try{unsubscribeNotifications&&(unsubscribeNotifications(),unsubscribeNotifications=null),await auth.signOut(),console.log("Usu√°rio deslogado com sucesso!"),state.usuario=null,state.pareado=!1,state.parceiroData=null,state.idPareamentoAmigavel=null,state.notificacoes=[],state.etapa="landing",state.carrinho=[],state.codigoUsuario=null,state.codigoDigitando=!1,state.parceiroCodigo=null,state.parceiroTelefone=null,state.parceiroNome=null,state.showPartnerInfo=!1,state.pendingPairingRequest=null,state.showCartSidebar=!1,state.showFoguinhosPopup=!1,state.conquistas={},state.achievementStats={},state.notificacoesTarefasNaoLidas=0,state.notificacoesPresentesNaoLidas=0,state.notificacoesConquistasNaoLidas=0,renderApp()}catch(e){console.error("Erro ao deslogar:",e),showToast("Erro ao fazer logout.","erro")}}async function handleDailyCheckIn(){if(state.pareado&&state.usuario&&state.usuario.pareadoUid)try{await safeAddInput({type:"daily_check_in",fromUid:auth.currentUser&&auth.currentUser.uid||state.usuario.uid,partnerUid:state.usuario.pareadoUid,timestamp:firebase.firestore.FieldValue.serverTimestamp()}),trackGAEvent("gift_foguinho"),trackMetaEvent("GiftFoguinho"),showToast("Presente enviado!","sucesso")}catch(e){console.error("Erro ao realizar Presentear (Check-in) di√°rio:",e),showToast("Erro ao presentear. Tente novamente.","erro")}else showToast("Voc√™ precisa estar pareado para presentear.","aviso")}function handleContinuarSemParear(){state.etapa="main",renderApp()}function filtrarMomentos(e){state.filtro=e,renderApp()}async function adicionarAoCarrinho(e){if(state.carrinho.length>=2)return void showToast("Limite de 2 itens no carrinho!","aviso");if(!state.pareado)return void showToast("Voc√™ precisa estar pareado para resgatar momentos.","aviso");const t=e.custoFoguinhos,a=state.carrinho.reduce((e,t)=>e+t.custoFoguinhos,0);(state.usuario.foguinhos||0)-a<t?showToast(`Voc√™ precisa de ${t} foguinhos para este momento.`,"aviso"):(state.carrinho=[...state.carrinho,e],trackGAEvent("add_to_cart",{currency:"FOG",value:e.custoFoguinhos,items:[{item_id:e.nome.replace(/\s+/g,"_"),item_name:e.nome,item_category:e.categoria,price:e.custoFoguinhos,quantity:1}]}),trackMetaEvent("AddToCart",{currency:"BRL",value:0,content_name:e.nome,content_ids:[e.nome.replace(/\s+/g,"_")],content_type:"product"}),showToast(`${e.nome} adicionado ao carrinho!`,"sucesso"),renderApp())}async function removerDoCarrinho(e){const t=state.carrinho[e];state.carrinho=state.carrinho.filter((t,a)=>a!==e),showToast(`Item removido do carrinho${t?` (${t.emoji||""} ${t?.nome||""})`:""}.`,"sucesso"),renderApp()}async function desparearParceiro(){if(confirm("Tem certeza que deseja desfazer o pareamento? Isso ir√° resetar os foguinhos de ambos os usu√°rios para 0."))try{const e=auth.currentUser;if(!e)throw new Error("Usu√°rio n√£o autenticado. Fa√ßa login antes de desfazer o pareamento.");const t=e.uid,a=state.parceiroCodigo||null,o=state.usuario.pareadoUid||state.parceiroData&&state.parceiroData.uid||null;await safeAddInput({type:"pairing_unpair",fromUid:t,partnerUid:o||null,partnerPhone:a||null}),state.pareado=!1,state.parceiroCodigo=null,state.parceiroTelefone=null,state.parceiroNome=null,state.showPartnerInfo=!1,state.usuario.pareadoCom=null,state.usuario.pareadoUid=null,state.carrinho=[],state.showCartSidebar=!1,state.pareado=!1,state.idPareamentoAmigavel=null,showToast("Solicita√ß√£o de desfazer pareamento enviada. Aguardando processamento...","sucesso"),renderApp()}catch(e){console.error("Erro ao desfazer pareamento (criando input):",e),e&&e.message&&e.message.toLowerCase().includes("autenticado")?alert(e.message):e&&"permission-denied"===e.code?alert("Permiss√£o negada: sua sess√£o expirou ou voc√™ n√£o est√° autenticado. Fa√ßa login novamente."):alert("Erro ao desfazer pareamento. Tente novamente.")}}async function finalizarPedido(){if(state.pareado)if(0!==state.carrinho.length)if(state.usuario&&state.usuario.pareadoUid)try{const e={type:"moment_redeem",fromUid:auth.currentUser&&auth.currentUser.uid||state.usuario.uid,partnerUid:state.usuario.pareadoUid,pareamentoId:state.idPareamentoAmigavel||"",items:state.carrinho.map(e=>({nome:e.nome,emoji:e.emoji||"",categoria:e.categoria||"Geral",custoFoguinhos:e.custoFoguinhos,img:e.img||""})),timestamp:firebase.firestore.FieldValue.serverTimestamp()};await safeAddInput(e);trackGAEvent("purchase",{currency:"FOG",value:state.carrinho.reduce((e,t)=>e+t.custoFoguinhos,0),items:state.carrinho.map(e=>({item_id:e.nome.replace(/\s+/g,"_"),item_name:e.nome,item_category:e.categoria,price:e.custoFoguinhos,quantity:1}))}),trackMetaEvent("Purchase",{currency:"BRL",value:0,content_ids:state.carrinho.map(e=>e.nome.replace(/\s+/g,"_")),content_name:state.carrinho.map(e=>e.nome).join(", "),content_type:"product",num_items:state.carrinho.length});const t=state.carrinho.length;showToast(`Pedido enviado! ${t} momento${t>1?"s":""} aguardando confirma√ß√£o.`,"sucesso"),state.carrinho=[],state.showCartSidebar=!1,renderApp()}catch(e){console.error("Erro ao finalizar pedido e criar tarefas:",e),showToast("Ocorreu um erro ao finalizar o pedido.","erro")}else showToast("Erro: parceiro pareado n√£o encontrado.","erro");else showToast("Seu carrinho est√° vazio.","aviso");else showToast("Voc√™ precisa estar pareado para finalizar o pedido.","aviso")}function toggleCartSidebar(){console.log("toggleCartSidebar chamada. state.showCartSidebar ANTES:",state.showCartSidebar),state.showCartSidebar=!state.showCartSidebar,console.log("state.showCartSidebar DEPOIS:",state.showCartSidebar),renderApp()}function renderApp(){switch(console.log("renderApp chamada. Etapa atual:",state.etapa,"state.codigoDigitando:",state.codigoDigitando,"state.showCartSidebar:",state.showCartSidebar,"state.showFoguinhosPopup:",state.showFoguinhosPopup),updateFixedUI(),state.etapa){case"landing":default:renderLandingPage();break;case"signIn":renderSignIn();break;case"register":renderRegister();break;case"parear":renderPareamento();break;case"main":renderMain();break;case"gerenciarCatalogo":renderGerenciarCatalogo();break;case"notificacoes":renderNossasTarefas();break;case"foguinhosPopup":renderFoguinhosPopupContent();break;case"achievementsPopup":renderAchievementsPopup()}}async function renderNossasTarefas(){try{if(state.notificacoesTarefasNaoLidas>0){const e=db.batch();let t=0;state.notificacoes.forEach(a=>{if(!a.lida&&"fa-shopping-bag"===a.icone){const o=db.collection("notificacoes").doc(a.id);e.update(o,{lida:!0}),t++}}),t>0&&(await e.commit(),console.log(`Marcou ${t} notifica√ß√µes de tarefa como lidas.`),state.notificacoesTarefasNaoLidas=0,updateFixedUI())}}catch(e){console.error("Erro ao marcar notifica√ß√µes de tarefa como lidas:",e)}const e=state.abaTarefasAtiva||"recebidos";appContainer.innerHTML=`\n        <div class="container mx-auto px-4 py-8 pb-24 pt-24">\n            <div class="text-center mb-10">\n                <h2 class="text-3xl md:text-4xl font-bold mb-2">Nossas Tarefas</h2>\n                <p class="text-gray-400">Momentos resgatados para curtir.</p>\n            </div>\n\n            <div class="flex justify-center mb-6 border-b border-gray-700">\n                <button \n                    onclick="trocarAbaTarefas('recebidos')" \n                    class="py-3 px-6 font-semibold transition-all duration-300 ${"recebidos"===e?"text-pink-400 border-b-2 border-pink-400":"text-gray-500"}">\n                    Recebidos\n                </button>\n                <button \n                    onclick="trocarAbaTarefas('enviados')" \n                    class="py-3 px-6 font-semibold transition-all duration-300 ${"enviados"===e?"text-pink-400 border-b-2 border-pink-400":"text-gray-500"}">\n                    Enviados\n                </button>\n            </div>\n\n            <div id="tarefas-list-container" class="space-y-4 max-w-2xl mx-auto">\n                <div class="text-center py-10">\n                    <i class="fas fa-spinner fa-spin text-4xl text-pink-500"></i>\n                    <p class="mt-2 text-gray-400">Buscando tarefas...</p>\n                </div>\n            </div>\n        </div>\n    `;let t=[],a="";a="recebidos"===e?"executadoPorUid":"resgatadoPorUid";try{(await db.collection("tarefasMomentos").where(a,"==",state.usuario.uid).where("idPareamento","==",state.idPareamentoAmigavel).orderBy("dataResgate","desc").limit(30).get()).forEach(e=>{t.push({id:e.id,...e.data()})})}catch(e){console.error("Erro ao buscar tarefas:",e),showToast("Erro ao carregar tarefas.","erro")}const o=document.getElementById("tarefas-list-container");0===t.length?o.innerHTML='<p class="text-center text-gray-500 py-10">Nenhuma tarefa encontrada aqui.</p>':o.innerHTML=t.map(t=>{const a="Pendente"===t.status,o=a?"text-yellow-400":"text-green-400",n=a?"fa-clock":"fa-check-circle",s=t.dataResgate?new Date(1e3*t.dataResgate.seconds).toLocaleDateString("pt-BR"):"Data indispon√≠vel",i=state.momentosMestres.find(e=>e.nome===t.momentoNome);return`\n                <div class="card p-4 flex items-center justify-between gap-4 ${a?"":"opacity-50"}">\n                    <div class="flex items-center gap-4">\n                        \n                        ${i?`<img src="${i.img}" class="w-12 h-12 rounded-lg object-cover">`:`<span class="text-3xl">${t.momentoEmoji}</span>`} \n\n                        <div>\n                            <h3 class="font-bold">${t.momentoNome}</h3>\n                            <p class="text-sm text-gray-300">\n                                ${"recebidos"===e?`Resgatado por: ${t.resgatadoPorNome}`:`Aguardando: ${t.executadoPorNome}`}\n                            </p>\n                            <p class="text-xs text-gray-500 mt-2">Resgatado em: ${s}</p>\n                        </div>\n                    </div>\n                    \n                    <div class="text-right flex-shrink-0"> <div class="flex items-center justify-end gap-2 font-semibold ${o} mb-3">\n                            <i class="fas ${n}"></i>\n                            <span>${t.status}</span>\n                        </div>\n                        \n                        ${"enviados"===e&&a?`\n                            <button \n                                onclick="handleDarCheck('${t.id}', '${t.momentoNome}', ${t.custoFoguinhos||0})"\n                                class="bg-green-600 hover:bg-green-700 text-white text-sm font-medium py-2 px-3 rounded-lg transition">\n                                \n                                <i class="fas fa-check"></i> Realizado\n                            \n                            </button>\n                        `:""}\n\n                         ${!a&&t.dataConclusao?`\n                            <p class="text-xs text-gray-400">Conclu√≠do em: ${new Date(1e3*t.dataConclusao.seconds).toLocaleDateString("pt-BR")}</p>\n                        `:""}\n                    </div>\n                </div>\n            `}).join("")}function trocarAbaTarefas(e){state.abaTarefasAtiva!==e&&(state.abaTarefasAtiva=e,renderNossasTarefas())}async function handleDarCheck(e,t,a){if(e){if(confirm("Tem certeza que deseja marcar este momento como 'Realizado'?"))try{const o=db.collection("tarefasMomentos").doc(e);await o.update({status:"Realizado",dataConclusao:firebase.firestore.FieldValue.serverTimestamp()}),trackGAEvent("complete_moment",{currency:"FOG",value:a,items:[{item_id:(t||"unknown").replace(/\s+/g,"_"),item_name:t||"unknown",price:a,quantity:1}]}),trackMetaEvent("CompleteMoment",{currency:"BRL",value:0,content_name:t||"unknown",content_ids:[(t||"unknown").replace(/\s+/g,"_")]}),showToast("Momento confirmado com sucesso!","sucesso"),renderNossasTarefas()}catch(e){console.error("Erro ao confirmar tarefa:",e),showToast("Erro ao confirmar o momento.","erro")}}else console.error("ID da tarefa n√£o fornecido.")}function changeStep(e){if(state.etapa===e){if("main"===e)return;state.etapa="main"}else state.etapa=e;state.showCartSidebar=!1,state.showFoguinhosPopup=!1,state.showPartnerInfoPopup=!1,state.showAchievementsPopup=!1,renderApp()}function updateFixedUI(){userNameDisplay&&(userNameDisplay.textContent=state.usuario&&state.usuario.nome?`Ol√°, ${state.usuario.nome}!`:"");const e=document.getElementById("headerProfilePic");if(e&&state.usuario){const t="/assets/icons/iconprincipal.png";e.src=state.usuario.fotoUrl||t,e.classList.remove("hidden")}else e&&e.classList.add("hidden");const t=document.getElementById("notificationDot");if(t&&((state.notificacoesTarefasNaoLidas||0)+(state.notificacoesConquistasNaoLidas||0)>0?t.classList.remove("hidden"):t.classList.add("hidden")),foguinhosBadge&&(foguinhosBadge.textContent=state.usuario?state.usuario.foguinhos:0),carrinhoBadge&&(carrinhoBadge.textContent=state.carrinho.length),bottomNavBar&&mainHeader){["main","parear","foguinhosPopup","partnerInfoPopup","gerenciarCatalogo","notificacoes"].includes(state.etapa)?(bottomNavBar.style.display="flex",mainHeader.style.display="flex"):(bottomNavBar.style.display="none",mainHeader.style.display="none")}const a=document.querySelectorAll(".bottom-nav-bar .bottom-nav-item, .bottom-nav-bar .bottom-nav-item-center"),o=document.getElementById("foguinhosNavButton");o&&(o.classList.remove("active","text-yellow-400"),"foguinhosPopup"===state.etapa?o.classList.add("active"):state.notificacoesPresentesNaoLidas>0&&o.classList.add("text-yellow-400")),a.forEach(e=>{if("foguinhosNavButton"===e.id)return;e.classList.remove("active");const t=e.querySelector(".fas.fa-heart");t&&(t.classList.remove("text-red-500","text-yellow-400","text-gray-400"),state.pareado?t.classList.add("text-red-500"):state.usuario&&state.usuario.pareadoCom&&state.usuario.pareadoCom.startsWith("pending_")?t.classList.add("text-yellow-400"):t.classList.add("text-gray-400")),e.querySelector(".fas.fa-store")&&"gerenciarCatalogo"===state.etapa?e.classList.add("active"):!e.querySelector(".fas.fa-heart")||"parear"!==state.etapa&&"partnerInfoPopup"!==state.etapa?(e.querySelector(".fas.fa-shopping-cart")&&state.showCartSidebar||e.querySelector(".fas.fa-bell")&&"notificacoes"===state.etapa)&&e.classList.add("active"):e.classList.add("active")})}function toggleFoguinhosPopup(){console.log("toggleFoguinhosPopup chamada. state.showFoguinhosPopup ANTES:",state.showFoguinhosPopup),"foguinhosPopup"===state.etapa?state.etapa="main":state.etapa="foguinhosPopup",state.showFoguinhosPopup=!state.showFoguinhosPopup,renderApp(),console.log("state.showFoguinhosPopup DEPOIS:",state.showFoguinhosPopup)}function togglePartnerInfoPopup(){console.log("togglePartnerInfoPopup chamada. state.showPartnerInfoPopup ANTES:",state.showPartnerInfoPopup),"partnerInfoPopup"===state.etapa?state.etapa="main":state.etapa="partnerInfoPopup",state.showPartnerInfoPopup=!state.showPartnerInfoPopup,renderApp(),console.log("state.showPartnerInfoPopup DEPOIS:",state.showPartnerInfoPopup)}function toggleAchievementsPopup(){console.log("toggleAchievementsPopup chamada. state.showAchievementsPopup ANTES:",state.showAchievementsPopup),"achievementsPopup"===state.etapa?state.etapa="gerenciarCatalogo":state.etapa="achievementsPopup",state.showAchievementsPopup=!state.showAchievementsPopup,renderApp(),console.log("state.showAchievementsPopup DEPOIS:",state.showAchievementsPopup)}async function loadUserDataAndNavigate(e,t){console.log("loadUserDataAndNavigate chamada para UID:",e),await carregarMomentosMestres();try{if(hasProcessedInitialConquistas=!1,!e)return console.error("UID do usu√°rio √© nulo ou indefinido em loadUserDataAndNavigate. Abortando carregamento."),state.etapa="landing",void renderApp();const a=await db.collection("usuarios").doc(e).get();if(a.exists){state.usuario={uid:e,email:t,...a.data()},state.usuario.notificationsEnabled=!!state.usuario.notificationsEnabled,state.usuario.conquistas=state.usuario.conquistas||{},state.usuario.achievementStats=state.usuario.achievementStats||{},state.conquistas=state.usuario.conquistas,state.achievementStats=state.usuario.achievementStats,state.usuario.pareadoUid=state.usuario.pareadoUid||null;const o=!(!state.usuario.pareadoUid||"string"!=typeof state.usuario.pareadoUid),n=!(!state.usuario.pareadoCom||"string"!=typeof state.usuario.pareadoCom||state.usuario.pareadoCom.startsWith("pending_"));if(state.pareado=o||n,state.parceiroCodigo=state.usuario.pareadoCom||null,state.parceiroData=null,state.parceiroNome=null,state.parceiroTelefone=null,state.idPareamentoAmigavel=null,setupNotificationListener(e),setupForegroundMessageHandler(),state.pareado&&state.usuario.pareadoUid){const e=await db.collection("usuarios").doc(state.usuario.pareadoUid).get();if(e.exists){const t={uid:e.id,...e.data()};state.parceiroData=t,state.parceiroNome=t.nome,state.parceiroCodigo=t.telefone||state.parceiroCodigo,t.telefone&&(state.parceiroTelefone="55"+t.telefone.replace(/\D/g,""));const a=state.usuario.telefone?state.usuario.telefone.replace(/\D/g,""):null,o=t.telefone?t.telefone.replace(/\D/g,""):null;if(a&&o){const e=[a,o].sort().join("_"),t=await db.collection("pareamentos").doc(e).get();t.exists&&t.data().idAmigavel&&(state.idPareamentoAmigavel=t.data().idAmigavel,console.log("ID Amig√°vel carregado:",state.idPareamentoAmigavel))}}else console.warn("Parceiro pareado n√£o encontrado no Firestore."),state.pareado=!1,state.usuario.pareadoUid=null}state.pareado||(state.parceiroData=null,state.idPareamentoAmigavel=null),unsubscribeUserDoc&&(unsubscribeUserDoc(),unsubscribeUserDoc=null),unsubscribeUserDoc=db.collection("usuarios").doc(e).onSnapshot(a=>{if(!a.exists)return;const o=a.data()||{},n={...state.conquistas||{}},s=o.conquistas?{...o.conquistas}:{},i=hasProcessedInitialConquistas?Object.keys(s).filter(e=>s[e]&&!n[e]):[];state.usuario={uid:e,email:t,...o,conquistas:s,achievementStats:o.achievementStats?{...o.achievementStats}:{}},state.usuario.notificationsEnabled=!!state.usuario.notificationsEnabled,state.usuario.pareadoUid=state.usuario.pareadoUid||null,state.conquistas=s,state.achievementStats=state.usuario.achievementStats;const r=!(!state.usuario.pareadoUid||"string"!=typeof state.usuario.pareadoUid),c=!(!state.usuario.pareadoCom||"string"!=typeof state.usuario.pareadoCom||state.usuario.pareadoCom.startsWith("pending_"));state.pareado=r||c,state.parceiroCodigo=state.usuario.pareadoCom||null,state.pareado||state.usuario.pareadoCom&&state.usuario.pareadoCom.startsWith("pending_")||(state.pendingPairingRequest=null,state.parceiroData=null,state.parceiroNome=null,state.parceiroTelefone=null,state.idPareamentoAmigavel=null),!state.pareado||!state.usuario.pareadoUid||state.parceiroData&&state.parceiroData.uid===state.usuario.pareadoUid||db.collection("usuarios").doc(state.usuario.pareadoUid).get().then(async e=>{if(e.exists){const t={uid:e.id,...e.data()};state.parceiroData=t,state.parceiroNome=t.nome,state.parceiroCodigo=t.telefone||state.usuario.pareadoCom||null,state.parceiroTelefone=t.telefone?"55"+t.telefone.replace(/\D/g,""):null;const a=state.usuario.telefone?state.usuario.telefone.replace(/\D/g,""):null,o=t.telefone?t.telefone.replace(/\D/g,""):null;if(a&&o){const e=[a,o].sort().join("_"),t=await db.collection("pareamentos").doc(e).get();t.exists&&t.data().idAmigavel&&(state.idPareamentoAmigavel=t.data().idAmigavel)}}renderApp()}).catch(e=>console.error("Erro ao carregar parceiro pareado:",e)),hasProcessedInitialConquistas&&i.length&&(console.log("Conquistas novas detectadas via snapshot:",i),i.forEach(e=>{const t=showAchievementCelebration(e);if(t){showToast(`üèÜ ${t.description?`${t.title}: ${t.description}`:t.title}`,"sucesso")}})),hasProcessedInitialConquistas=!0,renderApp()}),unsubscribePendingPairing&&(unsubscribePendingPairing(),unsubscribePendingPairing=null),unsubscribePendingPairing=db.collection("pairingRequests").where("receiverUid","==",e).where("status","==","pending").limit(1).onSnapshot(e=>{if(e.empty)state.usuario.pareadoCom&&"string"==typeof state.usuario.pareadoCom&&state.usuario.pareadoCom.startsWith("pending_")?(state.etapa="parear",state.pendingPairingRequest=null):state.etapa="main";else{const t=e.docs[0];state.pendingPairingRequest={id:t.id,...t.data()},state.etapa="parear"}renderApp()})}else console.log("Usu√°rio logado via Auth, mas sem documento de perfil no Firestore."),state.usuario={uid:e,email:t,conquistas:{},achievementStats:{}},state.etapa="register",alert("Por favor, complete seu cadastro para acessar todas as funcionalidades.")}catch(e){console.error("Erro ao carregar dados do usu√°rio:",e),state.etapa="landing"}finally{renderApp()}}function init(){auth.onAuthStateChanged(async e=>{e?(console.log("init: Usu√°rio j√° logado no Auth:",e.email,e.uid),await loadUserDataAndNavigate(e.uid,e.email)):(console.log("init: Nenhum usu√°rio logado no Auth. Redirecionando para landing page."),state.usuario=null,state.pareado=!1,state.etapa="landing",state.carrinho=[],state.codigoUsuario=null,state.codigoDigitando=!1,state.parceiroCodigo=null,state.parceiroTelefone=null,state.parceiroNome=null,state.showPartnerInfo=!1,state.pendingPairingRequest=null,state.showCartSidebar=!1,state.showFoguinhosPopup=!1,state.showPartnerInfoPopup=!1,renderApp())})}function initializeApp(){console.log("üöÄ Aplica√ß√£o inicializando..."),appContainer=document.getElementById("app"),userNameDisplay=document.getElementById("userNameDisplay"),foguinhosBadge=document.getElementById("foguinhosBadge"),carrinhoBadge=document.getElementById("carrinhoBadge"),bottomNavBar=document.getElementById("bottom-nav-bar"),mainHeader=document.getElementById("mainHeader"),window.changeStep=changeStep,window.handleSignIn=handleSignIn,window.handleRegister=handleRegister,window.handleLogout=handleLogout,window.sendPairingRequest=sendPairingRequest,window.acceptPairingRequest=acceptPairingRequest,window.rejectPairingRequest=rejectPairingRequest,window.handleDailyCheckIn=handleDailyCheckIn,window.handleContinuarSemParear=handleContinuarSemParear,window.filtrarMomentos=filtrarMomentos,window.adicionarAoCarrinho=adicionarAoCarrinho,window.removerDoCarrinho=removerDoCarrinho,window.finalizarPedido=finalizarPedido,window.desparearParceiro=desparearParceiro,window.toggleCartSidebar=toggleCartSidebar,window.cancelPendingPairingRequest=cancelPendingPairingRequest,window.toggleFoguinhosPopup=toggleFoguinhosPopup,window.togglePartnerInfoPopup=togglePartnerInfoPopup,window.toggleAchievementsPopup=toggleAchievementsPopup,window.solicitarPermissaoDeNotificacao=solicitarPermissaoDeNotificacao,window.desativarNotificacoes=desativarNotificacoes,window.handleNotificationToggle=handleNotificationToggle,window.handleSaveCatalogo=handleSaveCatalogo,window.toggleAccordion=toggleAccordion,window.handleFileSelect=handleFileSelect,window.trocarAbaTarefas=trocarAbaTarefas,window.handleDarCheck=handleDarCheck,console.log("‚úÖ Fun√ß√µes de evento prontas."),init()}window.ACHIEVEMENTS=ACHIEVEMENTS,window.ACHIEVEMENTS_BY_ID=ACHIEVEMENTS_BY_ID,document.addEventListener("DOMContentLoaded",initializeApp)</script><nav class="bottom-nav-bar" id="bottom-nav-bar" style="display:none"><button class="bottom-nav-item" onclick='changeStep("gerenciarCatalogo")'><i class="fas fa-store"></i></button> <button class="bottom-nav-item" onclick='changeStep("parear")'><i class="fas fa-heart"></i></button> <button class="bottom-nav-item-center" onclick='changeStep("main")'><i class="fas fa-shopping-bag"></i></button> <button class="bottom-nav-item relative" onclick="toggleCartSidebar()"><i class="fas fa-shopping-cart"></i> <span id="carrinhoBadge" class="badge-notification badge-gray">0</span></button> <button id="foguinhosNavButton" class="bottom-nav-item" onclick='changeStep("foguinhosPopup")'><i class="fas fa-fire"></i> <span id="foguinhosBadge" class="badge-notification badge-yellow">0</span></button></nav><div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[9999] space-y-2 w-auto max-w-sm"></div></body></html>