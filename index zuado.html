<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nosso Momento</title>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html { overflow-x: hidden; }
        body { font-family: 'Poppins', sans-serif; background-color: #000; }
        .product-card { transition: all 0.3s ease-out; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; overflow: hidden; position: relative; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(255, 53, 71, 0.2); background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.2); }
        .product-img { height: 160px; object-fit: cover; width: 100%; }
        .product-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; padding: 4px 10px; border-radius: 32px; font-size: 12px; display: flex; align-items: center; gap: 4px; }
        .btn-red { background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 50px; font-weight: 600; letter-spacing: 0.5px; box-shadow: 0 10px 20px rgba(255, 53, 71, 0.3); padding: 14px 24px; border: none; outline: none; text-transform: uppercase; font-size: 14px; }
        .btn-red:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 15px 30px rgba(255, 53, 71, 0.4); }
        input, select { border-radius: 12px !important; padding: 14px 16px !important; border: 1px solid rgba(255,255,255,0.1) !important; background: rgba(255,255,255,0.05) !important; color: white !important; }
        input::placeholder { color: rgba(255,255,255,0.5) !important; }
        .card { border-radius: 20px; background: rgba(30,30,30,0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        .bottom-nav-bar { background: linear-gradient(135deg, rgba(30,30,30,0.95) 0%, rgba(0,0,0,0.95) 100%); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.08); position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 100; box-shadow: 0 -5px 20px rgba(0,0,0,0.4); padding-bottom: env(safe-area-inset-bottom); }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; color: rgba(255,255,255,0.6); transition: color 0.3s ease; cursor: pointer; position: relative; height: 100%; flex-grow: 1; text-align: center; }
        .bottom-nav-item.active { color: #FF6B7C; }
        .bottom-nav-item:hover { color: #FF6B7C; }
        .bottom-nav-item i { font-size: 20px; }
        .badge-notification { position: absolute; top: 5px; right: 5px; min-width: 20px; height: 20px; border-radius: 50%; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 1px 3px rgba(0,0,0,0.3); pointer-events: none; transform: translate(50%, -50%); }
        .badge-yellow { background-color: #f59e0b; }
        .badge-gray { background-color: #6b7280; }
        .bottom-nav-item-center { display: flex; align-items: center; justify-content: center; width: 60px; height: 60px; background: linear-gradient(135deg, #FF3547 0%, #FF6B7C 100%); color: white; border-radius: 50%; border: 3px solid #1f2937; transform: translateY(-20px); box-shadow: 0 -5px 15px rgba(255, 53, 71, 0.4); transition: all 0.3s ease; }
        .bottom-nav-item-center:hover { transform: translateY(-23px) scale(1.05); box-shadow: 0 -8px 20px rgba(255, 53, 71, 0.5); }
        .bottom-nav-item-center i { font-size: 24px; }
        .accordion-content.open { max-height: 1000px; }
        .accordion-button.open i { transform: rotate(180deg); }
        .toast { display: flex; align-items: center; padding: 10px 16px; font-size: 14px; border-radius: 9999px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25); border: 1px solid rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); animation: slideInUp 0.5s ease-out forwards; }
        .toast.exiting { animation: slideOutDown 0.5s ease-in forwards; }
        .toast-icon { margin-right: 10px; font-size: 18px; }
        .toast-sucesso { background-color: rgba(22, 163, 74, 0.8); color: white; }
        .toast-erro { background-color: rgba(220, 38, 38, 0.8); color: white; }
        .toast-aviso { background-color: rgba(245, 158, 11, 0.8); color: white; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideOutDown { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(100%); } }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <header id="mainHeader" class="sticky top-0 z-20 bg-gray-900/80 backdrop-blur-md border-b border-gray-800" style="display: none;">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="flex items-center justify-center w-9 h-9 rounded-full bg-gradient-to-br from-pink-500 to-red-600 shadow-lg">
                    <i class="fas fa-heart-beat text-white text-xs"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold">
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 font-extrabold tracking-tight">NOSSO</span>
                    <span class="text-transparent bg-clip-text bg-gradient-to-r from-red-400 to-pink-500 font-extrabold tracking-tight">MOMENTO</span>
                </h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="changeStep('notificacoes')" class="relative text-gray-400 hover:text-white transition">
                    <i class="fas fa-bell text-xl"></i>
                    <span id="notificationDot" class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full hidden"></span>
                </button>
                <img id="headerProfilePic" src="" class="w-8 h-8 rounded-full object-cover hidden sm:block">
                <span id="userNameDisplay" class="text-gray-300 text-sm font-medium hidden sm:inline"></span>
                <button onclick="handleLogout()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-white font-medium transition flex items-center gap-2">
                    <i class="fas fa-sign-out-alt text-xs"></i> <span class="hidden sm:inline">Sair</span>
                </button>
            </div>
        </div>
    </header>

    <div id="app"></div>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyAppTP2vJuLofr9ueWsK3djbwSeEm5qb2c",
      authDomain: "nosso-momento-app.firebaseapp.com",
      projectId: "nosso-momento-app",
      storageBucket: "nosso-momento-app.firebasestorage.app",
      messagingSenderId: "503855316994",
      appId: "1:503855316994:web:7d5ee171b44c4f8b86a71b",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();
</script>

<script>
    // ===================================
    // ESTADO GLOBAL E DADOS MESTRES
    // ===================================
    const state = {
        usuario: null, pareado: false, parceiroData: null, idPareamentoAmigavel: null,
        notificacoesNaoLidas: 0, notificacoes: [], etapa: 'landing', carrinho: [],
        codigoUsuario: null, codigoDigitando: false, parceiroCodigo: null,
        parceiroTelefone: null, parceiroNome: null, showCartSidebar: false, filtro: null
    };
    
    let unsubscribeNotifications = null;

    const momentos = [
        { nome: 'Mamada Surpresa', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://imagenes.elpais.com/resizer/v2/2ARTSVZFAMOWYEREJ5CC72W4WA.jpg?auth=72d5ccea313b45142dc48ab5509bfa8751331fa78cbbf5cd412413fbc51ba60d&width=414', intensidade: 4, targetGender: 'Feminino' },
        { nome: 'Chupada Surpresa', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://uniqcondoms.com/wp-content/uploads/2024/07/condones-femeninos-sexo-oral.png', intensidade: 4, targetGender: 'Masculino' },
        { nome: 'Tapa na Bunda', categoria: 'Lovezin', emoji: 'üíó', img: 'https://vemconversar.com.br/wp-content/uploads/2022/10/E-no-olhar-que-tudo-comeca.jpeg', intensidade: 2, targetGender: 'Masculino' },
        { nome: '30 Beijinhos', categoria: 'Lovezin', emoji: 'üíó', img: 'https://img.freepik.com/fotos-premium/retrato-em-close-up-de-dois-apaixonados-apaixonados-se-beijando-em-casa_171337-79073.jpg', intensidade: 1, targetGender: 'Masculino' },
        { nome: 'C*zinho', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://t4.ftcdn.net/jpg/06/27/26/69/360_F_627266974_C25IGTTKd4Fp2nXhuCDv4dMTlDsxqiWj.jpg', intensidade: 5, targetGender: 'Feminino' },
        { nome: 'Sexo Rom√¢ntico', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://us.123rf.com/450wm/4pmproduction/4pmproduction1706/4pmproduction170600453/81004283-lindo-casal-apaixonado-est%C3%A1-se-beijando-na-cama-prel%C3%BAdio-ao-sexo.jpg', intensidade: 4, targetGender: 'Unisex' },
        { nome: 'Sexo Agressivo', categoria: 'Quentes', emoji: 'ü•µ', img: 'https://conteudo.imguol.com.br/c/entretenimento/2d/2016/07/22/voce-conhece-as-preferencias-sexuais-do-seu-par-1469219198036_v2_900x506.jpg', intensidade: 5, targetGender: 'Unisex' },
        { nome: 'Beij√£o', categoria: 'Lovezin', emoji: 'üíó', img: 'https://www.otempo.com.br/content/dam/otempo/editorias/interessa/2024/3/interessa-beijo-de-lingua-beneficios-do-beijo-1713342721.jpeg', intensidade: 1, targetGender: 'Unisex' },
        { nome: 'Abra√ßo', categoria: 'Lovezin', emoji: 'üíó', img: 'https://us.123rf.com/450wm/peopleimages12/peopleimages122210/peopleimages12221028649/193181819-seu-amor-transformou-meu-mundo-um-jovem-casal-desfrutando-de-algum-tempo-de-qualidade-juntos-na.jpg?ver=6', intensidade: 1, targetGender: 'Unisex' },
        { nome: 'Massagem', categoria: 'Lovezin', emoji: 'üíó', img: 'https://individuale.med.br/wp-content/uploads/2019/08/massagem-anti-stress.png', intensidade: 3, targetGender: 'Unisex' },
        { nome: 'Viajar', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://p2.trrsf.com/image/fget/cf/774/0/images.terra.com/2023/12/07/1581006561-1rdpraia-do-aventureiro-1.jpg', intensidade: 2, targetGender: 'Unisex' },
        { nome: 'Noitada', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://images.unsplash.com/photo-1470225620780-dba8ba36b745?w=600&auto=format', intensidade: 2, targetGender: 'Unisex' },
        { nome: 'Pagode', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://s2-g1.glbimg.com/PiT2YdXpDe8AU4vPY3nVopJ3ksM=/0x0:1014x681/984x0/smart/filters:strip_icc()/i.s3.glbimg.com/v1/AUTH_59edd422c0c84a879bd37670ae4f538a/internal_photos/bs/2021/j/p/h577gHSrq8AvQbtKQeBg/roda-de-samba-2.jpg', intensidade: 2, targetGender: 'Unisex' },
        { nome: 'Almo√ßar Fora', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://media.timeout.com/images/106062540/750/422/image.jpg', intensidade: 1, targetGender: 'Unisex' },
        { nome: 'Jantar Fora', categoria: 'Sair da Rotina', emoji: 'üéâ', img: 'https://www.rbsdirect.com.br/filestore/0/7/2/9/4/9/4_1b48f02f18ac345/4949270_5de2a64f5b53f27.jpg?format=webp&w=1600&h=900&a=c', intensidade: 1, targetGender: 'Unisex' }
    ];

    let appContainer;
    let userNameDisplay, foguinhosBadge, carrinhoBadge, bottomNavBar, mainHeader;

    // ===================================
    // FUN√á√ïES UTILIT√ÅRIAS E DE APOIO
    // ===================================
    function isSameDay(d1, d2) {
        if (!d1 || !d2) return false;
        return d1.getFullYear() === d2.getFullYear() &&
               d1.getMonth() === d2.getMonth() &&
               d1.getDate() === d2.getDate();
    }

    function toggleAccordion(buttonElement) {
        const content = buttonElement.nextElementSibling;
        buttonElement.classList.toggle('open');
        content.classList.toggle('open');
    }

    // ===================================
    // SISTEMA DE NOTIFICA√á√ïES
    // ===================================
    function showToast(message, type = 'sucesso') {
        const container = document.getElementById('toast-container');
        if (!container) return;

        let iconClass = 'fa-check-circle', toastClass = 'toast-sucesso';
        if (type === 'erro') {
            iconClass = 'fa-times-circle'; toastClass = 'toast-erro';
        } else if (type === 'aviso') {
            iconClass = 'fa-exclamation-triangle'; toastClass = 'toast-aviso';
        }

        const toastElement = document.createElement('div');
        toastElement.className = `toast ${toastClass}`;
        toastElement.innerHTML = `<i class="fas ${iconClass} toast-icon"></i><span>${message}</span>`;
        container.appendChild(toastElement);

        setTimeout(() => {
            toastElement.classList.add('exiting');
            setTimeout(() => { toastElement.remove(); }, 500);
        }, 3000);
    }

    async function criarNotificacao(userId, titulo, mensagem, icone) {
        try {
            await db.collection('notificacoes').add({
                userId, titulo, mensagem, icone,
                lida: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            console.log('Notifica√ß√£o criada para:', userId);
        } catch (error) {
            console.error("Erro ao criar notifica√ß√£o:", error);
        }
    }

    function setupNotificationListener(userId) {
        if (unsubscribeNotifications) unsubscribeNotifications();
        
        const notificationsQuery = db.collection('notificacoes').where('userId', '==', userId).orderBy('timestamp', 'desc').limit(20);
        
        unsubscribeNotifications = notificationsQuery.onSnapshot(snapshot => {
            const notifs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            state.notificacoes = notifs;
            state.notificacoesNaoLidas = notifs.filter(n => !n.lida).length;
            console.log(`Notifica√ß√µes carregadas: ${notifs.length}, N√£o lidas: ${state.notificacoesNaoLidas}`);
            
            if (state.etapa === 'notificacoes') {
                renderNotificacoes();
            }
            updateFixedUI();
        }, error => {
            console.error("Erro no ouvinte de notifica√ß√µes: ", error);
            showToast("N√£o foi poss√≠vel carregar as notifica√ß√µes.", "erro");
        });
    }

    // ===================================
    // FUN√á√ïES DE RENDERIZA√á√ÉO DE TELA
    // ===================================
    function renderLandingPage() {
        appContainer.innerHTML = `
            <div class="min-h-screen flex flex-col justify-center items-center p-4" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                <div class="card p-10 w-full max-w-md text-white text-center">
                    <h2 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-4">NOSSO MOMENTO</h2>
                    <p class="text-gray-300 tracking-wider">Apimente a rela√ß√£o.<br>Deixe tudo mais gostoso!</p>
                    <div class="space-y-5 mt-10">
                        <button onclick="changeStep('signIn')" class="btn-red w-full py-4 rounded-xl flex items-center justify-center gap-3"><span class="text-lg">ENTRAR</span><i class="fas fa-sign-in-alt"></i></button>
                        <button onclick="changeStep('register')" class="btn-red w-full py-4 rounded-xl flex items-center justify-center gap-3" style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none;"><span class="text-lg">CADASTRO</span><i class="fas fa-user-plus"></i></button>
                    </div>
                </div>
            </div>`;
    }

    function renderSignIn() {
        appContainer.innerHTML = `
            <div class="min-h-screen flex flex-col justify-center items-center p-4" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                <div class="card p-10 w-full max-w-md text-white relative">
                    <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>
                    <div class="text-center mb-10 mt-8">
                        <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-2">ENTRAR</h2>
                        <p class="text-gray-300">Acesse sua conta para continuar.</p>
                    </div>
                    <div class="space-y-5">
                        <input id="signInEmail" type="email" placeholder="Email" class="w-full" />
                        <input id="signInPassword" type="password" placeholder="Senha" class="w-full" />
                    </div>
                    <button onclick="handleSignIn()" class="btn-red w-full mt-8 py-4 rounded-xl flex items-center justify-center gap-3"><span class="text-lg">LOGIN</span><i class="fas fa-sign-in-alt"></i></button>
                </div>
            </div>`;
    }

    function renderRegister() {
        appContainer.innerHTML = `
            <div class="min-h-screen flex flex-col justify-center items-center p-4" style="background-image: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0.9)), url('https://images.unsplash.com/photo-1517511620798-cec17d428bc0?auto=format&fit=crop&w=1470&q=80'); background-size: cover; background-position: center;">
                <div class="card p-8 w-full max-w-md text-white relative">
                    <button onclick="changeStep('landing')" class="absolute top-5 left-5 text-gray-400 hover:text-white transition"><i class="fas fa-arrow-left mr-2"></i> Voltar</button>
                    <div class="text-center mb-8 mt-8">
                        <h2 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500 mb-2">CADASTRO</h2>
                        <p class="text-gray-300">Crie sua conta para come√ßar!</p>
                    </div>
                    <div class="space-y-4">
                        <input id="registerNome" placeholder="Seu nome" class="w-full" />
                        <input id="registerEmail" type="email" placeholder="Email" class="w-full" />
                        <input id="registerTelefone" type="tel" placeholder="Telefone (DDD + n√∫mero)" pattern="[0-9]{11}" required class="w-full" />
                        <input id="registerSenha" type="password" placeholder="Crie uma senha (m√≠n. 6 caracteres)" class="w-full" />
                        <select id="registerSexo" class="w-full text-white" style="background: rgba(255,255,255,0.05) !important;">
                            <option value="" disabled selected>Selecione seu sexo</option>
                            <option value="Masculino">Masculino</option>
                            <option value="Feminino">Feminino</option>
                        </select>
                    </div>
                    <button onclick="handleRegister()" class="btn-red w-full mt-8 py-4 rounded-xl flex items-center justify-center gap-3"><span class="text-lg">CADASTRAR</span><i class="fas fa-arrow-right-long"></i></button>
                </div>
            </div>`;
    }

    function renderPareamento() {
        if (state.pareado && state.parceiroData) {
            const fotoParceiroUrl = state.parceiroData.fotoUrl || 'https://images.pexels.com/photos/1105325/pexels-photo-1105325.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1';
            const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
            const canCheckIn = !lastCheckIn || !isSameDay(lastCheckIn, new Date());
            const checkInButtonText = canCheckIn ? 'Presentear com 1 üî•' : 'Presenteado Hoje';
            const checkInButtonClasses = canCheckIn ? 'bg-yellow-600 hover:bg-yellow-700 text-white' : 'bg-gray-700 text-gray-400 cursor-not-allowed';
            appContainer.innerHTML = `
                <div class="container mx-auto px-4 py-8 pb-24 pt-24">
                    <div class="max-w-md mx-auto card text-center p-8">
                        <h2 class="text-2xl font-bold mb-4 text-gray-300">Conectado com</h2>
                        <img src="${fotoParceiroUrl}" class="w-32 h-32 rounded-full object-cover border-4 border-pink-500/50 mx-auto mb-4">
                        <h3 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-red-500">${state.parceiroData.nome}</h3>
                        <p class="text-gray-500 text-sm mt-2">ID do Casal: ${state.idPareamentoAmigavel || 'Indispon√≠vel'}</p>
                        <div class="mt-8 space-y-4">
                            <button onclick="handleDailyCheckIn()" ${!canCheckIn ? 'disabled' : ''} class="w-full py-3 rounded-lg font-semibold transition flex items-center justify-center gap-2 ${checkInButtonClasses}"><i class="fas fa-gift"></i> ${checkInButtonText}</button>
                            <button onclick="desparearParceiro()" class="w-full py-3 bg-red-800/60 hover:bg-red-700 text-white rounded-lg font-semibold transition">Desfazer Pareamento</button>
                        </div>
                    </div>
                </div>`;
            return; 
        }
        const codigoUsuario = state.usuario.telefone.replace(/\D/g, '');
        let content = '';
        if (state.pendingPairingRequest) {
            content = `
                <div class="min-h-screen flex flex-col justify-center items-center p-4">
                    <div class="card p-8 max-w-md w-full text-center">
                        <h2 class="text-3xl font-bold mb-4 text-pink-400">Solicita√ß√£o Recebida</h2>
                        <p class="mb-4">Voc√™ recebeu uma solicita√ß√£o de pareamento de:</p>
                        <div class="text-2xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block mb-6">${state.pendingPairingRequest.senderName}</div>
                        <div class="flex flex-col sm:flex-row justify-center gap-4">
                            <button onclick="acceptPairingRequest('${state.pendingPairingRequest.id}', '${state.pendingPairingRequest.senderUid}', '${state.pendingPairingRequest.senderPhone}')" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded text-white font-semibold transition flex-1">Aceitar</button>
                            <button onclick="rejectPairingRequest('${state.pendingPairingRequest.id}')" class="btn-red px-6 py-3 rounded text-white font-semibold transition flex-1">Rejeitar</button>
                        </div>
                    </div>
                </div>`;
        } else if (state.usuario.pareadoCom && state.usuario.pareadoCom.startsWith('pending_')) {
            const pendingPhone = state.usuario.pareadoCom.replace('pending_', '');
            content = `
                <div class="min-h-screen flex flex-col justify-center items-center p-4">
                    <div class="card p-8 max-w-md w-full text-center">
                        <h2 class="text-3xl font-bold mb-4 text-yellow-400">Solicita√ß√£o Enviada</h2>
                        <p class="mb-4">Sua solicita√ß√£o para ${pendingPhone} est√° pendente.</p>
                        <p class="text-sm text-gray-300 mb-6">Aguardando aceita√ß√£o...</p>
                        <button onclick="cancelPendingPairingRequest()" class="btn-red px-6 py-3 rounded text-white font-semibold transition">Cancelar Solicita√ß√£o</button>
                    </div>
                </div>`;
        } else {
            content = `
                <div class="min-h-screen flex flex-col justify-center items-center p-4">
                    <div class="card p-8 max-w-md w-full text-center">
                        <h2 class="text-3xl font-bold mb-4 text-pink-400">Parear com seu Amor</h2>
                        ${!state.codigoDigitando ? `
                            <p class="mb-4">Seu c√≥digo de pareamento √©:</p>
                            <div class="text-4xl font-bold bg-gray-800 py-3 px-6 rounded-lg inline-block">${codigoUsuario}</div>
                            <p class="mt-4 text-sm text-gray-300 mb-6">Compartilhe este c√≥digo.</p>
                            <div class="flex flex-col sm:flex-row justify-center gap-4">
                                <button onclick="state.codigoDigitando = true; renderApp();" class="bg-purple-600 hover:bg-purple-700 px-6 py-3 rounded text-white font-semibold transition">Digitar C√≥digo</button>
                                <button onclick="handleContinuarSemParear()" class="btn-red">Fazer Isso Depois</button>
                            </div>
                        ` : `
                            <div class="mb-6">
                                <label class="block mb-2">Digite o c√≥digo do seu parceiro(a)</label>
                                <input id="codigoParceiro" type="text" class="w-full p-3 rounded text-white text-center" placeholder="11999991111" maxlength="11" />
                            </div>
                            <div class="flex gap-4">
                                <button onclick="state.codigoDigitando = false; renderApp();" class="bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded font-semibold transition">Voltar</button>
                                <button onclick="sendPairingRequest()" class="bg-green-700 hover:bg-green-600 px-6 py-3 rounded font-semibold transition flex-1">Enviar Solicita√ß√£o</button>
                            </div>
                        `}
                    </div>
                </div>`;
        }
        appContainer.innerHTML = content;
    }

    function renderFoguinhosPopupContent() {
        appContainer.innerHTML = `
            <div class="min-h-screen flex flex-col justify-center items-center p-4">
                <div class="card p-8 max-w-md w-full text-center relative overflow-hidden">
                    <h2 class="text-3xl font-bold text-center mb-8 text-transparent bg-clip-text bg-gradient-to-r from-pink-500 to-red-500"><i class="fas fa-fire mr-2"></i> Seus Foguinhos</h2>
                    <div class="text-center mb-6">
                        <p class="mb-4 text-xl">Voc√™ tem:</p>
                        <div class="relative inline-block">
                            <i class="fas fa-fire text-6xl text-yellow-400 animate-pulse"></i>
                            <span class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-xl font-bold text-white">${state.usuario ? state.usuario.foguinhos : 0}</span>
                        </div>
                        <p class="mt-4 text-sm text-gray-300">Use-os para resgatar momentos!</p>
                    </div>
                    <div class="flex justify-center mt-8">
                        <button onclick="changeStep('main');" class="bg-gray-600 hover:bg-gray-700 px-6 py-3 rounded-full text-white font-semibold transition">Voltar</button>
                    </div>
                </div>
            </div>`;
    }

    function renderNotificacoes() {
        if (state.notificacoesNaoLidas > 0) {
            state.notificacoesNaoLidas = 0;
            updateFixedUI();
            const batch = db.batch();
            state.notificacoes.forEach(notif => {
                if (!notif.lida) {
                    const notifRef = db.collection('notificacoes').doc(notif.id);
                    batch.update(notifRef, { lida: true });
                }
            });
            batch.commit().catch(err => console.error("Erro ao marcar notifica√ß√µes como lidas:", err));
        }

        appContainer.innerHTML = `
            <div class="container mx-auto px-4 py-8 pb-24 pt-24">
                <div class="text-center mb-10">
                    <h2 class="text-3xl md:text-4xl font-bold mb-2">Notifica√ß√µes</h2>
                    <p class="text-gray-400">Aqui est√£o suas atividades recentes.</p>
                </div>
                <div id="notifications-list" class="space-y-3 max-w-2xl mx-auto">
                    ${state.notificacoes.length === 0 
                        ? `<p class="text-center text-gray-500">Nenhuma notifica√ß√£o ainda.</p>`
                        : state.notificacoes.map(notif => `
                            <div class="card p-4 flex items-start gap-4 ${notif.lida ? 'opacity-60' : ''}">
                                <i class="fas ${notif.icone || 'fa-info-circle'} text-xl mt-1 text-pink-400"></i>
                                <div>
                                    <h3 class="font-bold">${notif.titulo}</h3>
                                    <p class="text-sm text-gray-300">${notif.mensagem}</p>
                                    <p class="text-xs text-gray-500 mt-2">${notif.timestamp ? new Date(notif.timestamp.seconds * 1000).toLocaleString('pt-BR') : ''}</p>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
            </div>
            ${state.showCartSidebar ? `
                <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
                <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>
                        <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">${state.carrinho.length === 0 ? `<p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>` : state.carrinho.map((item, index) => `<div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center"><div><h4 class="font-medium">${item.emoji} ${item.nome}</h4><small class="text-gray-400 text-sm">${item.categoria}</small><div class="text-yellow-400 text-sm flex items-center gap-1 mt-1"><i class="fas fa-fire"></i> ${item.custoFoguinhos} Foguinhos</div></div><button onclick="removerDoCarrinho(${index})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></div>`).join('')}</div>
                    <div class="mt-8 pt-6 border-t border-gray-800">
                        <button onclick="finalizarPedido()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all ${state.carrinho.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.carrinho.length === 0 ? 'disabled' : ''}>Finalizar Pedido</button>
                        <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">Continuar Resgatando</button>
                    </div>
                </div>
            ` : ''}
        `;
    }

    function renderMain() {
        if (!state.pareado || !state.parceiroData) {
            appContainer.innerHTML = `
                <div class="min-h-screen container mx-auto px-4 py-8 text-center flex flex-col justify-center items-center">
                    <h2 class="text-2xl font-bold mb-4">Voc√™ ainda n√£o est√° pareado(a).</h2>
                    <p class="text-gray-400 mb-6">Pareie com seu/sua parceiro(a) para ver o cat√°logo de momentos dele(a).</p>
                    <button onclick="changeStep('parear')" class="btn-red">Parear agora</button>
                </div>
            `;
            return;
        }

        const partnerGender = state.parceiroData.sexo;
        const momentosParaParceiro = momentos.filter(m => m.targetGender === partnerGender || m.targetGender === 'Unisex');
        const catalogoParceiro = state.parceiroData.catalogoPersonalizado || {};
        const categorias = [...new Set(momentosParaParceiro.map(m => m.categoria))].map(nomeCat => {
            const momentoExemplo = momentos.find(m => m.categoria === nomeCat);
            let cor = 'bg-purple-900';
            if (momentoExemplo.categoria === 'Quentes') cor = 'bg-pink-900';
            if (momentoExemplo.categoria === 'Lovezin') cor = 'bg-red-900';
            return {
                nome: nomeCat,
                emoji: momentoExemplo.emoji,
                color: cor
            };
        });

        const fotoParceiroUrl = state.parceiroData.fotoUrl || 'https://images.pexels.com/photos/1105325/pexels-photo-1105325.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1';

        appContainer.innerHTML = `
            <main class="container mx-auto px-4 py-8 pb-24 pt-24 bg-gradient-to-br from-gray-900 to-black text-white">
                <div class="mb-12 text-center">
                    <img src="${fotoParceiroUrl}" class="w-24 h-24 rounded-full object-cover border-4 border-pink-500/50 mx-auto mb-6">
                    <h2 class="text-3xl md:text-4xl font-bold mb-4">Cat√°logo de ${state.parceiroNome}</h2>
                    <p class="text-gray-400 max-w-2xl mx-auto">Escolha os momentos que voc√™ deseja viver!</p>
                </div>
                
                <div class="flex flex-wrap justify-center gap-3 mb-12">
                    <button onclick="filtrarMomentos(null)"
                        class="px-4 py-2 rounded-full transition-all ${!state.filtro ? 'bg-pink-600 text-white shadow-lg' : 'bg-gray-800 text-gray-300 hover:bg-gray-700'}"
                        style="background: ${!state.filtro ? 'linear-gradient(45deg, #FF3547 0%, #FF6B7B 100%)' : ''}">
                        Todos
                    </button>
                    ${categorias.map(cat => `
                        <button onclick="filtrarMomentos('${cat.nome}')"
                            class="px-4 py-2 rounded-full transition-all ${state.filtro === cat.nome ? 'text-white shadow-lg' : 'text-gray-300 hover:bg-gray-800/50'} ${cat.color}">
                            ${cat.emoji} ${cat.nome}
                        </button>
                    `).join('')}
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 mb-8">
                    ${(state.filtro ? momentosParaParceiro.filter(m => m.categoria === state.filtro) : momentosParaParceiro).map(momento => {
                        const configParceiro = catalogoParceiro[momento.nome];
                        const preco = configParceiro?.preco !== undefined ? configParceiro.preco : momento.intensidade * 2;
                        const bloqueado = configParceiro?.bloqueado || false;
                        const momentoParaCarrinho = { ...momento, custoFoguinhos: preco };

                        return `
                        <div class="product-card group ${bloqueado ? 'opacity-50' : ''}">
                            <div class="relative overflow-hidden">
                                <img src="${momento.img}" alt="${momento.nome}" class="product-img group-hover:scale-105 transition-transform duration-300">
                                <span class="product-badge">${momento.emoji} ${momento.categoria}</span>
                                ${bloqueado ? `<div class="absolute inset-0 bg-black/70 flex items-center justify-center"><i class="fas fa-lock text-4xl text-white"></i></div>` : ''}
                            </div>
                            <div class="p-4">
                                <h3 class="font-medium">${momento.nome}</h3>
                                <div class="flex justify-between items-center mt-4">
                                    <span class="text-yellow-400 text-sm flex items-center gap-1 font-semibold">
                                        <i class="fas fa-fire"></i> ${preco} Foguinhos
                                    </span>
                                    <button onclick='adicionarAoCarrinho(${JSON.stringify(momentoParaCarrinho).replace(/"/g, "&quot;")})'
                                        class="text-sm px-4 py-2 rounded-lg transition ${bloqueado ? 'bg-gray-700 cursor-not-allowed' : 'bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white'}"
                                        ${bloqueado ? 'disabled' : ''}>
                                        ${bloqueado ? 'Indispon√≠vel' : 'Resgatar'}
                                    </button>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </main>

            ${state.showCartSidebar ? `
                <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
                <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>
                        <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">${state.carrinho.length === 0 ? `<p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>` : state.carrinho.map((item, index) => `<div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center"><div><h4 class="font-medium">${item.emoji} ${item.nome}</h4><small class="text-gray-400 text-sm">${item.categoria}</small><div class="text-yellow-400 text-sm flex items-center gap-1 mt-1"><i class="fas fa-fire"></i> ${item.custoFoguinhos} Foguinhos</div></div><button onclick="removerDoCarrinho(${index})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></div>`).join('')}</div>
                    <div class="mt-8 pt-6 border-t border-gray-800">
                        <button onclick="finalizarPedido()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all ${state.carrinho.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.carrinho.length === 0 ? 'disabled' : ''}>Finalizar Pedido</button>
                        <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">Continuar Resgatando</button>
                    </div>
                </div>
            ` : ''}
        `;
    }

    function renderGerenciarCatalogo() {
        const userGender = state.usuario?.sexo || 'Masculino'; 
        const momentosDisponiveis = momentos.filter(m => m.targetGender === userGender || m.targetGender === 'Unisex');
        const catalogoSalvo = state.usuario.catalogoPersonalizado || {};
        const categorias = [...new Set(momentosDisponiveis.map(m => m.categoria))];
        const fotoUrl = state.usuario.fotoUrl || 'https://images.pexels.com/photos/1105325/pexels-photo-1105325.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1';

        appContainer.innerHTML = `
            <div class="container mx-auto px-4 py-8 pb-24 pt-24">
                <div class="text-center mb-10">
                    <h2 class="text-3xl md:text-4xl font-bold mb-2">Meu Perfil e Cat√°logo</h2>
                    <p class="text-gray-400 max-w-2xl mx-auto">Gerencie sua foto, pre√ßos e a disponibilidade dos momentos.</p>
                </div>
                <div class="max-w-2xl mx-auto mb-12 p-6 card flex flex-col items-center">
                    <h3 class="font-bold text-xl mb-4">Sua Foto de Perfil</h3>
                    <img id="profilePicPreview" src="${fotoUrl}" class="w-32 h-32 rounded-full object-cover border-4 border-gray-600 mb-4">
                    <input type="file" id="fileInput" onchange="handleFileSelect(event)" accept="image/*" class="hidden">
                    <button onclick="document.getElementById('fileInput').click()" class="text-pink-400 hover:text-pink-300 font-semibold">
                        Trocar Foto
                    </button>
                    <div id="uploadProgress" class="w-full bg-gray-700 rounded-full h-2.5 mt-4 hidden">
                        <div id="uploadProgressBar" class="bg-pink-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
                <div class="space-y-4 max-w-2xl mx-auto">
                    ${categorias.map(categoria => `
                        <div class="card overflow-hidden">
                            <button onclick="toggleAccordion(this)" class="w-full p-4 text-left font-bold text-lg flex justify-between items-center">
                                <span>${categoria}</span>
                                <i class="fas fa-chevron-down transition-transform duration-300"></i>
                            </button>
                            <div class="accordion-content max-h-0 overflow-hidden transition-all duration-500 ease-in-out">
                                <div class="space-y-2 p-4 border-t border-gray-700">
                                    ${momentosDisponiveis.filter(m => m.categoria === categoria).map(momento => {
                                        const configSalva = catalogoSalvo[momento.nome];
                                        const preco = configSalva?.preco !== undefined ? configSalva.preco : momento.intensidade * 2;
                                        const bloqueado = configSalva?.bloqueado || false;
                                        return `
                                        <div class="p-2 flex items-center justify-between gap-4">
                                            <div class="flex items-center gap-4">
                                                <img src="${momento.img}" class="w-12 h-12 rounded-lg object-cover">
                                                <div><h3 class="font-semibold">${momento.nome}</h3></div>
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <div class="flex items-center gap-1 bg-gray-800 rounded-lg p-2">
                                                    <i class="fas fa-fire text-yellow-400"></i>
                                                    <input type="number" value="${preco}" id="preco-${momento.nome.replace(/\s+/g, '-')}" class="bg-transparent w-16 text-center font-bold">
                                                </div>
                                                <label class="relative inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" ${bloqueado ? 'checked' : ''} class="sr-only peer" id="bloqueado-${momento.nome.replace(/\s+/g, '-')}">
                                                    <div class="relative w-14 h-7 bg-pink-600 peer-checked:bg-gray-600 rounded-full transition-colors flex items-center justify-between px-2">
                                                        <i class="fas fa-lock text-white text-xs"></i>
                                                        <i class="fas fa-lock-open text-white text-xs"></i>
                                                    </div>
                                                    <div class="absolute top-0.5 left-[2px] w-6 h-6 bg-white rounded-full border border-gray-300 transition-transform transform peer-checked:translate-x-full"></div>
                                                </label>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="mt-10 text-center">
                    <button onclick="handleSaveCatalogo()" class="btn-red px-10 py-4">
                        Salvar Altera√ß√µes
                    </button>
                </div>
            </div>
            ${state.showCartSidebar ? `
                <div class="fixed inset-0 bg-black/50 z-20" onclick="toggleCartSidebar()"></div>
                <div class="fixed right-0 top-0 h-full w-full sm:w-96 bg-gray-900 z-30 border-l border-gray-800 p-6 overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold">Meu Carrinho (${state.carrinho.length}/2)</h3>
                        <button onclick="toggleCartSidebar()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">${state.carrinho.length === 0 ? `<p class="text-gray-400 text-center py-4">Seu carrinho est√° vazio.</p>` : state.carrinho.map((item, index) => `<div class="bg-gray-800/50 rounded-lg p-4 flex justify-between items-center"><div><h4 class="font-medium">${item.emoji} ${item.nome}</h4><small class="text-gray-400 text-sm">${item.categoria}</small><div class="text-yellow-400 text-sm flex items-center gap-1 mt-1"><i class="fas fa-fire"></i> ${item.custoFoguinhos} Foguinhos</div></div><button onclick="removerDoCarrinho(${index})" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button></div>`).join('')}</div>
                    <div class="mt-8 pt-6 border-t border-gray-800">
                        <button onclick="finalizarPedido()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white rounded-lg font-medium transition-all ${state.carrinho.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${state.carrinho.length === 0 ? 'disabled' : ''}>Finalizar Pedido</button>
                        <button onclick="toggleCartSidebar()" class="w-full mt-4 py-2 text-gray-300 hover:text-white transition">Continuar Resgatando</button>
                    </div>
                </div>
            ` : ''}
        `;
    }

    // ===================================
    // FUN√á√ïES DE L√ìGICA (HANDLERS)
    // ===================================

    async function handleSaveCatalogo() {
        console.log('Iniciando salvamento do cat√°logo...');
        const novoCatalogo = {};
        const userGender = state.usuario?.sexo || 'Masculino'; 
        const momentosDisponiveis = momentos.filter(m => m.targetGender === userGender || m.targetGender === 'Unisex');

        momentosDisponiveis.forEach(momento => {
            const idPreco = `preco-${momento.nome.replace(/\s+/g, '-')}`;
            const idBloqueado = `bloqueado-${momento.nome.replace(/\s+/g, '-')}`;
            const inputPreco = document.getElementById(idPreco);
            const inputBloqueado = document.getElementById(idBloqueado);

            if (inputPreco && inputBloqueado) {
                const preco = parseInt(inputPreco.value, 10) || 0;
                const bloqueado = inputBloqueado.checked;
                novoCatalogo[momento.nome] = { preco, bloqueado };
            }
        });

        try {
            await db.collection('usuarios').doc(state.usuario.uid).update({
                catalogoPersonalizado: novoCatalogo
            });
            state.usuario.catalogoPersonalizado = novoCatalogo;
            showToast('Seu cat√°logo foi salvo com sucesso!', 'sucesso');
        } catch (error) {
            console.error("Erro ao salvar o cat√°logo: ", error);
            showToast('Houve um erro ao salvar seu cat√°logo.', 'erro');
        }
    }

    function toggleAccordion(buttonElement) {
        const content = buttonElement.nextElementSibling;
        buttonElement.classList.toggle('open');
        content.classList.toggle('open');
    }

    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (!file.type.startsWith('image/')){
            showToast('Por favor, selecione um arquivo de imagem.', 'aviso');
            return;
        }
        if (file.size > 5 * 1024 * 1024) { // 5MB
            showToast('A imagem √© muito grande (m√°x 5MB).', 'aviso');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const profilePicPreview = document.getElementById('profilePicPreview');
            if (profilePicPreview) profilePicPreview.src = e.target.result;
        };
        reader.readAsDataURL(file);

        uploadProfilePic(file);
    }

    async function uploadProfilePic(file) {
        if (!state.usuario) return showToast('Voc√™ precisa estar logado.', 'erro');

        const progressContainer = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('uploadProgressBar');
        if(progressContainer) progressContainer.classList.remove('hidden');

        const filePath = `profile_pics/${state.usuario.uid}/${file.name}`;
        const fileRef = storage.ref(filePath);
        const uploadTask = fileRef.put(file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                if(progressBar) progressBar.style.width = progress + '%';
            }, 
            (error) => {
                console.error("Erro no upload: ", error);
                showToast('Houve um erro ao enviar sua foto.', 'erro');
                if(progressContainer) progressContainer.classList.add('hidden');
            }, 
            () => {
                uploadTask.snapshot.ref.getDownloadURL().then(async (downloadURL) => {
                    console.log('Arquivo dispon√≠vel em', downloadURL);
                    await db.collection('usuarios').doc(state.usuario.uid).update({ fotoUrl: downloadURL });
                    state.usuario.fotoUrl = downloadURL;
                    updateFixedUI();
                    showToast('Foto de perfil atualizada!', 'sucesso');
                    if(progressContainer) progressContainer.classList.add('hidden');
                });
            }
        );
    }
    
    async function handleSignIn() {
        const email = document.getElementById('signInEmail').value;
        const password = document.getElementById('signInPassword').value;
        if (!email || !password) return showToast('Preencha email e senha.', 'aviso');

        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            await loadUserDataAndNavigate(userCredential.user.uid, userCredential.user.email);
        } catch (error) {
            console.error('Erro no login:', error.code, error.message);
            showToast('Email ou senha inv√°lidos.', 'erro');
        }
    }

    async function handleRegister() {
        const nome = document.getElementById('registerNome').value;
        const email = document.getElementById('registerEmail').value;
        const telefone = document.getElementById('registerTelefone').value;
        const senha = document.getElementById('registerSenha').value;
        const sexo = document.getElementById('registerSexo').value;

        if (!nome || !email || !telefone || !senha || !sexo) return showToast('Preencha todos os campos.', 'aviso');
        if (telefone.length !== 11 || !/^\d+$/.test(telefone)) return showToast('O telefone deve ter 11 d√≠gitos.', 'aviso');
        if (senha.length < 6) return showToast('A senha deve ter no m√≠nimo 6 caracteres.', 'aviso');

        try {
            const userCredential = await auth.createUserWithEmailAndPassword(email, senha);
            const user = userCredential.user;
            
            await db.collection('usuarios').doc(user.uid).set({
                nome, telefone, email, sexo,
                foguinhos: 10,
                lastCheckInDate: null,
                pareadoCom: null,
                catalogoPersonalizado: {},
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
            state.usuario = {
                uid: user.uid, email: user.email, nome, telefone, sexo,
                foguinhos: 10, lastCheckInDate: null, pareadoCom: null, catalogoPersonalizado: {}
            };
            
            showToast('Cadastro realizado com sucesso!', 'sucesso');
            changeStep('parear');
        } catch (error) {
            console.error('Erro no cadastro:', error.code, error.message);
            if (error.code === 'auth/email-already-in-use') {
                showToast('Este email j√° est√° em uso.', 'erro');
            } else {
                showToast('Erro ao cadastrar. Tente novamente.', 'erro');
            }
        }
    }

    async function handleLogout() {
        try {
            if (unsubscribeNotifications) {
                unsubscribeNotifications();
                unsubscribeNotifications = null;
            }
            await auth.signOut();
            
            // Reset state
            Object.assign(state, {
                usuario: null, pareado: false, parceiroData: null, idPareamentoAmigavel: null,
                notificacoesNaoLidas: 0, notificacoes: [], etapa: 'landing', carrinho: [],
                codigoUsuario: null, codigoDigitando: false, parceiroCodigo: null,
                parceiroTelefone: null, parceiroNome: null, showCartSidebar: false, filtro: null
            });

            renderApp();
            showToast('Voc√™ foi desconectado.', 'sucesso');
        } catch (error) {
            console.error('Erro ao deslogar:', error);
            showToast('Erro ao fazer logout.', 'erro');
        }
    }

    async function handleDailyCheckIn() {
        if (!state.pareado || !state.parceiroData) return showToast('Voc√™ precisa estar pareado para presentear.', 'aviso');

        const lastCheckIn = state.usuario.lastCheckInDate ? state.usuario.lastCheckInDate.toDate() : null;
        if (lastCheckIn && isSameDay(lastCheckIn, new Date())) return showToast('Voc√™ j√° presenteou hoje!', 'aviso');

        try {
            const parceiroQuery = await db.collection('usuarios').where('telefone', '==', state.parceiroCodigo).limit(1).get();
            if (parceiroQuery.empty) return showToast('Erro: Parceiro n√£o encontrado.', 'erro');
            
            const parceiroDoc = parceiroQuery.docs[0];
            const parceiroUid = parceiroDoc.id;

            await db.collection('usuarios').doc(state.usuario.uid).update({
                lastCheckInDate: firebase.firestore.FieldValue.serverTimestamp()
            });
            await db.collection('usuarios').doc(parceiroUid).update({
                foguinhos: firebase.firestore.FieldValue.increment(1)
            });

            await criarNotificacao(parceiroUid, 'Voc√™ ganhou um presente!', `${state.usuario.nome} te presenteou com 1 foguinho üî•.`, 'fa-gift');
            showToast(`Presente enviado para ${state.parceiroNome}!`, 'sucesso');
            await loadUserDataAndNavigate(state.usuario.uid, state.usuario.email);
        } catch (error) {
            console.error('Erro no Check-in di√°rio:', error);
            showToast('Erro ao presentear. Tente novamente.', 'erro');
        }
    }

    function handleContinuarSemParear() {
        changeStep('main');
    }

    function filtrarMomentos(categoria) {
        state.filtro = categoria;
        renderApp();
    }

    async function adicionarAoCarrinho(momento) {
        if (state.carrinho.length >= 2) return showToast('Limite de 2 itens no carrinho!', 'aviso');
        if (!state.pareado) return showToast('Voc√™ precisa estar pareado para resgatar.', 'aviso');
        
        const custo = momento.custoFoguinhos;
        if ((state.usuario.foguinhos || 0) < custo) return showToast(`Voc√™ precisa de ${custo} foguinhos.`, 'aviso');

        try {
            await db.collection('usuarios').doc(state.usuario.uid).update({
                foguinhos: firebase.firestore.FieldValue.increment(-custo)
            });
            
            state.usuario.foguinhos -= custo;
            state.carrinho.push(momento);

            showToast(`${momento.nome} adicionado!`, 'sucesso');
            renderApp();
        } catch (error) {
            console.error('Erro ao adicionar ao carrinho:', error);
            showToast('Erro ao adicionar momento.', 'erro');
        }
    }

    async function removerDoCarrinho(index) {
        const momentoRemovido = state.carrinho[index];
        const custo = momentoRemovido.custoFoguinhos;

        try {
            await db.collection('usuarios').doc(state.usuario.uid).update({
                foguinhos: firebase.firestore.FieldValue.increment(custo)
            });

            state.usuario.foguinhos += custo;
            state.carrinho.splice(index, 1);

            showToast(`Item removido (+${custo} üî•)`, 'sucesso');
            renderApp();
        } catch (error) {
            console.error('Erro ao remover do carrinho:', error);
            showToast('Erro ao remover item.', 'erro');
        }
    }

    async function desparearParceiro() {
        if (confirm('Tem certeza que deseja desfazer o pareamento?')) { 
            try {
                const usuarioUid = state.usuario.uid;
                const parceiroTelefone = state.parceiroCodigo; 

                let parceiroUid = null;
                const parceiroQuery = await db.collection('usuarios').where('telefone', '==', parceiroTelefone).limit(1).get();
                if (!parceiroQuery.empty) parceiroUid = parceiroQuery.docs[0].id;

                const batch = db.batch();
                const userDocRef = db.collection('usuarios').doc(usuarioUid);
                batch.update(userDocRef, { pareadoCom: firebase.firestore.FieldValue.delete() });

                if (parceiroUid) {
                    const parceiroDocRef = db.collection('usuarios').doc(parceiroUid);
                    batch.update(parceiroDocRef, { pareadoCom: firebase.firestore.FieldValue.delete() });
                }

                const telefonesOrdenados = [state.usuario.telefone, parceiroTelefone].sort();
                const idPareamento = telefonesOrdenados.map(tel => tel.replace(/\D/g, '')).join('_');
                const pareamentoDocRef = db.collection('pareamentos').doc(idPareamento);
                batch.delete(pareamentoDocRef);
                
                if (parceiroUid) {
                    const requestId = [usuarioUid, parceiroUid].sort().join('_');
                    const requestDocRef = db.collection('pairingRequests').doc(requestId);
                    batch.delete(requestDocRef);
                }
                
                await batch.commit();

                showToast('Pareamento desfeito com sucesso!', 'sucesso');
                // For√ßa um reload completo para resetar o estado.
                window.location.reload();

            } catch (error) {
                console.error('Erro ao desfazer pareamento:', error);
                showToast('Erro ao desfazer pareamento.', 'erro');
            }
        }
    }

    function finalizarPedido() {
        if (!state.pareado) return showToast('Voc√™ precisa estar pareado.', 'aviso');
        if (state.carrinho.length === 0) return showToast('Seu carrinho est√° vazio.', 'aviso');

        const momentosTxt = state.carrinho.map(m => `${m.emoji} ${m.nome}`).join(' | ');
        const mensagem = encodeURIComponent(`üíë Pedido de Momentos Especiais üíë\n\nOl√°, ${state.parceiroNome}!\n\nEu resgatei os seguintes momentos para n√≥s:\n\n${momentosTxt}\n\nCom amor, ${state.usuario.nome} ‚ù§Ô∏è`);
        const whatsappLink = `https://wa.me/${state.parceiroTelefone}?text=${mensagem}`;

        showToast('Abrindo WhatsApp para enviar...', 'sucesso');
        
        setTimeout(() => {
            window.open(whatsappLink, '_blank');
        }, 1500);

        state.carrinho = [];
        state.showCartSidebar = false;
        renderApp();
    }
    
    // ===================================
    // FUN√á√ïES DE CONTROLE PRINCIPAL
    // ===================================

    function changeStep(newStep) {
        if (state.etapa === newStep) {
            if (newStep !== 'main') state.etapa = 'main';
            else return; 
        } else {
            state.etapa = newStep;
        }
        state.showCartSidebar = false;
        renderApp();
    }

    function updateFixedUI() {
        if (userNameDisplay) userNameDisplay.textContent = state.usuario?.nome ? `Ol√°, ${state.usuario.nome}!` : '';
        const headerPic = document.getElementById('headerProfilePic');
        if (headerPic && state.usuario) {
            const fotoPadrao = 'https://images.pexels.com/photos/1105325/pexels-photo-1105325.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1';
            headerPic.src = state.usuario.fotoUrl || fotoPadrao;
            headerPic.classList.remove('hidden');
        } else if (headerPic) {
            headerPic.classList.add('hidden');
        }
        const notificationDot = document.getElementById('notificationDot');
        if (notificationDot) {
            notificationDot.classList.toggle('hidden', state.notificacoesNaoLidas <= 0);
        }
        if (foguinhosBadge) foguinhosBadge.textContent = state.usuario ? state.usuario.foguinhos : 0;
        if (carrinhoBadge) carrinhoBadge.textContent = state.carrinho.length;

        if (bottomNavBar && mainHeader) {
            const telasComBarraVisivel = ['main', 'parear', 'foguinhosPopup', 'gerenciarCatalogo', 'notificacoes'];
            const isVisible = telasComBarraVisivel.includes(state.etapa);
            bottomNavBar.style.display = isVisible ? 'flex' : 'none';
            mainHeader.style.display = isVisible ? 'flex' : 'none';
        }

        const bottomNavItems = document.querySelectorAll('.bottom-nav-bar .bottom-nav-item, .bottom-nav-bar .bottom-nav-item-center');
        bottomNavItems.forEach(item => {
            item.classList.remove('active');
            const heartIcon = item.querySelector('.fas.fa-heart');
            if (heartIcon) {
                heartIcon.className = 'fas fa-heart'; // Reset classes
                if (state.pareado) heartIcon.classList.add('text-red-500');
                else if (state.usuario?.pareadoCom?.startsWith('pending_')) heartIcon.classList.add('text-yellow-400');
                else heartIcon.classList.add('text-gray-400');
            }
            if (item.querySelector('.fas.fa-store') && state.etapa === 'gerenciarCatalogo') item.classList.add('active');
            else if (item.querySelector('.fas.fa-heart') && state.etapa === 'parear') item.classList.add('active');
            else if (item.querySelector('.fas.fa-shopping-cart') && state.showCartSidebar) item.classList.add('active');
            else if (item.querySelector('.fas.fa-fire') && state.etapa === 'foguinhosPopup') item.classList.add('active');
            else if (item.querySelector('.fas.fa-bell') && state.etapa === 'notificacoes') item.classList.add('active');
        });
    }
    
    function renderApp() {
        console.log('renderApp. Etapa:', state.etapa);
        updateFixedUI();
        switch (state.etapa) {
            case 'landing': renderLandingPage(); break;
            case 'signIn': renderSignIn(); break;
            case 'register': renderRegister(); break;
            case 'parear': renderPareamento(); break;
            case 'main': renderMain(); break;
            case 'gerenciarCatalogo': renderGerenciarCatalogo(); break;
            case 'notificacoes': renderNotificacoes(); break;
            case 'foguinhosPopup': renderFoguinhosPopupContent(); break;
            default: renderLandingPage();
        }
    }
    
    async function loadUserDataAndNavigate(uid, email) {
        console.log('loadUserDataAndNavigate:', uid);
        try {
            if (!uid) {
                changeStep('landing');
                return;
            }
            const userDoc = await db.collection('usuarios').doc(uid).get();
            if (userDoc.exists) {
                state.usuario = { uid, email, ...userDoc.data() };
                state.pareado = !!state.usuario.pareadoCom && !state.usuario.pareadoCom.startsWith('pending_');
                setupNotificationListener(uid);
                if (state.pareado) {
                    state.parceiroCodigo = state.usuario.pareadoCom;
                    const parceiroQuery = await db.collection('usuarios').where('telefone', '==', state.parceiroCodigo).limit(1).get();
                    if (!parceiroQuery.empty) {
                        state.parceiroData = parceiroQuery.docs[0].data();
                        state.parceiroNome = state.parceiroData.nome;
                        state.parceiroTelefone = '55' + state.parceiroData.telefone.replace(/\D/g, '');
                        const telefones = [state.usuario.telefone, state.parceiroData.telefone].sort();
                        const idPareamento = telefones.map(tel => tel.replace(/\D/g, '')).join('_');
                        const pareamentoDoc = await db.collection('pareamentos').doc(idPareamento).get();
                        if (pareamentoDoc.exists) state.idPareamentoAmigavel = pareamentoDoc.data().idAmigavel;
                    } else {
                        state.pareado = false; state.parceiroData = null;
                    }
                } else {
                    state.parceiroData = null; state.idPareamentoAmigavel = null;
                }
                const pendingRequestQuery = await db.collection('pairingRequests').where('receiverUid', '==', uid).where('status', '==', 'pending').limit(1).get();
                if (!pendingRequestQuery.empty) {
                    state.pendingPairingRequest = { id: pendingRequestQuery.docs[0].id, ...pendingRequestQuery.docs[0].data() };
                    changeStep('parear');
                } else if (state.usuario.pareadoCom?.startsWith('pending_')) {
                    changeStep('parear');
                } else {
                    changeStep('main');
                }
            } else {
                state.usuario = { uid, email };
                showToast('Por favor, complete seu cadastro.', 'aviso');
                changeStep('register');
            }
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            changeStep('landing');
        }
    }

    function init() {
        auth.onAuthStateChanged(user => {
            if (user) {
                loadUserDataAndNavigate(user.uid, user.email);
            } else {
                if (unsubscribeNotifications) unsubscribeNotifications();
                Object.assign(state, {
                    usuario: null, pareado: false, parceiroData: null, idPareamentoAmigavel: null,
                    notificacoesNaoLidas: 0, notificacoes: [], etapa: 'landing', carrinho: [],
                    codigoUsuario: null, codigoDigitando: false, parceiroCodigo: null,
                    parceiroTelefone: null, parceiroNome: null, showCartSidebar: false, filtro: null
                });
                renderApp();
            }
        });
    }

    window.onload = function() {
    // Atribui os elementos globais ap√≥s o DOM estar carregado
    appContainer = document.getElementById('app');
    userNameDisplay = document.getElementById('userNameDisplay');
    foguinhosBadge = document.getElementById('foguinhosBadge');
    carrinhoBadge = document.getElementById('carrinhoBadge');
    bottomNavBar = document.getElementById('bottom-nav-bar');
    mainHeader = document.getElementById('mainHeader');

    // Torna todas as fun√ß√µes necess√°rias globais para uso nos eventos onclick
    Object.assign(window, {
        isSameDay, changeStep, handleSignIn, handleRegister, handleLogout,
        sendPairingRequest, acceptPairingRequest, rejectPairingRequest,
        handleDailyCheckIn, handleContinuarSemParear, filtrarMomentos,
        adicionarAoCarrinho, removerDoCarrinho, finalizarPedido,
        desparearParceiro, toggleCartSidebar, cancelPendingPairingRequest,
        handleSaveCatalogo, handleFileSelect, uploadProfilePic, toggleAccordion
    });

    init(); // Inicia o aplicativo
};
</script>

<nav class="bottom-nav-bar" id="bottom-nav-bar" style="display: none;">
    <button class="bottom-nav-item" onclick="changeStep('gerenciarCatalogo');"><i class="fas fa-store"></i></button>
    <button class="bottom-nav-item" onclick="changeStep('parear');"><i class="fas fa-heart"></i></button>
    <button class="bottom-nav-item-center" onclick="changeStep('main');"><i class="fas fa-shopping-bag"></i></button>
    <button class="bottom-nav-item relative" onclick="toggleCartSidebar();"><i class="fas fa-shopping-cart"></i><span id="carrinhoBadge" class="badge-notification badge-gray">0</span></button>
    <button class="bottom-nav-item" onclick="changeStep('foguinhosPopup');"><i class="fas fa-fire"></i><span id="foguinhosBadge" class="badge-notification badge-yellow">0</span></button>
</nav>

<div id="toast-container" class="fixed bottom-24 left-1/2 -translate-x-1/2 z-[9999] space-y-2 w-auto max-w-sm"></div>

</body>
</html>