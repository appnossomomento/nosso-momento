rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthenticated() {
      return request.auth != null;
    }

    function authUid() {
      return request.auth.uid;
    }

    function isOwner(userId) {
      return isAuthenticated() && authUid() == userId;
    }

    function isPartner(resourceData) {
      return isAuthenticated() &&
        resourceData.pareadoUid != null &&
        resourceData.pareadoUid == authUid();
    }

    function hasField(data, fieldName) {
      return data.keys().hasAny([fieldName]);
    }

    function fieldUnchanged(fieldName) {
      return (!hasField(resource.data, fieldName) && !hasField(request.resource.data, fieldName)) ||
        request.resource.data[fieldName] == resource.data[fieldName];
    }

    match /usuarios/{userId} {
      allow get: if isOwner(userId) || (resource.data != null && isPartner(resource.data));
      allow list: if false;

      allow create: if isOwner(userId)
        && request.resource.data.keys().hasOnly([
          'achievementStats', 'catalogoPersonalizado', 'conquistas', 'createdAt',
          'email', 'fcmToken', 'foguinhos', 'fotoUrl', 'lastCheckInDate', 'nome',
          'notificationsEnabled', 'pareadoCom', 'pareadoUid', 'sexo', 'telefone'
        ])
        && request.resource.data.foguinhos is int
        && request.resource.data.foguinhos == 10
        && (!('pareadoUid' in request.resource.data) || request.resource.data.pareadoUid == null)
        && (!('pareadoCom' in request.resource.data) || request.resource.data.pareadoCom == null)
        && (!('lastCheckInDate' in request.resource.data) || request.resource.data.lastCheckInDate == null)
        && request.resource.data.catalogoPersonalizado is map
        && (!hasField(request.resource.data, 'achievementStats') || request.resource.data.achievementStats is map)
        && (!hasField(request.resource.data, 'conquistas') || request.resource.data.conquistas is map);

      allow update: if isOwner(userId)
        && fieldUnchanged('createdAt')
        && fieldUnchanged('email')
        && fieldUnchanged('foguinhos')
        && fieldUnchanged('nome')
        && fieldUnchanged('notificationsEnabled')
        && fieldUnchanged('pareadoCom')
        && fieldUnchanged('pareadoUid')
        && fieldUnchanged('sexo')
        && fieldUnchanged('telefone')
        && fieldUnchanged('lastCheckInDate')
  && fieldUnchanged('fcmToken')
  && fieldUnchanged('conquistas')
  && fieldUnchanged('achievementStats')
  && (hasField(request.resource.data, 'catalogoPersonalizado') || !hasField(resource.data, 'catalogoPersonalizado'))
  && (!hasField(request.resource.data, 'catalogoPersonalizado') || request.resource.data.catalogoPersonalizado is map)
  && (!hasField(request.resource.data, 'fotoUrl') || request.resource.data.fotoUrl is string || request.resource.data.fotoUrl == null);

      allow delete: if isOwner(userId);
    }

    match /inputs/{inputId} {
      allow read, write: if false;
    }

    match /notificacoes/{nid} {
      allow get: if isAuthenticated() && resource.data.userId == authUid();
      allow list: if isAuthenticated() && resource.data.userId == authUid();
      allow create: if isAuthenticated() && request.resource.data.userId == authUid();
      allow update: if isAuthenticated()
        && resource.data.userId == authUid()
        && resource.data.diff(request.resource.data).changedKeys()
          .hasOnly(['lida'])
        && request.resource.data.lida is bool;
      allow delete: if false;
    }

    match /pairingRequests/{pid} {
      allow get: if isAuthenticated() && (
        resource.data.senderUid == authUid() ||
        resource.data.receiverUid == authUid()
      );

      allow list: if isAuthenticated() && (
        resource.data.senderUid == authUid() ||
        resource.data.receiverUid == authUid()
      );

      allow create: if isAuthenticated()
        && request.resource.data.senderUid == authUid()
        && request.resource.data.receiverUid is string
        && request.resource.data.status == 'pending';

      allow update: if isAuthenticated()
        && resource.data.receiverUid == authUid()
        && (request.resource.data.status == 'accepted' || request.resource.data.status == 'rejected')
        && request.resource.data.keys().hasOnly([
          'processedAt', 'processedBy', 'receiverPhone', 'status'
        ]);

      allow delete: if isAuthenticated()
        && resource.data.senderUid == authUid()
        && resource.data.status == 'pending';
    }

    match /pareamentos/{pid} {
      allow get: if isAuthenticated() && (
        resource.data.pessoa1Uid == authUid() ||
        resource.data.pessoa2Uid == authUid()
      );
      allow list, write: if false;
    }

    match /tarefasMomentos/{tid} {
      allow get: if isAuthenticated() && (
        resource.data.resgatadoPorUid == authUid() ||
        resource.data.executadoPorUid == authUid()
      );

      allow list: if isAuthenticated() && (
        resource.data.executadoPorUid == authUid() ||
        resource.data.resgatadoPorUid == authUid()
      );

      allow update: if isAuthenticated()
        && (
          resource.data.executadoPorUid == authUid() ||
          resource.data.resgatadoPorUid == authUid()
        )
        && resource.data.status == 'Pendente'
        && request.resource.data.diff(resource.data).changedKeys().hasOnly([
          'dataConclusao', 'status'
        ])
        && request.resource.data.status == 'Realizado'
        && request.resource.data.dataConclusao == request.time;

      allow create, delete: if false;
    }

    match /momentosMestres/{mid} {
      allow read: if true;
      allow write: if false;
    }

    match /userNotificationTokens/{uid} {
      allow read, write: if false;
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
